# Raspberry Pi Hardware Device Override
#
# This docker-compose override file adds Raspberry Pi-specific hardware device mappings
# for GPIO, displays, and disk monitoring on Raspberry Pi hardware.
#
# On non-Raspberry Pi hosts, Docker will fail with "error gathering device information"
# if devices are missing. This override allows the base compose files to work on any
# host, with hardware features enabled only when needed.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.pi.yml up -d
# Or with embedded database:
#   docker-compose -f docker-compose.embedded-db.yml -f docker-compose.pi.yml up -d
#
# Hardware allocation:
#   - sdr-service: /dev/bus/usb (USB SDR devices for active streaming)
#   - hardware-service: /dev/gpiomem, /dev/gpiochip0, /dev/i2c-1 (GPIO + OLED displays)
#   - app: /dev/bus/usb (USB access for SDR discovery only)

services:
  app:
    env_file:
      - .env  # Load all settings from local .env
    environment:
      # Hard-code database settings for CasaOS PostgreSQL
      POSTGRES_HOST: host.docker.internal
      POSTGRES_PORT: 5432
      POSTGRES_DB: casaos
      POSTGRES_USER: casaos
      POSTGRES_PASSWORD: casaos
    devices:
      - /dev/bus/usb:/dev/bus/usb  # USB access for SDR discovery (read-only query)
    # NOTE: Only /dev/bus/usb mounted for discovery - full /dev mount removed to prevent pts errors
    # NOTE: GPIO/screen access removed - now in hardware-service
    # Configuration: start-pi.sh syncs local .env to persistent volume before starting

  sdr-service:
    env_file:
      - .env  # Load all settings from local .env
    environment:
      # Hard-code database settings for CasaOS PostgreSQL
      POSTGRES_HOST: host.docker.internal
      POSTGRES_PORT: 5432
      POSTGRES_DB: casaos
      POSTGRES_USER: casaos
      POSTGRES_PASSWORD: casaos
    # NOTE: USB devices already in base docker-compose.yml
    # No GPIO/screen hardware needed in SDR service

  hardware-service:
    env_file:
      - .env  # Load all settings from local .env
    environment:
      # Hard-code database settings for CasaOS PostgreSQL
      POSTGRES_HOST: host.docker.internal
      POSTGRES_PORT: 5432
      POSTGRES_DB: casaos
      POSTGRES_USER: casaos
      POSTGRES_PASSWORD: casaos

      # Enable GPIO and screens on Raspberry Pi
      GPIO_ENABLED: "true"
      SCREENS_AUTO_START: "true"
    devices:
      - /dev/gpiomem:/dev/gpiomem      # GPIO memory access for user-space control
      - /dev/gpiochip0:/dev/gpiochip0  # GPIO chip device for modern libraries (lgpio)
      - /dev/i2c-1:/dev/i2c-1          # I2C bus for OLED displays (Argon One, etc.)
    privileged: true  # Required for GPIO access on Pi 5
