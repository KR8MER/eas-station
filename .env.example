# =============================================================================
# EAS Station Configuration
# =============================================================================
# Copy this file to `.env` and update the values before running docker compose.
# Generate SECRET_KEY with: python3 -c 'import secrets; print(secrets.token_hex(32))'

# =============================================================================
# CORE SETTINGS (REQUIRED)
# =============================================================================

SECRET_KEY=replace-with-a-long-random-string

# Flask configuration
FLASK_DEBUG=false
FLASK_ENV=production

# Git commit hash (leave blank to auto-detect from repository)
# Only set this to override auto-detection (e.g., when building from tarball)
GIT_COMMIT=

# =============================================================================
# HTTPS / SSL CONFIGURATION
# =============================================================================

# Domain name for SSL certificate (required for Let's Encrypt)
# Use your actual domain name (e.g., eas.example.com)
# For local testing, use "localhost" (will generate self-signed certificate)
DOMAIN_NAME=localhost

# Email for Let's Encrypt certificate notifications
SSL_EMAIL=admin@example.com

# Use Let's Encrypt staging server for testing (0=production, 1=staging)
# Set to 1 when testing to avoid rate limits
CERTBOT_STAGING=0

# =============================================================================
# DATABASE (PostgreSQL + PostGIS)
# =============================================================================

# Use host.docker.internal for external database, or alerts-db for embedded mode
POSTGRES_HOST=host.docker.internal
POSTGRES_PORT=5432
POSTGRES_DB=alerts
POSTGRES_USER=postgres
POSTGRES_PASSWORD=change-me

# =============================================================================
# ALERT POLLING
# =============================================================================

# Poll interval in seconds (default: 120 = 2 minutes)
# FEMA IPAWS recommends polling no more frequently than every 2 minutes (120 seconds)
# Minimum: 30 seconds, Maximum: unlimited (higher values reduce server load)
POLL_INTERVAL_SEC=120
CAP_TIMEOUT=30

# NOAA User Agent (REQUIRED for NOAA Weather API compliance)
# The NOAA Weather API requires a User-Agent header that identifies your application
# and provides contact information. Format: "AppName/Version (contact info)"
# See: https://www.weather.gov/documentation/services-web-api
# No API key or authentication is required for the NOAA Weather API.
NOAA_USER_AGENT=EAS Station/2.12 (+https://github.com/KR8MER/eas-station; support@easstation.com)

# Optional: Override feed URLs (comma-separated)
CAP_ENDPOINTS=
IPAWS_DEFAULT_LOOKBACK_HOURS=12

# =============================================================================
# IPAWS FEED CONFIGURATION
# =============================================================================
# FEMA IPAWS provides public alert feeds with no authentication required.
# No API key or password is needed - these endpoints are publicly accessible.
# IMPORTANT: Test in STAGING first before switching to PRODUCTION!
#
# Available Feed Types:
#   - PUBLIC Feed: All alerts (EAS, WEA, NWEM, and other valid alerts)
#   - EAS Feed: Alerts valid for Emergency Alert System dissemination
#   - WEA Feed: Alerts valid for Wireless Emergency Alerts dissemination
#   - NWEM Feed: Non-Weather Emergency Messages for NOAA Weather Radio
#   - PUBLIC_NON_EAS: Public alerts excluding EAS dissemination path
#
# STAGING ENVIRONMENT (TDL) - For Testing:
# IPAWS_CAP_FEED_URLS=https://tdl.apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/public/recent/{timestamp}
# EAS only: https://tdl.apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/eas/recent/{timestamp}
# WEA only: https://tdl.apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/PublicWEA/recent/{timestamp}
# NWEM only: https://tdl.apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/nwem/recent/{timestamp}
# Non-EAS: https://tdl.apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/public_non_eas/recent/{timestamp}
#
# PRODUCTION ENVIRONMENT - For Live Alerts:
# IPAWS_CAP_FEED_URLS=https://apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/public/recent/{timestamp}
# EAS only: https://apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/eas/recent/{timestamp}
# WEA only: https://apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/PublicWEA/recent/{timestamp}
# NWEM only: https://apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/nwem/recent/{timestamp}
# Non-EAS: https://apps.fema.gov/IPAWSOPEN_EAS_SERVICE/rest/public_non_eas/recent/{timestamp}
#
# Multiple feeds can be specified (comma-separated) to receive alerts from different sources.
# The {timestamp} placeholder is automatically replaced with the appropriate lookback time.
IPAWS_CAP_FEED_URLS=

# Allow the CAP poller to request SDR capture files during alert playback (0 = off, 1 = on)
CAP_POLLER_ENABLE_RADIO=0

# =============================================================================
# LOCATION SETTINGS
# =============================================================================

DEFAULT_TIMEZONE=America/New_York
DEFAULT_COUNTY_NAME=Putnam County
DEFAULT_STATE_CODE=OH
DEFAULT_ZONE_CODES=OHZ016,OHC137

# Map display settings
DEFAULT_MAP_CENTER_LAT=41.0195
DEFAULT_MAP_CENTER_LNG=-84.1190
DEFAULT_MAP_ZOOM=9

# =============================================================================
# EAS BROADCAST (SAME/EAS ENCODER)
# =============================================================================

# Enable EAS audio generation (true/false)
EAS_BROADCAST_ENABLED=false

# EAS identification
EAS_ORIGINATOR=WXR
EAS_STATION_ID=EASNODES

# Audio generation
EAS_OUTPUT_DIR=static/eas_messages
EAS_ATTENTION_TONE_SECONDS=8
EAS_SAMPLE_RATE=16000
EAS_AUDIO_PLAYER=aplay

# Authorization for manual broadcasts (FIPS codes and event codes)
EAS_MANUAL_FIPS_CODES=039137
EAS_MANUAL_EVENT_CODES=TESTS

# GPIO relay control (leave blank to disable)
# Physical header pins 1-8 (BCM 2, 3, 4, 14 plus power/ground rails) are reserved for the Argon OLED enclosure.
EAS_GPIO_PIN=
EAS_GPIO_ACTIVE_STATE=HIGH
EAS_GPIO_HOLD_SECONDS=5
EAS_GPIO_WATCHDOG_SECONDS=300
GPIO_ADDITIONAL_PINS=
# JSON map of BCM pins to behavior lists (managed through GPIO Pin Map UI)
GPIO_PIN_BEHAVIOR_MATRIX=

# =============================================================================
# TEXT-TO-SPEECH (OPTIONAL)
# =============================================================================

# Provider: azure, azure_openai, pyttsx3, or blank to disable
EAS_TTS_PROVIDER=

# Azure OpenAI TTS (recommended for best quality)
AZURE_OPENAI_ENDPOINT=
AZURE_OPENAI_KEY=
AZURE_OPENAI_VOICE=alloy
AZURE_OPENAI_MODEL=tts-1-hd
AZURE_OPENAI_SPEED=1.0

# Azure AI Speech (legacy)
AZURE_SPEECH_KEY=
AZURE_SPEECH_REGION=

# =============================================================================
# LED DISPLAY (OPTIONAL)
# =============================================================================

# Alpha protocol LED sign (leave blank to disable)
LED_SIGN_IP=
LED_SIGN_PORT=10001
DEFAULT_LED_LINES=PUTNAM COUNTY,EMERGENCY MGMT,NO ALERTS,SYSTEM READY

# =============================================================================
# OLED DISPLAY (OPTIONAL)
# =============================================================================

# Argon Industria SSD1306 OLED module (enabled by default; set false to disable)
OLED_ENABLED=true
OLED_I2C_BUS=1
OLED_I2C_ADDRESS=0x3C
OLED_WIDTH=128
OLED_HEIGHT=64
OLED_ROTATE=0
OLED_DEFAULT_INVERT=false
# OLED_FONT_PATH=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf

# =============================================================================
# VFD DISPLAY (OPTIONAL)
# =============================================================================

# Noritake GU140x32F-7000B graphical VFD display (leave blank to disable)
VFD_PORT=/dev/ttyUSB0
VFD_BAUDRATE=38400

# =============================================================================
# NOTIFICATIONS (OPTIONAL)
# =============================================================================

ENABLE_EMAIL_NOTIFICATIONS=false
ENABLE_SMS_NOTIFICATIONS=false

# Email settings (if enabled)
MAIL_SERVER=
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USERNAME=
MAIL_PASSWORD=

# =============================================================================
# LOGGING & PERFORMANCE
# =============================================================================

LOG_LEVEL=INFO
LOG_FILE=logs/eas_station.log

# Web server access logs (true to enable, false to disable)
# When disabled, only error logs are shown to reduce clutter
WEB_ACCESS_LOG=false

# CAP ingestion cache timeout (legacy setting, kept for compatibility)
CACHE_TIMEOUT=300

# =============================================================================
# APPLICATION CACHING (Performance Optimization)
# =============================================================================

# Cache backend: simple (in-memory), filesystem, redis
# IMPORTANT: Redis is now the DEFAULT and REQUIRED for production use.
# - 'redis' (DEFAULT) - Redis cache (required for separated architecture & multi-worker deployments)
# - 'simple' - In-memory cache (only for development/testing with single worker)
# - 'filesystem' - File-based cache (legacy, not recommended)
#
# In separated architecture (default), Redis is REQUIRED for:
# - Sharing cache across app container workers
# - Communication with audio-service container
# - Worker coordination and metrics
CACHE_TYPE=redis

# Default cache timeout in seconds (how long cached data is valid)
# Lower values = fresher data but more database load
# Higher values = less database load but potentially stale data
CACHE_DEFAULT_TIMEOUT=300

# Filesystem cache directory (only used when CACHE_TYPE=filesystem)
# NOT RECOMMENDED: File-based caching doesn't work reliably in containers
CACHE_DIR=/tmp/eas-station-cache

# Redis connection URL (REQUIRED when CACHE_TYPE=redis)
# Format: redis://[password@]host:port/db
# Default for docker-compose: redis://redis:6379/0
CACHE_REDIS_URL=redis://redis:6379/0

# =============================================================================
# WEB SERVER CONFIGURATION
# =============================================================================

# Gunicorn worker processes (handles concurrent web requests)
# More workers = more concurrent users but higher memory usage
# Raspberry Pi 3: 1-2 workers, Pi 4/5: 2-3 workers
# Requires container restart to take effect
MAX_WORKERS=2

UPLOAD_FOLDER=/app/uploads

# =============================================================================
# EAS MONITORING (CONTINUOUS SAME DECODER)
# =============================================================================

# EAS scan interval in seconds (how often to check audio buffer for SAME headers)
# Default: 3.0 seconds (provides 75% overlap with 12s buffer)
# System automatically increases interval if scans take longer (prevents queue buildup)
# Raspberry Pi 5: recommend 5.0s, Desktop/Server: 3.0s
# Lower = more frequent scans (better detection) but higher CPU usage
# Monitor logs for "Skipping EAS scan" warnings and increase if needed
EAS_SCAN_INTERVAL=3.0

# Maximum concurrent EAS scan threads (default: 2)
# This limits how many audio buffer scans can run simultaneously to decode SAME headers.
# 
# IMPORTANT: This is PER FLASK WORKER, not system-wide!
# - Each Gunicorn worker process gets its own EAS monitor with this limit
# - With 1 Gunicorn worker (default), max_concurrent_scans=2 means 2 total scan threads
# - With 2 Gunicorn workers, max_concurrent_scans=2 means 4 total scan threads (2 per worker)
#
# Architecture:
# - EAS scans run in daemon threads spawned by ContinuousEASMonitor
# - Each scan thread is independent and processes one 12-second audio buffer
# - Scans are CPU-intensive (FFT analysis + FSK decoding)
# - If scans take longer than scan_interval (3s), they queue up and may be skipped
#
# When to increase:
# - If you see "Skipping EAS scan: X scans already active" warnings frequently
# - If scan_duration_seconds > scan_interval (3s) due to slow CPU
# - If you have a fast multi-core CPU and want better alert detection reliability
#
# When to decrease:
# - If CPU usage is too high during scanning
# - If web interface becomes unresponsive during scans
#
# Resource impact:
# - Each scan thread uses ~5-15% CPU during decode (depends on hardware)
# - With max_concurrent_scans=2, expect 10-30% CPU usage during active scanning
# - Does NOT require additional Gunicorn workers (uses daemon threads)
#
# Recommended values:
# - Raspberry Pi 4/5: 2-3 (default: 2)
# - Desktop/Server (4+ cores): 3-5
# - High-performance (8+ cores): 4-8
#
MAX_CONCURRENT_EAS_SCANS=2

# =============================================================================
# BACKUP & RECOVERY
# =============================================================================

# Backup directory (default: /var/backups/eas-station)
BACKUP_DIR=/var/backups/eas-station

# =============================================================================
# DOCKER/INFRASTRUCTURE
# =============================================================================

TZ=America/New_York
WATCHTOWER_LABEL_ENABLE=true
WATCHTOWER_MONITOR_ONLY=false
ALERTS_DB_IMAGE=postgis/postgis:17-3.4
