{% extends "base.html" %}

{% block title %}Custom Display Screens - EAS Station{% endblock %}

{% block nav_title %}Custom Display Screens{% endblock %}

{% block extra_css %}
<style>
.screens-page {
    gap: 1.25rem;
}

.page-hero {
    background: linear-gradient(120deg, #2b59ff, #3a8ef6);
    border-radius: 18px;
    padding: 2rem;
    color: #fff;
    position: relative;
    overflow: hidden;
}

.page-hero::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255,255,255,0.25), transparent 55%);
    pointer-events: none;
}

.page-hero .hero-content {
    position: relative;
    z-index: 1;
}

.page-hero h1 {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.page-hero p {
    margin-bottom: 1.25rem;
    font-size: 1.05rem;
    opacity: 0.95;
}

.hero-actions .btn + .btn {
    margin-left: 0.5rem;
}

.summary-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 1.25rem;
    min-height: 140px;
    box-shadow: var(--card-shadow, 0 12px 24px rgba(15, 23, 42, 0.08));
}

.summary-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.summary-value {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.summary-subtitle {
    color: var(--text-secondary);
    margin: 0;
}

.filter-card {
    border-radius: 14px;
    border: 1px solid var(--border-color);
    padding: 1.25rem;
    background: var(--card-bg);
    box-shadow: var(--card-shadow, 0 12px 24px rgba(15, 23, 42, 0.08));
}

.screen-card,
.rotation-card,
.doc-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    box-shadow: var(--card-shadow, 0 12px 24px rgba(15, 23, 42, 0.08));
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.screen-card:hover,
.rotation-card:hover,
.doc-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
}

.screen-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.screen-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.display-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    font-weight: 600;
}

.display-chip.led { background: rgba(255, 193, 7, 0.18); color: #f4b400; }
.display-chip.oled { background: rgba(32, 201, 151, 0.18); color: #20c997; }
.display-chip.vfd { background: rgba(111, 66, 193, 0.18); color: #6f42c1; }

.status-chip {
    padding: 0.25rem 0.75rem;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-chip.enabled { background: rgba(25, 135, 84, 0.18); color: #198754; }
.status-chip.disabled { background: rgba(220, 53, 69, 0.18); color: #dc3545; }

.screen-preview {
    border-radius: 12px;
    padding: 1rem;
    margin: 1.25rem 0 0.5rem;
    background: #050505;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    min-height: 110px;
    border: 1px solid rgba(255,255,255,0.08);
}

.screen-preview[data-display="led"] { background: #050505; color: #f8c102; text-shadow: 0 0 12px rgba(255, 193, 7, 0.6); }
.screen-preview[data-display="oled"] { background: #000; color: #f2f2f2; }
.screen-preview[data-display="vfd"] { background: #010c01; color: #19ff96; border-color: rgba(25, 255, 150, 0.2); }

.preview-line {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preview-line + .preview-line { margin-top: 0.25rem; }
.preview-line.large { font-size: 1.5rem; font-weight: 600; }
.preview-line.medium { font-size: 1.1rem; font-weight: 500; }
.preview-line.small { font-size: 0.95rem; }

.preview-json {
    max-height: 120px;
    overflow: hidden;
    font-size: 0.85rem;
}

.screen-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.datasource-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.65rem;
    border-radius: 999px;
    font-size: 0.8rem;
    background: rgba(13, 202, 240, 0.12);
    color: var(--text-color);
    margin-right: 0.35rem;
}

.conditions-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    border-radius: 0.5rem;
    background: rgba(255, 193, 7, 0.18);
    color: #f0ad4e;
    font-size: 0.8rem;
}

.rotation-sequence {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    margin-top: 1rem;
}

.rotation-item {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 0.75rem 1rem;
}

.rotation-order {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.35;
}

.tab-pane {
    padding-top: 1.5rem;
}

.json-editor {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.9rem;
    min-height: 200px;
}

.priority-badge {
    padding: 0.2rem 0.55rem;
    border-radius: 0.45rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.priority-0 { background-color: rgba(220,53,69,0.18); color: #dc3545; }
.priority-1 { background-color: rgba(253,126,20,0.18); color: #fd7e14; }
.priority-2 { background-color: rgba(13,202,240,0.18); color: #0dcaf0; }
.priority-3 { background-color: rgba(108,117,125,0.18); color: #6c757d; }

.doc-card table {
    margin-top: 1rem;
}

.doc-card code {
    font-size: 0.9rem;
}

.rotation-flags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.rotation-flag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: rgba(0, 123, 255, 0.12);
    color: var(--text-color);
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
}

.screen-card-actions {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end;
    gap: 0.4rem;
}

.screen-card-actions .btn {
    margin-left: 0;
}

@media (max-width: 991.98px) {
    .page-hero {
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .hero-actions {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-start;
    }

    .hero-actions .btn {
        margin-left: 0;
        flex: 1 1 200px;
    }
}

@media (max-width: 767.98px) {
    .screen-card-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .screen-card-actions {
        width: 100%;
        justify-content: flex-start;
    }

    .screen-card-actions .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 screens-page">
    <div class="page-hero mb-4 d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between">
        <div class="hero-content">
            <h1><i class="fas fa-display"></i> Custom Display Screens</h1>
            <p>Curate playlists for every display type, monitor their health at a glance, and push updates with confidence.</p>
        </div>
        <div class="hero-actions mt-3 mt-lg-0">
            <button class="btn btn-light text-primary" onclick="showCreateRotationModal()">
                <i class="fas fa-sync"></i> New Rotation
            </button>
            <button class="btn btn-dark" onclick="showCreateScreenModal()">
                <i class="fas fa-plus"></i> Create Screen
            </button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="summary-card">
                <span class="summary-label">Total Screens</span>
                <div class="summary-value" id="stat-total-screens">0</div>
                <p class="summary-subtitle" id="stat-enabled-breakdown">0 enabled · 0 disabled</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="summary-card">
                <span class="summary-label">LED Templates</span>
                <div class="summary-value" id="stat-led-count">0</div>
                <p class="summary-subtitle">Amber / RGB marquee layouts</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="summary-card">
                <span class="summary-label">OLED Templates</span>
                <div class="summary-value" id="stat-oled-count">0</div>
                <p class="summary-subtitle">Front-panel quick looks</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="summary-card">
                <span class="summary-label">VFD Templates</span>
                <div class="summary-value" id="stat-vfd-count">0</div>
                <p class="summary-subtitle">Rack status graphics</p>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="summary-card">
                <span class="summary-label">Rotations</span>
                <div class="summary-value" id="stat-rotations">0</div>
                <p class="summary-subtitle" id="stat-rotations-subtitle">0 active</p>
            </div>
        </div>
        <div class="col-xl-9 col-12">
            <div class="filter-card">
                <div class="row g-3 align-items-end">
                    <div class="col-lg-6">
                        <label class="form-label text-muted">Search by name or description</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="screen-search" placeholder="Search screens...">
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-muted">Display Type</label>
                        <select class="form-select" id="display-type-filter">
                            <option value="">All Types</option>
                            <option value="led">LED Only</option>
                            <option value="oled">OLED Only</option>
                            <option value="vfd">VFD Only</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label text-muted">Status</label>
                        <select class="form-select" id="enabled-filter">
                            <option value="">All Screens</option>
                            <option value="true">Enabled Only</option>
                            <option value="false">Disabled Only</option>
                        </select>
                    </div>
                    <div class="col-lg-1 col-md-12">
                        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                            <i class="fas fa-rotate-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="screens-tab" data-bs-toggle="tab" data-bs-target="#screens-pane" type="button" role="tab">
                <i class="fas fa-list"></i> Screens
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rotations-tab" data-bs-toggle="tab" data-bs-target="#rotations-pane" type="button" role="tab">
                <i class="fas fa-sync"></i> Rotations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs-pane" type="button" role="tab">
                <i class="fas fa-book"></i> Documentation
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Screens Tab -->
        <div class="tab-pane fade show active" id="screens-pane" role="tabpanel">
            <div id="screens-list">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading screens...</p>
                </div>
            </div>
        </div>

        <!-- Rotations Tab -->
        <div class="tab-pane fade" id="rotations-pane" role="tabpanel">
            <div id="rotations-list">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading rotations...</p>
                </div>
            </div>
        </div>

        <!-- Documentation Tab -->
        <div class="tab-pane fade" id="docs-pane" role="tabpanel">
            <div class="doc-card">
                <div class="card-body">
                    <h3><i class="fas fa-book"></i> Custom Screens Documentation</h3>
                    <p class="lead">Create dynamic display templates with API data integration.</p>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Quick Start:</strong> Click "Create Screen" to build a custom template. Choose LED or VFD, add data sources, and define your layout.
                        For complete documentation, see <a href="/static/docs/guides/CUSTOM_DISPLAY_SCREENS.md" target="_blank">Custom Display Screens Guide</a>.
                    </div>

                    <h4><i class="fas fa-code"></i> Template Variables</h4>
                    <p>Use these variables in your screen templates:</p>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>{status.status}</code></td>
                                <td>System health status</td>
                                <td>healthy, warning, critical</td>
                            </tr>
                            <tr>
                                <td><code>{status.active_alerts_count}</code></td>
                                <td>Number of active alerts</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td><code>{status.system_resources.cpu_usage_percent}</code></td>
                                <td>CPU usage percentage</td>
                                <td>45.2</td>
                            </tr>
                            <tr>
                                <td><code>{alerts.features[0].properties.event}</code></td>
                                <td>Latest alert event type</td>
                                <td>Tornado Warning</td>
                            </tr>
                            <tr>
                                <td><code>{now.time}</code></td>
                                <td>Current time (12-hour)</td>
                                <td>03:45 PM</td>
                            </tr>
                            <tr>
                                <td><code>{now.date}</code></td>
                                <td>Current date</td>
                                <td>11/06/2025</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4><i class="fas fa-database"></i> Available Data Sources</h4>
                    <ul>
                        <li><code>/api/system_status</code> - System health and resources</li>
                        <li><code>/api/alerts</code> - Active emergency alerts</li>
                        <li><code>/api/monitoring/radio</code> - Radio receiver status</li>
                        <li><code>/health</code> - Basic health check</li>
                        <li><code>/version</code> - System version info</li>
                    </ul>

                    <h4><i class="fas fa-tv"></i> LED Screen Example</h4>
                    <pre class="bg-dark text-light p-3 rounded"><code>{
  "lines": [
    "SYSTEM STATUS",
    "Health: {status.status}",
    "CPU: {status.system_resources.cpu_usage_percent}%",
    "Alerts: {status.active_alerts_count}"
  ],
  "color": "GREEN",
  "mode": "HOLD",
  "speed": "SPEED_3"
}</code></pre>

                    <h4><i class="fas fa-desktop"></i> VFD Screen Example (VU Meters)</h4>
                    <pre class="bg-dark text-light p-3 rounded"><code>{
  "elements": [
    {
      "type": "text",
      "x": 2,
      "y": 1,
      "text": "SYSTEM RESOURCES"
    },
    {
      "type": "progress_bar",
      "x": 10,
      "y": 8,
      "width": 120,
      "height": 6,
      "value": "{status.system_resources.cpu_usage_percent}",
      "label": "CPU"
    }
  ]
}</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Screen Modal -->
<div class="modal fade" id="screenModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenModalTitle">Create Screen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="screenForm">
                    <input type="hidden" id="screen-id">

                    <div class="mb-3">
                        <label for="screen-name" class="form-label">Screen Name *</label>
                        <input type="text" class="form-control" id="screen-name" required>
                    </div>

                    <div class="mb-3">
                        <label for="screen-description" class="form-label">Description</label>
                        <textarea class="form-control" id="screen-description" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="screen-display-type" class="form-label">Display Type *</label>
                            <select class="form-select" id="screen-display-type" required>
                                <option value="led">LED Sign</option>
                                <option value="oled">OLED Module</option>
                                <option value="vfd">VFD Display</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="screen-enabled" class="form-label">Status</label>
                            <select class="form-select" id="screen-enabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="screen-priority" class="form-label">Priority</label>
                            <select class="form-select" id="screen-priority">
                                <option value="0">Emergency (0)</option>
                                <option value="1">High (1)</option>
                                <option value="2" selected>Normal (2)</option>
                                <option value="3">Low (3)</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="screen-refresh" class="form-label">Refresh (sec)</label>
                            <input type="number" class="form-control" id="screen-refresh" value="30" min="1">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="screen-duration" class="form-label">Duration (sec)</label>
                            <input type="number" class="form-control" id="screen-duration" value="10" min="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="screen-template" class="form-label">Template Data (JSON) *</label>
                        <textarea class="form-control json-editor" id="screen-template" rows="8" required></textarea>
                        <div class="help-text">
                            Enter JSON template. Example: {"lines": ["Line 1", "Line 2"], "color": "GREEN"}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="screen-sources" class="form-label">Data Sources (JSON)</label>
                        <textarea class="form-control json-editor" id="screen-sources" rows="4"></textarea>
                        <div class="help-text">
                            Example: [{"endpoint": "/api/system_status", "var_name": "status"}]
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveScreen()">Save Screen</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Rotation Modal -->
<div class="modal fade" id="rotationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rotationModalTitle">Create Rotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rotationForm">
                    <input type="hidden" id="rotation-id">

                    <div class="mb-3">
                        <label for="rotation-name" class="form-label">Rotation Name *</label>
                        <input type="text" class="form-control" id="rotation-name" required>
                    </div>

                    <div class="mb-3">
                        <label for="rotation-description" class="form-label">Description</label>
                        <textarea class="form-control" id="rotation-description" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rotation-display-type" class="form-label">Display Type *</label>
                            <select class="form-select" id="rotation-display-type" required onchange="loadScreensForRotation()">
                                <option value="led">LED Sign</option>
                                <option value="oled">OLED Module</option>
                                <option value="vfd">VFD Display</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="rotation-enabled" class="form-label">Status</label>
                            <select class="form-select" id="rotation-enabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rotation-randomize">
                        <label class="form-check-label" for="rotation-randomize">
                            Randomize screen order
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rotation-skip-alert" checked>
                        <label class="form-check-label" for="rotation-skip-alert">
                            Pause rotation when alerts are active
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screen Sequence</label>
                        <div id="rotation-screens-list" class="mb-2"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addScreenToRotation()">
                            <i class="fas fa-plus"></i> Add Screen
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRotation()">Save Rotation</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allScreens = [];
let allRotations = [];
let availableScreensForRotation = [];
const DISPLAY_ICONS = {
    led: 'fas fa-lightbulb',
    oled: 'fas fa-mobile-screen-button',
    vfd: 'fas fa-wave-square'
};
const DISPLAY_LABELS = {
    led: 'LED',
    oled: 'OLED',
    vfd: 'VFD'
};

// Load screens on page load
document.addEventListener('DOMContentLoaded', function() {
    loadScreens();
    loadRotations();

    // Add event listeners for filters
    document.getElementById('screen-search')?.addEventListener('input', renderScreens);
    document.getElementById('display-type-filter')?.addEventListener('change', renderScreens);
    document.getElementById('enabled-filter')?.addEventListener('change', renderScreens);
});

// Load all screens
async function loadScreens() {
    console.log('Loading screens...');
    try {
        const response = await fetch('/api/screens');
        console.log('Screens API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        console.log('Screens loaded:', data.screens?.length || 0);
        allScreens = data.screens || [];
        renderScreens();
        updateScreenStats();
    } catch (error) {
        console.error('Error loading screens:', error);
        document.getElementById('screens-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <p>Error loading screens: ${error.message}</p>
                <button class="btn btn-primary mt-3" onclick="loadScreens()">
                    <i class="fas fa-sync"></i> Retry
                </button>
            </div>
        `;
    }
}

// Render screens list
function renderScreens() {
    const searchTerm = document.getElementById('screen-search')?.value.toLowerCase() || '';
    const displayTypeFilter = document.getElementById('display-type-filter')?.value || '';
    const enabledFilter = document.getElementById('enabled-filter')?.value || '';

    let filtered = allScreens.filter(screen => {
        const matchesSearch = !searchTerm ||
            screen.name.toLowerCase().includes(searchTerm) ||
            (screen.description && screen.description.toLowerCase().includes(searchTerm));

        const matchesType = !displayTypeFilter || screen.display_type === displayTypeFilter;

        const matchesEnabled = !enabledFilter ||
            (enabledFilter === 'true' && screen.enabled) ||
            (enabledFilter === 'false' && !screen.enabled);

        return matchesSearch && matchesType && matchesEnabled;
    });

    const container = document.getElementById('screens-list');

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-display"></i>
                <p>No screens found</p>
                <button class="btn btn-primary mt-3" onclick="showCreateScreenModal()">
                    <i class="fas fa-plus"></i> Create Your First Screen
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = filtered.map(screen => buildScreenCard(screen)).join('');
}

// Load rotations
async function loadRotations() {
    console.log('Loading rotations...');
    try {
        const response = await fetch('/api/rotations');
        console.log('Rotations API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        console.log('Rotations loaded:', data.rotations?.length || 0);
        allRotations = data.rotations || [];
        renderRotations();
        updateScreenStats();
    } catch (error) {
        console.error('Error loading rotations:', error);
        document.getElementById('rotations-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <p>Error loading rotations: ${error.message}</p>
                <button class="btn btn-primary mt-3" onclick="loadRotations()">
                    <i class="fas fa-sync"></i> Retry
                </button>
            </div>
        `;
    }
}

// Render rotations
function renderRotations() {
    const container = document.getElementById('rotations-list');

    if (allRotations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-sync"></i>
                <p>No rotations configured</p>
                <button class="btn btn-primary mt-3" onclick="showCreateRotationModal()">
                    <i class="fas fa-plus"></i> Create First Rotation
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = allRotations.map(rotation => {
        const type = rotation.display_type || 'led';
        const iconClass = getDisplayIcon(type);
        const screenList = Array.isArray(rotation.screens) ? rotation.screens : [];
        const totalDuration = screenList.reduce((acc, item) => acc + (parseInt(item.duration, 10) || 0), 0);
        return `
            <div class="rotation-card">
                <div class="screen-card-header">
                    <div>
                        <div class="screen-title">
                            <span class="display-chip ${type}"><i class="${iconClass}"></i>${getDisplayLabel(type)}</span>
                            <h5 class="mb-0">${escapeHtml(rotation.name)}</h5>
                            <span class="status-chip ${rotation.enabled ? 'enabled' : 'disabled'}">${rotation.enabled ? 'Active' : 'Paused'}</span>
                        </div>
                        ${rotation.description ? `<p class="text-muted mt-1 mb-0">${escapeHtml(rotation.description)}</p>` : ''}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="editRotation(${rotation.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick='deleteRotation(${rotation.id}, ${JSON.stringify(rotation.name)})'>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="screen-meta">
                    <div class="meta-item"><i class="fas fa-list-ol"></i>${screenList.length} screens</div>
                    <div class="meta-item"><i class="fas fa-stopwatch"></i>${totalDuration}s total cycle</div>
                    <div class="meta-item"><i class="fas fa-shuffle"></i>${rotation.randomize ? 'Random order' : 'Fixed order'}</div>
                </div>
                <div class="rotation-flags">
                    ${rotation.skip_on_alert ? '<span class="rotation-flag"><i class="fas fa-bell-slash"></i>Pauses during alerts</span>' : ''}
                </div>
                <div class="rotation-sequence">
                    ${screenList.map((item, idx) => `
                        <div class="rotation-item">
                            <span class="rotation-order">${idx + 1}</span>
                            <div>
                                <div>Screen ID: ${item.screen_id}</div>
                                <small class="text-muted">Duration ${item.duration || 0}s</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function buildScreenCard(screen) {
    const type = screen.display_type || 'led';
    const iconClass = getDisplayIcon(type);
    const statusClass = screen.enabled ? 'enabled' : 'disabled';
    const statusLabel = screen.enabled ? 'Enabled' : 'Disabled';
    const description = screen.description ? `<p class="text-muted mt-1 mb-0">${escapeHtml(screen.description)}</p>` : '';
    const previewMarkup = buildScreenPreview(screen);
    const conditions = screen.conditions ? '<span class="conditions-pill"><i class="fas fa-code-branch"></i> Conditional</span>' : '';
    const lastSeen = screen.last_displayed_at ? `<div class="meta-item"><i class="fas fa-calendar-alt"></i>${formatDate(screen.last_displayed_at)}</div>` : '';
    const dataSources = buildDataSourceChips(screen);

    return `
        <div class="screen-card">
            <div class="screen-card-header">
                <div>
                    <div class="screen-title">
                        <span class="display-chip ${type}"><i class="${iconClass}"></i>${getDisplayLabel(type)}</span>
                        <h5 class="mb-0">${escapeHtml(screen.name)}</h5>
                        <span class="status-chip ${statusClass}">${statusLabel}</span>
                        <span class="priority-badge priority-${screen.priority}">P${screen.priority}</span>
                        ${conditions}
                    </div>
                    ${description}
                </div>
                <div class="screen-card-actions btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="displayScreen(${screen.id})">
                        <i class="fas fa-play"></i> Display
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editScreen(${screen.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick='deleteScreen(${screen.id}, ${JSON.stringify(screen.name)})'>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="screen-preview" data-display="${type}">
                ${previewMarkup}
            </div>
            <div class="screen-meta">
                <div class="meta-item"><i class="fas fa-bolt"></i>${priorityLabel(screen.priority)}</div>
                <div class="meta-item"><i class="fas fa-clock"></i>${screen.refresh_interval}s refresh</div>
                <div class="meta-item"><i class="fas fa-hourglass-half"></i>${screen.duration}s duration</div>
                <div class="meta-item"><i class="fas fa-chart-line"></i>${screen.display_count || 0} plays</div>
                ${lastSeen}
            </div>
            <div class="mt-3">
                ${dataSources}
            </div>
        </div>
    `;
}

function buildDataSourceChips(screen) {
    const sources = Array.isArray(screen.data_sources) ? screen.data_sources : [];
    if (!sources.length) {
        return '<span class="datasource-pill text-muted"><i class="fas fa-plug-circle-xmark"></i> No data sources</span>';
    }

    const chips = sources.slice(0, 3).map(source => {
        const label = source.var_name || source.endpoint || 'Source';
        return `<span class="datasource-pill"><i class="fas fa-plug"></i>${escapeHtml(label)}</span>`;
    }).join('');

    const remaining = sources.length - 3;
    return remaining > 0
        ? chips + `<span class="datasource-pill"><i class="fas fa-ellipsis-h"></i>+${remaining}</span>`
        : chips;
}

function buildScreenPreview(screen) {
    const template = screen.template_data || {};

    if (screen.display_type === 'led') {
        const lines = Array.isArray(template.lines) ? template.lines.map(extractLineText).filter(Boolean) : [];
        if (!lines.length) {
            return '<span class="text-muted">Add LED lines to preview</span>';
        }
        return lines.slice(0, 4).map((line, idx) => {
            const sizeClass = idx === 0 ? 'large' : idx === 1 ? 'medium' : 'small';
            return `<span class="preview-line ${sizeClass}">${escapeHtml(line)}</span>`;
        }).join('');
    }

    if (screen.display_type === 'oled') {
        const lines = Array.isArray(template.lines) ? template.lines : [];
        if (!lines.length) {
            return '<span class="text-muted">OLED layout will appear here</span>';
        }
        return lines.slice(0, 4).map(entry => {
            const text = extractLineText(entry);
            const font = (entry && entry.font ? entry.font.toLowerCase() : 'small');
            const sizeClass = font === 'large' || font === 'xlarge' || font === 'huge' ? 'large' : font === 'medium' ? 'medium' : 'small';
            return `<span class="preview-line ${sizeClass}">${escapeHtml(text)}</span>`;
        }).join('');
    }

    if (screen.display_type === 'vfd') {
        const elements = Array.isArray(template.elements) ? template.elements : [];
        if (!elements.length) {
            return '<span class="text-muted">Define VFD elements to preview</span>';
        }
        return elements.slice(0, 3).map(element => {
            const type = element.type || 'element';
            const coords = `(${element.x ?? 0},${element.y ?? 0})`;
            return `<span class="preview-line">${escapeHtml(type)} ${coords}</span>`;
        }).join('');
    }

    const jsonSnippet = JSON.stringify(template, null, 2) || '{}';
    return `<pre class="preview-json">${escapeHtml(jsonSnippet)}</pre>`;
}

function extractLineText(entry) {
    if (typeof entry === 'string') {
        return entry;
    }
    if (entry && typeof entry === 'object') {
        return entry.text || '';
    }
    return '';
}

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatDate(value) {
    try {
        return new Date(value).toLocaleString();
    } catch (error) {
        return value;
    }
}

function priorityLabel(priority) {
    switch (priority) {
        case 0:
            return 'Priority 0 · Emergency';
        case 1:
            return 'Priority 1 · High';
        case 3:
            return 'Priority 3 · Low';
        default:
            return 'Priority 2 · Normal';
    }
}

function getDisplayIcon(type) {
    return DISPLAY_ICONS[type] || 'fas fa-display';
}

function getDisplayLabel(type) {
    return DISPLAY_LABELS[type] || (type ? type.toUpperCase() : 'DISPLAY');
}

function resetFilters() {
    const searchInput = document.getElementById('screen-search');
    const typeFilter = document.getElementById('display-type-filter');
    const enabledFilter = document.getElementById('enabled-filter');
    if (searchInput) searchInput.value = '';
    if (typeFilter) typeFilter.value = '';
    if (enabledFilter) enabledFilter.value = '';
    renderScreens();
}

function updateScreenStats() {
    const total = allScreens.length;
    const enabled = allScreens.filter(screen => screen.enabled).length;
    const disabled = total - enabled;
    const totalEl = document.getElementById('stat-total-screens');
    const breakdownEl = document.getElementById('stat-enabled-breakdown');
    if (totalEl) totalEl.textContent = total;
    if (breakdownEl) breakdownEl.textContent = `${enabled} enabled · ${disabled} disabled`;

    const ledEl = document.getElementById('stat-led-count');
    const oledEl = document.getElementById('stat-oled-count');
    const vfdEl = document.getElementById('stat-vfd-count');
    const ledCount = allScreens.filter(screen => screen.display_type === 'led').length;
    const oledCount = allScreens.filter(screen => screen.display_type === 'oled').length;
    const vfdCount = allScreens.filter(screen => screen.display_type === 'vfd').length;
    if (ledEl) ledEl.textContent = ledCount;
    if (oledEl) oledEl.textContent = oledCount;
    if (vfdEl) vfdEl.textContent = vfdCount;

    const rotationsEl = document.getElementById('stat-rotations');
    const rotationsSubtitleEl = document.getElementById('stat-rotations-subtitle');
    if (rotationsEl) rotationsEl.textContent = allRotations.length;
    if (rotationsSubtitleEl) {
        const activeRotations = allRotations.filter(rotation => rotation.enabled).length;
        rotationsSubtitleEl.textContent = `${activeRotations} active`;
    }
}

// Show create screen modal
function showCreateScreenModal() {
    document.getElementById('screenModalTitle').textContent = 'Create Screen';
    document.getElementById('screenForm').reset();
    document.getElementById('screen-id').value = '';
    document.getElementById('screen-template').value = '{\n  "lines": ["Line 1", "Line 2"],\n  "color": "GREEN",\n  "mode": "HOLD"\n}';
    document.getElementById('screen-sources').value = '[{"endpoint": "/api/system_status", "var_name": "status"}]';
    new bootstrap.Modal(document.getElementById('screenModal')).show();
}

// Edit screen
async function editScreen(id) {
    try {
        const response = await fetch(`/api/screens/${id}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const screen = await response.json();

        // Populate form
        document.getElementById('screenModalTitle').textContent = 'Edit Screen';
        document.getElementById('screen-id').value = screen.id;
        document.getElementById('screen-name').value = screen.name || '';
        document.getElementById('screen-description').value = screen.description || '';
        document.getElementById('screen-display-type').value = screen.display_type || '';
        document.getElementById('screen-enabled').value = screen.enabled ? 'true' : 'false';
        document.getElementById('screen-priority').value = screen.priority || 1;
        document.getElementById('screen-refresh').value = screen.refresh_interval || 60;
        document.getElementById('screen-duration').value = screen.duration || 10;
        document.getElementById('screen-template').value = JSON.stringify(screen.template_data || {}, null, 2);
        document.getElementById('screen-sources').value = JSON.stringify(screen.data_sources || [], null, 2);

        // Show modal
        new bootstrap.Modal(document.getElementById('screenModal')).show();
    } catch (error) {
        console.error('Error loading screen:', error);
        showToast(`Error loading screen: ${error.message}`, 'danger');
    }
}

// Save screen
function saveScreen() {
    const id = document.getElementById('screen-id').value;
    const isEdit = !!id;

    try {
        const data = {
            name: document.getElementById('screen-name').value,
            description: document.getElementById('screen-description').value,
            display_type: document.getElementById('screen-display-type').value,
            enabled: document.getElementById('screen-enabled').value === 'true',
            priority: parseInt(document.getElementById('screen-priority').value),
            refresh_interval: parseInt(document.getElementById('screen-refresh').value),
            duration: parseInt(document.getElementById('screen-duration').value),
            template_data: JSON.parse(document.getElementById('screen-template').value),
            data_sources: JSON.parse(document.getElementById('screen-sources').value || '[]')
        };

        const url = isEdit ? `/api/screens/${id}` : '/api/screens';
        const method = isEdit ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                showToast(result.error, 'danger');
            } else {
                showToast(`Screen ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('screenModal')).hide();
                loadScreens();
            }
        })
        .catch(error => {
            showToast('Error saving screen: ' + error, 'danger');
        });

    } catch (error) {
        showToast('Invalid JSON: ' + error.message, 'danger');
    }
}

// Display screen immediately
function displayScreen(id) {
    if (!confirm('Display this screen now?')) return;

    fetch(`/api/screens/${id}/display`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, 'danger');
        } else {
            showToast('Screen displayed successfully', 'success');
            loadScreens();
        }
    })
    .catch(error => {
        showToast('Error displaying screen: ' + error, 'danger');
    });
}

// Delete screen
function deleteScreen(id, name) {
    if (!confirm(`Delete screen "${name}"?`)) return;

    fetch(`/api/screens/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        showToast('Screen deleted successfully', 'success');
        loadScreens();
    })
    .catch(error => {
        showToast('Error deleting screen: ' + error, 'danger');
    });
}

// Show create rotation modal
function showCreateRotationModal() {
    document.getElementById('rotationModalTitle').textContent = 'Create Rotation';
    document.getElementById('rotationForm').reset();
    document.getElementById('rotation-id').value = '';
    document.getElementById('rotation-screens-list').innerHTML = '';
    loadScreensForRotation();
    new bootstrap.Modal(document.getElementById('rotationModal')).show();
}

// Edit rotation
async function editRotation(id) {
    try {
        const response = await fetch(`/api/rotations/${id}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const rotation = await response.json();

        // Populate form
        document.getElementById('rotationModalTitle').textContent = 'Edit Rotation';
        document.getElementById('rotation-id').value = rotation.id;
        document.getElementById('rotation-name').value = rotation.name || '';
        document.getElementById('rotation-description').value = rotation.description || '';
        document.getElementById('rotation-display-type').value = rotation.display_type || '';
        document.getElementById('rotation-enabled').value = rotation.enabled ? 'true' : 'false';
        document.getElementById('rotation-randomize').checked = rotation.randomize || false;
        document.getElementById('rotation-skip-alert').checked = rotation.skip_on_alert || false;

        // Load available screens
        await loadScreensForRotation();

        // Clear and repopulate screens list
        const screensList = document.getElementById('rotation-screens-list');
        screensList.innerHTML = '';
        if (rotation.screens && rotation.screens.length > 0) {
            rotation.screens.forEach(item => {
                addScreenToRotation(item.screen_id, item.duration);
            });
        }

        // Show modal
        new bootstrap.Modal(document.getElementById('rotationModal')).show();
    } catch (error) {
        console.error('Error loading rotation:', error);
        showToast(`Error loading rotation: ${error.message}`, 'danger');
    }
}

// Load screens for rotation picker
async function loadScreensForRotation() {
    const displayType = document.getElementById('rotation-display-type').value;
    try {
        const response = await fetch(`/api/screens?display_type=${displayType}&enabled=true`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        availableScreensForRotation = data.screens || [];
    } catch (error) {
        console.error('Error loading screens for rotation:', error);
        showToast(`Error loading screens: ${error.message}`, 'danger');
        availableScreensForRotation = [];
    }
}

// Add screen to rotation
function addScreenToRotation(screenId = null, duration = 10) {
    const container = document.getElementById('rotation-screens-list');
    const index = container.children.length;

    const item = document.createElement('div');
    item.className = 'rotation-item mb-2';
    item.innerHTML = `
        <span class="rotation-order">${index + 1}.</span>
        <select class="form-select form-select-sm" style="flex: 1;" required>
            <option value="">Select screen...</option>
            ${availableScreensForRotation.map(s => `<option value="${s.id}" ${s.id === screenId ? 'selected' : ''}>${s.name}</option>`).join('')}
        </select>
        <input type="number" class="form-control form-control-sm" placeholder="Duration (sec)" value="${duration}" min="1" style="width: 120px;">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(item);
}

// Save rotation
function saveRotation() {
    const id = document.getElementById('rotation-id').value;
    const isEdit = !!id;

    const screensItems = document.querySelectorAll('#rotation-screens-list .rotation-item');
    const screens = Array.from(screensItems).map(item => ({
        screen_id: parseInt(item.querySelector('select').value),
        duration: parseInt(item.querySelector('input').value)
    }));

    if (screens.length === 0) {
        showToast('Add at least one screen to the rotation', 'danger');
        return;
    }

    const data = {
        name: document.getElementById('rotation-name').value,
        description: document.getElementById('rotation-description').value,
        display_type: document.getElementById('rotation-display-type').value,
        enabled: document.getElementById('rotation-enabled').value === 'true',
        screens: screens,
        randomize: document.getElementById('rotation-randomize').checked,
        skip_on_alert: document.getElementById('rotation-skip-alert').checked
    };

    const url = isEdit ? `/api/rotations/${id}` : '/api/rotations';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showToast(result.error, 'danger');
        } else {
            showToast(`Rotation ${isEdit ? 'updated' : 'created'} successfully`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('rotationModal')).hide();
            loadRotations();
        }
    })
    .catch(error => {
        showToast('Error saving rotation: ' + error, 'danger');
    });
}

// Delete rotation
function deleteRotation(id, name) {
    if (!confirm(`Delete rotation "${name}"?`)) return;

    fetch(`/api/rotations/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        showToast('Rotation deleted successfully', 'success');
        loadRotations();
    })
    .catch(error => {
        showToast('Error deleting rotation: ' + error, 'danger');
    });
}
</script>
{% endblock %}
