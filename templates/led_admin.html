<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Sign Administration - KR8MER CAP Alerts</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .led-status-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .led-status-card.connected {
            border-left-color: #28a745;
        }
        .led-status-card.disconnected {
            border-left-color: #dc3545;
        }
        .led-status-card.alerting {
            border-left-color: #ffc107;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { border-left-color: #ffc107; }
            50% { border-left-color: #fd7e14; }
            100% { border-left-color: #ffc107; }
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-alerting { background-color: #ffc107; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .control-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            margin: 5px;
            min-width: 120px;
        }

        .led-preview {
            background: #000;
            color: #ffff00;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #333;
        }

        .severity-extreme { background: #8B0000; color: #FF0000; }
        .severity-severe { background: #B22222; color: #FF4500; }
        .severity-moderate { background: #FF8C00; color: #000; }
        .severity-minor { background: #FFD700; color: #000; }

        .alert-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .log-container {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-broadcast-tower"></i> KR8MER CAP - LED Sign Administration
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-arrow-left"></i> Back to Admin
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Control Panel -->
        <div class="control-panel">
            <h4><i class="fas fa-tv"></i> LED Sign Control Panel</h4>
            <p class="mb-3">Manage emergency alert LED signs for the KR8MER CAP system</p>
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex flex-wrap">
                        <button class="btn btn-light quick-action-btn" onclick="refreshStatus()">
                            <i class="fas fa-sync-alt"></i> Refresh Status
                        </button>
                        <button class="btn btn-warning quick-action-btn" onclick="sendTestMessage()">
                            <i class="fas fa-vial"></i> Send Test
                        </button>
                        <button class="btn btn-danger quick-action-btn" onclick="clearAllAlerts()">
                            <i class="fas fa-times-circle"></i> Clear Alerts
                        </button>
                        <button class="btn btn-info quick-action-btn" onclick="showAlertForm()">
                            <i class="fas fa-plus"></i> Manual Alert
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-light">
                        <small>Service Status:
                            <span id="service-status" class="fw-bold">
                                {% if service_running %}
                                    <span class="status-indicator status-online"></span>Running
                                {% else %}
                                    <span class="status-indicator status-offline"></span>Stopped
                                {% endif %}
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- LED Signs Status -->
        <div class="row">
            <div class="col-12">
                <h5><i class="fas fa-tv"></i> LED Sign Status</h5>
            </div>
        </div>

        <div class="row" id="led-signs-container">
            {% if signs_status %}
                {% for sign_name, status in signs_status.items() %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card led-status-card {% if status.connected %}connected{% else %}disconnected{% endif %} {% if status.current_alert %}alerting{% endif %}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-tv"></i> {{ sign_name.title().replace('_', ' ') }}
                            </h6>
                            <span class="badge {% if status.connected %}bg-success{% else %}bg-danger{% endif %}">
                                {% if status.connected %}Online{% else %}Offline{% endif %}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">IP Address:</small><br>
                                    <code>{{ status.ip_address }}:{{ status.port }}</code>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Current Status:</small><br>
                                    {% if status.current_alert %}
                                        <span class="badge bg-warning">Displaying Alert</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Default Message</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if status.current_alert %}
                            <div class="mt-3">
                                <small class="text-muted">Alert Since:</small><br>
                                <small>{{ status.alert_start_time or 'Unknown' }}</small>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="testSign('{{ sign_name }}')">
                                        <i class="fas fa-vial"></i> Test
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="clearSign('{{ sign_name }}')">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="connectSign('{{ sign_name }}')">
                                        <i class="fas fa-plug"></i> Connect
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        No LED signs configured. Please check your LED configuration file.
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Custom Messages Management -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-comment-dots"></i> Custom Messages</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="showAddMessageForm()">
                                <i class="fas fa-plus"></i> Add Message
                            </button>
                            <button class="btn btn-sm btn-info" onclick="toggleRotation()">
                                <i class="fas fa-sync-alt"></i> <span id="rotation-btn-text">Enable Rotation</span>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="refreshMessages()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Rotation Settings -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="rotationEnabled" onchange="updateRotationSettings()">
                                    <label class="form-check-label" for="rotationEnabled">
                                        Enable Message Rotation
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Interval:</span>
                                    <input type="number" class="form-control" id="rotationInterval" value="30" min="10" max="300" onchange="updateRotationSettings()">
                                    <span class="input-group-text">seconds</span>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Table -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="messagesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Status</th>
                                        <th>Message</th>
                                        <th>Color</th>
                                        <th>Effect</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="messagesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            Loading messages...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Message Form (Hidden by default) -->
        <div id="message-form-container" class="row mt-4" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-edit"></i> <span id="message-form-title">Add Custom Message</span></h5>
                    </div>
                    <div class="card-body">
                        <form id="messageForm">
                            <input type="hidden" id="messageId" value="">

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="messageText" class="form-label">Message Text</label>
                                        <textarea class="form-control" id="messageText" rows="3"
                                                maxlength="250" placeholder="Enter your custom message..."
                                                onkeyup="updateMessagePreview()"></textarea>
                                        <div class="form-text">
                                            <span id="charCount">0</span>/250 characters
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Live Preview</label>
                                        <div id="messagePreview" class="led-preview">
                                            Your message will appear here...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="messageColor" class="form-label">Color</label>
                                        <select class="form-select" id="messageColor" onchange="updateMessagePreview()">
                                            <option value="amber">Amber (Default)</option>
                                            <option value="red">Red</option>
                                            <option value="green">Green</option>
                                            <option value="yellow">Yellow</option>
                                            <option value="orange">Orange</option>
                                            <option value="blue">Blue</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="messageEffect" class="form-label">Effect</label>
                                        <select class="form-select" id="messageEffect" onchange="updateMessagePreview()">
                                            <option value="scroll">Scroll (Default)</option>
                                            <option value="hold">Hold</option>
                                            <option value="flash">Flash</option>
                                            <option value="roll_left">Roll Left</option>
                                            <option value="roll_right">Roll Right</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="messagePriority" class="form-label">Priority</label>
                                        <input type="number" class="form-control" id="messagePriority"
                                               value="10" min="1" max="99">
                                        <div class="form-text">Lower = Higher Priority</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="messageDescription" class="form-label">Description</label>
                                        <input type="text" class="form-control" id="messageDescription"
                                               placeholder="Brief description">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="messageEnabled" checked>
                                        <label class="form-check-label" for="messageEnabled">
                                            Enable this message
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="messageDynamic">
                                        <label class="form-check-label" for="messageDynamic">
                                            Dynamic message (updates automatically)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Message
                                </button>
                                <button type="button" class="btn btn-info" onclick="testMessage()">
                                    <i class="fas fa-play"></i> Test Display
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideMessageForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Alert Form (Hidden by default) -->
        <div id="manual-alert-form" class="row mt-4" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Send Manual Alert</h5>
                    </div>
                    <div class="card-body">
                        <form id="alertForm" class="alert-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="alertEvent" class="form-label">Event Type</label>
                                        <select class="form-select" id="alertEvent" required>
                                            <option value="">Select event type...</option>
                                            <option value="Tornado Warning">Tornado Warning</option>
                                            <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                                            <option value="Flash Flood Warning">Flash Flood Warning</option>
                                            <option value="Winter Storm Warning">Winter Storm Warning</option>
                                            <option value="Special Weather Statement">Special Weather Statement</option>
                                            <option value="Emergency Alert">Emergency Alert</option>
                                            <option value="Test Alert">Test Alert</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="alertSeverity" class="form-label">Severity</label>
                                        <select class="form-select" id="alertSeverity" required>
                                            <option value="Minor">Minor</option>
                                            <option value="Moderate" selected>Moderate</option>
                                            <option value="Severe">Severe</option>
                                            <option value="Extreme">Extreme</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="alertHeadline" class="form-label">Headline</label>
                                <input type="text" class="form-control" id="alertHeadline"
                                       placeholder="Brief description of the alert" maxlength="80">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="alertArea" class="form-label">Area</label>
                                        <input type="text" class="form-control" id="alertArea"
                                               value="Putnam County, OH" maxlength="50">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="alertUrgency" class="form-label">Urgency</label>
                                        <select class="form-select" id="alertUrgency">
                                            <option value="Immediate" selected>Immediate</option>
                                            <option value="Expected">Expected</option>
                                            <option value="Future">Future</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- LED Preview -->
                            <div class="mb-3">
                                <label class="form-label">LED Display Preview</label>
                                <div id="ledPreview" class="led-preview">
                                    KR8MER CAP ALERT SYSTEM - NO ACTIVE ALERTS
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-broadcast-tower"></i> Send Alert to LED Signs
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideAlertForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-info" onclick="previewAlert()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Activity Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="activity-log" class="log-container">
                            [{{ "now"|date:"Y-m-d H:i:s" }}] LED Sign administration panel loaded<br>
                            [{{ "now"|date:"Y-m-d H:i:s" }}] Monitoring {{ signs_status|length if signs_status else 0 }} LED sign(s)<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Activity logging
        function logActivity(message) {
            const log = document.getElementById('activity-log');
            const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        // Refresh LED sign status
        async function refreshStatus() {
            try {
                logActivity('Refreshing LED sign status...');
                const response = await fetch('/api/led_signs/status');
                const data = await response.json();

                if (data.status === 'success') {
                    logActivity(`Status updated: ${Object.keys(data.signs).length} signs monitored`);
                    // You could update the UI here with new status
                    setTimeout(() => location.reload(), 1000);
                } else {
                    logActivity(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                logActivity(`Error refreshing status: ${error.message}`);
            }
        }

        // Send test message to all signs
        async function sendTestMessage() {
            try {
                logActivity('Sending test message to all LED signs...');
                const response = await fetch('/api/led_signs/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'KR8MER CAP ALERT SYSTEM TEST - THIS IS ONLY A TEST'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    logActivity('Test message sent successfully');
                } else {
                    logActivity(`Failed to send test message: ${data.message}`);
                }
            } catch (error) {
                logActivity(`Error sending test: ${error.message}`);
            }
        }

        // Clear all alerts
        async function clearAllAlerts() {
            if (!confirm('Clear all alerts on LED signs?')) return;

            try {
                logActivity('Clearing all alerts...');
                const response = await fetch('/api/led_signs/clear', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    logActivity('All alerts cleared successfully');
                } else {
                    logActivity(`Failed to clear alerts: ${data.message}`);
                }
            } catch (error) {
                logActivity(`Error clearing alerts: ${error.message}`);
            }
        }

        // Test individual sign
        async function testSign(signName) {
            try {
                logActivity(`Testing sign: ${signName}...`);
                const response = await fetch('/api/led_signs/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `TEST MESSAGE FOR ${signName.toUpperCase()}`
                    })
                });

                const data = await response.json();
                logActivity(data.success ? `Test sent to ${signName}` : `Test failed for ${signName}`);
            } catch (error) {
                logActivity(`Error testing ${signName}: ${error.message}`);
            }
        }

        // Clear individual sign
        async function clearSign(signName) {
            try {
                logActivity(`Clearing alerts on sign: ${signName}...`);
                const response = await fetch('/api/led_signs/clear', {
                    method: 'POST'
                });

                const data = await response.json();
                logActivity(data.success ? `Cleared ${signName}` : `Failed to clear ${signName}`);
            } catch (error) {
                logActivity(`Error clearing ${signName}: ${error.message}`);
            }
        }

        // Connect to sign (placeholder)
        function connectSign(signName) {
            logActivity(`Attempting to connect to ${signName}...`);
            // This would trigger a reconnection attempt
            setTimeout(() => logActivity(`Connection attempt completed for ${signName}`), 2000);
        }

        // Show manual alert form
        function showAlertForm() {
            document.getElementById('manual-alert-form').style.display = 'block';
            document.getElementById('alertEvent').focus();
        }

        // Hide manual alert form
        function hideAlertForm() {
            document.getElementById('manual-alert-form').style.display = 'none';
        }

        // Preview alert on LED display
        function previewAlert() {
            const event = document.getElementById('alertEvent').value;
            const severity = document.getElementById('alertSeverity').value;
            const headline = document.getElementById('alertHeadline').value;
            const area = document.getElementById('alertArea').value;

            if (!event) {
                alert('Please select an event type');
                return;
            }

            const preview = document.getElementById('ledPreview');
            const previewText = `*** ${event.toUpperCase()} - ${severity.toUpperCase()} *** ${headline} AREA: ${area}`;

            preview.textContent = previewText;
            preview.className = `led-preview severity-${severity.toLowerCase()}`;

            logActivity(`Previewing alert: ${event} - ${severity}`);
        }

        // Handle alert form submission
        document.getElementById('alertForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const alertData = {
                event: document.getElementById('alertEvent').value,
                severity: document.getElementById('alertSeverity').value,
                headline: document.getElementById('alertHeadline').value,
                area_desc: document.getElementById('alertArea').value,
                urgency: document.getElementById('alertUrgency').value
            };

            if (!alertData.event) {
                alert('Please select an event type');
                return;
            }

            try {