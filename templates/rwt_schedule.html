{% extends "base.html" %}

{% block title %}Weekly Test Automation - EAS Station{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12 col-xl-10 col-xxl-9">
            <h1 class="mb-3">
                <i class="fas fa-calendar-alt me-2"></i>
                Weekly Test Automation
            </h1>

            <div class="alert alert-info border-0 shadow-sm">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                    <div>
                        <strong>Required Weekly Test (RWT) automation.</strong>
                        Configure the schedule, then manage the shared county list used by Quick RWT and manual broadcasts.
                    </div>
                    <div class="text-muted small">
                        RWTs automatically mute narration and attention tones—only SAME headers and EOM are generated.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 align-items-start">
        <div class="col-xl-7">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Schedule Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="rwtConfigForm">
                        <!-- Enable/Disable -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enabledCheckbox">
                                <label class="form-check-label" for="enabledCheckbox">
                                    <strong>Enable Automatic RWT Broadcasts</strong>
                                </label>
                            </div>
                        </div>

                        <!-- Days of Week -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Days of Week</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="0" id="day-monday">
                                        <label class="form-check-label" for="day-monday">Monday</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="1" id="day-tuesday">
                                        <label class="form-check-label" for="day-tuesday">Tuesday</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="2" id="day-wednesday">
                                        <label class="form-check-label" for="day-wednesday">Wednesday</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="3" id="day-thursday">
                                        <label class="form-check-label" for="day-thursday">Thursday</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="4" id="day-friday">
                                        <label class="form-check-label" for="day-friday">Friday</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="5" id="day-saturday">
                                        <label class="form-check-label" for="day-saturday">Saturday</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" value="6" id="day-sunday">
                                        <label class="form-check-label" for="day-sunday">Sunday</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Time Window -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Time Window</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Start Time</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="startHour" min="0" max="23" value="8" required>
                                            <small class="text-muted">Hour (0-23)</small>
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="startMinute" min="0" max="59" value="0" required>
                                            <small class="text-muted">Minute (0-59)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Time</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="endHour" min="0" max="23" value="16" required>
                                            <small class="text-muted">Hour (0-23)</small>
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="endMinute" min="0" max="59" value="0" required>
                                            <small class="text-muted">Minute (0-59)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SAME Codes Preview -->
                        <div class="mb-4">
                            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                                <div>
                                    <label class="form-label fw-bold mb-0">Active SAME/FIPS Coverage</label>
                                    <div class="text-muted small">The scheduler reuses the shared default county list. Update it using the manager on the right.</div>
                                </div>
                                <span class="badge bg-light text-dark border" id="scheduleCountySourceBadge">Loading counties…</span>
                            </div>
                            <div class="same-chip-cloud mt-3" id="scheduleCountyList"></div>
                            <div id="scheduleCountyEmpty" class="text-muted small">No default counties configured yet.</div>
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Originator and station identifiers come from <code>EAS_ORIGINATOR</code> and <code>EAS_STATION_ID</code>.
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Configuration
                            </button>
                            <button type="button" class="btn btn-secondary" id="testRWTBtn">
                                <i class="fas fa-broadcast-tower me-2"></i>Send Test RWT Now
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Last Run Info -->
            <div class="card mt-4" id="lastRunCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Last Automatic Run</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Time:</strong> <span id="lastRunTime">-</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong> <span id="lastRunStatus">-</span>
                        </div>
                    </div>
                    <div class="mt-2" id="lastRunDetails"></div>
                </div>
            </div>
        </div>

        <div class="col-xl-5">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Default RWT Counties</h5>
                    <small class="text-muted">This shared list powers Quick RWT, manual defaults, and the scheduler.</small>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="countyCodeInput" class="form-label">Add County by SAME/FIPS Code</label>
                        <div class="input-group">
                            <input type="text" id="countyCodeInput" class="form-control" placeholder="039003" maxlength="6">
                            <button class="btn btn-primary" type="button" id="addCountyCodeBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">Enter six digits. Non-numeric characters are ignored automatically.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Add Using Picker</label>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <select id="stateSelect" class="form-select">
                                    <option value="">Select State</option>
                                    {% for state in state_tree %}
                                    <option value="{{ state.state_fips }}">{{ state.name }} ({{ state.abbr }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6">
                                <select id="countySelect" class="form-select" disabled>
                                    <option value="">Select County</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addCountyFromPickerBtn" disabled>
                            <i class="fas fa-location-crosshairs me-1"></i>Add Selected County
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Selected Counties</label>
                        <div id="countyList" class="d-flex flex-wrap gap-2"></div>
                        <div id="countyListEmpty" class="text-muted small">No counties configured yet.</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="saveCountiesBtn">
                            <i class="fas fa-save me-1"></i>Save Default Counties
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="reloadCountiesBtn">
                            <i class="fas fa-undo me-1"></i>Reload from Database
                        </button>
                    </div>

                    <div class="alert alert-light mt-3 mb-0">
                        <i class="fas fa-circle-info me-2"></i>
                        These counties populate the Broadcast Builder's "Load Default Codes" button and serve as the fallback for automatic RWT runs.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const sameLookup = {{ same_lookup|tojson }};
    const stateTree = {{ state_tree|tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('rwtConfigForm');
        const testBtn = document.getElementById('testRWTBtn');

        const countyListEl = document.getElementById('countyList');
        const countyEmptyState = document.getElementById('countyListEmpty');
        const countyCodeInput = document.getElementById('countyCodeInput');
        const addCountyCodeBtn = document.getElementById('addCountyCodeBtn');
        const stateSelect = document.getElementById('stateSelect');
        const countySelect = document.getElementById('countySelect');
        const addCountyFromPickerBtn = document.getElementById('addCountyFromPickerBtn');
        const saveCountiesBtn = document.getElementById('saveCountiesBtn');
        const reloadCountiesBtn = document.getElementById('reloadCountiesBtn');
        const scheduleCountyListEl = document.getElementById('scheduleCountyList');
        const scheduleCountyEmptyState = document.getElementById('scheduleCountyEmpty');
        const scheduleCountySourceBadge = document.getElementById('scheduleCountySourceBadge');

        let defaultCountyCodes = [];
        let countySourceLabel = 'location_defaults';

        // Load configuration
        loadConfiguration();
        loadLocationSettings();

        // Save configuration
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            saveConfiguration();
        });

        // Test RWT
        testBtn.addEventListener('click', function() {
            sendTestRWT();
        });

        addCountyCodeBtn.addEventListener('click', function() {
            addCountyCode(countyCodeInput.value);
        });

        countyCodeInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCountyCode(countyCodeInput.value);
            }
        });

        stateSelect.addEventListener('change', function() {
            populateCountySelect(this.value);
        });

        addCountyFromPickerBtn.addEventListener('click', function() {
            const code = countySelect.value;
            if (code) {
                addCountyCode(code);
            }
        });

        saveCountiesBtn.addEventListener('click', function() {
            saveDefaultCounties();
        });

        reloadCountiesBtn.addEventListener('click', function() {
            loadLocationSettings(true);
        });

        function updateCountySourceBadge(source) {
            countySourceLabel = source || 'location_defaults';
            if (!scheduleCountySourceBadge) {
                return;
            }
            if (countySourceLabel === 'schedule') {
                scheduleCountySourceBadge.textContent = 'Using saved schedule copy';
                scheduleCountySourceBadge.className = 'badge bg-primary text-white';
            } else {
                scheduleCountySourceBadge.textContent = 'Following shared default list';
                scheduleCountySourceBadge.className = 'badge bg-success text-white';
            }
        }

        function loadConfiguration() {
            fetch('/api/rwt-schedule/config', {
                headers: {
                    'X-CSRF-Token': window.CSRF_TOKEN
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.config) {
                    const config = data.config;
                    updateCountySourceBadge(config.same_codes_source);

                    // Enable/disable
                    document.getElementById('enabledCheckbox').checked = config.enabled || false;

                    // Days of week
                    document.querySelectorAll('.day-checkbox').forEach(cb => {
                        cb.checked = (config.days_of_week || []).includes(parseInt(cb.value));
                    });

                    // Time window
                    document.getElementById('startHour').value = config.start_hour || 8;
                    document.getElementById('startMinute').value = config.start_minute || 0;
                    document.getElementById('endHour').value = config.end_hour || 16;
                    document.getElementById('endMinute').value = config.end_minute || 0;

                    // Last run info
                    if (config.last_run_at) {
                        document.getElementById('lastRunCard').style.display = 'block';
                        document.getElementById('lastRunTime').textContent = new Date(config.last_run_at).toLocaleString();
                        document.getElementById('lastRunStatus').textContent = config.last_run_status || '-';

                        const statusSpan = document.getElementById('lastRunStatus');
                        statusSpan.className = config.last_run_status === 'success' ? 'badge bg-success' : 'badge bg-danger';

                        if (config.last_run_details) {
                            const details = typeof config.last_run_details === 'string' ? JSON.stringify(config.last_run_details) : JSON.stringify(config.last_run_details, null, 2);
                            document.getElementById('lastRunDetails').innerHTML = `<pre class="mt-2 mb-0">${details}</pre>`;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Failed to load configuration:', error);
                alert('Failed to load configuration');
            });
        }

        function saveConfiguration() {
            // Collect form data
            const enabled = document.getElementById('enabledCheckbox').checked;

            const daysOfWeek = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            const startHour = parseInt(document.getElementById('startHour').value);
            const startMinute = parseInt(document.getElementById('startMinute').value);
            const endHour = parseInt(document.getElementById('endHour').value);
            const endMinute = parseInt(document.getElementById('endMinute').value);

            if (enabled && defaultCountyCodes.length === 0) {
                alert('Add at least one county to the shared list before enabling automatic RWT broadcasts.');
                return;
            }

            const data = {
                enabled,
                days_of_week: daysOfWeek,
                start_hour: startHour,
                start_minute: startMinute,
                end_hour: endHour,
                end_minute: endMinute,
                same_codes: defaultCountyCodes
            };

            fetch('/api/rwt-schedule/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.CSRF_TOKEN
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    loadConfiguration();
                } else {
                    alert('Failed to save configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Failed to save configuration:', error);
                alert('Failed to save configuration');
            });
        }

        function sendTestRWT() {
            if (!confirm('Send a test RWT broadcast now?')) {
                return;
            }

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';

            fetch('/api/rwt-schedule/test', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': window.CSRF_TOKEN
                }
            })
            .then(response => response.json())
            .then(data => {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-broadcast-tower me-2"></i>Send Test RWT Now';

                if (data.success) {
                    alert('Test RWT sent successfully!\nIdentifier: ' + (data.result.identifier || 'Unknown'));
                    loadConfiguration();
                } else {
                    alert('Failed to send test RWT: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Failed to send test RWT:', error);
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-broadcast-tower me-2"></i>Send Test RWT Now';
                alert('Failed to send test RWT');
            });
        }

        function loadLocationSettings(showToast = false) {
            fetch('/admin/location_settings', {
                headers: {
                    'X-CSRF-Token': window.CSRF_TOKEN
                }
            })
            .then(response => response.json())
            .then(data => {
                const settings = data.settings || {};
                defaultCountyCodes = sanitizeCountyList(settings.fips_codes || []);
                renderCountyList();
                if (showToast) {
                    alert('Reloaded county list from database.');
                }
            })
            .catch(error => {
                console.error('Failed to load location settings:', error);
                alert('Failed to load default counties');
            });
        }

        function sanitizeCountyList(values) {
            const seen = new Set();
            const cleaned = [];
            values.forEach(value => {
                const normalized = normalizeFips(value);
                if (normalized && !seen.has(normalized) && cleaned.length < 31) {
                    seen.add(normalized);
                    cleaned.push(normalized);
                }
            });
            return cleaned;
        }

        function normalizeFips(value) {
            if (value === undefined || value === null) {
                return null;
            }
            const digits = String(value).replace(/[^0-9]/g, '').slice(0, 6);
            if (digits.length !== 6) {
                return null;
            }
            return digits;
        }

        function addCountyCode(value) {
            const normalized = normalizeFips(value);
            if (!normalized) {
                alert('Enter a six-digit SAME/FIPS code.');
                return;
            }
            if (defaultCountyCodes.includes(normalized)) {
                countyCodeInput.value = '';
                return;
            }
            if (defaultCountyCodes.length >= 31) {
                alert('The SAME specification allows a maximum of 31 counties.');
                return;
            }
            defaultCountyCodes.push(normalized);
            countyCodeInput.value = '';
            renderCountyList();
        }

        function populateCountySelect(stateFips) {
            countySelect.innerHTML = '<option value="">Select County</option>';
            if (!stateFips) {
                countySelect.disabled = true;
                addCountyFromPickerBtn.disabled = true;
                return;
            }

            const state = (stateTree || []).find(item => item.state_fips === stateFips);
            if (!state) {
                countySelect.disabled = true;
                addCountyFromPickerBtn.disabled = true;
                return;
            }

            countySelect.disabled = false;
            addCountyFromPickerBtn.disabled = false;

            if (state.statewide_code) {
                const option = document.createElement('option');
                option.value = state.statewide_code;
                option.textContent = `${state.name} - Statewide`;
                countySelect.appendChild(option);
            }

            (state.counties || []).forEach(county => {
                const option = document.createElement('option');
                option.value = county.code;
                option.textContent = county.name;
                countySelect.appendChild(option);
            });
        }

        function renderCountyList() {
            countyListEl.innerHTML = '';
            if (defaultCountyCodes.length === 0) {
                countyEmptyState.style.display = 'block';
                renderScheduleCountyList();
                return;
            }
            countyEmptyState.style.display = 'none';

            defaultCountyCodes.forEach(code => {
                const chip = document.createElement('span');
                chip.className = 'badge bg-light text-dark border d-flex align-items-center gap-2 py-2 px-3';

                const codeEl = document.createElement('code');
                codeEl.textContent = code;
                chip.appendChild(codeEl);

                const label = document.createElement('span');
                label.textContent = describeSameCode(code);
                chip.appendChild(label);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-link text-danger p-0 ms-2';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    defaultCountyCodes = defaultCountyCodes.filter(item => item !== code);
                    renderCountyList();
                });
                chip.appendChild(removeBtn);

                countyListEl.appendChild(chip);
            });

            renderScheduleCountyList();
        }

        function renderScheduleCountyList() {
            if (!scheduleCountyListEl) {
                return;
            }
            scheduleCountyListEl.innerHTML = '';
            if (defaultCountyCodes.length === 0) {
                scheduleCountyEmptyState.style.display = 'block';
                return;
            }
            scheduleCountyEmptyState.style.display = 'none';
            defaultCountyCodes.forEach(code => {
                const chip = document.createElement('span');
                chip.className = 'badge bg-secondary text-white';
                chip.innerHTML = `<code class="me-1">${code}</code>${describeSameCode(code)}`;
                scheduleCountyListEl.appendChild(chip);
            });
        }

        function describeSameCode(code) {
            if (sameLookup && sameLookup[code]) {
                return sameLookup[code];
            }
            return 'Custom County';
        }

        function saveDefaultCounties() {
            fetch('/admin/location_settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.CSRF_TOKEN
                },
                body: JSON.stringify({
                    fips_codes: defaultCountyCodes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Failed to save counties: ' + data.error);
                    return;
                }
                alert('Default counties updated successfully.');
                loadLocationSettings();
            })
            .catch(error => {
                console.error('Failed to save counties:', error);
                alert('Failed to save default counties');
            });
        }
    });
</script>
{% endblock %}
