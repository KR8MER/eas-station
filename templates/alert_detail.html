{% extends "base.html" %}

{% block title %}Alert Details - {{ alert.event }} - KR8MER CAP Alerts{% endblock %}

{% block extra_css %}
<style>
    .county-wide-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .county-wide-icon {
        font-size: 2em;
        margin-bottom: 10px;
        display: block;
    }

    .affected-summary {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 8px 8px 0;
    }

    .boundary-type-group {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .boundary-type-header {
        background: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }

    .boundary-list {
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .boundary-item-simple {
        padding: 8px 15px;
        border-bottom: 1px solid #f8f9fa;
    }

    .boundary-item-simple:last-child {
        border-bottom: none;
    }

    .boundary-item-simple:nth-child(even) {
        background: #fdfdfe;
    }

    .boundary-item-simple .boundary-name {
        font-weight: 500;
    }

    .coverage-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        color: white;
        margin-left: 5px;
    }

    .coverage-badge.bg-success {
        background-color: #28a745 !important;
    }

    .coverage-badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .coverage-badge.bg-info {
        background-color: #17a2b8 !important;
    }

    .coverage-badge.bg-secondary {
        background-color: #6c757d !important;
    }

    .coverage-breakdown .badge {
        font-size: 0.7em;
        margin-bottom: 2px;
    }

    .alert-scope-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: 500;
    }

    .scope-county-wide {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
    }

    .scope-localized {
        background: #e9ecef;
        color: #495057;
    }

    .impact-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 15px 0;
    }

    .impact-stat {
        text-align: center;
        min-width: 80px;
    }

    .impact-number {
        font-size: 1.5em;
        font-weight: bold;
        color: #007bff;
    }

    .impact-label {
        font-size: 0.85em;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .alert-description {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .alert-instruction {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
        border: 2px solid #ffc107;
        border-left: 6px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .alert-instruction h6 {
        color: #856404;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .alert-content {
        line-height: 1.6;
    }

    .timing-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .timing-item {
        margin-bottom: 12px;
    }

    .timing-label {
        font-weight: 600;
        color: #495057;
        display: block;
        margin-bottom: 2px;
    }

    .timing-value {
        color: #007bff;
    }

    .technical-details {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .detail-item {
        margin-bottom: 10px;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
        margin-right: 8px;
    }

    .coverage-summary {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin: 20px 0;
    }

    .coverage-number {
        font-size: 3em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .coverage-label {
        font-size: 1.2em;
        margin-bottom: 10px;
    }

    .coverage-sublabel {
        opacity: 0.9;
        font-size: 0.9em;
    }

    /* Raw CAP Data styling */
    .raw-data-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
    }

    .raw-data-content {
        background: #ffffff;
        padding: 15px;
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .county-wide-badge {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        font-size: 0.75em;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
    }

    .popup-title {
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 8px;
    }

    .popup-detail {
        margin-bottom: 5px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 text-primary mb-1">
                        <i class="fas fa-exclamation-triangle"></i> Alert Details
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item"><a href="/alerts">Alerts History</a></li>
                            <li class="breadcrumb-item active">{{ alert.event }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <a href="/alerts" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Alerts
                    </a>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-map"></i> View on Map
                    </a>
                </div>
            </div>

            <!-- County-Wide Alert Banner -->
            {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
            {% set is_county_wide = (
                area_lower and (
                    'county' in area_lower or
                    'putnam county' in area_lower or
                    'entire county' in area_lower or
                    ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                )
            ) %}
            {% if is_county_wide %}
            <div class="county-wide-banner">
                <i class="fas fa-globe-americas county-wide-icon"></i>
                <h4 class="mb-2">COUNTY-WIDE ALERT</h4>
                <p class="mb-0">This alert affects the entire county and all emergency service boundaries within it.</p>
            </div>
            {% endif %}

            <div class="row">
                <!-- Main Alert Information -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Alert Information
                                <span class="float-end">
                                    {% if coverage_data and coverage_data.get('county') %}
                                        {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                        {% if county_coverage >= 95 %}
                                            <span class="alert-scope-indicator scope-county-wide">
                                                <i class="fas fa-globe"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% elif county_coverage >= 75 %}
                                            <span class="alert-scope-indicator" style="background: linear-gradient(45deg, #ffc107, #fd7e14); color: white;">
                                                <i class="fas fa-map"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% else %}
                                            <span class="alert-scope-indicator scope-localized">
                                                <i class="fas fa-map-marker-alt"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% endif %}
                                    {% elif is_county_wide %}
                                        <span class="alert-scope-indicator" style="background: #6c757d; color: white;">
                                            <i class="fas fa-question"></i> Coverage Calculating...
                                        </span>
                                    {% else %}
                                        <span class="alert-scope-indicator scope-localized">
                                            <i class="fas fa-map-marker-alt"></i> Localized Alert
                                        </span>
                                    {% endif %}
                                </span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if alert.headline %}
                            <div class="alert alert-{% if alert.severity == 'Extreme' %}danger{% elif alert.severity == 'Severe' %}warning{% elif alert.severity == 'Moderate' %}info{% else %}secondary{% endif %}" role="alert">
                                <h5 class="alert-heading">{{ alert.headline }}</h5>
                            </div>
                            {% endif %}

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Event Type</h6>
                                    <span class="fs-5 fw-bold text-primary">{{ alert.event }}</span>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Status</h6>
                                    <span class="badge bg-{% if alert.status == 'Actual' %}success{% else %}secondary{% endif %} fs-6">
                                        {{ alert.status }}
                                        {% if alert.expires | is_expired %}
                                        EXPIRED
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Severity</h6>
                                    {% if alert.severity %}
                                    <span class="badge bg-{% if alert.severity == 'Extreme' %}danger{% elif alert.severity == 'Severe' %}warning{% elif alert.severity == 'Moderate' %}info{% else %}secondary{% endif %} fs-6">{{ alert.severity }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Urgency</h6>
                                    {% if alert.urgency %}
                                    <span class="badge bg-warning fs-6">{{ alert.urgency }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Certainty</h6>
                                    {% if alert.certainty %}
                                    <span class="badge bg-success fs-6">{{ alert.certainty }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Message Type</h6>
                                    <span class="badge bg-dark fs-6">{{ alert.message_type }}</span>
                                </div>
                            </div>

                            {% if alert.description %}
                            <hr class="my-4">
                            <h6 class="text-muted mb-2">Description</h6>
                            <div class="alert-description alert-content">
                                {{ alert.description | safe }}
                            </div>
                            {% endif %}

                            {% if alert.instruction %}
                            <hr class="my-4">
                            <div class="alert-instruction">
                                <h6 class="text-muted mb-2"><i class="fas fa-exclamation-triangle"></i> Instructions</h6>
                                <div class="alert-content">
                                    {{ alert.instruction | safe }}
                                </div>
                            </div>
                            {% endif %}

                            {% if alert.area_desc %}
                            <hr class="my-4">
                            <h6 class="text-muted mb-2">Affected Areas</h6>
                            <div class="p-3 bg-info bg-opacity-10 rounded">
                                {{ alert.area_desc }}
                                {% if is_county_wide %}
                                <br><small class="text-muted mt-2">
                                    <i class="fas fa-info-circle"></i> This covers all emergency service districts, townships, and municipalities within the county.
                                </small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Alert Coverage Map -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map"></i> Alert Coverage Map
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Leaflet CSS -->
                            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

                            <div id="map" style="height: 500px; background: #f8f9fa; border-radius: 5px;">
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2 text-muted">Loading map...</p>
                                        <small class="text-muted">Loading alert coverage map...</small>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="map-legend">
                                    <small>
                                        <span class="badge" style="background: #ff6b35;">Alert Area</span>
                                        <span class="badge" style="background: #004e89;">Affected Boundaries</span>
                                    </small>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    {% if is_county_wide %}County-wide coverage shown{% else %}Specific alert area shown{% endif %}
                                </small>
                            </div>

                            <!-- Leaflet JS -->
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

                            <!-- Inline Map Script -->
                            <script>
                            (function() {
                                console.log('Map script starting...');

                                // Wait for Leaflet to load
                                setTimeout(function() {
                                    try {
                                        console.log('Initializing map for alert {{ alert.id }}');

                                        // Initialize map
                                        var map = L.map('map').setView([41.0167, -84.1330], 11);

                                        // Add OpenStreetMap tiles
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            attribution: 'Â© OpenStreetMap contributors'
                                        }).addTo(map);

                                        console.log('Map initialized successfully');

                                        // Try to load alert data with expired alerts included
                                        fetch('/api/alerts?include_expired=true')
                                            .then(function(response) {
                                                console.log('API response:', response.status);
                                                return response.json();
                                            })
                                            .then(function(data) {
                                                console.log('Data received:', data);

                                                if (data.features) {
                                                    var currentAlert = null;
                                                    for (var i = 0; i < data.features.length; i++) {
                                                        if (data.features[i].properties.id === {{ alert.id }}) {
                                                            currentAlert = data.features[i];
                                                            break;
                                                        }
                                                    }

                                                    if (currentAlert && currentAlert.geometry) {
                                                        console.log('Found alert geometry in API with expired=true');
                                                        displayAlertGeometry(map, currentAlert);
                                                    } else {
                                                        console.log('No geometry found for alert {{ alert.id }} even with expired=true');
                                                        showError('Alert #{{ alert.id }} has no geographic data');
                                                    }
                                                } else {
                                                    console.log('No features in API response');
                                                    showError('No alert data available from API');
                                                }
                                            })
                                            .catch(function(error) {
                                                console.error('API Error:', error);
                                                showError('Error loading alert data: ' + error.message);
                                            });

                                    } catch (error) {
                                        console.error('Map Error:', error);
                                        showError('Error initializing map: ' + error.message);
                                    }
                                }, 1000);

                                function displayAlertGeometry(map, alertData) {
                                    console.log('Displaying alert geometry:', alertData);

                                    try {
                                        // Add alert to map with styling based on severity
                                        var severity = '{{ alert.severity }}';
                                        var color = '#ff6b35'; // default orange

                                        switch(severity) {
                                            case 'Extreme': color = '#e74c3c'; break;
                                            case 'Severe': color = '#e67e22'; break;
                                            case 'Moderate': color = '#f39c12'; break;
                                            case 'Minor': color = '#3498db'; break;
                                        }

                                        var alertLayer = L.geoJSON(alertData, {
                                            style: {
                                                color: color,
                                                weight: 3,
                                                opacity: 0.8,
                                                fillOpacity: 0.3,
                                                fillColor: color
                                            }
                                        }).addTo(map);

                                        // Fit map to alert
                                        var bounds = alertLayer.getBounds();
                                        if (bounds.isValid()) {
                                            map.fitBounds(bounds, { padding: [20, 20] });
                                            console.log('Map fitted to alert bounds');
                                        }

                                        // Add popup
                                        alertLayer.bindPopup(
                                            '<b>{{ alert.event }}</b><br>' +
                                            'Alert #{{ alert.id }}<br>' +
                                            'Severity: ' + severity + '<br>' +
                                            'Status: {{ alert.status }}'
                                        );

                                        // Add county boundary for reference
                                        fetch('/api/boundaries?type=county')
                                            .then(function(response) { return response.json(); })
                                            .then(function(data) {
                                                if (data.features && data.features.length > 0) {
                                                    L.geoJSON(data.features[0], {
                                                        style: {
                                                            color: '#e74c3c',
                                                            weight: 2,
                                                            opacity: 0.6,
                                                            fillOpacity: 0.05,
                                                            fillColor: '#e74c3c'
                                                        }
                                                    }).addTo(map);
                                                    console.log('County boundary added');
                                                }
                                            })
                                            .catch(function(error) {
                                                console.log('County boundary load failed (non-critical):', error);
                                            });

                                        console.log('Alert displayed successfully');

                                    } catch (error) {
                                        console.error('Error displaying alert:', error);
                                        showError('Error displaying alert on map: ' + error.message);
                                    }
                                }

                                function showError(message) {
                                    console.log('Showing error:', message);
                                    document.getElementById('map').innerHTML =
                                        '<div style="height: 500px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">' +
                                        '<div style="text-align: center;">' +
                                        '<i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #ffc107; margin-bottom: 15px;"></i>' +
                                        '<h5>Map Error</h5>' +
                                        '<p>' + message + '</p>' +
                                        '<button class="btn btn-outline-primary" onclick="location.reload()">Retry</button>' +
                                        '<br><small style="margin-top: 10px; color: #6c757d;">Alert ID: {{ alert.id }}</small>' +
                                        '</div></div>';
                                }
                            })();
                            </script>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Affected Boundaries -->
                    {% if intersections %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt"></i>
                                {% if is_county_wide %}
                                Emergency Service Coverage - All County Boundaries
                                {% else %}
                                Affected Boundaries
                                {% endif %}
                                <span class="badge bg-secondary">{{ intersections|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- County Coverage Summary -->
                            {% if coverage_data and coverage_data.get('county') %}
                                {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                <div class="affected-summary">
                                    <h6>
                                        <i class="fas fa-{% if county_coverage >= 95 %}globe-americas text-success{% elif county_coverage >= 75 %}map text-warning{% else %}map-marker-alt text-info{% endif %}"></i>
                                        {% if county_coverage >= 95 %}
                                            County-Wide Impact
                                        {% elif county_coverage >= 75 %}
                                            Major County Impact
                                        {% elif county_coverage >= 50 %}
                                            Significant County Impact
                                        {% else %}
                                            Localized County Impact
                                        {% endif %}
                                    </h6>
                                    <p class="mb-2">
                                        This alert covers <strong>{{ county_coverage }}%</strong> of Putnam County
                                        {% if county_coverage >= 95 %}
                                            , affecting virtually all emergency service boundaries.
                                        {% elif county_coverage >= 75 %}
                                            , affecting most emergency service boundaries.
                                        {% elif county_coverage >= 50 %}
                                            , affecting many emergency service boundaries.
                                        {% else %}
                                            , affecting some emergency service boundaries.
                                        {% endif %}
                                    </p>

                                    <!-- Coverage breakdown -->
                                    {% if coverage_data %}
                                    <div class="coverage-breakdown">
                                        <small class="text-muted">Coverage by Service Type:</small>
                                        <div class="row mt-2">
                                            {% for service_type, data in coverage_data.items() %}
                                                {% if service_type != 'county' and data.coverage_percentage > 0 %}
                                                <div class="col-auto">
                                                    <span class="badge bg-{% if data.coverage_percentage >= 95 %}success{% elif data.coverage_percentage >= 75 %}warning{% elif data.coverage_percentage >= 50 %}info{% else %}secondary{% endif %} me-1">
                                                        {{ service_type.title() }}: {{ data.coverage_percentage }}%
                                                    </span>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% elif is_county_wide %}
                                <!-- Fallback for when detailed coverage isn't calculated yet -->
                                <div class="affected-summary">
                                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> County-Wide Alert - Coverage Analysis Needed</h6>
                                    <p class="mb-2">This alert appears to affect county-wide areas, but exact coverage percentages need to be calculated.</p>
                                    <button class="btn btn-warning btn-sm" onclick="triggerIntersectionFix()">
                                        <i class="fas fa-calculator"></i> Calculate Exact Coverage
                                    </button>
                                </div>
                            {% endif %}

                            <!-- Group boundaries by type with dynamic coverage -->
                            {% set boundary_groups = intersections | groupby('1.type') %}
                            {% for boundary_type, boundaries in boundary_groups %}
                            <div class="boundary-type-group">

                                <!-- Create deduplicated list by name -->
                                {% set unique_names = [] %}
                                {% for intersection, boundary in boundaries %}
                                    {% if boundary.name not in unique_names %}
                                        {% set _ = unique_names.append(boundary.name) %}
                                    {% endif %}
                                {% endfor %}

                                <div class="boundary-type-header">
                                    <i class="fas fa-{% if boundary_type == 'fire' %}fire{% elif boundary_type == 'ems' %}ambulance{% elif boundary_type == 'electric' %}bolt{% elif boundary_type == 'township' %}home{% elif boundary_type == 'village' %}building{% elif boundary_type == 'telephone' %}phone{% elif boundary_type == 'school' %}school{% else %}map{% endif %}"></i>
                                    {{ boundary_type.title() }}{% if boundary_type.endswith('s') %}{% else %}s{% endif %}
                                    <span class="badge bg-primary">{{ unique_names|length }}</span>

                                    <!-- Dynamic Coverage Badge -->
                                    {% if coverage_data and coverage_data.get(boundary_type) %}
                                        {% set coverage_pct = coverage_data[boundary_type]['coverage_percentage'] %}
                                        {% if coverage_pct >= 95 %}
                                            <span class="coverage-badge bg-success">{{ coverage_pct }}% Coverage</span>
                                        {% elif coverage_pct >= 75 %}
                                            <span class="coverage-badge bg-warning">{{ coverage_pct }}% Coverage</span>
                                        {% elif coverage_pct >= 50 %}
                                            <span class="coverage-badge bg-info">{{ coverage_pct }}% Coverage</span>
                                        {% else %}
                                            <span class="coverage-badge bg-secondary">{{ coverage_pct }}% Coverage</span>
                                        {% endif %}

                                        <!-- Additional coverage details -->
                                        <small class="text-muted ms-2">
                                            ({{ coverage_data[boundary_type]['affected_boundaries'] }} of {{ coverage_data[boundary_type]['total_boundaries'] }} {{ boundary_type }}s)
                                        </small>
                                    {% else %}
                                        <!-- Fallback for when coverage data isn't available -->
                                        {% if is_county_wide %}
                                            <span class="coverage-badge bg-warning">Coverage Calculating...</span>
                                            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="triggerIntersectionFix()" title="Calculate exact coverage">
                                                <i class="fas fa-calculator"></i>
                                            </button>
                                        {% else %}
                                            <span class="coverage-badge bg-secondary">Partial Coverage</span>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <ul class="boundary-list">
                                    {% for name in unique_names|sort %}
                                    <li class="boundary-item-simple">
                                        <div class="boundary-name">{{ name }}</div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <!-- No intersections found -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt"></i> Affected Boundaries
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if is_county_wide %}
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                <h5>County-Wide Alert - Boundary Analysis Pending</h5>
                                <p class="text-muted">This county-wide alert affects all emergency service boundaries, but intersection analysis is still processing.</p>
                                <button class="btn btn-warning" onclick="triggerIntersectionFix()">
                                    <i class="fas fa-wrench"></i> Calculate Affected Boundaries
                                </button>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-map fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Boundary Intersections Found</h5>
                                <p class="text-muted">This alert may not intersect with any configured emergency service boundaries.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Emergency Service Coverage Summary -->
                    {% if coverage_data and coverage_data.get('county') %}
                        {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                        <div class="coverage-summary">
                            <div class="coverage-number">{{ county_coverage }}%</div>
                            <div class="coverage-label">
                                {% if county_coverage >= 95 %}
                                    Complete County Coverage
                                {% elif county_coverage >= 75 %}
                                    Major County Coverage
                                {% elif county_coverage >= 50 %}
                                    Significant Coverage
                                {% else %}
                                    Localized Coverage
                                {% endif %}
                            </div>
                            <div class="coverage-sublabel">
                                {{ intersections|length }} Affected Boundaries<br>
                                {% set boundary_types = intersections | groupby('1.type') %}
                                {{ boundary_types|length }} Service Types
                            </div>
                        </div>
                    {% elif is_county_wide and intersections %}
                        <div class="coverage-summary">
                            <div class="coverage-number">?</div>
                            <div class="coverage-label">Coverage Calculating</div>
                            <div class="coverage-sublabel">
                                {{ intersections|length }} Boundaries<br>
                                {% set boundary_types = intersections | groupby('1.type') %}
                                {{ boundary_types|length }} Service Types
                            </div>
                        </div>
                    {% endif %}

                    <!-- Timing Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-clock"></i> Timing Information
                                <small class="text-muted">(Putnam County Time)</small>
                            </h5>
                        </div>
                        <div class="card-body timing-card">
                            <div class="timing-item">
                                <span class="timing-label">Alert Sent:</span>
                                <div class="timing-value">
                                    {% if alert.sent %}
                                    {{ alert.sent | format_local_datetime(false) }}<br>
                                    <small class="text-muted">{{ alert.sent | format_local_time }}</small>
                                    {% else %}
                                    <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Expires:</span>
                                <div class="timing-value">
                                    {% if alert.expires %}
                                    {{ alert.expires | format_local_datetime(false) }}<br>
                                    <small class="text-muted">{{ alert.expires | format_local_time }}</small>
                                    {% else %}
                                    <span class="text-muted">No expiration</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Added to System:</span>
                                <div class="timing-value">
                                    {{ alert.created_at | format_local_datetime(false) if alert.created_at else 'Unknown' }}<br>
                                    <small class="text-muted">{{ alert.created_at | format_local_time if alert.created_at else 'Unknown timezone' }}</small>
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Last Updated:</span>
                                <div class="timing-value">
                                    {{ alert.updated_at | format_local_datetime(false) if alert.updated_at else 'Unknown' }}<br>
                                    <small class="text-muted">{{ alert.updated_at | format_local_time if alert.updated_at else 'Unknown timezone' }}</small>
                                </div>
                            </div>
                            <hr>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> All times shown in Eastern Time (Putnam County local time) with UTC reference.
                                Times automatically adjust for daylight saving changes.
                            </small>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog"></i> Technical Details
                            </h5>
                        </div>
                        <div class="card-body technical-details">
                            <div class="detail-item">
                                <span class="detail-label">Alert Identifier</span>
                                <code>{{ alert.identifier }}</code>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Scope</span>
                                {{ alert.scope }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Category</span>
                                {{ alert.category or 'Not specified' }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Database ID</span>
                                #{{ alert.id }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Coverage Type</span>
                                {% if coverage_data and coverage_data.get('county') %}
                                    {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                    {% if county_coverage >= 95 %}County-Wide{% elif county_coverage >= 75 %}Major Coverage{% else %}Localized{% endif %}
                                {% elif is_county_wide %}County-Wide (Estimated){% else %}Localized{% endif %}
                            </div>
                            {% if coverage_data and coverage_data.get('county') %}
                            <div class="detail-item">
                                <span class="detail-label">Exact Coverage</span>
                                {{ coverage_data['county']['coverage_percentage'] }}% of Putnam County
                            </div>
                            {% endif %}
                            <hr>
                            <div class="detail-item">
                                <span class="detail-label">Timezone Processing</span>
                                <small class="text-muted">Source times converted from NWS format (UTC/EST/EDT) to local Eastern Time for display.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tools"></i> Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <!-- FIXED: Raw CAP Data button -->
                                <button class="btn btn-outline-info" onclick="toggleRawData()">
                                    <i class="fas fa-code"></i> View Raw CAP Data
                                </button>

                                <!-- FIXED: Separate Print button -->
                                <button class="btn btn-outline-secondary" onclick="window.print()">
                                    <i class="fas fa-print"></i> Print This Page
                                </button>

                                <!-- Keep the other buttons as they were -->
                                <button class="btn btn-outline-success" onclick="findSimilarAlerts()">
                                    <i class="fas fa-search"></i> Find Similar Alerts
                                </button>
                                <a href="/" class="btn btn-outline-primary">
                                    <i class="fas fa-map"></i> View on Interactive Map
                                </a>
                                <button class="btn btn-outline-warning" onclick="debugBoundaries()">
                                    <i class="fas fa-bug"></i> Debug Boundaries
                                </button>
                                {% if not coverage_data or not coverage_data.get('county') %}
                                <button class="btn btn-warning" onclick="triggerIntersectionFix()">
                                    <i class="fas fa-calculator"></i> Calculate Coverage Percentage
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Raw CAP Data Display Card (hidden by default) -->
                    <div class="card mt-4" id="rawDataCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-code"></i> Raw CAP Alert Data
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> Original JSON data received from NOAA National Weather Service
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="copyRawData()">
                                        <i class="fas fa-copy"></i> Copy to Clipboard
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadRawData()">
                                        <i class="fas fa-download"></i> Download JSON
                                    </button>
                                </div>
                            </div>
                            <div class="raw-data-container">
                                <pre class="raw-data-content" id="rawDataContent">{{ alert.raw_json | tojson(indent=2) if alert.raw_json else '{"error": "No raw CAP data available for this alert"}' }}</pre>
                            </div>

                            {% if alert.raw_json %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Data Source:</strong> {{ alert.raw_json.get('properties', {}).get('@id', 'Unknown') if alert.raw_json.get('properties') else 'Unknown' }}<br>
                                    <strong>Last Updated:</strong> {{ alert.updated_at | format_local_datetime if alert.updated_at else 'Unknown' }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="mt-5 py-4 bg-light border-top">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 text-center">
                <small class="text-muted">
                    <i class="fas fa-satellite-dish"></i> 2025 KR8MER CAP Emergency Alert System<br>
                    <i class="fas fa-radio"></i> Amateur Radio Emergency Communications |
                    {{ local_current_time() | format_local_time }}
                </small>
            </div>
        </div>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// Initialize the map
let map;
let alertLayer;
let boundaryLayers = {};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Putnam County, OH (same as main map)
    map = L.map('map').setView([41.0167, -84.1330], 11);

    // Add tile layer (same as main map)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Load alert geometry first, then boundaries
    loadAlertGeometry();
    loadBoundaries();
});

function loadAlertGeometry() {
    // Load all alerts and find the current one
    fetch('/api/alerts')
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                // Find the current alert by ID
                const currentAlert = data.features.find(f => f.properties.id === {{ alert.id }});

                if (currentAlert && currentAlert.geometry) {
                    // Determine styling based on severity
                    const severity = currentAlert.properties.severity;
                    let color = '#ff6b35'; // default orange

                    switch(severity) {
                        case 'Extreme': color = '#e74c3c'; break;
                        case 'Severe': color = '#e67e22'; break;
                        case 'Moderate': color = '#f39c12'; break;
                        case 'Minor': color = '#3498db'; break;
                    }

                    // Create alert layer with proper styling
                    alertLayer = L.geoJSON(currentAlert, {
                        style: {
                            color: color,
                            weight: currentAlert.properties.is_county_wide ? 4 : 3,
                            opacity: 0.8,
                            fillOpacity: currentAlert.properties.is_county_wide ? 0.2 : 0.3,
                            fillColor: color,
                            dashArray: currentAlert.properties.is_county_wide ? '10, 5' : ''
                        }
                    }).addTo(map);

                    // Fit map to alert bounds with padding
                    map.fitBounds(alertLayer.getBounds(), { padding: [20, 20] });

                    // Add popup with alert info
                    alertLayer.bindPopup(`
                        <div class="popup-title">
                            {{ alert.event }}
                            {% if is_county_wide %}<span class="county-wide-badge">COUNTY-WIDE</span>{% endif %}
                        </div>
                        <div class="popup-detail"><strong>Severity:</strong> {{ alert.severity or 'Unknown' }}</div>
                        <div class="popup-detail"><strong>Status:</strong> {{ alert.status }}</div>
                        <div class="popup-detail"><strong>Urgency:</strong> {{ alert.urgency or 'Unknown' }}</div>
                        {% if alert.expires %}<div class="popup-detail"><strong>Expires:</strong> {{ alert.expires | format_local_datetime(false) }}</div>{% endif %}
                        {% if alert.headline %}<div class="popup-detail"><strong>Headline:</strong> {{ alert.headline[:100] }}{% if alert.headline|length > 100 %}...{% endif %}</div>{% endif %}
                    `);

                    console.log('Alert geometry loaded successfully');
                } else {
                    console.log('No geometry found for alert ID {{ alert.id }}');
                    showMapError('Alert geometry not available');
                }
            } else {
                console.log('No alerts data received');
                showMapError('No alert data available');
            }
        })
        .catch(error => {
            console.error('Error loading alert geometry:', error);
            showMapError('Error loading alert data: ' + error.message);
        });
}

function loadBoundaries() {
    // Load boundaries using the same approach as index.html
    const boundaryTypes = ['county', 'fire', 'ems', 'electric', 'township', 'villages', 'telephone', 'school'];

    // Color scheme matching index.html
    const colors = {
        county: '#e74c3c',
        fire: '#e67e22',
        ems: '#f39c12',
        electric: '#2ecc71',
        township: '#3498db',
        villages: '#9b59b6',
        telephone: '#1abc9c',
        school: '#34495e'
    };

    boundaryTypes.forEach(type => {
        fetch(`/api/boundaries?type=${type}`)
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    // Create boundary layer
                    boundaryLayers[type] = L.geoJSON(data, {
                        style: {
                            color: colors[type] || '#95a5a6',
                            weight: type === 'county' ? 3 : 1,
                            opacity: 0.6,
                            fillOpacity: type === 'county' ? 0.05 : 0.1,
                            fillColor: colors[type] || '#95a5a6'
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <div class="popup-title">${props.name}</div>
                                <div class="popup-detail"><strong>Type:</strong> ${props.type}</div>
                                ${props.description ? `<div class="popup-detail">${props.description}</div>` : ''}
                            `);
                        }
                    });

                    // Add only county boundaries by default (others can be added if needed)
                    if (type === 'county') {
                        boundaryLayers[type].addTo(map);
                    }
                }
            })
            .catch(error => {
                console.error(`Error loading ${type} boundaries:`, error);
            });
    });
}

function showMapError(message) {
    // Show error in map container
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Map Loading Issue</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// FIXED: Raw CAP Data Functions
function toggleRawData() {
    const card = document.getElementById('rawDataCard');
    const button = event.target.closest('button');

    if (card.style.display === 'none') {
        card.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Raw CAP Data';
        // Smooth scroll to the raw data card
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    } else {
        card.style.display = 'none';
        button.innerHTML = '<i class="fas fa-code"></i> View Raw CAP Data';
    }
}

function copyRawData() {
    const content = document.getElementById('rawDataContent').textContent;
    const button = event.target.closest('button');

    navigator.clipboard.writeText(content).then(() => {
        // Visual feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(() => {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = content;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            button.classList.add('btn-success');
        } catch (err) {
            alert('Unable to copy to clipboard. Please select the text manually and copy.');
        }

        document.body.removeChild(textArea);

        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i> Copy to Clipboard';
            button.classList.remove('btn-success');
        }, 2000);
    });
}

function downloadRawData() {
    const content = document.getElementById('rawDataContent').textContent;
    const alertId = '{{ alert.identifier }}';
    const blob = new Blob([content], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `cap_alert_${alertId}.json`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Enhanced function to trigger intersection calculation
async function triggerIntersectionFix() {
    try {
        const response = await fetch('/admin/fix_county_intersections', { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
            if (typeof showToast === 'function') {
                showToast('Coverage calculation completed! Refreshing page...', 'success');
            }
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            if (typeof showToast === 'function') {
                showToast(result.error || 'Failed to calculate coverage', 'error');
            } else {
                alert(result.error || 'Failed to calculate coverage');
            }
        }
    } catch (error) {
        console.error('Error calculating coverage:', error);
        if (typeof showToast === 'function') {
            showToast('Error: ' + error.message, 'error');
        } else {
            alert('Error: ' + error.message);
        }
    }
}

function findSimilarAlerts() {
    // Implement similar alerts search
    alert('Similar alerts search would be implemented here.');
}

function debugBoundaries() {
    // Open debug view for boundaries
    window.open(`/debug/boundaries/{{ alert.id }}`, '_blank');
}
</script>
{% endblock %}