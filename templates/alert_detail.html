{% extends "base.html" %}

{% block title %}Alert Details - {{ alert.event }} - KR8MER CAP Alerts{% endblock %}

{% block extra_css %}
<style>
    .county-wide-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .major-coverage-banner {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .localized-banner {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .county-wide-icon {
        font-size: 2em;
        margin-bottom: 10px;
        display: block;
    }

    .affected-summary {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 8px 8px 0;
    }

    .boundary-type-group {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .boundary-type-header {
        background: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }

    .boundary-list {
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .boundary-item-simple {
        padding: 8px 15px;
        border-bottom: 1px solid #f8f9fa;
    }

    .boundary-item-simple:last-child {
        border-bottom: none;
    }

    .boundary-item-simple:nth-child(even) {
        background: #fdfdfe;
    }

    .boundary-item-simple .boundary-name {
        font-weight: 500;
    }

    .coverage-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        color: white;
        margin-left: 5px;
    }

    .coverage-badge.bg-success {
        background-color: #28a745 !important;
    }

    .coverage-badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .coverage-badge.bg-info {
        background-color: #17a2b8 !important;
    }

    .coverage-badge.bg-secondary {
        background-color: #6c757d !important;
    }

    .coverage-breakdown .badge {
        font-size: 0.7em;
        margin-bottom: 2px;
    }

    .alert-scope-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: 500;
    }

    .scope-county-wide {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
    }

    .scope-localized {
        background: #e9ecef;
        color: #495057;
    }

    .alert-description {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .alert-instruction {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
        border: 2px solid #ffc107;
        border-left: 6px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .alert-instruction h6 {
        color: #856404;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .alert-content {
        line-height: 1.6;
    }

    .timing-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .timing-item {
        margin-bottom: 12px;
    }

    .timing-label {
        font-weight: 600;
        color: #495057;
        display: block;
        margin-bottom: 2px;
    }

    .timing-value {
        color: #007bff;
    }

    .technical-details {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .detail-item {
        margin-bottom: 10px;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
        margin-right: 8px;
    }

    .coverage-summary {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin: 20px 0;
    }

    .coverage-number {
        font-size: 3em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .coverage-label {
        font-size: 1.2em;
        margin-bottom: 10px;
    }

    .coverage-sublabel {
        opacity: 0.9;
        font-size: 0.9em;
    }

    .raw-data-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
    }

    .raw-data-content {
        background: #ffffff;
        padding: 15px;
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .county-wide-badge {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        font-size: 0.75em;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
    }

    .popup-title {
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 8px;
    }

    .popup-detail {
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    .alert-actions {
        position: sticky;
        top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 text-primary mb-1">
                        <i class="fas fa-exclamation-triangle"></i> Alert Details
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item"><a href="/alerts">Alerts History</a></li>
                            <li class="breadcrumb-item active">{{ alert.event }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <a href="/alerts" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Alerts
                    </a>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-map"></i> View on Map
                    </a>
                </div>
            </div>

            <!-- Coverage-Based Alert Banner -->
            {% if coverage_data and coverage_data.get('county') %}
                {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                {% if county_coverage >= 95 %}
                <div class="county-wide-banner">
                    <i class="fas fa-globe-americas county-wide-icon"></i>
                    <h4 class="mb-2">COUNTY-WIDE ALERT</h4>
                    <p class="mb-0">This alert affects {{ county_coverage }}% of the county and virtually all emergency service boundaries within it.</p>
                </div>
                {% elif county_coverage >= 75 %}
                <div class="major-coverage-banner">
                    <i class="fas fa-map county-wide-icon"></i>
                    <h4 class="mb-2">MAJOR COUNTY COVERAGE ALERT</h4>
                    <p class="mb-0">This alert affects {{ county_coverage }}% of the county and most emergency service boundaries within it.</p>
                </div>
                {% elif county_coverage >= 25 %}
                <div class="localized-banner">
                    <i class="fas fa-map-marker-alt county-wide-icon"></i>
                    <h4 class="mb-2">LOCALIZED ALERT</h4>
                    <p class="mb-0">This alert affects {{ county_coverage }}% of the county and some emergency service boundaries within it.</p>
                </div>
                {% endif %}
            {% else %}
                <!-- Fallback banner when coverage data isn't available -->
                {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
                {% set is_county_wide_fallback = (
                    area_lower and (
                        'county' in area_lower or
                        'putnam county' in area_lower or
                        'entire county' in area_lower or
                        ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                    )
                ) %}
                {% if is_county_wide_fallback %}
                <div class="localized-banner">
                    <i class="fas fa-question-circle county-wide-icon"></i>
                    <h4 class="mb-2">ALERT - COVERAGE CALCULATING</h4>
                    <p class="mb-0">Alert coverage analysis is being processed.</p>
                </div>
                {% endif %}
            {% endif %}

            <div class="row">
                <!-- Main Alert Information -->
                <div class="col-lg-8">
                    <!-- Alert Info Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Alert Information
                                <span class="float-end">
                                    {% if coverage_data and coverage_data.get('county') %}
                                        {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                        {% if county_coverage >= 95 %}
                                            <span class="alert-scope-indicator scope-county-wide">
                                                <i class="fas fa-globe"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% elif county_coverage >= 75 %}
                                            <span class="alert-scope-indicator" style="background: linear-gradient(45deg, #ffc107, #fd7e14); color: white;">
                                                <i class="fas fa-map"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% else %}
                                            <span class="alert-scope-indicator scope-localized">
                                                <i class="fas fa-map-marker-alt"></i> {{ county_coverage }}% County Coverage
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="alert-scope-indicator" style="background: #6c757d; color: white;">
                                            <i class="fas fa-question"></i> Coverage Calculating...
                                        </span>
                                    {% endif %}
                                </span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if alert.headline %}
                            <div class="alert alert-{% if alert.severity == 'Extreme' %}danger{% elif alert.severity == 'Severe' %}warning{% elif alert.severity == 'Moderate' %}info{% else %}secondary{% endif %}" role="alert">
                                <h5 class="alert-heading">{{ alert.headline }}</h5>
                            </div>
                            {% endif %}

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Event Type</h6>
                                    <span class="fs-5 fw-bold text-primary">{{ alert.event }}</span>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Status</h6>
                                    <span class="badge bg-{% if alert.status == 'Actual' %}success{% else %}secondary{% endif %} fs-6">
                                        {{ alert.status }}
                                        {% if alert.expires | is_expired %}
                                        EXPIRED
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Severity</h6>
                                    {% if alert.severity %}
                                    <span class="badge bg-{% if alert.severity == 'Extreme' %}danger{% elif alert.severity == 'Severe' %}warning{% elif alert.severity == 'Moderate' %}info{% else %}secondary{% endif %} fs-6">{{ alert.severity }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Urgency</h6>
                                    {% if alert.urgency %}
                                    <span class="badge bg-warning fs-6">{{ alert.urgency }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Certainty</h6>
                                    {% if alert.certainty %}
                                    <span class="badge bg-success fs-6">{{ alert.certainty }}</span>
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Message Type</h6>
                                    <span class="badge bg-dark fs-6">{{ alert.message_type }}</span>
                                </div>
                            </div>

                            {% if alert.description %}
                            <hr class="my-4">
                            <h6 class="text-muted mb-2">Description</h6>
                            <div class="alert-description alert-content">
                                {{ alert.description | safe }}
                            </div>
                            {% endif %}

                            {% if alert.instruction %}
                            <hr class="my-4">
                            <div class="alert-instruction">
                                <h6 class="text-muted mb-2"><i class="fas fa-exclamation-triangle"></i> Instructions</h6>
                                <div class="alert-content">
                                    {{ alert.instruction | safe }}
                                </div>
                            </div>
                            {% endif %}

                            {% if alert.area_desc %}
                            <hr class="my-4">
                            <h6 class="text-muted mb-2">Affected Areas</h6>
                            <div class="p-3 bg-info bg-opacity-10 rounded">
                                {{ alert.area_desc }}
                                {% if coverage_data and coverage_data.get('county') %}
                                    {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                    <br><small class="text-muted mt-2">
                                        <i class="fas fa-info-circle"></i>
                                        {% if county_coverage >= 95 %}
                                            This covers virtually all emergency service districts, townships, and municipalities within the county.
                                        {% elif county_coverage >= 75 %}
                                            This covers most emergency service districts, townships, and municipalities within the county.
                                        {% elif county_coverage >= 25 %}
                                            This covers some emergency service districts, townships, and municipalities within the county.
                                        {% else %}
                                            This covers a small portion of emergency service districts, townships, and municipalities within the county.
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Alert Coverage Map -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map"></i> Alert Coverage Map
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="map" style="height: 500px; background: #f8f9fa; border-radius: 5px;">
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2 text-muted">Loading map...</p>
                                        <small class="text-muted">Loading alert coverage map...</small>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="map-legend">
                                    <small>
                                        <span class="badge" style="background: #ff6b35;">Alert Area</span>
                                        <span class="badge" style="background: #004e89;">Affected Boundaries</span>
                                    </small>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    {% if coverage_data and coverage_data.get('county') and coverage_data['county']['coverage_percentage'] >= 95 %}
                                        County-wide coverage shown
                                    {% else %}
                                        Specific alert area shown
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Affected Boundaries -->
                    {% if intersections %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt"></i>
                                {% if coverage_data and coverage_data.get('county') and coverage_data['county']['coverage_percentage'] >= 95 %}
                                Emergency Service Coverage - All County Boundaries
                                {% else %}
                                Affected Boundaries
                                {% endif %}
                                <span class="badge bg-secondary">{{ intersections|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- County Coverage Summary -->
                            {% if coverage_data and coverage_data.get('county') %}
                                {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                <div class="affected-summary">
                                    <h6>
                                        <i class="fas fa-{% if county_coverage >= 95 %}globe-americas text-success{% elif county_coverage >= 75 %}map text-warning{% else %}map-marker-alt text-info{% endif %}"></i>
                                        {% if county_coverage >= 95 %}
                                            County-Wide Impact
                                        {% elif county_coverage >= 75 %}
                                            Major County Impact
                                        {% elif county_coverage >= 50 %}
                                            Significant County Impact
                                        {% else %}
                                            Localized County Impact
                                        {% endif %}
                                    </h6>
                                    <p class="mb-2">
                                        This alert covers <strong>{{ county_coverage }}%</strong> of {{ location_settings.county_name }}
                                        {% if county_coverage >= 95 %}
                                            , affecting virtually all emergency service boundaries.
                                        {% elif county_coverage >= 75 %}
                                            , affecting most emergency service boundaries.
                                        {% elif county_coverage >= 50 %}
                                            , affecting many emergency service boundaries.
                                        {% else %}
                                            , affecting some emergency service boundaries.
                                        {% endif %}
                                    </p>

                                    <!-- Coverage breakdown -->
                                    {% if coverage_data %}
                                    <div class="coverage-breakdown">
                                        <small class="text-muted">Coverage by Service Type:</small>
                                        <div class="row mt-2">
                                            {% for service_type, data in coverage_data.items() %}
                                                {% if service_type != 'county' and data.coverage_percentage > 0 %}
                                                <div class="col-auto">
                                                    <span class="badge bg-{% if data.coverage_percentage >= 95 %}success{% elif data.coverage_percentage >= 75 %}warning{% elif data.coverage_percentage >= 50 %}info{% else %}secondary{% endif %} me-1">
                                                        {{ service_type.title() }}: {{ data.coverage_percentage }}%
                                                    </span>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- Fallback for when detailed coverage isn't calculated yet -->
                                {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
                                {% set is_county_wide_fallback = (
                                    area_lower and (
                                        'county' in area_lower or
                                        'putnam county' in area_lower or
                                        'entire county' in area_lower or
                                        ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                                    )
                                ) %}
                                {% if is_county_wide_fallback %}
                                <div class="affected-summary">
                                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Alert - Coverage Analysis Needed</h6>
                                    <p class="mb-2">This alert appears to affect county areas, but exact coverage percentages need to be calculated.</p>
                                    <button type="button" class="btn btn-warning btn-sm" onclick="triggerIntersectionFix()">
                                        <i class="fas fa-calculator"></i> Calculate Exact Coverage
                                    </button>
                                </div>
                                {% endif %}
                            {% endif %}

                            <!-- Group boundaries by type with dynamic coverage -->
                            {% set boundary_groups = intersections | groupby('1.type') %}
                            {% for boundary_type, boundaries in boundary_groups %}
                            <div class="boundary-type-group">

                                <!-- Create deduplicated list by name -->
                                {% set unique_names = [] %}
                                {% for intersection, boundary in boundaries %}
                                    {% if boundary.name not in unique_names %}
                                        {% set _ = unique_names.append(boundary.name) %}
                                    {% endif %}
                                {% endfor %}

                                <div class="boundary-type-header">
                                    <i class="fas fa-{% if boundary_type == 'fire' %}fire{% elif boundary_type == 'ems' %}ambulance{% elif boundary_type == 'electric' %}bolt{% elif boundary_type == 'township' %}home{% elif boundary_type == 'village' %}building{% elif boundary_type == 'telephone' %}phone{% elif boundary_type == 'school' %}school{% else %}map{% endif %}"></i>
                                    {{ boundary_type.title() }}{% if boundary_type.endswith('s') %}{% else %}s{% endif %}
                                    <span class="badge bg-primary">{{ unique_names|length }}</span>

                                    <!-- Dynamic Coverage Badge -->
                                    {% if coverage_data and coverage_data.get(boundary_type) %}
                                        {% set coverage_pct = coverage_data[boundary_type]['coverage_percentage'] %}
                                        {% if coverage_pct >= 95 %}
                                            <span class="coverage-badge bg-success">{{ coverage_pct }}% Coverage</span>
                                        {% elif coverage_pct >= 75 %}
                                            <span class="coverage-badge bg-warning">{{ coverage_pct }}% Coverage</span>
                                        {% elif coverage_pct >= 50 %}
                                            <span class="coverage-badge bg-info">{{ coverage_pct }}% Coverage</span>
                                        {% else %}
                                            <span class="coverage-badge bg-secondary">{{ coverage_pct }}% Coverage</span>
                                        {% endif %}

                                        <!-- Additional coverage details -->
                                        <small class="text-muted ms-2">
                                            ({{ coverage_data[boundary_type]['affected_boundaries'] }} of {{ coverage_data[boundary_type]['total_boundaries'] }} {{ boundary_type }}s)
                                        </small>
                                    {% else %}
                                        <!-- Fallback for when coverage data isn't available -->
                                        {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
                                        {% set is_county_wide_fallback = (
                                            area_lower and (
                                                'county' in area_lower or
                                                'putnam county' in area_lower or
                                                'entire county' in area_lower or
                                                ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                                            )
                                        ) %}
                                        {% if is_county_wide_fallback %}
                                            <span class="coverage-badge bg-warning">Coverage Calculating...</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="triggerIntersectionFix()" title="Calculate exact coverage">
                                                <i class="fas fa-calculator"></i>
                                            </button>
                                        {% else %}
                                            <span class="coverage-badge bg-secondary">Partial Coverage</span>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <ul class="boundary-list">
                                    {% for name in unique_names|sort %}
                                    <li class="boundary-item-simple">
                                        <div class="boundary-name">{{ name }}</div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <!-- No intersections found -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt"></i> Affected Boundaries
                            </h5>
                        </div>
                        <div class="card-body">
                            {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
                            {% set is_county_wide_fallback = (
                                area_lower and (
                                    'county' in area_lower or
                                    'putnam county' in area_lower or
                                    'entire county' in area_lower or
                                    ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                                )
                            ) %}
                            {% if is_county_wide_fallback %}
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                <h5>Alert - Boundary Analysis Pending</h5>
                                <p class="text-muted">This alert affects county areas, but intersection analysis is still processing.</p>
                                <button type="button" class="btn btn-warning" onclick="triggerIntersectionFix()">
                                    <i class="fas fa-wrench"></i> Calculate Affected Boundaries
                                </button>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-map fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Boundary Intersections Found</h5>
                                <p class="text-muted">This alert may not intersect with any configured emergency service boundaries.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Emergency Service Coverage Summary -->
                    {% if coverage_data and coverage_data.get('county') %}
                        {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                        <div class="coverage-summary">
                            <div class="coverage-number">{{ county_coverage }}%</div>
                            <div class="coverage-label">
                                {% if county_coverage >= 95 %}
                                    Complete County Coverage
                                {% elif county_coverage >= 75 %}
                                    Major County Coverage
                                {% elif county_coverage >= 50 %}
                                    Significant Coverage
                                {% else %}
                                    Localized Coverage
                                {% endif %}
                            </div>
                            <div class="coverage-sublabel">
                                {{ intersections|length }} Affected Boundaries<br>
                                {% set boundary_types = intersections | groupby('1.type') %}
                                {{ boundary_types|length }} Service Types
                            </div>
                        </div>
                    {% else %}
                        {% set area_lower = alert.area_desc.lower() if alert.area_desc else '' %}
                        {% set is_county_wide_fallback = (
                            area_lower and (
                                'county' in area_lower or
                                'putnam county' in area_lower or
                                'entire county' in area_lower or
                                ('putnam' in area_lower and (area_lower.count(';') >= 2 or area_lower.count(',') >= 2))
                            )
                        ) %}
                        {% if is_county_wide_fallback and intersections %}
                        <div class="coverage-summary">
                            <div class="coverage-number">?</div>
                            <div class="coverage-label">Coverage Calculating</div>
                            <div class="coverage-sublabel">
                                {{ intersections|length }} Boundaries<br>
                                {% set boundary_types = intersections | groupby('1.type') %}
                                {{ boundary_types|length }} Service Types
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- Timing Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-clock"></i> Timing Information
                                <small class="text-muted">({{ location_settings.county_name }} Time)</small>
                            </h5>
                        </div>
                        <div class="card-body timing-card">
                            <div class="timing-item">
                                <span class="timing-label">Alert Sent:</span>
                                <div class="timing-value">
                                    {% if alert.sent %}
                                    {{ alert.sent | format_local_datetime(false) }}<br>
                                    <small class="text-muted">{{ alert.sent | format_local_time }}</small>
                                    {% else %}
                                    <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Expires:</span>
                                <div class="timing-value">
                                    {% if alert.expires %}
                                    {{ alert.expires | format_local_datetime(false) }}<br>
                                    <small class="text-muted">{{ alert.expires | format_local_time }}</small>
                                    {% else %}
                                    <span class="text-muted">No expiration</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Added to System:</span>
                                <div class="timing-value">
                                    {{ alert.created_at | format_local_datetime(false) if alert.created_at else 'Unknown' }}<br>
                                    <small class="text-muted">{{ alert.created_at | format_local_time if alert.created_at else 'Unknown timezone' }}</small>
                                </div>
                            </div>
                            <div class="timing-item">
                                <span class="timing-label">Last Updated:</span>
                                <div class="timing-value">
                                    {{ alert.updated_at | format_local_datetime(false) if alert.updated_at else 'Unknown' }}<br>
                                    <small class="text-muted">{{ alert.updated_at | format_local_time if alert.updated_at else 'Unknown timezone' }}</small>
                                </div>
                            </div>
                            <hr>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> All times shown in {{ location_settings.timezone }} local time with UTC reference.
                                Times automatically adjust for daylight saving changes.
                            </small>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog"></i> Technical Details
                            </h5>
                        </div>
                        <div class="card-body technical-details">
                            <div class="detail-item">
                                <span class="detail-label">Alert Identifier</span>
                                <code>{{ alert.identifier }}</code>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Scope</span>
                                {{ alert.scope }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Category</span>
                                {{ alert.category or 'Not specified' }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Database ID</span>
                                #{{ alert.id }}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Coverage Type</span>
                                {% if coverage_data and coverage_data.get('county') %}
                                    {% set county_coverage = coverage_data['county']['coverage_percentage'] %}
                                    {% if county_coverage >= 95 %}County-Wide{% elif county_coverage >= 75 %}Major Coverage{% else %}Localized{% endif %}
                                {% else %}Coverage Calculating...{% endif %}
                            </div>
                            {% if coverage_data and coverage_data.get('county') %}
                            <div class="detail-item">
                                <span class="detail-label">Exact Coverage</span>
                                {{ coverage_data['county']['coverage_percentage'] }}% of {{ location_settings.county_name }}
                            </div>
                            {% endif %}
                            <hr>
                            <div class="detail-item">
                                <span class="detail-label">Timezone Processing</span>
                                <small class="text-muted">Source times converted from NWS format (UTC/EST/EDT) to local Eastern Time for display.</small>
                            </div>
                        </div>
                    </div>

                    {% if audio_entries %}
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-headphones"></i> Broadcast Audio Archive
                            </h5>
                            <a href="{{ url_for('audio_history') }}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-folder-open"></i> View All Audio
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="text-nowrap">Generated</th>
                                            <th scope="col">Details</th>
                                            <th scope="col" class="text-nowrap">SAME Header</th>
                                            <th scope="col" class="text-nowrap text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in audio_entries %}
                                        {% set meta = entry.metadata or {} %}
                                        <tr>
                                            <td class="text-nowrap">
                                                {{ entry.created_at | format_local_datetime(false) if entry.created_at else 'Unknown' }}
                                                <br>
                                                <small class="text-muted">
                                                    {{ entry.created_at | format_local_time if entry.created_at else '' }}
                                                </small>
                                            </td>
                                            <td>
                                                <strong>{{ meta.get('event', alert.event) or 'Unknown Event' }}</strong>
                                                {% if meta.get('severity') or alert.severity %}
                                                    <span class="badge bg-danger ms-1">{{ meta.get('severity', alert.severity) }}</span>
                                                {% endif %}
                                                {% if meta.get('status') or alert.status %}
                                                    <span class="badge bg-secondary ms-1">{{ meta.get('status', alert.status) }}</span>
                                                {% endif %}
                                                {% if meta.get('event_code') %}
                                                    <span class="badge bg-info ms-1">{{ meta.get('event_code') }}</span>
                                                {% endif %}
                                                {% set locations_meta = meta.get('locations') %}
                                                {% if locations_meta %}
                                                    <div class="small text-muted mt-1">
                                                        <i class="fas fa-map-pin"></i>
                                                        {% if locations_meta is string %}
                                                            {{ locations_meta }}
                                                        {% elif locations_meta is iterable %}
                                                            {{ locations_meta | join(', ') }}
                                                        {% else %}
                                                            {{ locations_meta }}
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-break">
                                                <code>{{ entry.same_header }}</code>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if entry.audio_url %}
                                                    <a class="btn btn-outline-primary" href="{{ entry.audio_url }}" target="_blank" rel="noopener">
                                                        <i class="fas fa-play"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if entry.text_url %}
                                                    <a class="btn btn-outline-info" href="{{ entry.text_url }}" target="_blank" rel="noopener" title="Download summary">
                                                        <i class="fas fa-file-alt"></i>
                                                    </a>
                                                    {% endif %}
                                                    <a class="btn btn-outline-secondary" href="{{ entry.detail_url }}" title="View detail">
                                                        <i class="fas fa-headphones"></i>
                                                    </a>
                                                    {% if entry.eom_url %}
                                                    <a class="btn btn-outline-warning" href="{{ entry.eom_url }}" target="_blank" rel="noopener" title="EOM Burst">
                                                        <i class="fas fa-broadcast-tower"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="card mt-4 alert-actions">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tools"></i> Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-info" onclick="toggleRawData()">
                                    <i class="fas fa-code"></i> <span id="raw-data-btn-text">View Raw CAP Data</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                                    <i class="fas fa-print"></i> Print This Page
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="findSimilarAlerts()">
                                    <i class="fas fa-search"></i> Find Similar Alerts
                                </button>
                                <a href="/" class="btn btn-outline-primary">
                                    <i class="fas fa-map"></i> View on Interactive Map
                                </a>
                                <button type="button" class="btn btn-outline-warning" onclick="debugBoundaries()">
                                    <i class="fas fa-bug"></i> Debug Boundaries
                                </button>
                                {% if not coverage_data or not coverage_data.get('county') %}
                                <button type="button" class="btn btn-warning" onclick="triggerIntersectionFix()">
                                    <i class="fas fa-calculator"></i> Calculate Coverage Percentage
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Raw CAP Data Display Card (hidden by default) -->
                    <div class="card mt-4" id="rawDataCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-code"></i> Raw CAP Alert Data
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> Original JSON data received from NOAA National Weather Service
                                </small>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="copyRawData()">
                                        <i class="fas fa-copy"></i> Copy to Clipboard
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadRawData()">
                                        <i class="fas fa-download"></i> Download JSON
                                    </button>
                                </div>
                            </div>
                            <div class="raw-data-container">
                                <pre class="raw-data-content" id="rawDataContent">{{ alert.raw_json | tojson(indent=2) if alert.raw_json else '{"error": "No raw CAP data available for this alert"}' }}</pre>
                            </div>

                            {% if alert.raw_json %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Data Source:</strong> {{ alert.raw_json.get('properties', {}).get('@id', 'Unknown') if alert.raw_json.get('properties') else 'Unknown' }}<br>
                                    <strong>Last Updated:</strong> {{ alert.updated_at | format_local_datetime if alert.updated_at else 'Unknown' }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet for maps -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
console.log('Alert detail page scripts loading...');

// Global variables for this page
let map;
let alertLayer;
let boundaryLayers = {};
const alertData = {
    id: {{ alert.id|int }},
    event: {{ alert.event|tojson }},
    severity: {{ alert.severity|tojson }},
    status: {{ alert.status|tojson }},
    identifier: {{ alert.identifier|tojson }},
    // Use coverage data instead of text-based detection
    is_county_wide: {% if coverage_data and coverage_data.get('county') and coverage_data['county']['coverage_percentage'] >= 95 %}true{% else %}false{% endif %}
};

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Alert detail page loaded for alert:', alertData.id);

    // Initialize map after a short delay
    setTimeout(initializeMap, 1000);
});

function initializeMap() {
    try {
        console.log('Initializing map...');

        // Create map
        map = L.map('map').setView([41.0167, -84.1330], 11);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        console.log('Map created successfully');

        // Load alert data and boundaries
        loadAlertData();
        loadBoundaries();

    } catch (error) {
        console.error('Error initializing map:', error);
        showMapError('Error initializing map: ' + error.message);
    }
}

function loadAlertData() {
    console.log('Loading alert data...');

    fetch('/api/alerts?include_expired=true')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch alerts: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Alert data received:', data);

            if (data.features && data.features.length > 0) {
                const currentAlert = data.features.find(f => f.properties.id === alertData.id);

                if (currentAlert && currentAlert.geometry) {
                    displayAlertOnMap(currentAlert);
                } else {
                    console.log('No geometry found for alert ID:', alertData.id);
                    showMapError('Alert has no geographic data');
                }
            } else {
                showMapError('No alert data available');
            }
        })
        .catch(error => {
            console.error('Error loading alert data:', error);
            showMapError('Error loading alert data: ' + error.message);
        });
}

function displayAlertOnMap(alertGeoData) {
    try {
        console.log('Displaying alert on map...');

        // Determine color based on severity
        let color = '#ff6b35'; // default orange
        switch(alertData.severity) {
            case 'Extreme': color = '#e74c3c'; break;
            case 'Severe': color = '#e67e22'; break;
            case 'Moderate': color = '#f39c12'; break;
            case 'Minor': color = '#3498db'; break;
        }

        // Create alert layer
        alertLayer = L.geoJSON(alertGeoData, {
            style: {
                color: color,
                weight: alertData.is_county_wide ? 4 : 3,
                opacity: 0.8,
                fillOpacity: alertData.is_county_wide ? 0.2 : 0.3,
                fillColor: color,
                dashArray: alertData.is_county_wide ? '10, 5' : ''
            }
        }).addTo(map);

        // Fit map to alert bounds
        try {
            map.fitBounds(alertLayer.getBounds(), { padding: [20, 20] });
        } catch (e) {
            console.log('Could not fit bounds, using default view');
        }

        // Add popup
        alertLayer.bindPopup(`
            <div class="popup-title">
                ${alertData.event}
                ${alertData.is_county_wide ? '<span class="county-wide-badge">COUNTY-WIDE</span>' : ''}
            </div>
            <div class="popup-detail"><strong>Severity:</strong> ${alertData.severity || 'Unknown'}</div>
            <div class="popup-detail"><strong>Status:</strong> ${alertData.status}</div>
        `);

        console.log('Alert displayed successfully on map');

    } catch (error) {
        console.error('Error displaying alert on map:', error);
        showMapError('Error displaying alert: ' + error.message);
    }
}

function loadBoundaries() {
    // Load boundaries using the same approach as index.html
    const boundaryTypes = ['county', 'fire', 'ems', 'electric', 'township', 'villages', 'telephone', 'school'];

    // Color scheme matching index.html
    const colors = {
        county: '#e74c3c',
        fire: '#e67e22',
        ems: '#f39c12',
        electric: '#2ecc71',
        township: '#3498db',
        villages: '#9b59b6',
        telephone: '#1abc9c',
        school: '#34495e'
    };

    boundaryTypes.forEach(type => {
        fetch(`/api/boundaries?type=${type}`)
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    // Create boundary layer
                    boundaryLayers[type] = L.geoJSON(data, {
                        style: {
                            color: colors[type] || '#95a5a6',
                            weight: type === 'county' ? 3 : 1,
                            opacity: 0.6,
                            fillOpacity: type === 'county' ? 0.05 : 0.1,
                            fillColor: colors[type] || '#95a5a6'
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <div class="popup-title">${props.name}</div>
                                <div class="popup-detail"><strong>Type:</strong> ${props.type}</div>
                                ${props.description ? `<div class="popup-detail">${props.description}</div>` : ''}
                            `);
                        }
                    });

                    // Add only county boundaries by default
                    if (type === 'county') {
                        boundaryLayers[type].addTo(map);
                    }
                }
            })
            .catch(error => {
                console.error(`Error loading ${type} boundaries:`, error);
            });
    });
}

function showMapError(message) {
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Map Error</h5>
                    <p class="text-muted">${message}</p>
                    <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Action button functions
function toggleRawData() {
    console.log('toggleRawData called');

    const card = document.getElementById('rawDataCard');
    const btnText = document.getElementById('raw-data-btn-text');

    if (!card || !btnText) {
        console.error('Raw data elements not found');
        return;
    }

    if (card.style.display === 'none') {
        card.style.display = 'block';
        btnText.textContent = 'Hide Raw CAP Data';
        // Smooth scroll to the raw data card
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    } else {
        card.style.display = 'none';
        btnText.textContent = 'View Raw CAP Data';
    }
}

function copyRawData() {
    console.log('copyRawData called');

    const content = document.getElementById('rawDataContent').textContent;
    const button = event.target.closest('button');

    navigator.clipboard.writeText(content).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);

        if (typeof showToast === 'function') {
            showToast('Raw data copied to clipboard!', 'success');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showToast === 'function') {
            showToast('Failed to copy to clipboard', 'error');
        }
    });
}

function downloadRawData() {
    console.log('downloadRawData called');

    const content = document.getElementById('rawDataContent').textContent;
    const blob = new Blob([content], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `cap_alert_${alertData.identifier}.json`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);

    if (typeof showToast === 'function') {
        showToast('Raw data downloaded!', 'success');
    }
}

function findSimilarAlerts() {
    console.log('findSimilarAlerts called');
    if (typeof showToast === 'function') {
        showToast('Similar alerts search would be implemented here.', 'info');
    } else {
        alert('Similar alerts search would be implemented here.');
    }
}

function debugBoundaries() {
    console.log('debugBoundaries called');
    const url = `/debug/boundaries/${alertData.id}`;
    window.open(url, '_blank');
}

// Enhanced function to trigger intersection calculation
async function triggerIntersectionFix() {
    console.log('triggerIntersectionFix called');

    try {
        const response = await fetch('/admin/fix_county_intersections', { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
            if (typeof showToast === 'function') {
                showToast('Coverage calculation completed! Refreshing page...', 'success');
            } else {
                alert('Coverage calculation completed! Refreshing page...');
            }
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            if (typeof showToast === 'function') {
                showToast(result.error || 'Failed to calculate coverage', 'error');
            } else {
                alert(result.error || 'Failed to calculate coverage');
            }
        }
    } catch (error) {
        console.error('Error calculating coverage:', error);
        if (typeof showToast === 'function') {
            showToast('Error: ' + error.message, 'error');
        } else {
            alert('Error: ' + error.message);
        }
    }
}

console.log('Alert detail page scripts loaded successfully');
</script>
{% endblock %}