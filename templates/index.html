{% extends "base.html" %}

{% block title %}Interactive Map - EAS Station{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    #map {
        height: 60vh;
        min-height: 400px;
        max-height: 800px;
        width: 100%;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        box-shadow: 0 12px 30px rgba(32, 72, 133, 0.16);
        overflow: hidden;
    }
    
    @media (max-width: 768px) {
        #map {
            height: 50vh;
            min-height: 300px;
            max-height: 600px;
        }
    }
    
    @media (max-width: 576px) {
        #map {
            height: 45vh;
            min-height: 250px;
            max-height: 500px;
        }
    }

    .page-shell {
        padding-top: 0.5rem;
        padding-bottom: 2rem;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: var(--radius-md);
        color: #fff;
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(32, 72, 133, 0.2);
    }

    .page-header::after {
        content: "";
        position: absolute;
        inset: auto -40% -70% auto;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.15), transparent 70%);
        transform: rotate(-12deg);
        pointer-events: none;
    }

    .page-header .header-content {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        position: relative;
        z-index: 1;
    }

    .page-header .header-text {
        display: flex;
        flex-direction: column;
    }

    .page-header .page-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        letter-spacing: 0.01em;
    }

    .page-header .page-subtitle {
        font-size: 0.85rem;
        opacity: 0.82;
        margin: 0;
    }

    /* Compact dashboard logo */
    .dashboard-page-logo {
        height: 40px;
        width: auto;
        display: block;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .dashboard-page-logo .logo-text-primary,
    .dashboard-page-logo .logo-text-secondary {
        fill: #ffffff;
    }

    .dashboard-page-logo .logo-bar {
        fill: #ffffff;
    }

    /* Snow Emergency Banner */
    .snow-emergency-banner {
        margin-top: var(--spacing-md);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .snow-emergency-banner.has-emergencies {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px var(--shadow-color);
    }

    .snow-emergency-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-color);
        border-bottom: 1px solid var(--border-color);
    }

    .snow-emergency-header h6 {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .snow-emergency-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
    }

    .snow-county-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        background: var(--bg-color);
        border: 2px solid transparent;
        transition: all var(--transition-fast);
    }

    .snow-county-card.level-1 {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }

    .snow-county-card.level-2 {
        border-color: #fd7e14;
        background: rgba(253, 126, 20, 0.1);
    }

    .snow-county-card.level-3 {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.15);
        animation: pulse-danger 2s infinite;
    }

    @keyframes pulse-danger {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
    }

    .snow-county-name {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .snow-level-badge {
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .snow-level-badge.level-1 {
        background: #ffc107;
        color: #000;
    }

    .snow-level-badge.level-2 {
        background: #fd7e14;
        color: #fff;
    }

    .snow-level-badge.level-3 {
        background: #dc3545;
        color: #fff;
    }

    .snow-emergency-edit-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* Snow Emergency Edit Modal */
    .snow-edit-county {
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        background: var(--bg-color);
    }

    .snow-edit-county-name {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .snow-edit-county-name .primary-badge {
        font-size: 0.65rem;
        background: var(--primary-color);
        color: #fff;
        padding: 0.1rem 0.4rem;
        border-radius: 999px;
    }

    .snow-level-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .snow-level-option {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.8rem;
        border: 2px solid var(--border-color);
        background: var(--surface-color);
        transition: all var(--transition-fast);
    }

    .snow-level-option:hover {
        background: var(--bg-color);
    }

    .snow-level-option input[type="radio"] {
        margin: 0;
    }

    .snow-level-option.selected {
        border-color: var(--primary-color);
        background: rgba(47, 90, 161, 0.1);
    }

    .snow-level-option[data-level="0"].selected {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .snow-level-option[data-level="1"].selected {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.15);
    }

    .snow-level-option[data-level="2"].selected {
        border-color: #fd7e14;
        background: rgba(253, 126, 20, 0.15);
    }

    .snow-level-option[data-level="3"].selected {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.15);
    }

    .page-header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .page-header-actions .btn {
        border-radius: var(--radius-sm);
        padding: 0.4rem 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 4px 8px rgba(12, 20, 38, 0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .page-header-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(12, 20, 38, 0.2);
    }

    .summary-metrics .metric-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        box-shadow: 0 12px 26px var(--shadow-color);
        min-height: 100%;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.35rem;
        color: var(--color-text-inverse);
    }

    /* Using CSS variables for metric icons - all colors from theme variables */
    .metric-icon.metric-alert { background: var(--danger-color); }
    .metric-icon.metric-boundary { background: var(--success-color); }
    .metric-icon.metric-clock { background: var(--warning-color); color: var(--text-color); }
    .metric-icon.metric-map { background: var(--info-color); }

    .metric-label {
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
    }

    .metric-value {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--text-color);
        line-height: 1.1;
    }

    .metric-value small {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted);
        display: block;
        margin-top: 0.35rem;
    }

    .sticky-card {
        position: sticky;
        top: 96px;
        z-index: 2;
        background-color: var(--surface-color);
    }

    .control-card .card-header,
    .insight-card .card-header,
    .quick-actions-card .card-header,
    .legend-card .card-header {
        border: none;
        background: transparent;
        padding-bottom: 0;
    }

    .control-card .card-title,
    .insight-card .card-title,
    .quick-actions-card .card-title,
    .legend-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .card-subtitle {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .control-card .card-body {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .layer-section {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 1rem;
        background: var(--surface-color);
        box-shadow: 0 6px 16px rgba(32, 72, 133, 0.12);
    }

    .layer-section:not(:last-child) {
        margin-bottom: 0.5rem;
    }

    .layer-heading {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
        color: var(--text-color);
    }

    .layer-options {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }

    .layer-options .form-check {
        margin-bottom: 0;
        padding: 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .layer-options .form-check.form-switch {
        padding-left: 0;
    }

    .layer-options .form-check.form-switch .form-check-input {
        margin-left: 0;
        margin-right: 0.5rem;
        width: 2.6rem;
        height: 1.3rem;
        background-color: var(--light-color);
        border: 1px solid var(--border-color);
        transition: background-color var(--transition-fast), border-color var(--transition-fast);
    }

    .layer-options .form-check.form-switch .form-check-input:focus {
        box-shadow: 0 0 0 0.15rem rgba(47, 90, 161, 0.25);
    }

    .layer-options .form-check.form-switch .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .layer-options .form-check.form-switch .form-check-label {
        margin-left: 0;
        flex: 1;
    }

    .layer-options .form-check-label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        width: 100%;
        font-weight: 500;
    }

    .layer-options .form-check-label .ms-auto {
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .layer-swatch {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .layer-options .empty-placeholder {
        font-style: italic;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: none;
    }

    #date-filters {
        background: var(--light-color);
        border-radius: var(--radius-sm);
        padding: 1rem;
        border: 1px dashed var(--border-color);
        margin-top: 0.75rem;
    }

    #date-filters .form-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
    }

    .insight-card .card-body {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .alert-summary-panel {
        background: var(--light-color);
        border-radius: var(--radius-sm);
        padding: 1rem;
        border: 1px solid var(--border-color);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .quick-actions-grid .btn {
        justify-content: center;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.55rem 0.75rem;
        border-radius: var(--radius-sm);
    }

    .quick-actions-grid .btn i {
        font-size: 0.95rem;
    }

    .map-card .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .map-card .card-body {
        padding: 0;
        overflow: hidden;
    }

    .map-refresh-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.2rem;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .map-refresh-meta .meta-row {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        text-align: right;
    }

    .map-refresh-meta .status-pill {
        background: rgba(32, 72, 133, 0.12);
        border-radius: 999px;
        text-transform: uppercase;
        font-size: 0.68rem;
        letter-spacing: 0.08em;
        padding: 0.1rem 0.6rem;
        color: var(--primary-color);
        font-weight: 600;
    }

    .map-refresh-meta strong {
        color: var(--text-color);
        font-weight: 600;
    }

    .loading-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 600px;
        color: var(--text-muted);
        flex-direction: column;
        background: var(--light-color);
        border-radius: var(--radius-md);
        border: 1px dashed var(--border-color);
    }

    .spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .map-error {
        text-align: center;
        color: var(--danger-color);
        padding: 40px;
        background: var(--light-color);
        border-radius: var(--radius-md);
        border: 1px solid var(--danger-color);
    }

    .legend-card .card-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .legend {
        margin: 0;
    }

    .legend h6 {
        color: var(--text-color);
        margin-bottom: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .legend-dynamic {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .historical-badge {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: #fff;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 8px;
        margin-left: 5px;
    }

    .alert-active {
        border: 2px solid var(--danger-color) !important;
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .alert-expired {
        border: 2px solid var(--secondary-color) !important;
        background-color: rgba(108, 117, 125, 0.1) !important;
        opacity: 0.7;
    }

    /* Leaflet popup customization */
    .leaflet-popup-content {
        max-width: 300px;
    }

    .popup-title {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .popup-detail {
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    .popup-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        margin: 2px;
    }

    .severity-extreme { background: #dc3545; color: white; }
    .severity-severe { background: #fd7e14; color: white; }
    .severity-moderate { background: #ffc107; color: black; }
    .severity-minor { background: #17a2b8; color: white; }
    .severity-unknown { background: #6c757d; color: white; }

    @media (max-width: 991px) {
        .sticky-card {
            position: static;
        }

        .page-header {
            padding: var(--spacing-md);
        }

        .page-header .page-title {
            font-size: 1.6rem;
        }

        .page-header-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 576px) {
        #map,
        .loading-message {
            height: 420px;
        }

        .summary-metrics .metric-card {
            padding: var(--spacing-sm);
        }

        .metric-value {
            font-size: 1.35rem;
        }

        .map-refresh-meta {
            align-items: flex-start;
            width: 100%;
        }

        .map-refresh-meta .meta-row {
            justify-content: flex-start;
            text-align: left;
        }
    }

.dashboard-sidebar {
    display: flex;
    flex-direction: column;
}

.dashboard-sidebar > .card + .card {
    margin-top: var(--spacing-lg);
}

@media (max-width: 991px) {
    .dashboard-sidebar > .card + .card {
        margin-top: var(--spacing-md);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid page-shell">
    {% set county_name = location_settings.county_name if location_settings is defined and location_settings and location_settings.county_name else 'your area' %}
    {% set state_code = location_settings.state_code if location_settings is defined and location_settings and location_settings.state_code else '' %}
    <div class="page-header">
        <div class="header-content">
            {% with logo_classes='dashboard-page-logo', logo_style='height: 36px; width: auto;' %}
                {% include 'partials/logo_wordmark.html' %}
            {% endwith %}
            <div class="header-text">
                <h1 class="page-title">Emergency Alert Dashboard</h1>
                <p class="page-subtitle">{{ county_name }}{% if state_code %}, {{ state_code }}{% endif %}</p>
            </div>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-light text-primary" onclick="refreshData({ includeBoundaries: true, reason: 'Manual refresh' })">
                <i class="fas fa-sync-alt" id="refresh-icon"></i>
                <span>Refresh</span>
            </button>
            <a href="/alerts" class="btn btn-outline-light">
                <i class="fas fa-history"></i>
                <span>Alerts</span>
            </a>
            <button class="btn btn-outline-light" onclick="openSnowEmergencyModal()" title="Manage Snow Emergencies">
                <i class="fas fa-snowflake"></i>
                <span>Snow</span>
            </button>
        </div>
    </div>

    <!-- Snow Emergency Banner - Shows active emergencies, hidden when none -->
    <div id="snow-emergency-banner" class="snow-emergency-banner" style="display: none;">
        <div class="snow-emergency-header">
            <h6><i class="fas fa-snowflake"></i> Snow Emergencies</h6>
            <button class="btn btn-sm btn-outline-primary snow-emergency-edit-btn" onclick="openSnowEmergencyModal()">
                <i class="fas fa-edit"></i> Edit
            </button>
        </div>
        <div id="snow-emergency-grid" class="snow-emergency-grid"></div>
    </div>

    <div class="row g-3 summary-metrics my-3">
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-icon metric-alert">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <span class="metric-label">Active Alerts</span>
                    <div class="metric-value" id="active-alert-count">Loading...</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-icon metric-boundary">
                    <i class="fas fa-draw-polygon"></i>
                </div>
                <div>
                    <span class="metric-label">Boundary Layers</span>
                    <div class="metric-value" id="boundary-count">Loading...</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-icon metric-clock">
                    <i class="fas fa-clock"></i>
                </div>
                <div>
                    <span class="metric-label">Last Update</span>
                    <div class="metric-value" id="last-update">--</div>
                    <small>Local time</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-icon metric-map">
                    <i class="fas fa-map"></i>
                </div>
                <div>
                    <span class="metric-label">Map Status</span>
                    <div class="metric-value" id="map-status">Initializing...</div>
                    <small>Leaflet renderer</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-icon" style="background: #7c3aed;">
                    <i class="fas fa-waveform"></i>
                </div>
                <div>
                    <span class="metric-label">Audio System</span>
                    <div class="metric-value" id="audio-health">--<span style="font-size: 0.9rem; font-weight: normal; color: var(--text-muted);">%</span></div>
                    <small id="audio-sources-status">Loading...</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 align-items-start">
        <div class="col-lg-4 col-xxl-3 order-2 order-lg-1 dashboard-sidebar">
            <div class="card control-card sticky-card">
                <div class="card-header">
                    <h5 class="card-title mb-1 d-flex align-items-center gap-2">
                        <i class="fas fa-layer-group text-primary"></i>
                        <span>Map Layers</span>
                    </h5>
                    <p class="card-subtitle mb-0">Toggle overlays to compare coverage across your service area.</p>
                </div>
                <div class="card-body">
                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-exclamation-triangle text-danger"></i><span>Alert Types</span></div>
                        <div class="layer-options">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-active" checked>
                                <label class="form-check-label" for="show-active">
                                    <i class="fas fa-circle text-danger"></i> Active Alerts
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-expired">
                                <label class="form-check-label" for="show-expired">
                                    <i class="fas fa-circle text-secondary"></i> Historical Alerts
                                </label>
                            </div>
                        </div>
                        <div id="date-filters" style="display: none;">
                            <div class="mb-2">
                                <label for="start-date" class="form-label">From</label>
                                <input type="date" class="form-control form-control-sm" id="start-date">
                            </div>
                            <div class="mb-2">
                                <label for="end-date" class="form-label">To</label>
                                <input type="date" class="form-control form-control-sm" id="end-date">
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="loadHistoricalAlerts()">
                                <i class="fas fa-search"></i> Apply Filter
                            </button>
                        </div>
                    </div>

                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-map-marked-alt text-primary"></i><span>Geographic Boundaries</span></div>
                        <div id="layer-group-geographic" class="layer-options"></div>
                    </div>

                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-shield-alt text-success"></i><span>Service Boundaries</span></div>
                        <div id="layer-group-service" class="layer-options"></div>
                    </div>

                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-tools text-secondary"></i><span>Infrastructure</span></div>
                        <div id="layer-group-infrastructure" class="layer-options"></div>
                    </div>

                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-water text-info"></i><span>Water Features</span></div>
                        <div id="layer-group-hydrography" class="layer-options"></div>
                    </div>

                    <div class="layer-section">
                        <div class="layer-heading"><i class="fas fa-layer-group text-warning"></i><span>Custom Layers</span></div>
                        <div id="layer-group-custom" class="layer-options"></div>
                    </div>
                </div>
            </div>

            <div class="card insight-card">
                <div class="card-header">
                    <h5 class="card-title mb-1 d-flex align-items-center gap-2">
                        <i class="fas fa-chart-pie text-primary"></i>
                        <span>Active Alert Breakdown</span>
                    </h5>
                    <p class="card-subtitle mb-0">Auto-updates when new alerts stream in.</p>
                </div>
                <div class="card-body">
                    <div id="alert-summary" class="alert-summary-panel" style="display: none;"></div>
                    <p class="text-muted small mb-0" id="alert-summary-placeholder">Alert types will appear after the next data refresh.</p>
                </div>
            </div>

            <div class="card quick-actions-card">
                <div class="card-header">
                    <h5 class="card-title mb-1 d-flex align-items-center gap-2">
                        <i class="fas fa-bolt text-warning"></i>
                        <span>Quick Actions</span>
                    </h5>
                    <p class="card-subtitle mb-0">Jump into frequently used tools.</p>
                </div>
                <div class="card-body">
                    <div class="quick-actions-grid">
                        <a href="{{ url_for('audio_history') }}" class="btn btn-outline-primary">
                            <i class="fas fa-headphones"></i> Audio Archive
                        </a>
                        <a href="/stats" class="btn btn-outline-info">
                            <i class="fas fa-chart-bar"></i> Statistics
                        </a>
                        <a href="/admin" class="btn btn-outline-secondary">
                            <i class="fas fa-cog"></i> Admin Panel
                        </a>
                        <button class="btn btn-outline-warning" onclick="centerOnConfiguredLocation()">
                            <i class="fas fa-crosshairs"></i> Center on {{ county_name }}
                        </button>
                        <button class="btn btn-outline-success" onclick="inspectBoundaries()">
                            <i class="fas fa-search"></i> Inspect Boundaries
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-xxl-9 order-1 order-lg-2 d-flex flex-column gap-4">
            <div class="card map-card shadow-sm">
                <div class="card-header">
                    <div class="d-flex align-items-center gap-2">
                        <h5 class="mb-0 d-flex align-items-center gap-2">
                            <i class="fas fa-map text-primary"></i>
                            <span>Interactive Emergency Alert Map</span>
                        </h5>
                        <span class="badge bg-success" id="map-status-badge">Loading...</span>
                    </div>
                    <div class="map-refresh-meta" aria-live="polite">
                        <div class="meta-row">
                            <i class="fas fa-clock-rotate-left"></i>
                            <span>Last updated</span>
                            <strong id="map-data-last-updated">--</strong>
                        </div>
                        <div class="meta-row">
                            <span class="status-pill" id="map-refresh-source">Waiting</span>
                            <div>
                                <i class="fas fa-arrows-rotate"></i>
                                <span>Next refresh in <strong id="map-refresh-countdown">--</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="map">
                        <div class="loading-message">
                            <div class="spinner"></div>
                            <div><strong>Loading Interactive Map...</strong></div>
                            <div class="text-muted">Initializing Leaflet map for {{ county_name }}{% if state_code %}, {{ state_code }}{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card legend-card">
                <div class="card-header">
                    <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                        <i class="fas fa-list text-primary"></i>
                        <span>Map Legend</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="legend">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <p class="text-uppercase small text-muted fw-semibold mb-2">Alert Severity</p>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #dc3545;"></div>
                                    <span>Extreme</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #fd7e14;"></div>
                                    <span>Severe</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #ffc107;"></div>
                                    <span>Moderate</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #17a2b8;"></div>
                                    <span>Minor</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <p class="text-uppercase small text-muted fw-semibold mb-2">Alert Status</p>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #28a745;"></div>
                                    <span>Active Alerts</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: repeating-linear-gradient(45deg, #6c757d, #6c757d 3px, transparent 3px, transparent 6px);"></div>
                                    <span>Historical Alerts</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <p class="text-uppercase small text-muted fw-semibold mb-2">Boundaries & Layers</p>
                                <div id="legend-boundary-layers" class="legend-dynamic"></div>
                                <div id="legend-boundary-empty" class="text-muted small">Layers will appear when data is loaded.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
console.log('ðŸ—ºï¸ Interactive map page initializing...');

// Global map variables
let map;
let alertLayer;
let boundaryLayers = {};
let alertData = { active: [], historical: [] };

const BOUNDARY_TYPE_CONFIG = window.BOUNDARY_TYPE_CONFIG || {};
const BOUNDARY_GROUP_LABELS = window.BOUNDARY_GROUP_LABELS || {};
const CUSTOM_BOUNDARY_PALETTE = ['#38bdf8', '#fb7185', '#845ef7', '#22c55e', '#f97316', '#14b8a6', '#facc15', '#64748b'];
const boundaryTypeMetadata = new Map();
const layerVisibility = {};
const customColorAssignments = {};

const LOCATION_SETTINGS = window.APP_LOCATION || {};
const MAP_CENTER = [
    Number(LOCATION_SETTINGS.map_center_lat ?? 0) || 0,
    Number(LOCATION_SETTINGS.map_center_lng ?? 0) || 0
];
const MAP_ZOOM = Number(LOCATION_SETTINGS.map_default_zoom ?? 10) || 10;
const LOCATION_LABEL = `${(LOCATION_SETTINGS.county_name || 'Configured Location')}${LOCATION_SETTINGS.state_code ? ', ' + LOCATION_SETTINGS.state_code : ''}`;

const AUTO_REFRESH_INTERVAL_MS = 5 * 60 * 1000;
let autoRefreshTimerId = null;
let refreshCountdownIntervalId = null;
let nextAutoRefreshAt = null;
let lastRefreshTimestamp = null;
let lastRefreshSource = 'Waiting';
let isMapReady = false;
let isRefreshInFlight = false;

function updateLastUpdateDisplays() {
    if (!lastRefreshTimestamp) {
        return;
    }

    const formattedTime = lastRefreshTimestamp.toLocaleTimeString();
    const metricElement = document.getElementById('last-update');
    const headerElement = document.getElementById('map-data-last-updated');
    const sourceElement = document.getElementById('map-refresh-source');

    if (metricElement) {
        metricElement.textContent = formattedTime;
    }

    if (headerElement) {
        headerElement.textContent = formattedTime;
        headerElement.setAttribute('title', lastRefreshTimestamp.toLocaleString());
    }

    if (sourceElement) {
        sourceElement.textContent = lastRefreshSource;
    }
}

function renderRefreshCountdown() {
    const countdownElement = document.getElementById('map-refresh-countdown');
    if (!countdownElement) {
        return;
    }

    if (isRefreshInFlight) {
        countdownElement.textContent = 'Refreshingâ€¦';
        return;
    }

    if (!nextAutoRefreshAt) {
        countdownElement.textContent = 'â€”';
        return;
    }

    const remaining = Math.max(0, nextAutoRefreshAt - Date.now());
    if (remaining === 0) {
        countdownElement.textContent = 'Refreshingâ€¦';
        return;
    }

    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function startCountdownTicker() {
    if (refreshCountdownIntervalId) {
        clearInterval(refreshCountdownIntervalId);
    }
    refreshCountdownIntervalId = setInterval(renderRefreshCountdown, 1000);
}

function markRefreshInProgress() {
    const countdownElement = document.getElementById('map-refresh-countdown');
    nextAutoRefreshAt = null;
    isRefreshInFlight = true;
    if (countdownElement) {
        countdownElement.textContent = 'Refreshingâ€¦';
    }
}

function scheduleAutoRefresh(delayMs = AUTO_REFRESH_INTERVAL_MS) {
    if (!isMapReady) {
        return;
    }
    isRefreshInFlight = false;
    if (autoRefreshTimerId) {
        clearTimeout(autoRefreshTimerId);
        autoRefreshTimerId = null;
    }
    nextAutoRefreshAt = Date.now() + delayMs;
    renderRefreshCountdown();
    startCountdownTicker();
    autoRefreshTimerId = setTimeout(() => {
        refreshData({ reason: 'Automatic refresh', showSpinner: false });
    }, delayMs);
}

function markDataRefreshed(source = 'Automatic refresh') {
    lastRefreshTimestamp = new Date();
    lastRefreshSource = source;
    updateLastUpdateDisplays();
}

// Boundary helpers
function sanitizeBoundaryType(value) {
    if (!value) {
        return 'unknown';
    }
    const sanitized = value.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '');
    return sanitized || 'unknown';
}

function resolveCanonicalBoundaryType(value) {
    const sanitized = sanitizeBoundaryType(value);
    for (const [key, config] of Object.entries(BOUNDARY_TYPE_CONFIG)) {
        const aliases = Array.isArray(config.aliases) ? config.aliases.map(alias => sanitizeBoundaryType(alias)) : [];
        if (sanitized === key || aliases.includes(sanitized)) {
            return key;
        }
    }
    return sanitized;
}

function formatBoundaryLabel(type) {
    const canonical = resolveCanonicalBoundaryType(type);
    const config = BOUNDARY_TYPE_CONFIG[canonical];
    if (config && config.label) {
        return config.label;
    }
    if (!canonical || canonical === 'unknown') {
        return 'Unknown Boundary';
    }
    return canonical.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
}

function assignCustomColor(typeKey) {
    if (customColorAssignments[typeKey]) {
        return customColorAssignments[typeKey];
    }
    const hash = Array.from(typeKey).reduce((acc, char) => acc + char.charCodeAt(0), 0);
    const color = CUSTOM_BOUNDARY_PALETTE[hash % CUSTOM_BOUNDARY_PALETTE.length];
    customColorAssignments[typeKey] = color;
    return color;
}

function getBoundaryMetadata(rawType, displayType, colorHint) {
    const canonical = resolveCanonicalBoundaryType(rawType);
    const config = BOUNDARY_TYPE_CONFIG[canonical];
    const label = displayType || (config && config.label) || formatBoundaryLabel(canonical);
    const group = config && config.group ? config.group : 'custom';
    const color = colorHint || (config && config.color) || assignCustomColor(canonical || 'custom');

    return {
        key: canonical,
        label,
        group,
        color,
        rawType: rawType,
    };
}

// Map initialization
async function initMap() {
    try {
        console.log(`ðŸ—ºï¸ Initializing Leaflet map for ${LOCATION_LABEL}...`);

        // Create map centered on configured location
        map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 8
        }).addTo(map);

        // Initialize layer groups
        alertLayer = L.layerGroup().addTo(map);
        boundaryLayers = {};

        // Add scale control
        L.control.scale({
            position: 'bottomleft'
        }).addTo(map);

        console.log('âœ… Map initialized successfully');
        updateMapStatus('Ready', 'success');

        // Load initial data
        await Promise.all([
            loadAlerts(),
            loadBoundaries(),
            updateSystemStatus()
        ]);
        isMapReady = true;
        markDataRefreshed('Initial load');

        // Set up event listeners
        setupEventListeners();

    } catch (error) {
        console.error('âŒ Error initializing map:', error);
        showMapError('Failed to initialize map: ' + error.message);
        updateMapStatus('Error', 'danger');
    }
}

// Load alerts from API
async function loadAlerts() {
    try {
        console.log('ðŸ“¡ Loading alerts from API...');
        const response = await fetch('/api/alerts');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();

        if (response.ok && data.features) {
            alertData.active = data.features;
            displayAlerts(data.features);
            updateAlertCount(data.features.length);
            updateAlertSummary(data.features);
            console.log(`âœ… Loaded ${data.features.length} alerts`);

            // Debug: Log the structure of the first alert if available
            if (data.features.length > 0) {
                console.log('ðŸ“‹ Sample alert structure:', data.features[0]);
            }
        } else {
            console.warn('âš ï¸ No alert features in API response:', data);
            updateAlertCount(0);
        }
    } catch (error) {
        console.error('âŒ Error loading alerts:', error);
        showToast('Failed to load alerts: ' + error.message, 'error');
        updateAlertCount(0);
    }
}

// Load historical alerts
async function loadHistoricalAlerts() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'warning');
        return;
    }

    try {
        const response = await fetch(`/api/alerts/historical?start=${startDate}&end=${endDate}`);
        const data = await response.json();

        if (response.ok && data.features) {
            alertData.historical = data.features;
            if (document.getElementById('show-expired').checked) {
                displayHistoricalAlerts(data.features);
            }
            showToast(`Loaded ${data.features.length} historical alerts`, 'success');
        }
    } catch (error) {
        console.error('âŒ Error loading historical alerts:', error);
        showToast('Failed to load historical alerts: ' + error.message, 'error');
    }
}

// Display alerts on map
function displayAlerts(alerts) {
    alertLayer.clearLayers();

    if (!alerts || alerts.length === 0) {
        console.log('â„¹ï¸ No alerts to display');
        return;
    }

    alerts.forEach(alert => {
        if (alert.geometry) {
            const severity = alert.properties.severity || 'Unknown';
            const color = getSeverityColor(severity);
            const isActive = !isAlertExpired(alert.properties.expires);

            const alertFeature = L.geoJSON(alert, {
                style: {
                    color: color,
                    weight: alert.properties.is_county_wide ? 4 : 3,
                    opacity: isActive ? 0.8 : 0.5,
                    fillOpacity: alert.properties.is_county_wide ? 0.3 : 0.4,
                    fillColor: color,
                    dashArray: alert.properties.is_county_wide ? '10,5' : null,
                    className: isActive ? 'alert-active' : 'alert-expired'
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = createAlertPopup(props);
                    layer.bindPopup(popupContent, { maxWidth: 300 });
                }
            });

            alertLayer.addLayer(alertFeature);
        }
    });

    console.log(`âœ… Displayed ${alerts.length} alerts on map`);
}

// Display historical alerts
function displayHistoricalAlerts(alerts) {
    alerts.forEach(alert => {
        if (alert.geometry) {
            const alertFeature = L.geoJSON(alert, {
                style: {
                    color: '#6c757d',
                    weight: 2,
                    opacity: 0.6,
                    fillOpacity: 0.1,
                    fillColor: '#6c757d',
                    dashArray: '5,5',
                    className: 'alert-expired'
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = createHistoricalAlertPopup(props);
                    layer.bindPopup(popupContent, { maxWidth: 300 });
                }
            });

            alertLayer.addLayer(alertFeature);
        }
    });
}

// Load boundaries
async function loadBoundaries() {
    try {
        console.log('ðŸ“¡ Loading boundaries from API...');
        const response = await fetch('/api/boundaries');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();
        const newKeys = new Set();
        let totalLoaded = 0;
        boundaryTypeMetadata.clear();

        if (data.features && Array.isArray(data.features) && data.features.length > 0) {
            console.log(`âœ… Received ${data.features.length} boundaries`);

            const featuresByType = new Map();

            data.features.forEach(feature => {
                const props = feature.properties || {};
                const rawType = props.canonical_type || props.type || props.raw_type || 'unknown';
                const metadata = getBoundaryMetadata(rawType, props.display_type, props.color);
                const typeKey = metadata.key || 'unknown';

                if (!featuresByType.has(typeKey)) {
                    featuresByType.set(typeKey, { metadata, features: [] });
                }
                featuresByType.get(typeKey).features.push(feature);
            });

            featuresByType.forEach(({ metadata, features }) => {
                const typeKey = metadata.key || 'unknown';
                newKeys.add(typeKey);
                totalLoaded += features.length;

                let layerGroup = boundaryLayers[typeKey];
                if (!layerGroup) {
                    layerGroup = L.layerGroup();
                    boundaryLayers[typeKey] = layerGroup;
                } else {
                    layerGroup.clearLayers();
                }

                const boundaryFeature = L.geoJSON(features, {
                    style: {
                        color: metadata.color,
                        weight: 1,
                        opacity: 0.6,
                        fillOpacity: 0.1,
                        fillColor: metadata.color
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties || {};
                        const popupContent = createBoundaryPopup(props, typeKey);
                        layer.bindPopup(popupContent);
                    }
                });

                layerGroup.addLayer(boundaryFeature);

                if (layerVisibility[typeKey] !== false) {
                    layerVisibility[typeKey] = true;
                    layerGroup.addTo(map);
                } else {
                    map.removeLayer(layerGroup);
                }

                boundaryTypeMetadata.set(typeKey, {
                    key: typeKey,
                    label: metadata.label,
                    color: metadata.color,
                    group: metadata.group || 'custom',
                    count: features.length
                });

                console.log(`âœ… Loaded ${features.length} ${metadata.label} features`);
            });
        } else {
            console.warn('âš ï¸ No boundary features in API response');
        }

        Object.keys(boundaryLayers).forEach(key => {
            if (!newKeys.has(key)) {
                map.removeLayer(boundaryLayers[key]);
                delete boundaryLayers[key];
                boundaryTypeMetadata.delete(key);
                delete layerVisibility[key];
            }
        });

        renderBoundaryControls();
        renderBoundaryLegend();
        updateBoundaryCount(totalLoaded);
    } catch (error) {
        console.error('âŒ Error loading boundaries:', error);
        showToast('Failed to load boundaries: ' + error.message, 'error');
        updateBoundaryCount(0);
        boundaryTypeMetadata.clear();
        renderBoundaryControls();
        renderBoundaryLegend();
    }
}

function renderBoundaryControls() {
    const containers = {
        geographic: document.getElementById('layer-group-geographic'),
        service: document.getElementById('layer-group-service'),
        infrastructure: document.getElementById('layer-group-infrastructure'),
        hydrography: document.getElementById('layer-group-hydrography'),
        custom: document.getElementById('layer-group-custom')
    };

    Object.values(containers).forEach(container => {
        if (container) {
            container.innerHTML = '';
        }
    });

    const entries = Array.from(boundaryTypeMetadata.values()).sort((a, b) => a.label.localeCompare(b.label));

    entries.forEach(meta => {
        const groupKey = containers[meta.group] ? meta.group : 'custom';
        const container = containers[groupKey] || containers.custom;
        if (!container) {
            return;
        }

        const checkboxId = `layer-toggle-${meta.key}`;
        const isChecked = layerVisibility[meta.key] !== false;

        const wrapper = document.createElement('div');
        wrapper.className = 'form-check form-switch layer-toggle';

        const checkbox = document.createElement('input');
        checkbox.className = 'form-check-input';
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.checked = isChecked;
        checkbox.setAttribute('role', 'switch');
        checkbox.setAttribute('aria-checked', String(isChecked));

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', checkboxId);

        const swatch = document.createElement('span');
        swatch.className = 'layer-swatch';
        swatch.style.backgroundColor = meta.color;

        const labelText = document.createElement('span');
        labelText.textContent = meta.label;

        const countWrapper = document.createElement('span');
        countWrapper.className = 'ms-auto text-muted small';
        countWrapper.innerHTML = `(<span data-type-count="${meta.key}">${meta.count}</span>)`;

        label.appendChild(swatch);
        label.appendChild(labelText);
        label.appendChild(countWrapper);

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        container.appendChild(wrapper);

        checkbox.addEventListener('change', function() {
            this.setAttribute('aria-checked', String(this.checked));
            layerVisibility[meta.key] = this.checked;
            if (this.checked) {
                if (boundaryLayers[meta.key]) {
                    boundaryLayers[meta.key].addTo(map);
                }
            } else if (boundaryLayers[meta.key]) {
                map.removeLayer(boundaryLayers[meta.key]);
            }
        });
    });

    Object.entries(containers).forEach(([groupKey, container]) => {
        if (!container) {
            return;
        }

        if (!container.children.length) {
            const empty = document.createElement('div');
            empty.className = 'empty-placeholder';
            const groupLabel = BOUNDARY_GROUP_LABELS[groupKey] || 'Layers';
            const labelText = typeof groupLabel === 'string' ? groupLabel.toLowerCase() : 'layers';
            empty.textContent = `No ${labelText} loaded`;
            container.appendChild(empty);
        }
    });
}

function renderBoundaryLegend() {
    const container = document.getElementById('legend-boundary-layers');
    const emptyMessage = document.getElementById('legend-boundary-empty');

    if (!container || !emptyMessage) {
        return;
    }

    container.innerHTML = '';

    const entries = Array.from(boundaryTypeMetadata.values())
        .filter(meta => meta.count > 0)
        .sort((a, b) => a.label.localeCompare(b.label));

    if (entries.length === 0) {
        emptyMessage.style.display = 'block';
        return;
    }

    emptyMessage.style.display = 'none';

    entries.forEach(meta => {
        const item = document.createElement('div');
        item.className = 'legend-item';

        const swatch = document.createElement('div');
        swatch.className = 'legend-color';
        swatch.style.backgroundColor = meta.color;

        const label = document.createElement('span');
        label.textContent = `${meta.label} (${meta.count})`;

        item.appendChild(swatch);
        item.appendChild(label);
        container.appendChild(item);
    });
}

// Create alert popup content
function createAlertPopup(props) {
    const severityClass = `severity-${(props.severity || 'unknown').toLowerCase()}`;
    const isActive = !isAlertExpired(props.expires);
    const statusBadge = isActive ?
        '<span class="popup-badge" style="background: #28a745; color: white;">ACTIVE</span>' :
        '<span class="popup-badge" style="background: #6c757d; color: white;">EXPIRED</span>';

    return `
        <div class="popup-title">${props.event || 'Unknown Event'}</div>
        <div class="popup-detail">
            <span class="popup-badge ${severityClass}">${props.severity || 'Unknown'}</span>
            ${statusBadge}
            ${props.is_county_wide ? '<span class="popup-badge" style="background: #17a2b8; color: white;">COUNTY-WIDE</span>' : ''}
        </div>
        <div class="popup-detail"><strong>Area:</strong> ${props.area_desc || 'Unknown'}</div>
        <div class="popup-detail"><strong>Effective:</strong> ${props.effective ? new Date(props.effective).toLocaleString() : 'Unknown'}</div>
        <div class="popup-detail"><strong>Expires:</strong> ${props.expires ? new Date(props.expires).toLocaleString() : 'Unknown'}</div>
        ${props.headline ? `<div class="popup-detail"><strong>Headline:</strong> ${props.headline}</div>` : ''}
        <div class="mt-2">
            <a href="/alerts/${props.id}" class="btn btn-sm btn-primary">View Details</a>
        </div>
    `;
}

// Create historical alert popup content
function createHistoricalAlertPopup(props) {
    return `
        <div class="popup-title">
            ${props.event || 'Unknown Event'}
            <span class="historical-badge">Historical</span>
        </div>
        <div class="popup-detail"><strong>Severity:</strong> ${props.severity || 'Unknown'}</div>
        <div class="popup-detail"><strong>Area:</strong> ${props.area_desc || 'Unknown'}</div>
        <div class="popup-detail"><strong>Date:</strong> ${props.effective ? new Date(props.effective).toLocaleDateString() : 'Unknown'}</div>
        <div class="mt-2">
            <a href="/alerts/${props.id}" class="btn btn-sm btn-outline-secondary">View Details</a>
        </div>
    `;
}

// Create boundary popup content
function createBoundaryPopup(props, type) {
    const displayType = props.display_type || formatBoundaryLabel(props.type || type);
    return `
        <div class="popup-title">${props.name || 'Unnamed'}</div>
        <div class="popup-detail"><strong>Type:</strong> ${displayType}</div>
        <div class="popup-detail"><strong>ID:</strong> ${props.id}</div>
        ${props.description ? `<div class="popup-detail"><strong>Description:</strong> ${props.description}</div>` : ''}
        ${props.population ? `<div class="popup-detail"><strong>Population:</strong> ${props.population.toLocaleString()}</div>` : ''}
        ${props.area ? `<div class="popup-detail"><strong>Area:</strong> ${props.area} sq mi</div>` : ''}
    `;
}

// Utility functions
function getSeverityColor(severity) {
    const colors = {
        'Extreme': '#dc3545',
        'Severe': '#fd7e14',
        'Moderate': '#ffc107',
        'Minor': '#17a2b8'
    };
    return colors[severity] || '#6c757d';
}

function isAlertExpired(expiresDate) {
    if (!expiresDate) return false;
    return new Date(expiresDate) < new Date();
}

// Update UI functions
function updateMapStatus(status, type) {
    const badge = document.getElementById('map-status-badge');
    const statusElement = document.getElementById('map-status');

    if (badge) {
        badge.textContent = status;
        badge.className = `badge bg-${type} ms-2`;
    }

    if (statusElement) {
        statusElement.textContent = status;
    }
}

function updateAlertCount(count) {
    const element = document.getElementById('active-alert-count');
    if (element) {
        element.textContent = count;
    }
}

function updateBoundaryCount(count) {
    const element = document.getElementById('boundary-count');
    if (element) {
        element.textContent = count;
    }
}

function updateAlertSummary(alerts) {
    const summaryElement = document.getElementById('alert-summary');
    const placeholder = document.getElementById('alert-summary-placeholder');

    if (!summaryElement) {
        return;
    }

    if (!alerts || alerts.length === 0) {
        summaryElement.innerHTML = '';
        summaryElement.style.display = 'none';
        if (placeholder) {
            placeholder.style.display = 'block';
        }
        return;
    }

    const activeCounts = {};
    alerts.forEach(alert => {
        const event = alert.properties.event || 'Unknown';
        activeCounts[event] = (activeCounts[event] || 0) + 1;
    });

    const summaryHtml = Object.entries(activeCounts)
        .map(([event, count]) => `<div><strong>${event}:</strong> ${count}</div>`)
        .join('');

    summaryElement.innerHTML = `<h6 class="mb-2">Active Alerts by Type</h6>${summaryHtml}`;
    summaryElement.style.display = 'block';

    if (placeholder) {
        placeholder.style.display = 'none';
    }
}

async function updateSystemStatus() {
    try {
        const response = await fetch('/api/system_status');
        if (response.ok) {
            const data = await response.json();
            console.log('âœ… System status updated:', data);
            // Update any additional system status here if needed
        }
    } catch (error) {
        console.warn('Could not fetch system status:', error);
    }
}

// Event handlers
function setupEventListeners() {
    // Layer toggles
    document.getElementById('show-active').addEventListener('change', function() {
        if (this.checked && alertData.active) {
            displayAlerts(alertData.active);
        } else if (!this.checked) {
            alertLayer.clearLayers();
        }
    });

    document.getElementById('show-expired').addEventListener('change', function() {
        const dateFilters = document.getElementById('date-filters');
        if (this.checked) {
            dateFilters.style.display = 'block';
            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        } else {
            dateFilters.style.display = 'none';
            // Remove historical alerts from map
            if (alertData.active) {
                displayAlerts(alertData.active);
            }
        }
    });

}

// Action functions
async function refreshData(options = {}) {
    if (!isMapReady) {
        console.warn('Map is not ready yet; skipping refresh request.');
        return;
    }

    const {
        includeBoundaries = false,
        reason = 'Manual refresh',
        showSpinner = true
    } = options;
    const refreshBtn = document.getElementById('refresh-icon');
    if (refreshBtn && showSpinner) {
        refreshBtn.classList.add('fa-spin');
    }

    if (autoRefreshTimerId) {
        clearTimeout(autoRefreshTimerId);
        autoRefreshTimerId = null;
    }
    markRefreshInProgress();

    try {
        const tasks = [
            loadAlerts(),
            updateSystemStatus()
        ];

        if (includeBoundaries) {
            tasks.push(loadBoundaries());
        }

        await Promise.all(tasks);
        markDataRefreshed(reason);
        showToast('Map data refreshed successfully', 'success');
    } catch (error) {
        showToast('Failed to refresh data', 'error');
        console.error('Refresh failed:', error);
    } finally {
        scheduleAutoRefresh();
        if (refreshBtn && showSpinner) {
            refreshBtn.classList.remove('fa-spin');
        }
    }
}

function centerOnConfiguredLocation() {
    if (map) {
        map.setView(MAP_CENTER, MAP_ZOOM);
        showToast(`Map centered on ${LOCATION_LABEL}`, 'info');
    }
}

async function inspectBoundaries() {
    try {
        console.log('ðŸ” Inspecting boundaries...');
        const response = await fetch('/api/boundaries');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();

        if (data.features && Array.isArray(data.features)) {
            // Group boundaries by type for inspection
            const boundariesByType = {};
            data.features.forEach(boundary => {
                const props = boundary.properties || {};
                const typeKey = resolveCanonicalBoundaryType(props.canonical_type || props.type || props.raw_type || 'unknown');
                const displayLabel = props.display_type || formatBoundaryLabel(typeKey);
                if (!boundariesByType[typeKey]) {
                    boundariesByType[typeKey] = {
                        label: displayLabel,
                        items: []
                    };
                }
                boundariesByType[typeKey].items.push({
                    id: props.id,
                    name: props.name,
                    description: props.description,
                    type: displayLabel
                });
            });

            // Sort types for better display
            const sortedTypes = Object.keys(boundariesByType).sort((a, b) => {
                const labelA = boundariesByType[a].label.toLowerCase();
                const labelB = boundariesByType[b].label.toLowerCase();
                return labelA.localeCompare(labelB);
            });

            // Create inspection report
            let report = `ðŸ“Š COMPREHENSIVE BOUNDARY INSPECTION REPORT\n`;
            report += `=========================================================\n`;
            report += `Total Boundaries: ${data.features.length}\n`;
            report += `Boundary Types: ${sortedTypes.length}\n`;
            report += `Generated: ${new Date().toLocaleString()}\n\n`;

            // Summary by type
            report += `SUMMARY BY TYPE:\n`;
            report += `================\n`;
            sortedTypes.forEach(type => {
                const group = boundariesByType[type];
                const count = group.items.length;
                report += `${group.label.toUpperCase()}: ${count}\n`;
            });
            report += `\n`;

            // Detailed listings
            sortedTypes.forEach(type => {
                const group = boundariesByType[type];
                const boundaries = group.items;
                report += `${group.label.toUpperCase()} DETAILS (${boundaries.length}):\n`;
                report += `${'='.repeat(group.label.length + 15)}\n`;
                boundaries.forEach((boundary, index) => {
                    report += `  ${index + 1}. ${boundary.name} (ID: ${boundary.id})\n`;
                    if (boundary.description) {
                        report += `     Description: ${boundary.description}\n`;
                    }
                });
                report += `\n`;
            });

            // Show in console
            console.log(report);

            // Create enhanced inspection window
            const inspectionWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            inspectionWindow.document.write(`
                <html>
                <head>
                    <title>Comprehensive Boundary Inspection Report</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            padding: 20px;
                            background: #f5f5f5;
                            margin: 0;
                        }
                        .report {
                            background: white;
                            padding: 30px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            max-width: 1000px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #007bff;
                            border-bottom: 3px solid #007bff;
                            padding-bottom: 10px;
                        }
                        .summary {
                            background: #e9ecef;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .summary h2 {
                            color: #28a745;
                            margin-top: 0;
                        }
                        .type-section {
                            margin-bottom: 30px;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            padding: 20px;
                        }
                        .type-header {
                            font-weight: bold;
                            color: #dc3545;
                            margin-bottom: 15px;
                            font-size: 1.2em;
                            border-bottom: 2px solid #dc3545;
                            padding-bottom: 5px;
                        }
                        .boundary-item {
                            margin-left: 20px;
                            margin-bottom: 10px;
                            padding: 8px;
                            background: #f8f9fa;
                            border-radius: 4px;
                        }
                        .boundary-name {
                            font-weight: bold;
                            color: #007bff;
                        }
                        .boundary-id {
                            color: #6c757d;
                            font-size: 0.9em;
                        }
                        .description {
                            color: #495057;
                            font-style: italic;
                            margin-top: 5px;
                            padding: 5px;
                            background: white;
                            border-radius: 4px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .stat-box {
                            background: #007bff;
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .stat-number {
                            font-size: 2em;
                            font-weight: bold;
                            display: block;
                        }
                        .stat-label {
                            font-size: 0.9em;
                            opacity: 0.9;
                        }
                        @media print {
                            body { background: white; }
                            .report { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="report">
                        <h1>ðŸ—ºï¸ Comprehensive Boundary Inspection Report</h1>

                        <div class="summary">
                            <h2>ðŸ“Š System Overview</h2>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <span class="stat-number">${data.features.length}</span>
                                    <span class="stat-label">Total Boundaries</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">${sortedTypes.length}</span>
                                    <span class="stat-label">Boundary Types</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">${new Date().toLocaleDateString()}</span>
                                    <span class="stat-label">Report Date</span>
                                </div>
                            </div>
                        </div>

                        <div class="summary">
                            <h2>ðŸ“ˆ Type Distribution</h2>
                            ${sortedTypes.map(type => {
                                const count = boundariesByType[type].length;
                                const percentage = ((count / data.features.length) * 100).toFixed(1);
                                return `<div><strong>${type.toUpperCase()}:</strong> ${count} boundaries (${percentage}%)</div>`;
                            }).join('')}
                        </div>

                        ${sortedTypes.map(type => {
                            const boundaries = boundariesByType[type];
                            const typeColors = {
                                'county': '#6c757d', 'township': '#28a745', 'village': '#17a2b8',
                                'fire': '#dc3545', 'ems': '#007bff', 'school': '#ffc107',
                                'electric': '#fd7e14', 'telephone': '#6f42c1'
                            };
                            const color = typeColors[type.toLowerCase()] || '#6c757d';

                            return `
                                <div class="type-section">
                                    <div class="type-header" style="color: ${color}; border-bottom-color: ${color};">
                                        ${type.toUpperCase()} BOUNDARIES (${boundaries.length})
                                    </div>
                                    ${boundaries.map((boundary, index) => `
                                        <div class="boundary-item">
                                            <div class="boundary-name">${boundary.name}</div>
                                            <div class="boundary-id">ID: ${boundary.id} | Type: ${boundary.type}</div>
                                            ${boundary.description ? `<div class="description">${boundary.description}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('')}

                        <div class="summary">
                            <p><strong>ðŸ“ System Location:</strong> ${LOCATION_LABEL} EAS Station</p>
                            <p><strong>ðŸ”§ Generated by:</strong> EAS Station Alert System</p>
                            <p><small>This comprehensive report shows all boundary data available in the EAS station database.</small></p>
                        </div>
                    </div>
                </body>
                </html>
            `);

            showToast(`Comprehensive boundary inspection complete: ${data.features.length} boundaries across ${sortedTypes.length} types`, 'success');

        } else {
            showToast('No boundaries found in system', 'warning');
        }
    } catch (error) {
        console.error('âŒ Error inspecting boundaries:', error);
        showToast('Failed to inspect boundaries: ' + error.message, 'error');
    }
}

// Error handling
function showMapError(message) {
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="map-error">
                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                <h4>Map Loading Error</h4>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    <i class="fas fa-redo"></i> Reload Page
                </button>
            </div>
        `;
    }
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ðŸ“„ Interactive map page loaded');

    try {
        await initMap();
        if (isMapReady) {
            scheduleAutoRefresh();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    refreshData({ includeBoundaries: true, reason: 'Keyboard shortcut' });
                }
            }
        });

    } catch (error) {
        console.error('âŒ Error initializing page:', error);
        showMapError('Failed to initialize map interface: ' + error.message);
    }
});

console.log('ðŸ“œ Interactive map script loaded');

// Make diagnostic functions available globally for debugging
window.mapDebug = {
    testAPIs: async function() {
        console.log('ðŸ” Testing all API endpoints...');

        const endpoints = [
            '/api/alerts',
            '/api/boundaries',
            '/api/system_status'
        ];

        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                console.log(`âœ… ${endpoint}: ${response.status}`, data);
            } catch (error) {
                console.error(`âŒ ${endpoint}: ${error.message}`);
            }
        }
    },

    refreshAll: function() {
        console.log('ðŸ”„ Refreshing all map data...');
        refreshData({ includeBoundaries: true, reason: 'Debug refresh' });
    },

    inspectMap: function() {
        console.log('ðŸ—ºï¸ Map inspection:');
        console.log('Map object:', map);
        console.log('Alert layer:', alertLayer);
        console.log('Boundary layers:', boundaryLayers);
        console.log('Alert data:', alertData);
    },

    analyzeBoundaries: async function() {
        console.log('ðŸ“Š Analyzing boundary data...');
        try {
            const response = await fetch('/api/boundaries');
            const data = await response.json();

            if (data.features) {
                const analysis = {};
                data.features.forEach(boundary => {
                    const props = boundary.properties || {};
                    const typeKey = resolveCanonicalBoundaryType(props.canonical_type || props.type || props.raw_type || 'unknown');
                    if (!analysis[typeKey]) {
                        analysis[typeKey] = { count: 0, examples: [], label: formatBoundaryLabel(typeKey) };
                    }
                    analysis[typeKey].count++;
                    if (analysis[typeKey].examples.length < 3) {
                        analysis[typeKey].examples.push({
                            name: props.name,
                            id: props.id
                        });
                    }
                });

                console.log('ðŸ“‹ Boundary Analysis:');
                const tableData = Object.entries(analysis).map(([key, info]) => ({
                    type: info.label || formatBoundaryLabel(key),
                    count: info.count,
                    examples: info.examples.map(example => example.name).join(', ')
                }));
                console.table(tableData);
                return analysis;
            }
        } catch (error) {
            console.error('âŒ Analysis failed:', error);
        }
    }
};

console.log('ðŸ’¡ Debug functions available:');
console.log('  â€¢ window.mapDebug.testAPIs() - Test all API endpoints');
console.log('  â€¢ window.mapDebug.refreshAll() - Refresh all map data');
console.log('  â€¢ window.mapDebug.inspectMap() - Inspect map objects');
console.log('  â€¢ window.mapDebug.analyzeBoundaries() - Analyze boundary types');

// Audio Health Widget
async function updateAudioHealth() {
    try {
        const response = await fetch('/api/audio/health');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const health = await response.json();

        const healthElement = document.getElementById('audio-health');
        const statusElement = document.getElementById('audio-sources-status');

        if (healthElement) {
            healthElement.innerHTML = `${health.health_score}<span style="font-size: 0.9rem; font-weight: normal; color: var(--text-muted);">%</span>`;

            // Color code based on health score
            if (health.health_score >= 80) {
                healthElement.style.color = '#2eb08d';
            } else if (health.health_score >= 50) {
                healthElement.style.color = '#f6b968';
            } else {
                healthElement.style.color = '#e05263';
            }
        }

        if (statusElement) {
            const activeText = health.active_sources === 1 ? 'source' : 'sources';
            statusElement.textContent = `${health.active_sources} ${activeText} active`;
        }
    } catch (error) {
        console.error('Failed to update audio health:', error);
        const healthElement = document.getElementById('audio-health');
        const statusElement = document.getElementById('audio-sources-status');

        if (healthElement) {
            healthElement.textContent = 'â€”';
            healthElement.style.color = 'var(--text-muted)';
        }
        if (statusElement) {
            statusElement.textContent = 'Unavailable';
        }
    }
}

// Update audio health periodically (every 2 seconds for real-time monitoring)
updateAudioHealth();
// REDUCED: 30 seconds instead of 5 seconds - health status doesn't change rapidly
setInterval(updateAudioHealth, 30000);

// ===== SNOW EMERGENCY FUNCTIONS =====

let snowEmergencyData = { emergencies: [], levels: {} };

async function loadSnowEmergencies() {
    try {
        const response = await fetch('/api/snow_emergencies');
        if (!response.ok) {
            console.warn('Snow emergencies API not available');
            return;
        }
        const data = await response.json();
        snowEmergencyData = data;
        renderSnowEmergencyBanner(data);
    } catch (error) {
        console.warn('Failed to load snow emergencies:', error);
    }
}

function renderSnowEmergencyBanner(data) {
    const banner = document.getElementById('snow-emergency-banner');
    const grid = document.getElementById('snow-emergency-grid');
    
    if (!banner || !grid) return;
    
    const activeEmergencies = (data.emergencies || []).filter(e => e.level > 0);
    
    if (activeEmergencies.length === 0) {
        banner.style.display = 'none';
        banner.classList.remove('has-emergencies');
        return;
    }
    
    banner.style.display = 'block';
    banner.classList.add('has-emergencies');
    
    grid.innerHTML = activeEmergencies.map(e => `
        <div class="snow-county-card level-${e.level}">
            <span class="snow-county-name">${escapeHtml(e.county_name)}</span>
            <span class="snow-level-badge level-${e.level}">${escapeHtml(e.level_name)}</span>
        </div>
    `).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function openSnowEmergencyModal() {
    // Load all counties for editing
    try {
        const response = await fetch('/api/snow_emergencies/all');
        if (!response.ok) {
            showToast('Failed to load snow emergency data', 'error');
            return;
        }
        const data = await response.json();
        showSnowEmergencyModal(data);
    } catch (error) {
        console.error('Failed to load snow emergencies for editing:', error);
        showToast('Failed to load snow emergency data', 'error');
    }
}

function showSnowEmergencyModal(data) {
    // Remove existing modal if present
    const existingModal = document.getElementById('snowEmergencyModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const levels = data.levels || {
        0: { name: 'None', color: '#28a745' },
        1: { name: 'Level 1', color: '#ffc107' },
        2: { name: 'Level 2', color: '#fd7e14' },
        3: { name: 'Level 3', color: '#dc3545' }
    };
    
    const modalHtml = `
        <div class="modal fade" id="snowEmergencyModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-snowflake text-info me-2"></i>
                            Snow Emergency Levels
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Level Explanations -->
                        <div class="accordion mb-3" id="snowLevelAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#snowLevelInfo">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small><strong>What do the levels mean?</strong></small>
                                    </button>
                                </h2>
                                <div id="snowLevelInfo" class="accordion-collapse collapse" data-bs-parent="#snowLevelAccordion">
                                    <div class="accordion-body py-2 small">
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <span class="badge bg-success me-1">None</span>
                                                Normal conditions
                                            </div>
                                            <div class="col-6">
                                                <span class="badge bg-warning text-dark me-1">Level 1</span>
                                                Hazardous - drive cautiously
                                            </div>
                                            <div class="col-6">
                                                <span class="badge me-1" style="background-color: #fd7e14;">Level 2</span>
                                                Only necessary travel
                                            </div>
                                            <div class="col-6">
                                                <span class="badge bg-danger me-1">Level 3</span>
                                                Roads closed - emergency only
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="snow-edit-counties">
                            \${(data.emergencies || []).map(e => renderCountyEditor(e, levels)).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="/admin#snow-emergencies" class="btn btn-outline-info btn-sm me-auto">
                            <i class="fas fa-cog"></i> Full Settings
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('snowEmergencyModal'));
    modal.show();
    
    // Add event listeners for radio buttons
    document.querySelectorAll('.snow-level-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', handleSnowLevelChange);
    });
}

function renderCountyEditor(emergency, levels) {
    const currentLevel = emergency.level || 0;
    const isPrimary = emergency.is_primary || false;
    
    return `
        <div class="snow-edit-county" data-fips="${escapeHtml(emergency.county_fips)}">
            <div class="snow-edit-county-name">
                ${escapeHtml(emergency.county_name)} County
                ${isPrimary ? '<span class="primary-badge">Primary</span>' : ''}
            </div>
            <div class="snow-level-options">
                ${[0, 1, 2, 3].map(level => {
                    const levelInfo = levels[level] || { name: `Level ${level}` };
                    const isSelected = currentLevel === level;
                    return `
                        <label class="snow-level-option ${isSelected ? 'selected' : ''}" data-level="${level}">
                            <input type="radio" name="snow-level-${emergency.county_fips}" 
                                   value="${level}" ${isSelected ? 'checked' : ''}
                                   data-fips="${escapeHtml(emergency.county_fips)}">
                            ${escapeHtml(levelInfo.name)}
                        </label>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

async function handleSnowLevelChange(event) {
    const radio = event.target;
    const fips = radio.dataset.fips;
    const newLevel = parseInt(radio.value, 10);
    
    // Update visual selection
    const container = radio.closest('.snow-edit-county');
    container.querySelectorAll('.snow-level-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    radio.closest('.snow-level-option').classList.add('selected');
    
    try {
        const response = await fetch(`/api/snow_emergencies/${fips}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ level: newLevel }),
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update');
        }
        
        const result = await response.json();
        console.log('Snow emergency updated:', result);
        
        // Refresh the banner
        loadSnowEmergencies();
        
        showToast(`${result.emergency.county_name} County updated to ${result.emergency.level_name}`, 'success');
        
    } catch (error) {
        console.error('Failed to update snow emergency:', error);
        showToast('Failed to update snow emergency: ' + error.message, 'error');
        
        // Revert the radio button
        loadSnowEmergencies();
    }
}

// Load snow emergencies on page load and periodically
loadSnowEmergencies();
setInterval(loadSnowEmergencies, 60000); // Refresh every minute
</script>
{% endblock %}