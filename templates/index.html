{% extends "base.html" %}

{% block title %}Interactive Map - KR8MER CAP Emergency Alert System{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px var(--shadow-color);
    }

    .map-controls {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px var(--shadow-color);
    }

    .status-panel {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px var(--shadow-color);
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .status-item:last-child {
        border-bottom: none;
    }

    .status-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .alert-summary {
        background: var(--light-color);
        border-radius: 5px;
        padding: 15px;
        margin-top: 15px;
    }

    .layer-group {
        margin-bottom: 15px;
    }

    .layer-group h6 {
        color: var(--text-color);
        margin-bottom: 10px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-check {
        margin-bottom: 8px;
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .legend {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }

    .legend h6 {
        color: var(--primary-color);
        margin-bottom: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 10px;
        border: 1px solid var(--border-color);
    }

    .loading-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 600px;
        color: var(--secondary-color);
        flex-direction: column;
        background: var(--light-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .map-error {
        text-align: center;
        color: var(--danger-color);
        padding: 40px;
        background: var(--light-color);
        border-radius: 8px;
        border: 1px solid var(--danger-color);
    }

    .historical-badge {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: white;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 8px;
        margin-left: 5px;
    }

    #date-filters {
        background: var(--light-color);
        border-radius: 6px;
        padding: 15px;
        border: 1px solid var(--border-color);
        margin-top: 10px;
    }

    .btn-outline-success:hover {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .alert-active {
        border: 2px solid var(--danger-color) !important;
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .alert-expired {
        border: 2px solid var(--secondary-color) !important;
        background-color: rgba(108, 117, 125, 0.1) !important;
        opacity: 0.7;
    }

    /* Leaflet popup customization */
    .leaflet-popup-content {
        max-width: 300px;
    }

    .popup-title {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .popup-detail {
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    .popup-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        margin: 2px;
    }

    .severity-extreme { background: #dc3545; color: white; }
    .severity-severe { background: #fd7e14; color: white; }
    .severity-moderate { background: #ffc107; color: black; }
    .severity-minor { background: #17a2b8; color: white; }
    .severity-unknown { background: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- Control Panel -->
        <div class="col-md-3">
            <!-- Map Controls -->
            <div class="status-panel">
                <h5 class="mb-3">
                    <i class="fas fa-layer-group"></i> Map Layers
                </h5>

                <!-- Alert Layers -->
                <div class="layer-group">
                    <h6><i class="fas fa-exclamation-triangle"></i> Alert Types</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-active" checked>
                        <label class="form-check-label" for="show-active">
                            <i class="fas fa-circle text-danger"></i> Active Alerts
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-expired">
                        <label class="form-check-label" for="show-expired">
                            <i class="fas fa-circle text-secondary"></i> Historical Alerts
                        </label>
                    </div>
                </div>

                <!-- Boundary Layers -->
                <div class="layer-group">
                    <h6><i class="fas fa-map-marked-alt"></i> Geographic Boundaries</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-counties" checked>
                        <label class="form-check-label" for="show-counties">
                            <i class="fas fa-square text-secondary"></i> Counties (<span id="counties-count">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-townships">
                        <label class="form-check-label" for="show-townships">
                            <i class="fas fa-square text-success"></i> Townships (<span id="townships-count">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-villages">
                        <label class="form-check-label" for="show-villages">
                            <i class="fas fa-square text-info"></i> Villages (<span id="villages-count">0</span>)
                        </label>
                    </div>
                </div>

                <!-- Service Boundaries -->
                <div class="layer-group">
                    <h6><i class="fas fa-shield-alt"></i> Service Boundaries</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-fire">
                        <label class="form-check-label" for="show-fire">
                            <i class="fas fa-square text-danger"></i> Fire Districts (<span id="fire-count">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-ems">
                        <label class="form-check-label" for="show-ems">
                            <i class="fas fa-square text-primary"></i> EMS Districts (<span id="ems-count">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-school">
                        <label class="form-check-label" for="show-school">
                            <i class="fas fa-square text-warning"></i> School Districts (<span id="school-count">0</span>)
                        </label>
                    </div>
                </div>

                <!-- Infrastructure Boundaries -->
                <div class="layer-group">
                    <h6><i class="fas fa-tools"></i> Infrastructure</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-electric">
                        <label class="form-check-label" for="show-electric">
                            <i class="fas fa-square" style="color: #ffc107;"></i> Electric Utilities (<span id="electric-count">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-telephone">
                        <label class="form-check-label" for="show-telephone">
                            <i class="fas fa-square" style="color: #6f42c1;"></i> Telephone Service (<span id="telephone-count">0</span>)
                        </label>
                    </div>
                </div>

                <!-- Date Filters for Historical -->
                <div id="date-filters" style="display: none;">
                    <h6><i class="fas fa-calendar-alt"></i> Date Range</h6>
                    <div class="mb-2">
                        <label for="start-date" class="form-label small">From:</label>
                        <input type="date" class="form-control form-control-sm" id="start-date">
                    </div>
                    <div class="mb-2">
                        <label for="end-date" class="form-label small">To:</label>
                        <input type="date" class="form-control form-control-sm" id="end-date">
                    </div>
                    <button class="btn btn-primary btn-sm w-100" onclick="loadHistoricalAlerts()">
                        <i class="fas fa-search"></i> Apply Filter
                    </button>
                </div>
            </div>

            <!-- System Status -->
            <div class="status-panel">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle"></i> System Status
                </h5>
                <div class="status-item">
                    <span><i class="fas fa-exclamation-triangle"></i> Active Alerts:</span>
                    <span class="status-value" id="active-alert-count">Loading...</span>
                </div>
                <div class="status-item">
                    <span><i class="fas fa-map-marked"></i> Boundaries:</span>
                    <span class="status-value" id="boundary-count">Loading...</span>
                </div>
                <div class="status-item">
                    <span><i class="fas fa-clock"></i> Last Update:</span>
                    <span class="status-value" id="last-update">Loading...</span>
                </div>
                <div class="status-item">
                    <span><i class="fas fa-map"></i> Map Status:</span>
                    <span class="status-value" id="map-status">Initializing...</span>
                </div>

                <div id="alert-summary" class="alert-summary" style="display: none;">
                    <!-- Alert summary will be populated by JavaScript -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="status-panel">
                <h5 class="mb-3">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh Map
                    </button>
                    <a href="/alerts" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-history"></i> View History
                    </a>
                    <a href="/stats" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </a>
                    <a href="/admin" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    <button class="btn btn-outline-warning btn-sm" onclick="centerOnConfiguredLocation()">
                        <i class="fas fa-crosshairs"></i> Center on {{ location_settings.county_name }}
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="inspectBoundaries()">
                        <i class="fas fa-search"></i> Inspect Boundaries
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Column -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map"></i> Interactive Emergency Alert Map
                        <span class="badge bg-success ms-2" id="map-status-badge">Loading...</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map">
                        <div class="loading-message">
                            <div class="spinner"></div>
                            <div><strong>Loading Interactive Map...</strong></div>
                            <div class="text-muted">Initializing Leaflet map for {{ location_settings.county_name }}, {{ location_settings.state_code }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Legend -->
            <div class="legend">
                <h6><i class="fas fa-list"></i> Map Legend</h6>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Alert Severity:</strong>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #dc3545;"></div>
                            <span>Extreme</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #fd7e14;"></div>
                            <span>Severe</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffc107;"></div>
                            <span>Moderate</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #17a2b8;"></div>
                            <span>Minor</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <strong>Geographic Boundaries:</strong>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6c757d;"></div>
                            <span>Counties</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #28a745;"></div>
                            <span>Townships</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #17a2b8;"></div>
                            <span>Villages</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: repeating-linear-gradient(45deg, #6c757d, #6c757d 3px, transparent 3px, transparent 6px);"></div>
                            <span>Historical Alerts</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <strong>Service Districts:</strong>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #dc3545;"></div>
                            <span>Fire Districts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #007bff;"></div>
                            <span>EMS Districts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffc107;"></div>
                            <span>School Districts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #fd7e14;"></div>
                            <span>Electric Utilities</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6f42c1;"></div>
                            <span>Telephone Service</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
console.log('🗺️ Interactive map page initializing...');

// Global map variables
let map;
let alertLayer;
let boundaryLayers = {};
let alertData = { active: [], historical: [] };

const LOCATION_SETTINGS = window.APP_LOCATION || {};
const MAP_CENTER = [
    Number(LOCATION_SETTINGS.map_center_lat ?? 0) || 0,
    Number(LOCATION_SETTINGS.map_center_lng ?? 0) || 0
];
const MAP_ZOOM = Number(LOCATION_SETTINGS.map_default_zoom ?? 10) || 10;
const LOCATION_LABEL = `${(LOCATION_SETTINGS.county_name || 'Configured Location')}${LOCATION_SETTINGS.state_code ? ', ' + LOCATION_SETTINGS.state_code : ''}`;

// Map initialization
function initMap() {
    try {
        console.log(`🗺️ Initializing Leaflet map for ${LOCATION_LABEL}...`);

        // Create map centered on configured location
        map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 8
        }).addTo(map);

        // Initialize layer groups
        alertLayer = L.layerGroup().addTo(map);
        boundaryLayers = {
            counties: L.layerGroup(),
            townships: L.layerGroup(),
            villages: L.layerGroup(),
            fire: L.layerGroup(),
            ems: L.layerGroup(),
            school: L.layerGroup(),
            electric: L.layerGroup(),
            telephone: L.layerGroup()
        };

        // Add scale control
        L.control.scale({
            position: 'bottomleft'
        }).addTo(map);

        console.log('✅ Map initialized successfully');
        updateMapStatus('Ready', 'success');

        // Load initial data
        loadAlerts();
        loadBoundaries();
        updateSystemStatus();

        // Set up event listeners
        setupEventListeners();

    } catch (error) {
        console.error('❌ Error initializing map:', error);
        showMapError('Failed to initialize map: ' + error.message);
        updateMapStatus('Error', 'danger');
    }
}

// Load alerts from API
async function loadAlerts() {
    try {
        console.log('📡 Loading alerts from API...');
        const response = await fetch('/api/alerts');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();

        if (response.ok && data.features) {
            alertData.active = data.features;
            displayAlerts(data.features);
            updateAlertCount(data.features.length);
            updateAlertSummary(data.features);
            console.log(`✅ Loaded ${data.features.length} alerts`);

            // Debug: Log the structure of the first alert if available
            if (data.features.length > 0) {
                console.log('📋 Sample alert structure:', data.features[0]);
            }
        } else {
            console.warn('⚠️ No alert features in API response:', data);
            updateAlertCount(0);
        }
    } catch (error) {
        console.error('❌ Error loading alerts:', error);
        showToast('Failed to load alerts: ' + error.message, 'error');
        updateAlertCount(0);
    }
}

// Load historical alerts
async function loadHistoricalAlerts() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'warning');
        return;
    }

    try {
        const response = await fetch(`/api/alerts/historical?start=${startDate}&end=${endDate}`);
        const data = await response.json();

        if (response.ok && data.features) {
            alertData.historical = data.features;
            if (document.getElementById('show-expired').checked) {
                displayHistoricalAlerts(data.features);
            }
            showToast(`Loaded ${data.features.length} historical alerts`, 'success');
        }
    } catch (error) {
        console.error('❌ Error loading historical alerts:', error);
        showToast('Failed to load historical alerts: ' + error.message, 'error');
    }
}

// Display alerts on map
function displayAlerts(alerts) {
    alertLayer.clearLayers();

    if (!alerts || alerts.length === 0) {
        console.log('ℹ️ No alerts to display');
        return;
    }

    alerts.forEach(alert => {
        if (alert.geometry) {
            const severity = alert.properties.severity || 'Unknown';
            const color = getSeverityColor(severity);
            const isActive = !isAlertExpired(alert.properties.expires);

            const alertFeature = L.geoJSON(alert, {
                style: {
                    color: color,
                    weight: alert.properties.is_county_wide ? 4 : 3,
                    opacity: isActive ? 0.8 : 0.5,
                    fillOpacity: alert.properties.is_county_wide ? 0.3 : 0.4,
                    fillColor: color,
                    dashArray: alert.properties.is_county_wide ? '10,5' : null,
                    className: isActive ? 'alert-active' : 'alert-expired'
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = createAlertPopup(props);
                    layer.bindPopup(popupContent, { maxWidth: 300 });
                }
            });

            alertLayer.addLayer(alertFeature);
        }
    });

    console.log(`✅ Displayed ${alerts.length} alerts on map`);
}

// Display historical alerts
function displayHistoricalAlerts(alerts) {
    alerts.forEach(alert => {
        if (alert.geometry) {
            const alertFeature = L.geoJSON(alert, {
                style: {
                    color: '#6c757d',
                    weight: 2,
                    opacity: 0.6,
                    fillOpacity: 0.1,
                    fillColor: '#6c757d',
                    dashArray: '5,5',
                    className: 'alert-expired'
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = createHistoricalAlertPopup(props);
                    layer.bindPopup(popupContent, { maxWidth: 300 });
                }
            });

            alertLayer.addLayer(alertFeature);
        }
    });
}

// Load boundaries
async function loadBoundaries() {
    try {
        console.log('📡 Loading boundaries from API...');
        const response = await fetch('/api/boundaries');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();

        if (data.features && Array.isArray(data.features)) {
            console.log(`✅ Received ${data.features.length} boundaries`);

            // Debug: Log the structure of the first boundary
            if (data.features.length > 0) {
                console.log('📋 Sample boundary structure:', data.features[0]);
            }

            // Group boundaries by type
            const boundariesByType = {
                counties: [],
                townships: [],
                villages: [],
                fire: [],
                ems: [],
                school: [],
                electric: [],
                telephone: []
            };

            let totalLoaded = 0;
            data.features.forEach(boundary => {
                const type = boundary.properties.type;
                if (type && typeof type === 'string') {
                    const lowerType = type.toLowerCase();

                    if (lowerType.includes('county') || lowerType === 'county') {
                        boundariesByType.counties.push(boundary);
                    } else if (lowerType.includes('township') || lowerType === 'township') {
                        boundariesByType.townships.push(boundary);
                    } else if (lowerType.includes('village') || lowerType === 'village') {
                        boundariesByType.villages.push(boundary);
                    } else if (lowerType.includes('fire') || lowerType === 'fire') {
                        boundariesByType.fire.push(boundary);
                    } else if (lowerType.includes('ems') || lowerType === 'ems') {
                        boundariesByType.ems.push(boundary);
                    } else if (lowerType.includes('school') || lowerType === 'school') {
                        boundariesByType.school.push(boundary);
                    } else if (lowerType.includes('electric') || lowerType === 'electric') {
                        boundariesByType.electric.push(boundary);
                    } else if (lowerType.includes('telephone') || lowerType === 'telephone') {
                        boundariesByType.telephone.push(boundary);
                    } else {
                        // For truly unknown types, add to counties but log it
                        console.log(`📋 Unrecognized boundary type: ${type} - adding to counties`);
                        boundariesByType.counties.push(boundary);
                    }
                } else {
                    console.warn(`❓ Boundary with no type property:`, boundary.properties);
                    boundariesByType.counties.push(boundary);
                }
                totalLoaded++;
            });

            // Create map layers for each type
            Object.keys(boundariesByType).forEach(type => {
                const boundaries = boundariesByType[type];
                if (boundaries.length > 0) {
                    const color = getBoundaryColor(type);

                    const boundaryFeature = L.geoJSON(boundaries, {
                        style: {
                            color: color,
                            weight: 1,
                            opacity: 0.6,
                            fillOpacity: 0.1,
                            fillColor: color
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            const popupContent = createBoundaryPopup(props, type);
                            layer.bindPopup(popupContent);
                        }
                    });

                    boundaryLayers[type].addLayer(boundaryFeature);
                    console.log(`✅ Loaded ${boundaries.length} ${type} - Color: ${color}`);

                    // Update count in UI
                    updateBoundaryTypeCount(type, boundaries.length);
                }
            });

            updateBoundaryCount(totalLoaded);

        } else {
            console.warn('⚠️ No boundary features in API response');
            updateBoundaryCount(0);
        }
    } catch (error) {
        console.error('❌ Error loading boundaries:', error);
        showToast('Failed to load boundaries: ' + error.message, 'error');
        updateBoundaryCount(0);
    }
}

// Create alert popup content
function createAlertPopup(props) {
    const severityClass = `severity-${(props.severity || 'unknown').toLowerCase()}`;
    const isActive = !isAlertExpired(props.expires);
    const statusBadge = isActive ?
        '<span class="popup-badge" style="background: #28a745; color: white;">ACTIVE</span>' :
        '<span class="popup-badge" style="background: #6c757d; color: white;">EXPIRED</span>';

    return `
        <div class="popup-title">${props.event || 'Unknown Event'}</div>
        <div class="popup-detail">
            <span class="popup-badge ${severityClass}">${props.severity || 'Unknown'}</span>
            ${statusBadge}
            ${props.is_county_wide ? '<span class="popup-badge" style="background: #17a2b8; color: white;">COUNTY-WIDE</span>' : ''}
        </div>
        <div class="popup-detail"><strong>Area:</strong> ${props.area_desc || 'Unknown'}</div>
        <div class="popup-detail"><strong>Effective:</strong> ${props.effective ? new Date(props.effective).toLocaleString() : 'Unknown'}</div>
        <div class="popup-detail"><strong>Expires:</strong> ${props.expires ? new Date(props.expires).toLocaleString() : 'Unknown'}</div>
        ${props.headline ? `<div class="popup-detail"><strong>Headline:</strong> ${props.headline}</div>` : ''}
        <div class="mt-2">
            <a href="/alerts/${props.id}" class="btn btn-sm btn-primary">View Details</a>
        </div>
    `;
}

// Create historical alert popup content
function createHistoricalAlertPopup(props) {
    return `
        <div class="popup-title">
            ${props.event || 'Unknown Event'}
            <span class="historical-badge">Historical</span>
        </div>
        <div class="popup-detail"><strong>Severity:</strong> ${props.severity || 'Unknown'}</div>
        <div class="popup-detail"><strong>Area:</strong> ${props.area_desc || 'Unknown'}</div>
        <div class="popup-detail"><strong>Date:</strong> ${props.effective ? new Date(props.effective).toLocaleDateString() : 'Unknown'}</div>
        <div class="mt-2">
            <a href="/alerts/${props.id}" class="btn btn-sm btn-outline-secondary">View Details</a>
        </div>
    `;
}

// Create boundary popup content
function createBoundaryPopup(props, type) {
    return `
        <div class="popup-title">${props.name || 'Unnamed'}</div>
        <div class="popup-detail"><strong>Type:</strong> ${props.type || type}</div>
        <div class="popup-detail"><strong>ID:</strong> ${props.id}</div>
        ${props.description ? `<div class="popup-detail"><strong>Description:</strong> ${props.description}</div>` : ''}
        ${props.population ? `<div class="popup-detail"><strong>Population:</strong> ${props.population.toLocaleString()}</div>` : ''}
        ${props.area ? `<div class="popup-detail"><strong>Area:</strong> ${props.area} sq mi</div>` : ''}
    `;
}

// Utility functions
function getSeverityColor(severity) {
    const colors = {
        'Extreme': '#dc3545',
        'Severe': '#fd7e14',
        'Moderate': '#ffc107',
        'Minor': '#17a2b8'
    };
    return colors[severity] || '#6c757d';
}

// FIXED: getBoundaryColor function with missing colors added
function getBoundaryColor(type) {
    const colors = {
        'counties': '#6c757d',      // Grey
        'townships': '#28a745',     // Green
        'villages': '#17a2b8',      // Blue
        // MISSING COLORS THAT WERE CAUSING GREY BOUNDARIES:
        'fire': '#dc3545',          // Red (matches your legend)
        'ems': '#007bff',           // Blue (matches your legend)
        'school': '#ffc107',        // Yellow (matches your legend)
        'electric': '#fd7e14',      // Orange (matches your legend)
        'telephone': '#6f42c1'      // Purple (matches your legend)
    };
    return colors[type] || '#6c757d';
}

function isAlertExpired(expiresDate) {
    if (!expiresDate) return false;
    return new Date(expiresDate) < new Date();
}

// Update UI functions
function updateMapStatus(status, type) {
    const badge = document.getElementById('map-status-badge');
    const statusElement = document.getElementById('map-status');

    if (badge) {
        badge.textContent = status;
        badge.className = `badge bg-${type} ms-2`;
    }

    if (statusElement) {
        statusElement.textContent = status;
    }
}

function updateAlertCount(count) {
    const element = document.getElementById('active-alert-count');
    if (element) {
        element.textContent = count;
    }
}

function updateBoundaryCount(count) {
    const element = document.getElementById('boundary-count');
    if (element) {
        element.textContent = count;
    }
}

function updateBoundaryTypeCount(type, count) {
    const element = document.getElementById(`${type}-count`);
    if (element) {
        element.textContent = count;
    }
}

function updateAlertSummary(alerts) {
    const summaryElement = document.getElementById('alert-summary');
    if (!summaryElement || !alerts || alerts.length === 0) return;

    const activeCounts = {};
    alerts.forEach(alert => {
        const event = alert.properties.event || 'Unknown';
        activeCounts[event] = (activeCounts[event] || 0) + 1;
    });

    const summaryHtml = Object.entries(activeCounts)
        .map(([event, count]) => `<div><strong>${event}:</strong> ${count}</div>`)
        .join('');

    summaryElement.innerHTML = `<h6>Active Alerts by Type:</h6>${summaryHtml}`;
    summaryElement.style.display = 'block';
}

async function updateSystemStatus() {
    try {
        const response = await fetch('/api/system_status');
        if (response.ok) {
            const data = await response.json();
            console.log('✅ System status updated:', data);
            // Update any additional system status here if needed
        }
    } catch (error) {
        console.warn('Could not fetch system status:', error);
    }

    // Update timestamp
    const element = document.getElementById('last-update');
    if (element) {
        element.textContent = new Date().toLocaleTimeString();
    }
}

// Event handlers
function setupEventListeners() {
    // Layer toggles
    document.getElementById('show-active').addEventListener('change', function() {
        if (this.checked && alertData.active) {
            displayAlerts(alertData.active);
        } else if (!this.checked) {
            alertLayer.clearLayers();
        }
    });

    document.getElementById('show-expired').addEventListener('change', function() {
        const dateFilters = document.getElementById('date-filters');
        if (this.checked) {
            dateFilters.style.display = 'block';
            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        } else {
            dateFilters.style.display = 'none';
            // Remove historical alerts from map
            if (alertData.active) {
                displayAlerts(alertData.active);
            }
        }
    });

    // Boundary layer toggles
    ['counties', 'townships', 'villages', 'fire', 'ems', 'school', 'electric', 'telephone'].forEach(type => {
        const checkbox = document.getElementById(`show-${type}`);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(boundaryLayers[type]);
                } else {
                    map.removeLayer(boundaryLayers[type]);
                }
            });
        }
    });
}

// Action functions
async function refreshData() {
    const refreshBtn = document.getElementById('refresh-icon');
    if (refreshBtn) {
        refreshBtn.classList.add('fa-spin');
    }

    try {
        await Promise.all([
            loadAlerts(),
            updateSystemStatus()
        ]);
        showToast('Map data refreshed successfully', 'success');
    } catch (error) {
        showToast('Failed to refresh data', 'error');
    }

    setTimeout(() => {
        if (refreshBtn) {
            refreshBtn.classList.remove('fa-spin');
        }
    }, 2000);
}

function centerOnConfiguredLocation() {
    if (map) {
        map.setView(MAP_CENTER, MAP_ZOOM);
        showToast(`Map centered on ${LOCATION_LABEL}`, 'info');
    }
}

async function inspectBoundaries() {
    try {
        console.log('🔍 Inspecting boundaries...');
        const response = await fetch('/api/boundaries');

        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const data = await response.json();

        if (data.features && Array.isArray(data.features)) {
            // Group boundaries by type for inspection
            const boundariesByType = {};
            data.features.forEach(boundary => {
                const type = boundary.properties.type || 'unknown';
                if (!boundariesByType[type]) {
                    boundariesByType[type] = [];
                }
                boundariesByType[type].push({
                    id: boundary.properties.id,
                    name: boundary.properties.name,
                    description: boundary.properties.description,
                    type: type
                });
            });

            // Sort types for better display
            const sortedTypes = Object.keys(boundariesByType).sort();

            // Create inspection report
            let report = `📊 COMPREHENSIVE BOUNDARY INSPECTION REPORT\n`;
            report += `=========================================================\n`;
            report += `Total Boundaries: ${data.features.length}\n`;
            report += `Boundary Types: ${sortedTypes.length}\n`;
            report += `Generated: ${new Date().toLocaleString()}\n\n`;

            // Summary by type
            report += `SUMMARY BY TYPE:\n`;
            report += `================\n`;
            sortedTypes.forEach(type => {
                const count = boundariesByType[type].length;
                report += `${type.toUpperCase()}: ${count}\n`;
            });
            report += `\n`;

            // Detailed listings
            sortedTypes.forEach(type => {
                const boundaries = boundariesByType[type];
                report += `${type.toUpperCase()} DETAILS (${boundaries.length}):\n`;
                report += `${'='.repeat(type.length + 15)}\n`;
                boundaries.forEach((boundary, index) => {
                    report += `  ${index + 1}. ${boundary.name} (ID: ${boundary.id})\n`;
                    if (boundary.description) {
                        report += `     Description: ${boundary.description}\n`;
                    }
                });
                report += `\n`;
            });

            // Show in console
            console.log(report);

            // Create enhanced inspection window
            const inspectionWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            inspectionWindow.document.write(`
                <html>
                <head>
                    <title>Comprehensive Boundary Inspection Report</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            padding: 20px;
                            background: #f5f5f5;
                            margin: 0;
                        }
                        .report {
                            background: white;
                            padding: 30px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            max-width: 1000px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #007bff;
                            border-bottom: 3px solid #007bff;
                            padding-bottom: 10px;
                        }
                        .summary {
                            background: #e9ecef;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .summary h2 {
                            color: #28a745;
                            margin-top: 0;
                        }
                        .type-section {
                            margin-bottom: 30px;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            padding: 20px;
                        }
                        .type-header {
                            font-weight: bold;
                            color: #dc3545;
                            margin-bottom: 15px;
                            font-size: 1.2em;
                            border-bottom: 2px solid #dc3545;
                            padding-bottom: 5px;
                        }
                        .boundary-item {
                            margin-left: 20px;
                            margin-bottom: 10px;
                            padding: 8px;
                            background: #f8f9fa;
                            border-radius: 4px;
                        }
                        .boundary-name {
                            font-weight: bold;
                            color: #007bff;
                        }
                        .boundary-id {
                            color: #6c757d;
                            font-size: 0.9em;
                        }
                        .description {
                            color: #495057;
                            font-style: italic;
                            margin-top: 5px;
                            padding: 5px;
                            background: white;
                            border-radius: 4px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .stat-box {
                            background: #007bff;
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .stat-number {
                            font-size: 2em;
                            font-weight: bold;
                            display: block;
                        }
                        .stat-label {
                            font-size: 0.9em;
                            opacity: 0.9;
                        }
                        @media print {
                            body { background: white; }
                            .report { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="report">
                        <h1>🗺️ Comprehensive Boundary Inspection Report</h1>

                        <div class="summary">
                            <h2>📊 System Overview</h2>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <span class="stat-number">${data.features.length}</span>
                                    <span class="stat-label">Total Boundaries</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">${sortedTypes.length}</span>
                                    <span class="stat-label">Boundary Types</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">${new Date().toLocaleDateString()}</span>
                                    <span class="stat-label">Report Date</span>
                                </div>
                            </div>
                        </div>

                        <div class="summary">
                            <h2>📈 Type Distribution</h2>
                            ${sortedTypes.map(type => {
                                const count = boundariesByType[type].length;
                                const percentage = ((count / data.features.length) * 100).toFixed(1);
                                return `<div><strong>${type.toUpperCase()}:</strong> ${count} boundaries (${percentage}%)</div>`;
                            }).join('')}
                        </div>

                        ${sortedTypes.map(type => {
                            const boundaries = boundariesByType[type];
                            const typeColors = {
                                'county': '#6c757d', 'township': '#28a745', 'village': '#17a2b8',
                                'fire': '#dc3545', 'ems': '#007bff', 'school': '#ffc107',
                                'electric': '#fd7e14', 'telephone': '#6f42c1'
                            };
                            const color = typeColors[type.toLowerCase()] || '#6c757d';

                            return `
                                <div class="type-section">
                                    <div class="type-header" style="color: ${color}; border-bottom-color: ${color};">
                                        ${type.toUpperCase()} BOUNDARIES (${boundaries.length})
                                    </div>
                                    ${boundaries.map((boundary, index) => `
                                        <div class="boundary-item">
                                            <div class="boundary-name">${boundary.name}</div>
                                            <div class="boundary-id">ID: ${boundary.id} | Type: ${boundary.type}</div>
                                            ${boundary.description ? `<div class="description">${boundary.description}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('')}

                        <div class="summary">
                            <p><strong>📍 System Location:</strong> ${LOCATION_LABEL} Emergency Management</p>
                            <p><strong>🔧 Generated by:</strong> KR8MER CAP Emergency Alert System</p>
                            <p><small>This comprehensive report shows all boundary data available in the emergency management system database.</small></p>
                        </div>
                    </div>
                </body>
                </html>
            `);

            showToast(`Comprehensive boundary inspection complete: ${data.features.length} boundaries across ${sortedTypes.length} types`, 'success');

        } else {
            showToast('No boundaries found in system', 'warning');
        }
    } catch (error) {
        console.error('❌ Error inspecting boundaries:', error);
        showToast('Failed to inspect boundaries: ' + error.message, 'error');
    }
}

// Error handling
function showMapError(message) {
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="map-error">
                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                <h4>Map Loading Error</h4>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    <i class="fas fa-redo"></i> Reload Page
                </button>
            </div>
        `;
    }
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Interactive map page loaded');

    try {
        initMap();

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadAlerts();
            updateSystemStatus();
        }, 300000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    refreshData();
                }
            }
        });

    } catch (error) {
        console.error('❌ Error initializing page:', error);
        showMapError('Failed to initialize map interface: ' + error.message);
    }
});

console.log('📜 Interactive map script loaded');

// Make diagnostic functions available globally for debugging
window.mapDebug = {
    testAPIs: async function() {
        console.log('🔍 Testing all API endpoints...');

        const endpoints = [
            '/api/alerts',
            '/api/boundaries',
            '/api/system_status'
        ];

        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                console.log(`✅ ${endpoint}: ${response.status}`, data);
            } catch (error) {
                console.error(`❌ ${endpoint}: ${error.message}`);
            }
        }
    },

    refreshAll: function() {
        console.log('🔄 Refreshing all map data...');
        refreshData();
    },

    inspectMap: function() {
        console.log('🗺️ Map inspection:');
        console.log('Map object:', map);
        console.log('Alert layer:', alertLayer);
        console.log('Boundary layers:', boundaryLayers);
        console.log('Alert data:', alertData);
    },

    analyzeBoundaries: async function() {
        console.log('📊 Analyzing boundary data...');
        try {
            const response = await fetch('/api/boundaries');
            const data = await response.json();

            if (data.features) {
                const analysis = {};
                data.features.forEach(boundary => {
                    const type = boundary.properties.type || 'unknown';
                    if (!analysis[type]) {
                        analysis[type] = { count: 0, examples: [] };
                    }
                    analysis[type].count++;
                    if (analysis[type].examples.length < 3) {
                        analysis[type].examples.push({
                            name: boundary.properties.name,
                            id: boundary.properties.id
                        });
                    }
                });

                console.log('📋 Boundary Analysis:');
                console.table(analysis);
                return analysis;
            }
        } catch (error) {
            console.error('❌ Analysis failed:', error);
        }
    }
};

console.log('💡 Debug functions available:');
console.log('  • window.mapDebug.testAPIs() - Test all API endpoints');
console.log('  • window.mapDebug.refreshAll() - Refresh all map data');
console.log('  • window.mapDebug.inspectMap() - Inspect map objects');
console.log('  • window.mapDebug.analyzeBoundaries() - Analyze boundary types');
</script>
{% endblock %}