{% extends "base.html" %}

{% block title %}GPIO Control Panel - EAS Station{% endblock %}

{% block extra_css %}
<style>
    .gpio-card { border-left: 4px solid #007bff; }
    .gpio-card.active { border-left-color: #28a745; }
    .gpio-card.inactive { border-left-color: #6c757d; }
    .gpio-card.error { border-left-color: #dc3545; }
    .activation-timeline { max-height: 400px; overflow-y: auto; }
    .timeline-item { border-left: 3px solid #e9ecef; padding-left: 1rem; margin-bottom: 1rem; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -7px; width: 11px; height: 11px; border-radius: 50%; background: #007bff; }
    .timeline-item.success::before { background: #28a745; }
    .timeline-item.error::before { background: #dc3545; }
    .timeline-item.warning::before { background: #ffc107; }
    
    /* LED Status Indicator */
    .status-led {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        position: relative;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1) inset;
    }
    .status-led.active {
        background: #28a745;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1) inset, 0 0 10px #28a745, 0 0 20px rgba(40, 167, 69, 0.5);
        animation: pulse-green 2s infinite;
    }
    .status-led.inactive {
        background: #6c757d;
    }
    .status-led.error {
        background: #dc3545;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1) inset, 0 0 10px #dc3545;
    }
    @keyframes pulse-green {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Auto-refresh indicator */
    .auto-refresh-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        margin-right: 6px;
        animation: blink 2s infinite;
    }
    @keyframes blink {
        0%, 50%, 100% { opacity: 1; }
        25%, 75% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4 align-items-center">
        <div class="col-12 col-lg-8">
            <h2><i class="fas fa-microchip"></i> GPIO Control Panel</h2>
            <p class="text-muted mb-0">Manage GPIO relays and peripherals with audit logging</p>
        </div>
        <div class="col-12 col-lg-4 text-lg-end mt-3 mt-lg-0">
            <a class="btn btn-outline-primary" href="{{ url_for('gpio_pin_map') }}">
                <i class="fas fa-map"></i> Open GPIO Pin Map
            </a>
        </div>
    </div>

    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Warning:</strong> GPIO control affects real hardware. Use caution when activating relays.
        All actions are logged for audit purposes.
    </div>

    <!-- GPIO Pins Status -->
    <div class="row mb-4">
        <div class="col-12">
            <h4><i class="fas fa-toggle-on"></i> Configured GPIO Pins</h4>
        </div>
        {% if pins %}
            {% for pin_info in pins %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card gpio-card {{ 'active' if pin_info.is_active else 'inactive' }} h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <span class="status-led {{ 'active' if pin_info.is_active else 'inactive' if pin_info.state == 'inactive' else 'error' }}" 
                                      title="{{ 'Active' if pin_info.is_active else pin_info.state.title() }}"></span>
                                <h5 class="card-title mb-0">{{ pin_info.name }}</h5>
                            </div>
                            <span class="badge bg-{{ 'success' if pin_info.is_active else 'secondary' if pin_info.state == 'inactive' else 'danger' }}">
                                {{ pin_info.state.upper() }}
                            </span>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">
                                <strong>BCM GPIO:</strong> GPIO {{ pin_info.pin }}<br>
                                <strong>Mode:</strong> Active {{ 'High' if pin_info.active_high else 'Low' }}<br>
                                {% if pin_info.is_active %}
                                    <strong>Active for:</strong> {{ "%.1f"|format(pin_info.active_seconds) }}s<br>
                                    {% if pin_info.reason %}
                                        <strong>Reason:</strong> {{ pin_info.reason }}<br>
                                    {% endif %}
                                    {% if pin_info.operator %}
                                        <strong>Operator:</strong> {{ pin_info.operator }}<br>
                                    {% endif %}
                                {% endif %}
                            </small>
                        </div>

                        <div class="d-grid gap-2">
                            {% if pin_info.is_active %}
                                <button class="btn btn-danger btn-sm deactivate-pin" data-pin="{{ pin_info.pin }}">
                                    <i class="fas fa-power-off"></i> Deactivate
                                </button>
                                <button class="btn btn-outline-danger btn-sm force-deactivate-pin" data-pin="{{ pin_info.pin }}">
                                    <i class="fas fa-exclamation-triangle"></i> Force Deactivate
                                </button>
                            {% else %}
                                {% if pin_info.enabled %}
                                    <button class="btn btn-success btn-sm activate-pin" data-pin="{{ pin_info.pin }}" data-name="{{ pin_info.name }}">
                                        <i class="fas fa-power-off"></i> Activate
                                    </button>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-ban"></i> Disabled
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No GPIO pins are currently configured. Configure pins in
                    <strong>Settings â†’ Environment</strong> using the GPIO section
                    (<code>EAS_GPIO_PIN</code>, <code>GPIO_ADDITIONAL_PINS</code>)
                    and restart the services to apply changes.
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Activation History Timeline -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-history"></i> Recent Activation History (24 hours)</h4>
                </div>
                <div class="card-body activation-timeline">
                    {% if recent_logs %}
                        {% for log in recent_logs %}
                        <div class="timeline-item {{ 'success' if log.success else 'error' }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>BCM GPIO {{ log.pin }}</strong>
                                    <span class="badge bg-primary ms-2">{{ log.activation_type }}</span>
                                    {% if log.operator %}
                                        <span class="badge bg-info ms-1">{{ log.operator }}</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">
                                        {{ log.activated_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                                    </small>
                                    {% if log.reason %}
                                        <br>
                                        <small>{{ log.reason }}</small>
                                    {% endif %}
                                    {% if log.duration_seconds %}
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-clock"></i> Duration: {{ "%.2f"|format(log.duration_seconds) }}s
                                        </small>
                                    {% endif %}
                                    {% if not log.success and log.error_message %}
                                        <br>
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-circle"></i> {{ log.error_message }}
                                        </small>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if log.success %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No recent GPIO activations recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-refresh toggle -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
        <div class="d-flex flex-column gap-2">
            <button class="btn btn-sm btn-outline-primary" id="auto-refresh-toggle">
                <span class="auto-refresh-indicator" id="refresh-indicator" style="display: none;"></span>
                <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="auto-refresh-status">OFF</span>
            </button>
            <button class="btn btn-primary" id="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh Now
            </button>
        </div>
    </div>
</div>

<!-- Activation Reason Modal -->
<div class="modal fade" id="activationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Activate GPIO Pin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to activate <strong id="modal-pin-name"></strong></p>
                <div class="mb-3">
                    <label for="activation-type" class="form-label">Activation Type</label>
                    <select class="form-select" id="activation-type">
                        <option value="manual">Manual</option>
                        <option value="test">Test</option>
                        <option value="override">Override</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="activation-reason" class="form-label">Reason (required)</label>
                    <textarea class="form-control" id="activation-reason" rows="3"
                              placeholder="Enter reason for activation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-activate">
                    <i class="fas fa-power-off"></i> Activate
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPin = null;
let autoRefreshEnabled = false;
let autoRefreshInterval = null;

// Auto-refresh functionality
function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const statusSpan = document.getElementById('auto-refresh-status');
    const indicator = document.getElementById('refresh-indicator');
    
    if (autoRefreshEnabled) {
        statusSpan.textContent = 'ON';
        indicator.style.display = 'inline-block';
        startAutoRefresh();
    } else {
        statusSpan.textContent = 'OFF';
        indicator.style.display = 'none';
        stopAutoRefresh();
    }
    
    // Save preference to localStorage
    localStorage.setItem('gpioAutoRefresh', autoRefreshEnabled);
}

function startAutoRefresh() {
    if (autoRefreshInterval) return;
    
    // Refresh every 3 seconds
    autoRefreshInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/gpio/status');
            const data = await response.json();
            
            if (data.success && data.pins) {
                // Update pin states without full page reload
                updatePinStates(data.pins);
            }
        } catch (error) {
            console.error('Auto-refresh failed:', error);
        }
    }, 3000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function updatePinStates(pins) {
    pins.forEach(pin => {
        // Find the card for this pin
        const cards = document.querySelectorAll('.gpio-card');
        cards.forEach(card => {
            const pinButtons = card.querySelectorAll('[data-pin]');
            if (pinButtons.length === 0) return;
            
            const cardPin = parseInt(pinButtons[0].dataset.pin);
            if (cardPin !== pin.pin) return;
            
            // Update LED indicator
            const led = card.querySelector('.status-led');
            if (led) {
                led.className = 'status-led';
                if (pin.is_active) {
                    led.classList.add('active');
                    led.title = 'Active';
                } else if (pin.state === 'inactive') {
                    led.classList.add('inactive');
                    led.title = 'Inactive';
                } else {
                    led.classList.add('error');
                    led.title = pin.state;
                }
            }
            
            // Update badge
            const badge = card.querySelector('.badge');
            if (badge) {
                badge.className = 'badge';
                badge.classList.add(pin.is_active ? 'bg-success' : (pin.state === 'inactive' ? 'bg-secondary' : 'bg-danger'));
                badge.textContent = pin.state.toUpperCase();
            }
            
            // Update card border
            card.className = 'card gpio-card h-100';
            if (pin.is_active) {
                card.classList.add('active');
            } else if (pin.state === 'inactive') {
                card.classList.add('inactive');
            } else {
                card.classList.add('error');
            }
            
            // Update active time if shown
            if (pin.is_active && pin.active_seconds !== undefined) {
                const activeTimeElement = card.querySelector('.text-muted');
                if (activeTimeElement) {
                    const innerHTML = activeTimeElement.innerHTML;
                    const match = innerHTML.match(/<strong>Active for:<\/strong> [\d.]+s/);
                    if (match) {
                        activeTimeElement.innerHTML = innerHTML.replace(
                            /<strong>Active for:<\/strong> [\d.]+s/,
                            `<strong>Active for:</strong> ${pin.active_seconds.toFixed(1)}s`
                        );
                    }
                }
            }
        });
    });
}

// Load saved preference
document.addEventListener('DOMContentLoaded', () => {
    const savedPreference = localStorage.getItem('gpioAutoRefresh');
    if (savedPreference === 'true') {
        toggleAutoRefresh();
    }
});

// Auto-refresh toggle button
document.getElementById('auto-refresh-toggle').addEventListener('click', toggleAutoRefresh);

// Activate pin button click
document.querySelectorAll('.activate-pin').forEach(btn => {
    btn.addEventListener('click', function() {
        currentPin = parseInt(this.dataset.pin);
        document.getElementById('modal-pin-name').textContent = this.dataset.name;
        const modal = new bootstrap.Modal(document.getElementById('activationModal'));
        modal.show();
    });
});

// Confirm activation
document.getElementById('confirm-activate').addEventListener('click', async function() {
    const reason = document.getElementById('activation-reason').value.trim();
    const activationType = document.getElementById('activation-type').value;

    if (!reason) {
        alert('Please enter a reason for activation');
        return;
    }

    try {
        const response = await fetch(`/api/gpio/activate/${currentPin}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, activation_type: activationType })
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('activationModal')).hide();
            window.location.reload();
        } else {
            alert('Activation failed: ' + data.error);
        }
    } catch (error) {
        alert('Error activating pin: ' + error.message);
    }
});

// Deactivate pin
document.querySelectorAll('.deactivate-pin').forEach(btn => {
    btn.addEventListener('click', async function() {
        const pin = parseInt(this.dataset.pin);

        if (!confirm(`Deactivate GPIO ${pin}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/gpio/deactivate/${pin}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force: false })
            });

            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                alert('Deactivation failed: ' + data.error);
            }
        } catch (error) {
            alert('Error deactivating pin: ' + error.message);
        }
    });
});

// Force deactivate pin
document.querySelectorAll('.force-deactivate-pin').forEach(btn => {
    btn.addEventListener('click', async function() {
        const pin = parseInt(this.dataset.pin);

        if (!confirm(`FORCE deactivate GPIO ${pin}? This will ignore hold time and immediately deactivate the relay.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/gpio/deactivate/${pin}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force: true })
            });

            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                alert('Force deactivation failed: ' + data.error);
            }
        } catch (error) {
            alert('Error force deactivating pin: ' + error.message);
        }
    });
});

// Refresh button
document.getElementById('refresh-btn').addEventListener('click', function() {
    window.location.reload();
});
</script>
{% endblock %}
