{% extends "base.html" %}

{% block title %}Setup Complete - EAS Station{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="card shadow border-0">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="fas fa-check-circle me-2"></i>Configuration Saved Successfully!</h3>
                </div>
                <div class="card-body p-4">
                    <!-- Critical Action: Download Backup -->
                    <div class="alert alert-danger border-danger" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-download me-2"></i>IMPORTANT: Download Your Configuration Backup Now!</h4>
                        <p class="mb-3">Your configuration has been saved to <code>/app/.env</code> inside the container, but <strong>it will be lost on redeployment</strong>.</p>

                        <div class="d-grid gap-2 mb-3">
                            <a href="{{ url_for('setup_download_env') }}" class="btn btn-danger btn-lg">
                                <i class="fas fa-download me-2"></i>Download Backup Now
                            </a>
                        </div>

                        <p class="mb-0"><small><strong>Why?</strong> When you redeploy from Git, the .env file resets to empty. Download this backup so you can restore it after redeployments.</small></p>
                    </div>

                    <!-- Restore from Backup Section -->
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Restore Configuration from Backup</h5>
                        </div>
                        <div class="card-body">
                            <p>After redeploying your stack, restore your configuration by uploading the backup file you downloaded:</p>

                            <form id="restore-form" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="env-file-input" class="form-label">Select your .env backup file:</label>
                                    <input type="file" class="form-control" id="env-file-input" name="env_file" accept=".env" required>
                                </div>
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-upload me-2"></i>Restore Configuration
                                </button>
                                <div id="restore-status" class="mt-3"></div>
                            </form>
                        </div>
                    </div>

                    <!-- Important notice about persistence -->
                    <div class="alert alert-warning border-warning" role="alert">
                        <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>How Configuration Persistence Works</h5>
                        <strong>Container behavior:</strong>
                        <ul class="mb-3">
                            <li><strong>Container Restart</strong> (Stop/Start): ✅ Configuration persists from .env file</li>
                            <li><strong>Container Redeploy</strong> (Git update): ❌ .env resets to empty - upload your backup to restore</li>
                        </ul>
                        <p class="mb-0"><strong>Workflow:</strong> Download backup now → Redeploy stack → Upload backup → Restart container</p>
                    </div>

                    <!-- Alternative: Use Portainer Environment Variables (Optional) -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fab fa-docker me-2"></i>Alternative: Use Portainer Environment Variables (Optional)</h5>
                        </div>
                        <div class="card-body">
                            <p>Instead of using the backup/restore workflow, you can set environment variables directly in Portainer (they override the .env file):</p>
                            <ol>
                                <li>Go to your stack in Portainer</li>
                                <li>Click <strong>"Editor"</strong> tab</li>
                                <li>Scroll down to <strong>"Environment variables"</strong> section</li>
                                <li>Paste the variables from the "Portainer Format" section below</li>
                                <li>Click <strong>"Update the stack"</strong></li>
                            </ol>
                            <p class="mb-0 text-muted"><small>⚙️ This is more work initially but ensures config persists without restore steps.</small></p>
                        </div>
                    </div>

                    <!-- Configuration table for debugging -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Configuration Values (For Debugging)</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyAllToClipboard()">
                                <i class="fas fa-copy me-1"></i> Copy All
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 30%;">Variable Name</th>
                                            <th style="width: 60%;">Value</th>
                                            <th style="width: 10%;" class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for var in env_vars %}
                                        <tr>
                                            <td><code>{{ var.key }}</code></td>
                                            <td>
                                                <span class="d-inline-block text-truncate" style="max-width: 500px;" title="{{ var.value }}">
                                                    {% if var.is_sensitive %}
                                                        <span class="text-muted" id="display-{{ var.key }}">{{ var.display_value }}</span>
                                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="toggleVisibility('{{ var.key }}')" title="Show full value">
                                                            <i class="fas fa-eye" id="icon-{{ var.key }}"></i>
                                                        </button>
                                                    {% else %}
                                                        <code>{{ var.value }}</code>
                                                    {% endif %}
                                                </span>
                                                <input type="hidden" id="value-{{ var.key }}" value="{{ var.value }}">
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ var.key }}')" title="Copy to clipboard">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Click <i class="fas fa-copy"></i> to copy individual values, or "Copy All" to copy in Portainer format.
                            </small>
                        </div>
                    </div>

                    <!-- Portainer format for copy-paste -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>Portainer Format (Ready to Paste)</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyPortainerFormat()">
                                <i class="fas fa-copy me-1"></i> Copy Format
                            </button>
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded mb-0" id="portainer-format" style="max-height: 300px; overflow-y: auto;"><code>{% for var in env_vars %}{{ var.key }}={{ var.value }}
{% endfor %}</code></pre>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                Copy the above text and paste it into Portainer's "Environment variables" section (one per line).
                            </small>
                        </div>
                    </div>

                    <!-- Next steps -->
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-forward me-2"></i>Next Steps</h5>
                        </div>
                        <div class="card-body">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>Recommended Workflow:</h6>
                            <ol>
                                <li><strong>Download your backup</strong> using the button above (CRITICAL!)</li>
                                <li><strong>Restart your container</strong> (Stop/Start in Portainer)</li>
                                <li>Access your EAS Station dashboard and verify everything works</li>
                                <li><strong>After future redeployments:</strong> Upload your backup to restore config</li>
                            </ol>

                            <h6 class="mt-4"><i class="fas fa-info-circle text-info me-2"></i>Alternative (No Restore Needed):</h6>
                            <ol>
                                <li>Copy the environment variables from the "Portainer Format" section above</li>
                                <li>Paste them into Portainer's Environment Variables editor</li>
                                <li>Your configuration will persist permanently without needing to restore backups</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="d-flex gap-3 mt-4">
                        <a href="{{ url_for('setup_wizard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Setup
                        </a>
                        <a href="{{ url_for('setup_view_env') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-file-code me-2"></i>View .env File (Debug)
                        </a>
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-home me-2"></i>Go to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store visibility state for sensitive fields
const visibilityState = {};

// Handle restore form submission
document.addEventListener('DOMContentLoaded', function() {
    const restoreForm = document.getElementById('restore-form');
    const restoreStatus = document.getElementById('restore-status');

    if (restoreForm) {
        restoreForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('env-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showRestoreStatus('Please select a file.', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('env_file', file);

            try {
                showRestoreStatus('Uploading and restoring configuration...', 'info');

                const response = await fetch('{{ url_for("setup_upload_env") }}', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showRestoreStatus(
                        result.message || 'Configuration restored successfully! Please restart the container.',
                        'success'
                    );
                    // Clear the file input
                    fileInput.value = '';
                } else {
                    showRestoreStatus(
                        result.error || 'Failed to restore configuration.',
                        'danger'
                    );
                }
            } catch (error) {
                showRestoreStatus(
                    'Error uploading file: ' + error.message,
                    'danger'
                );
            }
        });
    }
});

function showRestoreStatus(message, type) {
    const restoreStatus = document.getElementById('restore-status');
    restoreStatus.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
}

function toggleVisibility(key) {
    const displaySpan = document.getElementById(`display-${key}`);
    const icon = document.getElementById(`icon-${key}`);
    const valueInput = document.getElementById(`value-${key}`);

    if (!visibilityState[key]) {
        // Show full value
        displaySpan.textContent = valueInput.value;
        icon.className = 'fas fa-eye-slash';
        visibilityState[key] = true;
    } else {
        // Hide value
        const value = valueInput.value;
        const masked = value.length > 12
            ? value.substring(0, 8) + '...' + value.substring(value.length - 4)
            : '***';
        displaySpan.textContent = masked;
        icon.className = 'fas fa-eye';
        visibilityState[key] = false;
    }
}

function copyToClipboard(key) {
    const valueInput = document.getElementById(`value-${key}`);
    const value = valueInput.value;

    navigator.clipboard.writeText(value).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

function copyPortainerFormat() {
    const formatEl = document.getElementById('portainer-format');
    const text = formatEl.textContent;

    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

function copyAllToClipboard() {
    const formatEl = document.getElementById('portainer-format');
    const text = formatEl.textContent;

    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}
</script>
{% endblock %}
