{% extends "base.html" %}

{% block title %}LED Sign Control - Alpha 9120C{% endblock %}

{% block nav_title %}LED Sign Control{% endblock %}

{% block extra_css %}
<style>
/* LED-specific styles */
.message-preview {
    background: #000;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    word-break: break-word;
    position: relative;
    overflow: hidden;
}

.preview-line {
    margin: 2px 0;
    min-height: 20px;
}

.color-preview {
    width: 25px;
    height: 25px;
    border-radius: 4px;
    display: inline-block;
    margin-right: 8px;
    border: 1px solid var(--border-color);
    vertical-align: middle;
}

.rgb-input-group {
    position: relative;
}

.rgb-preview {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid #ccc;
}

.effect-preview {
    font-size: 0.8em;
    color: #666;
    font-style: italic;
}

.btn-emergency {
    background: linear-gradient(135deg, var(--danger-color), #e74c3c);
    border: none;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

@keyframes flashText {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.flash-preview {
    animation: flashText 1s infinite;
}

.rainbow-text {
    background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbow 2s ease-in-out infinite;
}

@keyframes rainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.message-item {
    border-left: 4px solid var(--primary-color);
    padding: 10px 15px;
    margin-bottom: 10px;
    background: white;
    border-radius: 0 8px 8px 0;
}

.message-item.sent { border-left-color: var(--success-color); }
.message-item.failed { border-left-color: var(--danger-color); }

.feature-group {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: var(--light-color);
}

.feature-group h6 {
    margin-bottom: 15px;
    color: var(--primary-color);
    font-weight: 600;
}

.line-editor.card {
    border: 1px solid var(--border-color);
    border-radius: 10px;
    transition: box-shadow 0.2s ease;
}

.line-editor.card:hover {
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}

.line-preview {
    min-height: 3.5rem;
    border: 1px dashed rgba(0, 255, 0, 0.4);
    border-radius: 6px;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.75);
    color: #00ff00;
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
    transition: background 0.2s ease, border-color 0.2s ease;
}

.line-preview:focus {
    outline: none;
    border-color: var(--primary-color);
    background: rgba(0, 0, 0, 0.85);
}

.line-preview:empty:before {
    content: attr(data-placeholder);
    color: rgba(255, 255, 255, 0.35);
    pointer-events: none;
}

.line-controls .form-label {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--primary-color);
}

.line-specials .form-check {
    margin-right: 0.75rem;
}

.line-clear {
    margin-top: 0.25rem;
}

.char-count {
    font-size: 0.85rem;
    color: var(--secondary-color);
}

.nav-tabs .nav-link {
    border: none;
    border-radius: 8px 8px 0 0;
    margin-right: 0.25rem;
}

.nav-tabs .nav-link.active {
    background: var(--primary-color);
    color: white;
}

.tab-content {
    background: white;
    padding: 2rem;
    border-radius: 0 12px 12px 12px;
    box-shadow: 0 4px 15px var(--shadow-color);
}

.special-function-group {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 10px;
    margin: 5px 0;
}

.priority-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
}

.priority-emergency { background: #dc3545; color: white; }
.priority-urgent { background: #fd7e14; color: white; }
.priority-normal { background: #17a2b8; color: white; }
.priority-low { background: #28a745; color: white; }

@media (max-width: 768px) {
    .tab-content { padding: 1rem; }
    .feature-group { padding: 10px; }
}
</style>
{% endblock %}

{% block content %}
<!-- LED Status Overview -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-tv"></i> LED Sign Status
            <small class="ms-2 opacity-75">Alpha 9120C M-Protocol</small>
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div id="led-status-display">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator status-connected"></span>
                        <strong>LED Sign: Ready</strong>
                    </div>
                    <div class="alert alert-success">
                        <strong>Status:</strong> Connected and ready<br>
                        <strong>Location:</strong> {{ led_status.host if led_status else '192.168.1.100' }}:{{ led_status.port if led_status else '10001' }}<br>
                        <strong>Last Update:</strong> <span id="last-update-time">Just now</span><br>
                        <strong>Features:</strong> RGB Support, Graphics, 4 Lines × 20 Chars
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="message-preview" id="message-preview">
                    {% set preview_lines = location_settings.led_default_lines or ['LINE 1', 'LINE 2', 'LINE 3', 'LINE 4'] %}
                    {% for line in preview_lines %}
                    <div class="preview-line">{{ line }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Buttons -->
<div class="row mb-4">
    <div class="col-md-3">
        <button class="btn btn-success w-100" onclick="sendDefaultMessage()">
            <i class="fas fa-home"></i> Default Message
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-warning w-100" onclick="clearDisplay()">
            <i class="fas fa-eraser"></i> Clear Display
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-info w-100" onclick="testAllFeatures()">
            <i class="fas fa-cog"></i> Test Features
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="loadMessageHistory()">
            <i class="fas fa-history"></i> Message History
        </button>
    </div>
</div>

<!-- Main Control Interface -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="ledTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab">
                    <i class="fas fa-edit"></i> Custom Message
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rgb-tab" data-bs-toggle="tab" data-bs-target="#rgb" type="button" role="tab">
                    <i class="fas fa-palette"></i> RGB Message
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="canned-tab" data-bs-toggle="tab" data-bs-target="#canned" type="button" role="tab">
                    <i class="fas fa-list"></i> Canned Messages
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="emergency-tab" data-bs-toggle="tab" data-bs-target="#emergency" type="button" role="tab">
                    <i class="fas fa-exclamation-triangle"></i> Emergency
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                    <i class="fas fa-cogs"></i> Advanced
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="time-tab" data-bs-toggle="tab" data-bs-target="#time" type="button" role="tab">
                    <i class="fas fa-clock"></i> Time Display
                </button>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="ledTabContent">
        <!-- Custom Message Tab -->
        <div class="tab-pane fade show active" id="custom" role="tabpanel">
            <h4><i class="fas fa-edit text-primary"></i> Custom Message</h4>
            <p class="text-muted mb-4">Create messages for the LED sign - 4 lines, 20 characters each.</p>

            <form id="custom-message-form">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Message Text -->
                        {% set positions = [' ', '!', '"', '#'] %}
                        <div class="feature-group">
                            <h6><i class="fas fa-keyboard"></i> Message Designer</h6>
                            <p class="text-muted small mb-3">Click the line cards to edit text, choose colours and effects, and preview exactly how the sign will render each line.</p>
                            <div class="row g-3">
                                {% for idx in range(4) %}
                                <div class="col-xl-6">
                                    <div class="line-editor card shadow-sm" data-line-index="{{ idx }}" data-position="{{ positions[idx] }}">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span class="fw-semibold">Line {{ idx + 1 }}</span>
                                            <span class="char-count" id="line{{ idx + 1 }}-count">0 / 20</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="line-preview" id="line{{ idx + 1 }}-editor" contenteditable="true" data-line-index="{{ idx }}" data-placeholder="Line {{ idx + 1 }} text"></div>
                                            <div class="row g-2 mt-3 line-controls">
                                                <div class="col-md-4">
                                                    <label class="form-label">Colour</label>
                                                    <select class="form-select line-color" data-line-index="{{ idx }}">
                                                        <option value="DEFAULT" selected>Use default</option>
                                                        <option value="RED">🔴 Red</option>
                                                        <option value="GREEN">🟢 Green</option>
                                                        <option value="AMBER">🟠 Amber</option>
                                                        <option value="DIM_RED">🔴 Dim Red</option>
                                                        <option value="DIM_GREEN">🟢 Dim Green</option>
                                                        <option value="BROWN">🤎 Brown</option>
                                                        <option value="ORANGE">🟠 Orange</option>
                                                        <option value="YELLOW">🟡 Yellow</option>
                                                        <option value="RAINBOW_1">🌈 Rainbow 1</option>
                                                        <option value="RAINBOW_2">🌈 Rainbow 2</option>
                                                        <option value="COLOR_MIX">🎨 Color Mix</option>
                                                        <option value="AUTO_COLOR">🔄 Auto Color</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Effect</label>
                                                    <select class="form-select line-mode" data-line-index="{{ idx }}">
                                                        <option value="DEFAULT" selected>Use default</option>
                                                        <option value="HOLD">📌 Hold (Static)</option>
                                                        <option value="FLASH">⚡ Flash</option>
                                                        <option value="SCROLL">📜 Scroll</option>
                                                        <option value="ROTATE">🔄 Rotate</option>
                                                        <option value="ROLL_LEFT">⬅️ Roll Left</option>
                                                        <option value="ROLL_RIGHT">➡️ Roll Right</option>
                                                        <option value="ROLL_UP">⬆️ Roll Up</option>
                                                        <option value="ROLL_DOWN">⬇️ Roll Down</option>
                                                        <option value="WIPE_LEFT">🧽 Wipe Left</option>
                                                        <option value="WIPE_RIGHT">🧽 Wipe Right</option>
                                                        <option value="WIPE_UP">🧽 Wipe Up</option>
                                                        <option value="WIPE_DOWN">🧽 Wipe Down</option>
                                                        <option value="AUTO_MODE">🎲 Auto Mode</option>
                                                        <option value="ROLL_IN">🌪️ Roll In</option>
                                                        <option value="ROLL_OUT">🌪️ Roll Out</option>
                                                        <option value="WIPE_IN">🧽 Wipe In</option>
                                                        <option value="WIPE_OUT">🧽 Wipe Out</option>
                                                        <option value="COMPRESSED_ROTATE">🔄 Compressed Rotate</option>
                                                        <option value="EXPLODE">💥 Explode</option>
                                                        <option value="CLOCK">⏰ Clock</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Speed</label>
                                                    <select class="form-select line-speed" data-line-index="{{ idx }}">
                                                        <option value="DEFAULT" selected>Use default</option>
                                                        <option value="SPEED_1">🐌 Slowest</option>
                                                        <option value="SPEED_2">🚶 Slow</option>
                                                        <option value="SPEED_3">🚴 Medium</option>
                                                        <option value="SPEED_4">🏃 Fast</option>
                                                        <option value="SPEED_5">🏎️ Fastest</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="line-specials mt-3">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input line-special" type="checkbox" id="line{{ idx + 1 }}-flash" value="CHAR_FLASH_ON" data-line-index="{{ idx }}">
                                                    <label class="form-check-label" for="line{{ idx + 1 }}-flash">Character Flash</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input line-special" type="checkbox" id="line{{ idx + 1 }}-wide" value="WIDE_CHAR_ON" data-line-index="{{ idx }}">
                                                    <label class="form-check-label" for="line{{ idx + 1 }}-wide">Wide Characters</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input line-special" type="checkbox" id="line{{ idx + 1 }}-desc" value="TRUE_DESC_ON" data-line-index="{{ idx }}">
                                                    <label class="form-check-label" for="line{{ idx + 1 }}-desc">True Descenders</label>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary line-clear" data-line-index="{{ idx }}">
                                                    <i class="fas fa-backspace"></i> Clear line
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Color & Font Selection -->
                        <div class="feature-group">
                            <h6><i class="fas fa-paint-brush"></i> Default Colour &amp; Font</h6>
                            <p class="text-muted small">Applied whenever a line card is set to "Use default" for colour or font.</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="custom-color" class="form-label">Color</label>
                                    <select class="form-select" id="custom-color" onchange="updatePreview()">
                                        <option value="RED">🔴 Red</option>
                                        <option value="GREEN" selected>🟢 Green</option>
                                        <option value="AMBER">🟠 Amber</option>
                                        <option value="DIM_RED">🔴 Dim Red</option>
                                        <option value="DIM_GREEN">🟢 Dim Green</option>
                                        <option value="BROWN">🤎 Brown</option>
                                        <option value="ORANGE">🟠 Orange</option>
                                        <option value="YELLOW">🟡 Yellow</option>
                                        <option value="RAINBOW_1">🌈 Rainbow 1</option>
                                        <option value="RAINBOW_2">🌈 Rainbow 2</option>
                                        <option value="COLOR_MIX">🎨 Color Mix</option>
                                        <option value="AUTO_COLOR">🔄 Auto Color</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="custom-font" class="form-label">Font Size</label>
                                    <select class="form-select" id="custom-font" onchange="updatePreview()">
                                        <option value="FONT_5x7">5×7 (Tiny)</option>
                                        <option value="FONT_6x7">6×7 (Small)</option>
                                        <option value="FONT_7x9" selected>7×9 (Medium)</option>
                                        <option value="FONT_8x7">8×7 (Medium Wide)</option>
                                        <option value="FONT_7x11">7×11 (Large)</option>
                                        <option value="FONT_15x7">15×7 (Wide)</option>
                                        <option value="FONT_19x7">19×7 (Extra Wide)</option>
                                        <option value="FONT_7x13">7×13 (Large Tall)</option>
                                        <option value="FONT_16x9">16×9 (Large Wide)</option>
                                        <option value="FONT_32x16">32×16 (Huge)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Display Effects -->
                        <div class="feature-group">
                            <h6><i class="fas fa-magic"></i> Default Display Effects</h6>
                            <p class="text-muted small">Line-specific settings override these defaults; otherwise they control the animation applied on the sign.</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="custom-mode" class="form-label">Display Mode</label>
                                    <select class="form-select" id="custom-mode" onchange="updatePreview()">
                                        <option value="HOLD" selected>📌 Hold (Static)</option>
                                        <option value="FLASH">⚡ Flash</option>
                                        <option value="SCROLL">📜 Scroll</option>
                                        <option value="ROTATE">🔄 Rotate</option>
                                        <option value="ROLL_LEFT">⬅️ Roll Left</option>
                                        <option value="ROLL_RIGHT">➡️ Roll Right</option>
                                        <option value="ROLL_UP">⬆️ Roll Up</option>
                                        <option value="ROLL_DOWN">⬇️ Roll Down</option>
                                        <option value="WIPE_LEFT">🧽 Wipe Left</option>
                                        <option value="WIPE_RIGHT">🧽 Wipe Right</option>
                                        <option value="WIPE_UP">🧽 Wipe Up</option>
                                        <option value="WIPE_DOWN">🧽 Wipe Down</option>
                                        <option value="AUTO_MODE">🎲 Auto Mode</option>
                                        <option value="ROLL_IN">🌪️ Roll In</option>
                                        <option value="ROLL_OUT">🌪️ Roll Out</option>
                                        <option value="WIPE_IN">🧽 Wipe In</option>
                                        <option value="WIPE_OUT">🧽 Wipe Out</option>
                                        <option value="COMPRESSED_ROTATE">🔄 Compressed Rotate</option>
                                        <option value="EXPLODE">💥 Explode</option>
                                        <option value="CLOCK">⏰ Clock</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="custom-speed" class="form-label">Animation Speed</label>
                                    <select class="form-select" id="custom-speed">
                                        <option value="SPEED_1">🐌 Slowest</option>
                                        <option value="SPEED_2">🚶 Slow</option>
                                        <option value="SPEED_3" selected>🚴 Medium</option>
                                        <option value="SPEED_4">🏃 Fast</option>
                                        <option value="SPEED_5">🏎️ Fastest</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Priority & Settings -->
                        <div class="feature-group">
                            <h6><i class="fas fa-exclamation"></i> Priority & Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="custom-priority" class="form-label">Message Priority</label>
                                    <select class="form-select" id="custom-priority">
                                        <option value="0">🚨 Emergency</option>
                                        <option value="1">⚠️ Urgent</option>
                                        <option value="2" selected>ℹ️ Normal</option>
                                        <option value="3">📝 Low</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="custom-hold" class="form-label">Hold Time (seconds)</label>
                                    <input type="number" class="form-control" id="custom-hold" min="1" max="60" value="5">
                                </div>
                            </div>
                        </div>

                        <!-- Special Functions -->
                        <div class="feature-group">
                            <h6><i class="fas fa-star"></i> Typography Options</h6>
                            <p class="text-muted small">Line-specific flash, wide, and descender toggles are available on each editor card. Use these controls to set the default font width for the entire message.</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="special-function-group">
                                        <h6 class="mb-2">Font Width</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="font-style" id="fixed-width" value="FIXED_WIDTH">
                                            <label class="form-check-label" for="fixed-width">Fixed Width Font</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="font-style" id="prop-width" value="PROP_WIDTH" checked>
                                            <label class="form-check-label" for="prop-width">Proportional Width Font</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="sticky-top" style="top: 20px;">
                            <div class="mb-3">
                                <label class="form-label">Live Preview</label>
                                <div class="message-preview" id="custom-preview">
                                    <div class="preview-line" id="preview-line1">Enter message</div>
                                    <div class="preview-line" id="preview-line2">to see preview</div>
                                    <div class="preview-line" id="preview-line3"></div>
                                    <div class="preview-line" id="preview-line4"></div>
                                </div>
                                <div class="effect-preview mt-2" id="effect-description">
                                    Effect: Static display
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane"></i> Send to LED Sign
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearPreview()">
                                    <i class="fas fa-eraser"></i> Clear All Lines
                                </button>
                                <button type="button" class="btn btn-info" onclick="fillSampleMessage()">
                                    <i class="fas fa-eye"></i> Sample Message
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- RGB Message Tab -->
        <div class="tab-pane fade" id="rgb" role="tabpanel">
            <h4><i class="fas fa-palette text-danger"></i> RGB Custom Color Message</h4>
            <p class="text-muted mb-4">Use custom RGB colors (RRGGBB format) for enhanced visual effects.</p>

            <form id="rgb-message-form">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- RGB Message Text -->
                        <div class="feature-group">
                            <h6><i class="fas fa-keyboard"></i> RGB Message Text</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="rgb-line1" class="form-label">Line 1</label>
                                    <input type="text" class="form-control" id="rgb-line1" maxlength="20" placeholder="Line 1" oninput="updateRGBPreview()">
                                </div>
                                <div class="col-md-6">
                                    <label for="rgb-line2" class="form-label">Line 2</label>
                                    <input type="text" class="form-control" id="rgb-line2" maxlength="20" placeholder="Line 2" oninput="updateRGBPreview()">
                                </div>
                                <div class="col-md-6">
                                    <label for="rgb-line3" class="form-label">Line 3</label>
                                    <input type="text" class="form-control" id="rgb-line3" maxlength="20" placeholder="Line 3" oninput="updateRGBPreview()">
                                </div>
                                <div class="col-md-6">
                                    <label for="rgb-line4" class="form-label">Line 4</label>
                                    <input type="text" class="form-control" id="rgb-line4" maxlength="20" placeholder="Line 4" oninput="updateRGBPreview()">
                                </div>
                            </div>
                        </div>

                        <!-- RGB Color Controls -->
                        <div class="feature-group">
                            <h6><i class="fas fa-palette"></i> RGB Color Selection</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="rgb-color" class="form-label">RGB Color (RRGGBB)</label>
                                    <div class="rgb-input-group">
                                        <input type="text" class="form-control" id="rgb-color" value="FF6600" placeholder="FF6600" maxlength="6" oninput="updateRGBPreview()">
                                        <div class="rgb-preview" id="rgb-color-preview"></div>
                                    </div>
                                    <small class="form-text text-muted">Enter 6-digit hex color (e.g., FF0000 for red)</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Color Presets</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="button" class="btn btn-sm" style="background: #FF0000; color: white;" onclick="setRGBColor('FF0000')">Red</button>
                                        <button type="button" class="btn btn-sm" style="background: #00FF00; color: black;" onclick="setRGBColor('00FF00')">Green</button>
                                        <button type="button" class="btn btn-sm" style="background: #0000FF; color: white;" onclick="setRGBColor('0000FF')">Blue</button>
                                        <button type="button" class="btn btn-sm" style="background: #FF00FF; color: white;" onclick="setRGBColor('FF00FF')">Magenta</button>
                                        <button type="button" class="btn btn-sm" style="background: #FFFF00; color: black;" onclick="setRGBColor('FFFF00')">Yellow</button>
                                        <button type="button" class="btn btn-sm" style="background: #00FFFF; color: black;" onclick="setRGBColor('00FFFF')">Cyan</button>
                                        <button type="button" class="btn btn-sm" style="background: #FF6600; color: white;" onclick="setRGBColor('FF6600')">Orange</button>
                                        <button type="button" class="btn btn-sm" style="background: #8000FF; color: white;" onclick="setRGBColor('8000FF')">Purple</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RGB Display Settings -->
                        <div class="feature-group">
                            <h6><i class="fas fa-cog"></i> Display Settings</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="rgb-font" class="form-label">Font</label>
                                    <select class="form-select" id="rgb-font">
                                        <option value="FONT_7x9" selected>7×9 Medium</option>
                                        <option value="FONT_7x13">7×13 Large</option>
                                        <option value="FONT_16x9">16×9 Wide</option>
                                        <option value="FONT_32x16">32×16 Huge</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="rgb-mode" class="form-label">Effect</label>
                                    <select class="form-select" id="rgb-mode">
                                        <option value="HOLD">Hold</option>
                                        <option value="FLASH">Flash</option>
                                        <option value="SCROLL" selected>Scroll</option>
                                        <option value="EXPLODE">Explode</option>
                                        <option value="RAINBOW_1">Rainbow</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="rgb-speed" class="form-label">Speed</label>
                                    <select class="form-select" id="rgb-speed">
                                        <option value="SPEED_2">Slow</option>
                                        <option value="SPEED_3" selected>Medium</option>
                                        <option value="SPEED_4">Fast</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="sticky-top" style="top: 20px;">
                            <div class="mb-3">
                                <label class="form-label">RGB Preview</label>
                                <div class="message-preview" id="rgb-preview">
                                    <div class="preview-line" id="rgb-preview-line1">RGB Message</div>
                                    <div class="preview-line" id="rgb-preview-line2">Custom Colors</div>
                                    <div class="preview-line" id="rgb-preview-line3">Enter text above</div>
                                    <div class="preview-line" id="rgb-preview-line4"></div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-palette"></i> Send RGB Message
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearRGBMessage()">
                                    <i class="fas fa-eraser"></i> Clear RGB
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Canned Messages Tab -->
        <div class="tab-pane fade" id="canned" role="tabpanel">
            <h4><i class="fas fa-list text-success"></i> Predefined Messages</h4>
            <p class="text-muted mb-4">Quick access to common emergency and informational messages.</p>

            <div class="row" id="canned-messages-container">
                <!-- Canned messages will be loaded here -->
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>Welcome Message</strong>
                            <span class="priority-badge priority-low">Low</span>
                        </div>
                        <div class="card-body">
                            <div class="message-preview small mb-2">
                                <div class="preview-line">WELCOME TO</div>
                                <div class="preview-line">PUTNAM COUNTY</div>
                                <div class="preview-line">EMERGENCY MGMT</div>
                                <div class="preview-line"></div>
                            </div>
                            <button class="btn btn-success btn-sm w-100" onclick="sendCannedMessage('welcome')">
                                <i class="fas fa-paper-plane"></i> Send Welcome
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>Emergency Severe</strong>
                            <span class="priority-badge priority-emergency">Emergency</span>
                        </div>
                        <div class="card-body">
                            <div class="message-preview small mb-2 flash-preview">
                                <div class="preview-line">EMERGENCY ALERT</div>
                                <div class="preview-line">SEVERE WEATHER</div>
                                <div class="preview-line">TAKE SHELTER</div>
                                <div class="preview-line">IMMEDIATELY</div>
                            </div>
                            <button class="btn btn-danger btn-sm w-100" onclick="sendCannedMessage('emergency_severe')">
                                <i class="fas fa-exclamation-triangle"></i> Send Alert
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>Rainbow Test</strong>
                            <span class="priority-badge priority-normal">Normal</span>
                        </div>
                        <div class="card-body">
                            <div class="message-preview small mb-2 rainbow-text">
                                <div class="preview-line">RAINBOW TEST</div>
                                <div class="preview-line">COLOR CYCLING</div>
                                <div class="preview-line">ALPHA 9120C</div>
                                <div class="preview-line">M-PROTOCOL</div>
                            </div>
                            <button class="btn btn-info btn-sm w-100" onclick="sendCannedMessage('rainbow_test')">
                                <i class="fas fa-rainbow"></i> Send Test
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>No Alerts</strong>
                            <span class="priority-badge priority-normal">Normal</span>
                        </div>
                        <div class="card-body">
                            <div class="message-preview small mb-2">
                                <div class="preview-line">PUTNAM COUNTY</div>
                                <div class="preview-line">NO ACTIVE</div>
                                <div class="preview-line">ALERTS</div>
                                <div class="preview-line">ALL CLEAR</div>
                            </div>
                            <button class="btn btn-success btn-sm w-100" onclick="sendCannedMessage('no_alerts')">
                                <i class="fas fa-check-circle"></i> Send All Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Tab -->
        <div class="tab-pane fade" id="emergency" role="tabpanel">
            <h4><i class="fas fa-exclamation-triangle text-danger"></i> Emergency Override</h4>
            <p class="text-muted mb-4">High-priority emergency messages with immediate display and flashing effects.</p>

            <form id="emergency-message-form">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="feature-group">
                            <h6><i class="fas fa-keyboard"></i> Emergency Message</h6>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Warning:</strong> Emergency messages override all other displays and flash continuously.
                            </div>

                            <div class="mb-3">
                                <label for="emergency-text" class="form-label">Emergency Text (Auto-wrapped to 4 lines)</label>
                                <textarea class="form-control" id="emergency-text" rows="3" placeholder="Enter emergency message..." oninput="updateEmergencyPreview()"></textarea>
                                <small class="form-text text-muted">Text will automatically wrap to fit 4 lines of 20 characters each.</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Quick Templates</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="setEmergencyTemplate('SEVERE WEATHER WARNING TAKE SHELTER IMMEDIATELY TORNADO WATCH')">
                                            🌪️ Tornado Warning
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="setEmergencyTemplate('EVACUATION ORDER LEAVE AREA IMMEDIATELY FOLLOW POSTED ROUTES')">
                                            🚨 Evacuation Order
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="setEmergencyTemplate('SHELTER IN PLACE CLOSE ALL WINDOWS TURN OFF VENTILATION')">
                                            🏠 Shelter In Place
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="setEmergencyTemplate('FLOOD WARNING AVOID LOW AREAS ROADS MAY BE IMPASSABLE')">
                                            🌊 Flood Warning
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="emergency-duration" class="form-label">Display Duration</label>
                                    <select class="form-select" id="emergency-duration">
                                        <option value="30">30 seconds</option>
                                        <option value="60" selected>1 minute</option>
                                        <option value="120">2 minutes</option>
                                        <option value="300">5 minutes</option>
                                        <option value="600">10 minutes</option>
                                        <option value="0">Until manually cleared</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="sticky-top" style="top: 20px;">
                            <div class="mb-3">
                                <label class="form-label">Emergency Preview</label>
                                <div class="message-preview flash-preview" id="emergency-preview" style="background: #330000; color: #ff6666;">
                                    <div class="preview-line" id="emergency-preview-line1">EMERGENCY</div>
                                    <div class="preview-line" id="emergency-preview-line2">ALERT</div>
                                    <div class="preview-line" id="emergency-preview-line3">Enter emergency</div>
                                    <div class="preview-line" id="emergency-preview-line4">message above</div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-emergency btn-lg">
                                    <i class="fas fa-exclamation-triangle"></i> SEND EMERGENCY ALERT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Features Tab -->
        <div class="tab-pane fade" id="advanced" role="tabpanel">
            <h4><i class="fas fa-cogs text-info"></i> Advanced Features</h4>
            <p class="text-muted mb-4">Advanced M-Protocol features and sign configuration.</p>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-sun"></i> Brightness Control</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="brightness-slider" class="form-label">Brightness Level: <span id="brightness-value">10</span></label>
                                <input type="range" class="form-range" id="brightness-slider" min="1" max="16" value="10"
                                       oninput="updateBrightnessValue(this.value)">
                                <div class="d-flex justify-content-between">
                                    <small>Dim (1)</small>
                                    <small>Bright (16)</small>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="setBrightness()">
                                <i class="fas fa-check"></i> Apply Brightness
                            </button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-vial"></i> Test Functions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="testAllColors()">
                                    <i class="fas fa-palette"></i> Test All Colors
                                </button>
                                <button class="btn btn-outline-primary" onclick="testAllFonts()">
                                    <i class="fas fa-font"></i> Test All Fonts
                                </button>
                                <button class="btn btn-outline-primary" onclick="testAllModes()">
                                    <i class="fas fa-magic"></i> Test All Effects
                                </button>
                                <button class="btn btn-outline-primary" onclick="testRGBColors()">
                                    <i class="fas fa-rainbow"></i> Test RGB Colors
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-network-wired"></i> Sign Information</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr><td><strong>Model:</strong></td><td>Alpha 9120C</td></tr>
                                <tr><td><strong>Protocol:</strong></td><td>M-Protocol</td></tr>
                                <tr><td><strong>Display:</strong></td><td>4 Lines × 20 Characters</td></tr>
                                <tr><td><strong>Colors:</strong></td><td>12 Standard + RGB</td></tr>
                                <tr><td><strong>Fonts:</strong></td><td>10 Different Sizes</td></tr>
                                <tr><td><strong>Effects:</strong></td><td>20+ Display Modes</td></tr>
                                <tr><td><strong>Special:</strong></td><td>8 Special Functions</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-tools"></i> System Controls</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="clearAllMessages()">
                                    <i class="fas fa-trash"></i> Clear All Messages
                                </button>
                                <button class="btn btn-info" onclick="getSignStatus()">
                                    <i class="fas fa-info-circle"></i> Get Sign Status
                                </button>
                                <button class="btn btn-secondary" onclick="resetSign()">
                                    <i class="fas fa-power-off"></i> Reset Sign
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Display Tab -->
        <div class="tab-pane fade" id="time" role="tabpanel">
            <h4><i class="fas fa-clock text-primary"></i> Time & Date Display</h4>
            <p class="text-muted mb-4">Configure time and date display formats and automatic time updates.</p>

            <div class="row">
                <div class="col-md-8">
                    <div class="feature-group">
                        <h6><i class="fas fa-calendar"></i> Date Format</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="date-format" class="form-label">Date Format</label>
                                <select class="form-select" id="date-format">
                                    <option value="MMDDYY">MM/DD/YY (US Format)</option>
                                    <option value="DDMMYY">DD/MM/YY (European)</option>
                                    <option value="MMDDYYYY" selected>MM/DD/YYYY (US Long)</option>
                                    <option value="DDMMYYYY">DD/MM/YYYY (European Long)</option>
                                    <option value="YYMMDD">YY-MM-DD (ISO Short)</option>
                                    <option value="YYYYMMDD">YYYY-MM-DD (ISO Long)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="time-format" class="form-label">Time Format</label>
                                <select class="form-select" id="time-format">
                                    <option value="TIME_12H" selected>12 Hour (AM/PM)</option>
                                    <option value="TIME_24H">24 Hour (Military)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="feature-group">
                        <h6><i class="fas fa-cog"></i> Time Display Settings</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="time-color" class="form-label">Time Color</label>
                                <select class="form-select" id="time-color">
                                    <option value="GREEN" selected>Green</option>
                                    <option value="AMBER">Amber</option>
                                    <option value="RED">Red</option>
                                    <option value="YELLOW">Yellow</option>
                                    <option value="AUTO_COLOR">Auto Color</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="time-font" class="form-label">Time Font</label>
                                <select class="form-select" id="time-font">
                                    <option value="FONT_7x13" selected>7×13 Large</option>
                                    <option value="FONT_16x9">16×9 Wide</option>
                                    <option value="FONT_32x16">32×16 Huge</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-update">
                                    <label class="form-check-label" for="auto-update">
                                        Auto-update every minute
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-seconds">
                                    <label class="form-check-label" for="show-seconds">
                                        Show seconds
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-primary" onclick="sendTimeDisplay()">
                            <i class="fas fa-clock"></i> Send Time Display
                        </button>
                        <button class="btn btn-secondary" onclick="sendDateDisplay()">
                            <i class="fas fa-calendar"></i> Send Date Display
                        </button>
                        <button class="btn btn-info" onclick="sendDateTimeDisplay()">
                            <i class="fas fa-calendar-clock"></i> Send Date & Time
                        </button>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="sticky-top" style="top: 20px;">
                        <div class="mb-3">
                            <label class="form-label">Time Preview</label>
                            <div class="message-preview" id="time-preview">
                                <div class="preview-line" id="time-preview-date">07/28/2025</div>
                                <div class="preview-line" id="time-preview-time">2:30:45 PM</div>
                                <div class="preview-line"></div>
                                <div class="preview-line"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message History -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-history"></i> Message History
            <button class="btn btn-sm btn-outline-primary float-end" onclick="loadMessageHistory()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-control" id="history-filter">
                    <option value="all">All Messages</option>
                    <option value="custom">Custom</option>
                    <option value="canned">Canned</option>
                    <option value="emergency">Emergency</option>
                    <option value="rgb">RGB</option>
                </select>
            </div>
            <div class="col-md-8">
                <input type="text" class="form-control" id="history-search" placeholder="Search messages..." onkeyup="searchHistory()">
            </div>
        </div>

        <div class="message-history" id="message-history" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center py-4">
                <div class="loading-spinner"></div>
                Loading message history...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// LED Control JavaScript with ALL Features
let ledStatus = null;
let cannedMessages = [];
let messageHistory = [];
let filteredHistory = [];

// Complete color mapping
const colorMap = {
    'RED': '#ff0000', 'GREEN': '#00ff00', 'AMBER': '#ffbf00', 'DIM_RED': '#800000',
    'DIM_GREEN': '#008000', 'BROWN': '#964B00', 'ORANGE': '#ff8000', 'YELLOW': '#ffff00',
    'RAINBOW_1': 'linear-gradient(45deg, #ff0000, #00ff00, #0000ff)',
    'RAINBOW_2': 'linear-gradient(45deg, #ff00ff, #ffff00, #00ffff)',
    'COLOR_MIX': 'linear-gradient(45deg, #ff0000, #00ff00, #0000ff, #ffff00)',
    'AUTO_COLOR': '#ffffff'
};

// Font size mapping
const fontSizeMap = {
    'FONT_5x7': '0.7em', 'FONT_6x7': '0.8em', 'FONT_7x9': '1.0em', 'FONT_8x7': '1.1em',
    'FONT_7x11': '1.2em', 'FONT_15x7': '1.4em', 'FONT_19x7': '1.6em', 'FONT_7x13': '1.3em',
    'FONT_16x9': '1.5em', 'FONT_32x16': '2.0em'
};

// Display mode descriptions
const modeDescriptions = {
    'HOLD': 'Static display', 'FLASH': 'Flashing display', 'SCROLL': 'Continuous scrolling',
    'ROTATE': 'Rotating text', 'ROLL_LEFT': 'Roll in from right', 'ROLL_RIGHT': 'Roll in from left',
    'ROLL_UP': 'Roll in from bottom', 'ROLL_DOWN': 'Roll in from top', 'WIPE_LEFT': 'Wipe from right to left',
    'WIPE_RIGHT': 'Wipe from left to right', 'WIPE_UP': 'Wipe from bottom to top', 'WIPE_DOWN': 'Wipe from top to bottom',
    'AUTO_MODE': 'Automatic mode cycling', 'ROLL_IN': 'Roll to center', 'ROLL_OUT': 'Roll from center',
    'WIPE_IN': 'Wipe to center', 'WIPE_OUT': 'Wipe from center', 'COMPRESSED_ROTATE': 'Compressed rotation',
    'EXPLODE': 'Exploding text effect', 'CLOCK': 'Clock display mode'
};

const MAX_LINE_LENGTH = 20;

function getLineEditors() {
    return Array.from(document.querySelectorAll('.line-editor'));
}

function enforceCharacterLimit(element) {
    const text = element.innerText.replace(/\s+/g, ' ');
    if (text.length > MAX_LINE_LENGTH) {
        element.innerText = text.slice(0, MAX_LINE_LENGTH);
        placeCaretAtEnd(element);
    } else if (text !== element.innerText) {
        element.innerText = text;
        placeCaretAtEnd(element);
    }
}

function placeCaretAtEnd(element) {
    if (!element || !element.childNodes) return;
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(element);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
}

function resolveLineColor(value) {
    return value && value !== 'DEFAULT' ? value : document.getElementById('custom-color').value;
}

function resolveLineMode(value) {
    return value && value !== 'DEFAULT' ? value : document.getElementById('custom-mode').value;
}

function resolveLineSpeed(value) {
    return value && value !== 'DEFAULT' ? value : document.getElementById('custom-speed').value;
}

function buildLinePayload() {
    return getLineEditors().map(editor => {
        const index = editor.dataset.lineIndex;
        const preview = editor.querySelector('.line-preview');
        const text = (preview.innerText || '').trim();
        const colorSelect = editor.querySelector('.line-color').value;
        const modeSelect = editor.querySelector('.line-mode').value;
        const speedSelect = editor.querySelector('.line-speed').value;
        const specials = Array.from(editor.querySelectorAll('.line-special:checked')).map(cb => cb.value);

        const segment = { text: text.slice(0, MAX_LINE_LENGTH) };
        if (colorSelect !== 'DEFAULT') segment.color = colorSelect;
        if (modeSelect !== 'DEFAULT') segment.mode = modeSelect;
        if (speedSelect !== 'DEFAULT') segment.speed = speedSelect;
        if (specials.length) segment.special_functions = specials;

        return {
            display_position: editor.dataset.position,
            segments: [segment]
        };
    });
}

function applyLineStyle(editor) {
    const preview = editor.querySelector('.line-preview');
    const colorValue = resolveLineColor(editor.querySelector('.line-color').value);
    const modeValue = resolveLineMode(editor.querySelector('.line-mode').value);

    preview.style.color = colorMap[colorValue] || '#00ff00';
    preview.classList.remove('flash-preview', 'rainbow-text');
    if (colorValue.includes('RAINBOW') || colorValue === 'COLOR_MIX') {
        preview.classList.add('rainbow-text');
    }
    if (modeValue === 'FLASH') {
        preview.classList.add('flash-preview');
    }
}

function refreshMainPreview() {
    const payload = buildLinePayload();
    payload.forEach((line, idx) => {
        const previewLine = document.getElementById(`preview-line${idx + 1}`);
        if (!previewLine) return;
        const segment = line.segments[0] || { text: '' };
        const text = segment.text || '';
        previewLine.textContent = text || (idx <= 1 ? ['Enter message', 'to see preview'][idx] : '');
        const colorValue = resolveLineColor(segment.color || line.color);
        const modeValue = resolveLineMode(segment.mode || line.mode);
        previewLine.style.color = colorMap[colorValue] || '#00ff00';
        previewLine.style.fontSize = fontSizeMap[document.getElementById('custom-font').value] || '1.0em';
        previewLine.className = 'preview-line';
        if (colorValue && (colorValue.includes('RAINBOW') || colorValue === 'COLOR_MIX')) {
            previewLine.classList.add('rainbow-text');
        }
        if (modeValue === 'FLASH') {
            previewLine.classList.add('flash-preview');
        }
    });

    const activeMode = document.getElementById('custom-mode').value;
    document.getElementById('effect-description').textContent = `Effect: ${modeDescriptions[activeMode] || activeMode}`;
}

function updateLineState(index) {
    const editor = document.querySelector(`.line-editor[data-line-index="${index}"]`);
    if (!editor) return;
    const preview = editor.querySelector('.line-preview');
    enforceCharacterLimit(preview);
    const count = preview.innerText.trim().length;
    const countElement = editor.querySelector('.char-count');
    if (countElement) {
        countElement.textContent = `${count} / ${MAX_LINE_LENGTH}`;
    }
    applyLineStyle(editor);
    refreshMainPreview();
}

function clearLine(index) {
    const editor = document.querySelector(`.line-editor[data-line-index="${index}"]`);
    if (!editor) return;
    editor.querySelector('.line-preview').innerText = '';
    editor.querySelector('.line-color').value = 'DEFAULT';
    editor.querySelector('.line-mode').value = 'DEFAULT';
    editor.querySelector('.line-speed').value = 'DEFAULT';
    editor.querySelectorAll('.line-special').forEach(cb => { cb.checked = false; });
    updateLineState(index);
}

function initLineEditors() {
    getLineEditors().forEach(editor => {
        const index = editor.dataset.lineIndex;
        const preview = editor.querySelector('.line-preview');
        preview.addEventListener('input', () => updateLineState(index));
        preview.addEventListener('blur', () => updateLineState(index));
        editor.querySelectorAll('.line-color, .line-mode, .line-speed').forEach(select => {
            select.addEventListener('change', () => updateLineState(index));
        });
        editor.querySelectorAll('.line-special').forEach(checkbox => {
            checkbox.addEventListener('change', () => updateLineState(index));
        });
        const clearButton = editor.querySelector('.line-clear');
        if (clearButton) {
            clearButton.addEventListener('click', () => clearLine(index));
        }
        updateLineState(index);
    });
}

// Initialize LED control
function initLEDControl() {
    loadLEDStatus();
    loadCannedMessages();
    loadMessageHistory();
    setupFormHandlers();
    initLineEditors();
    updateTimePreview();
    setInterval(loadLEDStatus, 30000);
    setInterval(updateTimePreview, 1000);

    // Initialize RGB preview
    updateRGBPreview();
    refreshMainPreview();
}

function setupFormHandlers() {
    document.getElementById('custom-message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendCustomMessage();
    });

    document.getElementById('rgb-message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendRGBMessage();
    });

    document.getElementById('emergency-message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEmergencyMessage();
    });
}

// Preview update functions
function updatePreview() {
    getLineEditors().forEach(editor => applyLineStyle(editor));
    refreshMainPreview();
}

function updateRGBPreview() {
    const lines = [
        document.getElementById('rgb-line1').value || '',
        document.getElementById('rgb-line2').value || '',
        document.getElementById('rgb-line3').value || '',
        document.getElementById('rgb-line4').value || ''
    ];

    const rgbColor = document.getElementById('rgb-color').value;
    const hexColor = rgbColor.length === 6 ? '#' + rgbColor : '#FF6600';

    // Update RGB color preview
    document.getElementById('rgb-color-preview').style.backgroundColor = hexColor;

    // Update preview lines
    for (let i = 1; i <= 4; i++) {
        const element = document.getElementById(`rgb-preview-line${i}`);
        element.textContent = lines[i-1] || ['RGB Message', 'Custom Colors', 'Enter text above', ''][i-1];
        element.style.color = hexColor;
    }

    // Update main preview background color
    document.getElementById('rgb-preview').style.color = hexColor;
}

function updateEmergencyPreview() {
    const text = document.getElementById('emergency-text').value;
    if (!text) return;

    // Auto-wrap text to 4 lines of 20 characters
    const words = text.split(' ');
    let lines = ['', '', '', ''];
    let currentLine = 0;
    let currentLength = 0;

    for (let word of words) {
        if (currentLine >= 4) break;

        if (currentLength + word.length + 1 <= 20) {
            lines[currentLine] += (lines[currentLine] ? ' ' : '') + word;
            currentLength += word.length + 1;
        } else {
            currentLine++;
            if (currentLine < 4) {
                lines[currentLine] = word;
                currentLength = word.length;
            }
        }
    }

    // Update preview
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`emergency-preview-line${i}`).textContent =
            lines[i-1] || (i <= 2 ? ['EMERGENCY', 'ALERT'][i-1] : '');
    }
}

function updateTimePreview() {
    const now = new Date();
    const dateFormat = document.getElementById('date-format')?.value || 'MMDDYYYY';
    const timeFormat = document.getElementById('time-format')?.value || 'TIME_12H';
    const showSeconds = document.getElementById('show-seconds')?.checked || false;

    let dateStr = '';
    let timeStr = '';

    // Format date
    switch(dateFormat) {
        case 'MMDDYY':
            dateStr = (now.getMonth()+1).toString().padStart(2,'0') + '/' +
                     now.getDate().toString().padStart(2,'0') + '/' +
                     now.getFullYear().toString().slice(-2);
            break;
        case 'DDMMYY':
            dateStr = now.getDate().toString().padStart(2,'0') + '/' +
                     (now.getMonth()+1).toString().padStart(2,'0') + '/' +
                     now.getFullYear().toString().slice(-2);
            break;
        case 'MMDDYYYY':
            dateStr = (now.getMonth()+1).toString().padStart(2,'0') + '/' +
                     now.getDate().toString().padStart(2,'0') + '/' +
                     now.getFullYear();
            break;
        case 'DDMMYYYY':
            dateStr = now.getDate().toString().padStart(2,'0') + '/' +
                     (now.getMonth()+1).toString().padStart(2,'0') + '/' +
                     now.getFullYear();
            break;
        case 'YYMMDD':
            dateStr = now.getFullYear().toString().slice(-2) + '-' +
                     (now.getMonth()+1).toString().padStart(2,'0') + '-' +
                     now.getDate().toString().padStart(2,'0');
            break;
        case 'YYYYMMDD':
            dateStr = now.getFullYear() + '-' +
                     (now.getMonth()+1).toString().padStart(2,'0') + '-' +
                     now.getDate().toString().padStart(2,'0');
            break;
    }

    // Format time
    if (timeFormat === 'TIME_12H') {
        let hours = now.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;

        timeStr = hours + ':' + now.getMinutes().toString().padStart(2,'0');
        if (showSeconds) timeStr += ':' + now.getSeconds().toString().padStart(2,'0');
        timeStr += ' ' + ampm;
    } else {
        timeStr = now.getHours().toString().padStart(2,'0') + ':' +
                 now.getMinutes().toString().padStart(2,'0');
        if (showSeconds) timeStr += ':' + now.getSeconds().toString().padStart(2,'0');
    }

    // Update preview
    if (document.getElementById('time-preview-date')) {
        document.getElementById('time-preview-date').textContent = dateStr;
        document.getElementById('time-preview-time').textContent = timeStr;
    }
}

// Color and utility functions
function setRGBColor(color) {
    document.getElementById('rgb-color').value = color;
    updateRGBPreview();
}

function updateBrightnessValue(value) {
    document.getElementById('brightness-value').textContent = value;
}

function clearPreview() {
    getLineEditors().forEach((editor, index) => {
        editor.querySelector('.line-preview').innerText = '';
        editor.querySelector('.line-color').value = 'DEFAULT';
        editor.querySelector('.line-mode').value = 'DEFAULT';
        editor.querySelector('.line-speed').value = 'DEFAULT';
        editor.querySelectorAll('.line-special').forEach(cb => { cb.checked = false; });
        updateLineState(index);
    });
    document.getElementById('custom-color').value = 'GREEN';
    document.getElementById('custom-font').value = 'FONT_7x9';
    document.getElementById('custom-mode').value = 'HOLD';
    document.getElementById('custom-speed').value = 'SPEED_3';
    document.getElementById('prop-width').checked = true;
    refreshMainPreview();
}

function clearRGBMessage() {
    ['rgb-line1', 'rgb-line2', 'rgb-line3', 'rgb-line4'].forEach(id => {
        document.getElementById(id).value = '';
    });
    setRGBColor('FF6600');
}

function fillSampleMessage() {
    const examples = [
        { text: 'PUTNAM COUNTY', color: 'RED', mode: 'HOLD' },
        { text: 'EMERGENCY MGMT', color: 'GREEN', mode: 'ROLL_LEFT' },
        { text: 'SYSTEM TEST', color: 'AMBER', mode: 'SCROLL' },
        { text: 'MESSAGE OK', color: 'AUTO_COLOR', mode: 'FLASH' }
    ];

    getLineEditors().forEach((editor, index) => {
        const sample = examples[index] || { text: '' };
        editor.querySelector('.line-preview').innerText = sample.text;
        editor.querySelector('.line-color').value = sample.color ? sample.color : 'DEFAULT';
        editor.querySelector('.line-mode').value = sample.mode ? sample.mode : 'DEFAULT';
        editor.querySelector('.line-speed').value = sample.speed ? sample.speed : 'DEFAULT';
        editor.querySelectorAll('.line-special').forEach(cb => { cb.checked = false; });
        updateLineState(index);
    });

    document.getElementById('custom-color').value = 'GREEN';
    document.getElementById('custom-font').value = 'FONT_7x9';
    document.getElementById('custom-mode').value = 'HOLD';
    document.getElementById('custom-speed').value = 'SPEED_3';
    document.getElementById('prop-width').checked = true;
    refreshMainPreview();
}

function setEmergencyTemplate(template) {
    document.getElementById('emergency-text').value = template;
    updateEmergencyPreview();
}

// Message sending functions
function sendCustomMessage() {
    const linePayload = buildLinePayload();
    const hasContent = linePayload.some(line =>
        (line.segments || []).some(segment => (segment.text || '').trim().length > 0)
    );

    if (!hasContent) {
        showToast('Please enter at least one line of text', 'error');
        return;
    }

    const specialFunctions = [];
    const fontStyle = document.querySelector('input[name="font-style"]:checked');
    if (fontStyle && fontStyle.value) {
        specialFunctions.push(fontStyle.value);
    }

    const message = {
        lines: linePayload,
        color: document.getElementById('custom-color').value,
        font: document.getElementById('custom-font').value,
        mode: document.getElementById('custom-mode').value,
        speed: document.getElementById('custom-speed').value,
        priority: parseInt(document.getElementById('custom-priority').value),
        hold_time: parseInt(document.getElementById('custom-hold').value)
    };

    if (specialFunctions.length) {
        message.special_functions = specialFunctions;
    }

    fetch('/api/led/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Custom message sent successfully', 'success');
            loadMessageHistory();
        } else {
            showToast('Failed to send message: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error sending message', 'error');
        console.error('Error:', error);
    });
}

function sendRGBMessage() {
    const lines = [
        document.getElementById('rgb-line1').value,
        document.getElementById('rgb-line2').value,
        document.getElementById('rgb-line3').value,
        document.getElementById('rgb-line4').value
    ].filter(line => line.trim() !== '');

    if (lines.length === 0) {
        showToast('Please enter at least one line of text', 'error');
        return;
    }

    const rgbColor = document.getElementById('rgb-color').value;
    if (!/^[0-9A-Fa-f]{6}$/.test(rgbColor)) {
        showToast('Please enter a valid 6-digit hex color (e.g., FF0000)', 'error');
        return;
    }

    const message = {
        lines: lines,
        rgb_color: rgbColor,
        font: document.getElementById('rgb-font').value,
        mode: document.getElementById('rgb-mode').value,
        speed: document.getElementById('rgb-speed').value,
        priority: 2
    };

    fetch('/api/led/send_rgb_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('RGB message sent successfully', 'success');
            loadMessageHistory();
        } else {
            showToast('Failed to send RGB message: ' + result.error, 'error');
        }
    });
}

function sendEmergencyMessage() {
    const text = document.getElementById('emergency-text').value.trim();
    if (!text) {
        showToast('Please enter emergency message text', 'error');
        return;
    }

    const duration = parseInt(document.getElementById('emergency-duration').value);

    const message = {
        text: text,
        duration: duration,
        priority: 0  // Emergency priority
    };

    fetch('/api/led/emergency_override', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Emergency message sent!', 'success');
            loadMessageHistory();
        } else {
            showToast('Failed to send emergency message: ' + result.error, 'error');
        }
    });
}

function sendCannedMessage(messageName) {
    fetch('/api/led/send_canned', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message_name: messageName })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast(`Canned message "${messageName}" sent`, 'success');
            loadMessageHistory();
        } else {
            showToast('Failed to send canned message: ' + result.error, 'error');
        }
    });
}

// Time display functions
function sendTimeDisplay() {
    const timeFormat = document.getElementById('time-format').value;
    const color = document.getElementById('time-color').value;
    const font = document.getElementById('time-font').value;

    fetch('/api/led/set_time_format', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            time_format: timeFormat,
            color: color,
            font: font
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Time display format set', 'success');
        } else {
            showToast('Failed to set time format: ' + result.error, 'error');
        }
    });
}

function sendDateDisplay() {
    const dateFormat = document.getElementById('date-format').value;
    const color = document.getElementById('time-color').value;
    const font = document.getElementById('time-font').value;

    fetch('/api/led/set_time_format', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            time_format: dateFormat,
            color: color,
            font: font
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Date display format set', 'success');
        } else {
            showToast('Failed to set date format: ' + result.error, 'error');
        }
    });
}

function sendDateTimeDisplay() {
    const lines = [];
    const now = new Date();
    const dateFormat = document.getElementById('date-format').value;
    const timeFormat = document.getElementById('time-format').value;

    // Build date/time message
    updateTimePreview();
    lines.push(document.getElementById('time-preview-date').textContent);
    lines.push(document.getElementById('time-preview-time').textContent);

    const message = {
        lines: lines,
        color: document.getElementById('time-color').value,
        font: document.getElementById('time-font').value,
        mode: 'HOLD',
        speed: 'SPEED_3',
        priority: 2
    };

    fetch('/api/led/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Date & time display sent', 'success');
        } else {
            showToast('Failed to send date/time: ' + result.error, 'error');
        }
    });
}

// Advanced functions
function setBrightness() {
    const brightness = document.getElementById('brightness-slider').value;

    fetch('/api/led/set_brightness', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brightness: parseInt(brightness) })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast(`Brightness set to ${brightness}`, 'success');
        } else {
            showToast('Failed to set brightness: ' + result.error, 'error');
        }
    });
}

function testAllColors() {
    fetch('/api/led/test_colors', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Color test started', 'success');
        } else {
            showToast('Failed to start color test', 'error');
        }
    });
}

function testAllFonts() {
    fetch('/api/led/test_fonts', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Font test started', 'success');
        } else {
            showToast('Failed to start font test', 'error');
        }
    });
}

function testAllModes() {
    fetch('/api/led/test_modes', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Effect test started', 'success');
        } else {
            showToast('Failed to start effect test', 'error');
        }
    });
}

function testRGBColors() {
    fetch('/api/led/test_rgb', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('RGB color test started', 'success');
        } else {
            showToast('Failed to start RGB test', 'error');
        }
    });
}

function testAllFeatures() {
    if (confirm('This will run a comprehensive test of all LED sign features. Continue?')) {
        fetch('/api/led/test_all_features', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('Comprehensive feature test started', 'success');
            } else {
                showToast('Failed to start feature test', 'error');
            }
        });
    }
}

// Quick action functions
function sendDefaultMessage() {
    const message = {
        lines: ['PUTNAM COUNTY', 'EMERGENCY MGMT', 'NO ALERTS', 'SYSTEM READY'],
        color: 'GREEN',
        font: 'FONT_7x9',
        mode: 'HOLD',
        priority: 2
    };

    fetch('/api/led/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Default message sent', 'success');
        } else {
            showToast('Failed to send message', 'error');
        }
    });
}

function clearDisplay() {
    if (!confirm('Clear the LED display?')) return;

    fetch('/api/led/clear', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Display cleared', 'success');
        } else {
            showToast('Failed to clear display', 'error');
        }
    });
}

function clearAllMessages() {
    if (!confirm('Clear all stored messages from the LED sign?')) return;

    fetch('/api/led/clear_all', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('All messages cleared', 'success');
        } else {
            showToast('Failed to clear messages', 'error');
        }
    });
}

function getSignStatus() {
    fetch('/api/led/status')
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Sign status retrieved', 'success');
            console.log('Sign Status:', result.status);
        } else {
            showToast('Failed to get sign status', 'error');
        }
    });
}

function resetSign() {
    if (!confirm('Reset the LED sign? This will clear all messages and settings.')) return;

    fetch('/api/led/reset', { method: 'POST' })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Sign reset successfully', 'success');
        } else {
            showToast('Failed to reset sign', 'error');
        }
    });
}

// Loading functions
function loadLEDStatus() {
    fetch('/api/led/status')
    .then(response => response.json())
    .then(data => {
        ledStatus = data;
        updateStatusDisplay();
    })
    .catch(error => console.error('Error loading LED status:', error));
}

function loadCannedMessages() {
    // Canned messages are predefined in the interface
    cannedMessages = [
        { name: 'welcome', display: 'Welcome Message' },
        { name: 'emergency_severe', display: 'Emergency Severe' },
        { name: 'rainbow_test', display: 'Rainbow Test' },
        { name: 'no_alerts', display: 'No Alerts' }
    ];
}

function loadMessageHistory() {
    fetch('/api/led/history')
    .then(response => response.json())
    .then(data => {
        messageHistory = data.messages || [];
        displayMessageHistory();
    })
    .catch(error => console.error('Error loading message history:', error));
}

function updateStatusDisplay() {
    if (ledStatus && ledStatus.success) {
        document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
    }
}

function displayMessageHistory() {
    const container = document.getElementById('message-history');
    if (!container) return;

    if (messageHistory.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">No message history available</div>';
        return;
    }

    container.innerHTML = messageHistory.map(msg => `
        <div class="message-item ${msg.status || 'sent'}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${msg.message_type || 'Custom'}</strong>
                    <div class="text-muted small">${msg.content || msg.lines?.join(' | ') || 'No content'}</div>
                </div>
                <div class="text-end">
                    <span class="priority-badge priority-${['emergency', 'urgent', 'normal', 'low'][msg.priority] || 'normal'}">
                        ${['Emergency', 'Urgent', 'Normal', 'Low'][msg.priority] || 'Normal'}
                    </span>
                    <div class="text-muted small">${new Date(msg.created_at).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function searchHistory() {
    const searchTerm = document.getElementById('history-search').value.toLowerCase();
    const filter = document.getElementById('history-filter').value;

    filteredHistory = messageHistory.filter(msg => {
        const matchesSearch = !searchTerm ||
            (msg.content && msg.content.toLowerCase().includes(searchTerm)) ||
            (msg.message_type && msg.message_type.toLowerCase().includes(searchTerm));

        const matchesFilter = filter === 'all' ||
            (msg.message_type && msg.message_type.toLowerCase() === filter);

        return matchesSearch && matchesFilter;
    });

    displayFilteredHistory();
}

function displayFilteredHistory() {
    const container = document.getElementById('message-history');
    // Use filteredHistory instead of messageHistory for display
    // Implementation similar to displayMessageHistory but with filteredHistory
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initLEDControl();
});
</script>
{% endblock %}