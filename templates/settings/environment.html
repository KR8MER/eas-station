{% extends "base.html" %}

{% block title %}Environment Settings - EAS Station{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .settings-header {
        margin-bottom: 2rem;
    }

    .settings-header h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .settings-header p {
        color: var(--bs-secondary);
        margin-bottom: 1rem;
    }

    .validation-banner {
        margin-bottom: 1.5rem;
    }

    .category-nav {
        position: sticky;
        top: 80px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .category-btn {
        width: 100%;
        text-align: left;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border: 1px solid var(--bs-border-color);
        background: var(--bs-body-bg);
        border-radius: 0.375rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .category-btn:hover {
        background: var(--bs-light);
        border-color: var(--bs-primary);
    }

    .category-btn.active {
        background: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }

    .category-btn i {
        width: 1.25rem;
        text-align: center;
    }

    .category-info {
        flex: 1;
    }

    .category-name {
        font-weight: 600;
        display: block;
    }

    .category-desc {
        font-size: 0.875rem;
        opacity: 0.8;
        display: block;
    }

    .category-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        background: rgba(255,255,255,0.2);
    }

    .category-section {
        display: none;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .category-section.active {
        display: block;
    }

    .category-section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--bs-border-color);
    }

    .category-section-header i {
        font-size: 1.75rem;
        color: var(--bs-primary);
    }

    .category-section-header h2 {
        font-size: 1.5rem;
        margin: 0;
    }

    .variable-group {
        margin-bottom: 1.5rem;
    }

    .variable-group:last-child {
        margin-bottom: 0;
    }

    .variable-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .variable-required {
        color: var(--bs-danger);
    }

    .variable-sensitive {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        background: var(--bs-warning);
        color: var(--bs-dark);
    }

    .variable-description {
        font-size: 0.875rem;
        color: var(--bs-secondary);
        margin-top: 0.25rem;
    }

    .form-control, .form-select {
        font-family: 'Courier New', monospace;
    }

    .actions-bar {
        position: sticky;
        bottom: 0;
        background: var(--bs-body-bg);
        border-top: 2px solid var(--bs-border-color);
        padding: 1.5rem;
        margin: 0 -2rem -2rem -2rem;
        border-radius: 0 0 0.5rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .changed-indicator {
        display: none;
        color: var(--bs-warning);
        font-weight: 600;
    }

    .changed-indicator.show {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* GPIO Pin Builder Styles */
    .gpio-pin-builder {
        background: var(--bs-light);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 1rem;
    }

    .gpio-pin-row {
        background: white;
        border: 1px solid var(--bs-border-color);
        transition: all 0.2s;
    }

    .gpio-pin-row:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: var(--bs-primary);
    }

    .gpio-pin-row .form-label {
        font-weight: 600;
        color: var(--bs-secondary);
        margin-bottom: 0.25rem;
    }

    .gpio-pin-row .form-control-sm,
    .gpio-pin-row .form-select-sm {
        font-size: 0.875rem;
    }

    @media (max-width: 991px) {
        .category-nav {
            position: static;
            max-height: none;
            margin-bottom: 2rem;
        }

        .settings-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header -->
    <div class="settings-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1><i class="fas fa-cog"></i> Environment Settings</h1>
                <p>Manage application configuration and environment variables. Changes require a restart to take effect.</p>
            </div>
            <div>
                <a href="{{ url_for('environment.admin_download_env') }}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download .env Backup
                </a>
            </div>
        </div>

        {% if not can_configure %}
        <div class="alert alert-warning">
            <i class="fas fa-eye"></i>
            <strong>Read-Only Mode:</strong> You have view-only access to environment settings. All fields are disabled. Contact your administrator to request the <code>system.configure</code> permission if you need to make changes.
        </div>
        {% endif %}

        <!-- Validation Banner -->
        <div id="validation-banner" class="validation-banner"></div>
    </div>

    <div class="row">
        <!-- Category Navigation -->
        <div class="col-lg-3">
            <div class="category-nav" id="category-nav">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <div id="settings-content">
                <!-- Category sections populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Debug logging
    console.log('Environment settings page loading...');
    {% if current_user %}
    console.log('Current user:', {{ current_user.username|tojson }});
    console.log('User role:', {{ current_user.role.name|tojson if current_user.role else 'null' }});
    {% else %}
    console.log('No current user');
    {% endif %}
    console.log('Has configure permission:', {{ 'true' if can_configure else 'false' }});

    // Ensure required utility functions are available
    if (typeof showLoading !== 'function' || typeof hideLoading !== 'function' || typeof showToast !== 'function') {
        console.error('Required utility functions are not available. Check that loading-error-utils.js is loaded.');
        // Define fallback functions
        window.showLoading = function(message) { console.log('Loading:', message || '...'); };
        window.hideLoading = function() { console.log('Loading complete'); };
        window.showToast = function(message, type) { alert(message); };
    }

    let categoriesData = {};
    let currentValues = {};
    let hasChanges = false;
    // Permission check passed from backend
    const canEdit = {{ 'true' if can_configure else 'false' }};
    console.log('canEdit =', canEdit);

    // Load categories and variables on page load
    async function loadSettings() {
        console.log('Loading environment settings...');
        try {
            showLoading();

            // Load validation status
            console.log('Fetching validation status...');
            const validationResp = await fetch('/api/environment/validate');
            if (!validationResp.ok) {
                if (validationResp.status === 403) {
                    throw new Error('You do not have permission to view environment settings. Contact your administrator to grant you the "system.view_config" permission.');
                }
                console.error('Validation API failed:', validationResp.status, validationResp.statusText);
                throw new Error(`Validation API returned ${validationResp.status}: ${validationResp.statusText}`);
            }
            const validation = await validationResp.json();
            console.log('Validation result:', validation);
            displayValidation(validation);

            // Load all variables
            console.log('Fetching environment variables...');
            const resp = await fetch('/api/environment/variables');
            if (!resp.ok) {
                if (resp.status === 403) {
                    throw new Error('You do not have permission to view environment settings. Contact your administrator to grant you the "system.view_config" permission.');
                }
                console.error('Variables API failed:', resp.status, resp.statusText);
                throw new Error(`API returned ${resp.status}: ${resp.statusText}`);
            }
            categoriesData = await resp.json();
            console.log('Loaded categories:', Object.keys(categoriesData));

            // Check for metadata
            if (categoriesData._meta) {
                console.log('Environment metadata:', categoriesData._meta);
                if (!categoriesData._meta.env_file_exists) {
                    console.warn('.env file does not exist, reading from environment variables');

                    // Show info banner
                    const banner = document.getElementById('validation-banner');
                    banner.innerHTML = `
                        <div class="alert alert-info alert-dismissible fade show">
                            <i class="fas fa-info-circle"></i>
                            <strong>No .env File Found</strong>
                            <p class="mb-0">Reading configuration from environment variables at <code>${categoriesData._meta.env_file_path}</code>.
                            When you save changes, a .env file will be created automatically to persist your settings.</p>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                }
                // Remove _meta from categories data
                delete categoriesData._meta;
            }

            // Store current values
            for (const [catId, catData] of Object.entries(categoriesData)) {
                for (const variable of catData.variables) {
                    currentValues[variable.key] = variable.value;
                }
            }

            console.log('Rendering UI...');
            renderCategoryNav();
            renderCategories();

            // Activate first category
            const firstCat = Object.keys(categoriesData)[0];
            if (firstCat) {
                console.log('Activating first category:', firstCat);
                activateCategory(firstCat);
            }

            hideLoading();
            console.log('Environment settings loaded successfully');
        } catch (error) {
            console.error('Error loading settings:', error);

            // Show detailed error on page
            const content = document.getElementById('settings-content');
            if (content) {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Settings</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check the browser console for more details.</p>
                        <button class="btn btn-primary" onclick="loadSettings()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }

            showToast('Error loading settings: ' + error.message, 'danger');
            hideLoading();
        }
    }

    function displayValidation(validation) {
        const banner = document.getElementById('validation-banner');
        if (!validation.issues.length && !validation.warnings.length) {
            banner.innerHTML = '';
            return;
        }

        const issues = [...validation.issues, ...validation.warnings];
        const hasErrors = issues.some(i => i.severity === 'error');

        const alertClass = hasErrors ? 'alert-danger' : 'alert-warning';
        const icon = hasErrors ? 'fa-exclamation-triangle' : 'fa-info-circle';

        let html = `
            <div class="alert ${alertClass} alert-dismissible fade show">
                <i class="fas ${icon}"></i>
                <strong>${hasErrors ? 'Configuration Issues' : 'Configuration Warnings'}</strong>
                <ul class="mb-0 mt-2">
        `;

        for (const issue of issues) {
            html += `<li><strong>${issue.variable}:</strong> ${issue.message}</li>`;
        }

        html += `
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        banner.innerHTML = html;
    }

    function renderCategoryNav() {
        const nav = document.getElementById('category-nav');
        let html = '';

        for (const [catId, catData] of Object.entries(categoriesData)) {
            html += `
                <button class="category-btn" data-category="${catId}" onclick="activateCategory('${catId}')">
                    <i class="fas ${catData.icon}"></i>
                    <div class="category-info">
                        <span class="category-name">${catData.name}</span>
                        <span class="category-desc">${catData.description}</span>
                    </div>
                    <span class="category-badge">${catData.variables.length}</span>
                </button>
            `;
        }

        nav.innerHTML = html;
    }

    function renderCategories() {
        const content = document.getElementById('settings-content');
        let html = '';

        for (const [catId, catData] of Object.entries(categoriesData)) {
            html += `
                <div class="category-section" id="category-${catId}">
                    <div class="category-section-header">
                        <i class="fas ${catData.icon}"></i>
                        <div>
                            <h2>${catData.name}</h2>
                            <p class="text-muted mb-0">${catData.description}</p>
                        </div>
                    </div>

                    <form id="form-${catId}">
            `;

            for (const variable of catData.variables) {
                html += renderVariable(variable);
            }

            html += `
                        <div class="actions-bar">
                            ${canEdit ? `
                            <div class="changed-indicator" id="changed-${catId}">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Unsaved changes</span>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" onclick="resetCategory('${catId}')">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                            ` : `
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                You have view-only access to environment settings. Contact your administrator to request edit permissions.
                            </div>
                            `}
                        </div>
                    </form>
                </div>
            `;
        }

        content.innerHTML = html;

        // Attach form submit handlers
        for (const catId of Object.keys(categoriesData)) {
            const form = document.getElementById(`form-${catId}`);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveCategory(catId);
            });

            // Attach change handlers
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => checkChanges(catId));
            });
        }
    }

    function renderGPIOPinBuilder(variable, value, disabledAttr) {
        // Parse existing value from colon-separated format
        // Format: PIN:Name:State:Hold:Watchdog
        let pins = [];
        if (value) {
            const lines = value.split('\n').filter(line => line.trim());
            pins = lines.map(line => {
                const parts = line.split(':').map(p => p.trim());
                return {
                    pin: parts[0] || '',
                    name: parts[1] || '',
                    state: parts[2] || 'HIGH',
                    hold: parts[3] || '5',
                    watchdog: parts[4] || '300'
                };
            });
        }
        
        // If no pins, show one empty template
        if (pins.length === 0) {
            pins = [{ pin: '', name: '', state: 'HIGH', hold: '5', watchdog: '300' }];
        }
        
        let html = `
            <div id="gpio-pin-builder" class="gpio-pin-builder">
                <input type="hidden" id="var-${variable.key}" name="${variable.key}" value="${escapeHtml(value || '')}">
                <div id="gpio-pins-list">
        `;
        
        pins.forEach((pin, index) => {
            html += `
                <div class="gpio-pin-row card mb-2" data-index="${index}">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small mb-1">BCM Pin #</label>
                                <input type="number" class="form-control form-control-sm pin-number" 
                                       placeholder="17" min="2" max="27" value="${pin.pin}" ${disabledAttr}
                                       onchange="updateGPIOPinsValue()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small mb-1">Pin Name</label>
                                <input type="text" class="form-control form-control-sm pin-name" 
                                       placeholder="e.g., Aux Relay" value="${escapeHtml(pin.name)}" ${disabledAttr}
                                       onchange="updateGPIOPinsValue()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Active State</label>
                                <select class="form-select form-select-sm pin-state" ${disabledAttr} onchange="updateGPIOPinsValue()">
                                    <option value="HIGH" ${pin.state === 'HIGH' ? 'selected' : ''}>HIGH</option>
                                    <option value="LOW" ${pin.state === 'LOW' ? 'selected' : ''}>LOW</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Hold (sec)</label>
                                <input type="number" class="form-control form-control-sm pin-hold" 
                                       placeholder="5" min="1" max="300" value="${pin.hold}" ${disabledAttr}
                                       onchange="updateGPIOPinsValue()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Watchdog (sec)</label>
                                <input type="number" class="form-control form-control-sm pin-watchdog" 
                                       placeholder="300" min="5" max="3600" value="${pin.watchdog}" ${disabledAttr}
                                       onchange="updateGPIOPinsValue()">
                            </div>
                            <div class="col-md-1">
                                ${canEdit ? `
                                <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                        onclick="removeGPIOPin(${index})" title="Remove this pin">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                ${canEdit ? `
                <button type="button" class="btn btn-sm btn-success mt-2" onclick="addGPIOPin()">
                    <i class="fas fa-plus me-1"></i> Add Another Pin
                </button>
                ` : ''}
            </div>
        `;
        
        return html;
    }

    function renderVariable(variable) {
        const required = variable.required ? '<span class="variable-required">*</span>' : '';
        const sensitive = variable.sensitive ? '<span class="variable-sensitive"><i class="fas fa-lock"></i> Sensitive</span>' : '';
        const disabledAttr = !canEdit ? 'disabled' : '';

        let inputHtml = '';
        const inputId = `var-${variable.key}`;
        const value = escapeHtml(variable.value || '');

        if (variable.type === 'boolean') {
            const checked = value === 'true' ? 'checked' : '';
            inputHtml = `
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="${inputId}" name="${variable.key}" ${checked} ${disabledAttr}>
                    <label class="form-check-label" for="${inputId}">${variable.description || variable.label}</label>
                </div>
            `;
        } else if (variable.type === 'select') {
            inputHtml = `<select class="form-select" id="${inputId}" name="${variable.key}" ${variable.required ? 'required' : ''} ${disabledAttr}>`;
            for (const option of variable.options || []) {
                const selected = value === option ? 'selected' : '';
                inputHtml += `<option value="${option}" ${selected}>${option}</option>`;
            }
            inputHtml += `</select>`;
        } else if (variable.type === 'textarea') {
            inputHtml = `<textarea class="form-control" id="${inputId}" name="${variable.key}" rows="3" placeholder="${variable.placeholder || ''}" ${variable.required ? 'required' : ''} ${disabledAttr}>${value}</textarea>`;
        } else if (variable.type === 'gpio_pin_builder') {
            // Custom GPIO Pin Builder interface
            inputHtml = renderGPIOPinBuilder(variable, value, disabledAttr);
        } else {
            const inputType = variable.type || 'text';
            const step = variable.step ? `step="${variable.step}"` : '';
            const min = variable.min !== undefined ? `min="${variable.min}"` : '';
            const max = variable.max !== undefined ? `max="${variable.max}"` : '';
            const maxlength = variable.maxlength ? `maxlength="${variable.maxlength}"` : '';
            const minlength = variable.minlength ? `minlength="${variable.minlength}"` : '';
            const pattern = variable.pattern ? `pattern="${variable.pattern}"` : '';
            const title = variable.title ? `title="${escapeHtml(variable.title)}"` : '';
            const placeholder = variable.placeholder ? `placeholder="${variable.placeholder}"` : '';

            // Add generate button for SECRET_KEY
            if (variable.key === 'SECRET_KEY' && canEdit) {
                inputHtml = `
                    <div class="input-group">
                        <input type="${inputType}" class="form-control" id="${inputId}" name="${variable.key}" value="${value}" ${step} ${min} ${max} ${maxlength} ${minlength} ${pattern} ${title} ${placeholder} ${variable.required ? 'required' : ''} ${disabledAttr}>
                        <button class="btn btn-outline-secondary" type="button" id="generate-secret-btn" onclick="generateSecretKey()">
                            <i class="fas fa-magic me-1"></i> Generate
                        </button>
                    </div>
                `;
            } else {
                inputHtml = `<input type="${inputType}" class="form-control" id="${inputId}" name="${variable.key}" value="${value}" ${step} ${min} ${max} ${maxlength} ${minlength} ${pattern} ${title} ${placeholder} ${variable.required ? 'required' : ''} ${disabledAttr}>`;
            }
        }

        return `
            <div class="variable-group">
                <label class="variable-label" for="${inputId}">
                    ${variable.label}
                    ${required}
                    ${sensitive}
                </label>
                ${inputHtml}
                ${variable.description && variable.type !== 'boolean' ? `<div class="variable-description">${variable.description}</div>` : ''}
            </div>
        `;
    }

    function activateCategory(catId) {
        // Update nav buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-category="${catId}"]`).classList.add('active');

        // Update sections
        document.querySelectorAll('.category-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(`category-${catId}`).classList.add('active');
    }

    function checkChanges(catId) {
        const form = document.getElementById(`form-${catId}`);
        const formData = new FormData(form);
        let hasChanges = false;

        const catData = categoriesData[catId];
        for (const variable of catData.variables) {
            let currentValue;
            if (variable.type === 'boolean') {
                const checkbox = form.querySelector(`[name="${variable.key}"]`);
                currentValue = checkbox.checked ? 'true' : 'false';
            } else {
                currentValue = formData.get(variable.key) || '';
            }

            const originalValue = currentValues[variable.key] || '';
            if (currentValue !== originalValue) {
                hasChanges = true;
                break;
            }
        }

        const indicator = document.getElementById(`changed-${catId}`);
        if (hasChanges) {
            indicator.classList.add('show');
        } else {
            indicator.classList.remove('show');
        }
    }

    function resetCategory(catId) {
        const form = document.getElementById(`form-${catId}`);
        const catData = categoriesData[catId];

        for (const variable of catData.variables) {
            const input = form.querySelector(`[name="${variable.key}"]`);
            const originalValue = currentValues[variable.key] || '';

            if (variable.type === 'boolean') {
                input.checked = originalValue === 'true';
            } else {
                input.value = originalValue;
            }
        }

        checkChanges(catId);
    }

    async function saveCategory(catId) {
        const form = document.getElementById(`form-${catId}`);
        const formData = new FormData(form);
        const updates = {};

        const catData = categoriesData[catId];
        for (const variable of catData.variables) {
            if (variable.type === 'boolean') {
                const checkbox = form.querySelector(`[name="${variable.key}"]`);
                updates[variable.key] = checkbox.checked ? 'true' : 'false';
            } else {
                updates[variable.key] = formData.get(variable.key) || '';
            }
        }

        try {
            showLoading();

            const resp = await fetch('/api/environment/variables', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ variables: updates }),
            });

            const result = await resp.json();

            if (resp.ok) {
                showToast(result.message, 'success');

                // Update current values
                Object.assign(currentValues, updates);
                checkChanges(catId);

                // Show restart warning
                if (result.restart_required) {
                    setTimeout(() => {
                        showToast('Restart the application for changes to take effect', 'warning', 10000);
                    }, 1000);
                }

                // Reload validation
                const validationResp = await fetch('/api/environment/validate');
                const validation = await validationResp.json();
                displayValidation(validation);
            } else {
                showToast(result.error || 'Failed to save settings', 'danger');
            }

            hideLoading();
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast('Error saving settings', 'danger');
            hideLoading();
        }
    }

    async function generateSecretKey() {
        const button = document.getElementById('generate-secret-btn');
        const input = document.getElementById('var-SECRET_KEY');

        if (!button || !input) return;

        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';

        try {
            const response = await fetch('/api/environment/generate-secret', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to generate secret key');
            }

            const result = await response.json();
            input.value = result.secret_key;

            // Trigger change event to mark category as changed
            input.dispatchEvent(new Event('input', { bubbles: true }));

            showToast('New secret key generated successfully', 'success');
        } catch (error) {
            console.error('Error generating secret key:', error);
            showToast('Failed to generate secret key', 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showLoading() {
        // You can implement a loading overlay here
    }

    function hideLoading() {
        // Hide loading overlay
    }

    function showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';

        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white ${bgClass} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: duration });
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', loadSettings);

    // GPIO Pin Builder Functions
    function updateGPIOPinsValue() {
        const builder = document.getElementById('gpio-pin-builder');
        if (!builder) return;
        
        const rows = builder.querySelectorAll('.gpio-pin-row');
        const pins = [];
        
        rows.forEach(row => {
            const pin = row.querySelector('.pin-number').value.trim();
            const name = row.querySelector('.pin-name').value.trim();
            const state = row.querySelector('.pin-state').value;
            const hold = row.querySelector('.pin-hold').value || '5';
            const watchdog = row.querySelector('.pin-watchdog').value || '300';
            
            // Only add if pin number is specified
            if (pin) {
                pins.push(`${pin}:${name}:${state}:${hold}:${watchdog}`);
            }
        });
        
        const hiddenInput = document.getElementById('var-GPIO_ADDITIONAL_PINS');
        if (hiddenInput) {
            hiddenInput.value = pins.join('\n');
            // Trigger change event to mark as changed
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    function addGPIOPin() {
        const list = document.getElementById('gpio-pins-list');
        if (!list) return;
        
        const rows = list.querySelectorAll('.gpio-pin-row');
        const newIndex = rows.length;
        
        const newRow = document.createElement('div');
        newRow.className = 'gpio-pin-row card mb-2';
        newRow.setAttribute('data-index', newIndex);
        newRow.innerHTML = `
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small mb-1">BCM Pin #</label>
                        <input type="number" class="form-control form-control-sm pin-number" 
                               placeholder="17" min="2" max="27" value="" 
                               onchange="updateGPIOPinsValue()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">Pin Name</label>
                        <input type="text" class="form-control form-control-sm pin-name" 
                               placeholder="e.g., Aux Relay" value="" 
                               onchange="updateGPIOPinsValue()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Active State</label>
                        <select class="form-select form-select-sm pin-state" onchange="updateGPIOPinsValue()">
                            <option value="HIGH" selected>HIGH</option>
                            <option value="LOW">LOW</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Hold (sec)</label>
                        <input type="number" class="form-control form-control-sm pin-hold" 
                               placeholder="5" min="1" max="300" value="5" 
                               onchange="updateGPIOPinsValue()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Watchdog (sec)</label>
                        <input type="number" class="form-control form-control-sm pin-watchdog" 
                               placeholder="300" min="5" max="3600" value="300" 
                               onchange="updateGPIOPinsValue()">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                onclick="removeGPIOPin(${newIndex})" title="Remove this pin">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        list.appendChild(newRow);
        
        // Update indices
        updateRowIndices();
    }

    function removeGPIOPin(index) {
        const list = document.getElementById('gpio-pins-list');
        if (!list) return;
        
        const rows = list.querySelectorAll('.gpio-pin-row');
        if (rows.length <= 1) {
            // Don't remove the last row, just clear it
            const row = rows[0];
            row.querySelector('.pin-number').value = '';
            row.querySelector('.pin-name').value = '';
            row.querySelector('.pin-state').value = 'HIGH';
            row.querySelector('.pin-hold').value = '5';
            row.querySelector('.pin-watchdog').value = '300';
        } else {
            // Remove the specific row
            rows[index].remove();
            updateRowIndices();
        }
        
        updateGPIOPinsValue();
    }

    function updateRowIndices() {
        const list = document.getElementById('gpio-pins-list');
        if (!list) return;
        
        const rows = list.querySelectorAll('.gpio-pin-row');
        rows.forEach((row, index) => {
            row.setAttribute('data-index', index);
            const removeBtn = row.querySelector('button[onclick^="removeGPIOPin"]');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeGPIOPin(${index})`);
            }
        });
    }
</script>
{% endblock %}
