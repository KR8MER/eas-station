{% extends "base.html" %}

{% block title %}IPAWS Configuration - EAS Station{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }

    .settings-header {
        margin-bottom: 2rem;
    }

    .settings-header h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .settings-header p {
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    .config-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .config-card h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 1rem;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    .form-help {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.375rem;
    }

    .environment-option,
    .feed-option {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 2px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .environment-option:hover,
    .feed-option:hover {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.05);
    }

    .environment-option.selected,
    .feed-option.selected {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.1);
    }

    .environment-option input,
    .feed-option input {
        margin-right: 0.75rem;
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .option-content {
        flex: 1;
    }

    .option-name {
        font-weight: 600;
        color: var(--text-color);
    }

    .option-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .env-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .env-badge.test {
        background: #FEF3C7;
        color: #92400E;
    }

    .env-badge.live {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .status-badge.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-badge.inactive {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .status-item {
        padding: 0.75rem;
        background: var(--bg-color);
        border-radius: 0.375rem;
    }

    .status-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .status-value {
        font-weight: 600;
        color: var(--text-color);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
    }

    .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--shadow-color);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: var(--surface-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
    }

    .btn-secondary:hover {
        background: var(--bg-card);
        border-color: var(--primary-color);
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
    }

    .alert-success {
        background: #D1FAE5;
        border: 1px solid #10B981;
        color: #065F46;
    }

    .alert-error {
        background: #FEE2E2;
        border: 1px solid #EF4444;
        color: #991B1B;
    }

    .alert-warning {
        background: #FEF3C7;
        border: 1px solid #F59E0B;
        color: #92400E;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1>
            <i class="fas fa-satellite-dish"></i>
            IPAWS Feed Configuration
        </h1>
        <p>Configure connection to FEMA IPAWS alert feeds. No authentication required.</p>
    </div>

    <div id="alertContainer"></div>

    <!-- Current Status -->
    <div class="status-card">
        <div class="status-header">
            <h2 style="margin: 0;">Current Status</h2>
            {% if status.configured %}
            <span class="status-badge active">âœ“ Configured</span>
            {% else %}
            <span class="status-badge inactive">Not Configured</span>
            {% endif %}
        </div>

        <div class="status-details">
            <div class="status-item">
                <div class="status-label">Environment</div>
                <div class="status-value">
                    {% if status.environment == 'staging' %}
                    STAGING (TDL)
                    {% elif status.environment == 'production' %}
                    PRODUCTION (Live)
                    {% else %}
                    Not Set
                    {% endif %}
                </div>
            </div>

            <div class="status-item">
                <div class="status-label">Feed Type</div>
                <div class="status-value">
                    {% if status.feed_type %}
                    {{ feed_types[status.feed_type].name }}
                    {% else %}
                    Not Set
                    {% endif %}
                </div>
            </div>

            <div class="status-item">
                <div class="status-label">Poll Interval</div>
                <div class="status-value">{{ status.poll_interval }} seconds</div>
            </div>

            <div class="status-item">
                <div class="status-label">Last Poll</div>
                <div class="status-value" id="lastPollTime">
                    {% if status.last_poll %}
                    {{ status.last_poll | format_local_datetime }}
                    {% else %}
                    Never
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <form id="ipawsConfigForm">
        <div class="config-card">
            <h2>1. Select Environment</h2>
            <p class="form-help">Start with STAGING for testing, then switch to PRODUCTION for live alerts.</p>

            <div class="form-group">
                {% for env_key, env_data in environments.items() %}
                <div class="environment-option {% if status.environment == env_key %}selected{% endif %}"
                     onclick="selectEnvironment('{{ env_key }}')">
                    <label class="option-label">
                        <input type="radio" name="environment" value="{{ env_key }}"
                               {% if status.environment == env_key %}checked{% endif %}>
                        <div class="option-content">
                            <div class="option-name">
                                {{ env_data.name }}
                                <span class="env-badge {% if env_key == 'staging' %}test{% else %}live{% endif %}">
                                    {{ env_data.badge }}
                                </span>
                            </div>
                            <div class="option-desc">{{ env_data.description }}</div>
                            <code style="font-size: 0.75rem; color: var(--text-secondary);">{{ env_data.base_url }}</code>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="config-card">
            <h2>2. Select Feed Type</h2>
            <p class="form-help">Choose which types of alerts to receive. PUBLIC includes all alert types.</p>

            <div class="form-group">
                {% for feed_key, feed_data in feed_types.items() %}
                <div class="feed-option {% if status.feed_type == feed_key %}selected{% endif %}"
                     onclick="selectFeedType('{{ feed_key }}')">
                    <label class="option-label">
                        <input type="radio" name="feed_type" value="{{ feed_key }}"
                               {% if status.feed_type == feed_key %}checked{% endif %}>
                        <div class="option-content">
                            <div class="option-name">{{ feed_data.name }}</div>
                            <div class="option-desc">{{ feed_data.description }}</div>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="config-card">
            <h2>3. Poll Interval</h2>
            <div class="form-group">
                <label for="pollInterval">Poll Interval (seconds)</label>
                <input type="number" id="pollInterval" name="poll_interval"
                       value="{{ status.poll_interval }}" min="30" max="3600" step="30">
                <div class="form-help">
                    FEMA recommends polling no more frequently than every 2 minutes (120 seconds).
                    Minimum: 30 seconds.
                </div>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Apply Configuration
            </button>
            <button type="button" class="btn-secondary" onclick="testConnection()">
                <i class="fas fa-flask"></i> Test Connection
            </button>
            {% if status.configured %}
            <button type="button" class="btn-secondary" onclick="disableIPAWS()">
                <i class="fas fa-ban"></i> Disable IPAWS
            </button>
            {% endif %}
        </div>
    </form>
</div>

<script>
function selectEnvironment(env) {
    document.querySelectorAll('.environment-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    document.querySelector(`input[name="environment"][value="${env}"]`).checked = true;
}

function selectFeedType(type) {
    document.querySelectorAll('.feed-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    document.querySelector(`input[name="feed_type"][value="${type}"]`).checked = true;
}

function showAlert(message, type = 'success') {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    container.innerHTML = '';
    container.appendChild(alert);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

document.getElementById('ipawsConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = {
        environment: formData.get('environment'),
        feed_type: formData.get('feed_type'),
        poll_interval: formData.get('poll_interval')
    };

    if (!data.environment || !data.feed_type) {
        showAlert('Please select both environment and feed type', 'error');
        return;
    }

    try {
        const response = await fetch('/api/ipaws/configure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            // Reload page after 2 seconds
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(result.error || 'Configuration failed', 'error');
        }
    } catch (error) {
        showAlert('Error saving configuration: ' + error.message, 'error');
    }
});

async function testConnection() {
    showAlert('Testing connection to IPAWS feed...', 'warning');

    try {
        const response = await fetch('/api/ipaws/status');
        const result = await response.json();

        if (response.ok && result.configured) {
            showAlert('Connection test successful! Feed is configured.', 'success');
        } else {
            showAlert('IPAWS feed not configured yet', 'warning');
        }
    } catch (error) {
        showAlert('Connection test failed: ' + error.message, 'error');
    }
}

async function disableIPAWS() {
    if (!confirm('Are you sure you want to disable IPAWS feed?')) {
        return;
    }

    try {
        const response = await fetch('/api/ipaws/disable', {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(result.error || 'Failed to disable IPAWS', 'error');
        }
    } catch (error) {
        showAlert('Error disabling IPAWS: ' + error.message, 'error');
    }
}

// Auto-refresh status every 30 seconds
setInterval(async function() {
    try {
        const response = await fetch('/api/ipaws/status');
        const result = await response.json();

        if (result.last_poll) {
            document.getElementById('lastPollTime').textContent = new Date(result.last_poll).toLocaleString();
        }
    } catch (error) {
        console.error('Error refreshing status:', error);
    }
}, 30000);
</script>
{% endblock %}
