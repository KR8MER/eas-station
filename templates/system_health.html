{% extends "base.html" %}

{% block title %}System Health Monitor - EAS Station{% endblock %}

{% block extra_css %}
<style>
        .health-card { border-left: 4px solid #007bff; }
        .health-card.warning { border-left-color: #ffc107; }
        .health-card.danger { border-left-color: #dc3545; }
        .health-card.success { border-left-color: #28a745; }
        .metric-row { margin-bottom: 1rem; }
        .metric-label { font-weight: 600; color: #495057; }
        .metric-value { font-family: 'Courier New', monospace; }
        .progress-sm { height: 8px; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .section-icon { color: #007bff; margin-right: 8px; }
        .status-badge { font-size: 0.8em; }
        .system-overview { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .system-overview .card-body { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .stack-summary { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; }
        .stack-summary .metric-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: #6c757d; }
        .stack-summary .metric-value { display: block; font-size: 1.1rem; font-weight: 600; }
        .container-table { font-size: 0.85rem; }
        .container-table th { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; color: #6c757d; }
        .container-table td, .container-table th { vertical-align: middle; }
        .container-image { font-family: 'Courier New', monospace; font-size: 0.75rem; }
        .container-meta { font-size: 0.75rem; color: #6c757d; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
        <div class="alert alert-danger d-none" id="refresh-error" role="alert"></div>
        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card system-overview">
                    <div class="card-body">
                        <h4><i class="fas fa-server section-icon text-white"></i> System Overview</h4>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Hostname</div>
                                    <div class="metric-value text-white" id="hostname-value">{{ system.hostname or 'Unknown' }}</div>
                                </div>
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Operating System</div>
                                    <div class="metric-value text-white" id="os-value">{{ (system.system or 'Unknown') ~ ' ' ~ (system.release or '') }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Architecture</div>
                                    <div class="metric-value text-white" id="architecture-value">{{ system.machine or 'Unknown' }}</div>
                                </div>
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Uptime</div>
                                    <div class="metric-value text-white" id="uptime-value">{{ format_uptime(system.uptime_seconds or 0) }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Load Average</div>
                                    <div class="metric-value text-white" id="load-average-value">
                                        {% if load_averages %}
                                            {{ ', '.join(load_averages|map('string')) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Processes</div>
                                    <div class="metric-value text-white" id="processes-summary">{{ processes.total_processes or 0 }} total ({{ processes.running_processes or 0 }} running)</div>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="metric-row">
                                    <div class="metric-label text-white-50">Last Updated</div>
                                    <div class="metric-value text-white" id="current-time"></div>
                                </div>
                                <button class="btn btn-light btn-sm mt-2 refresh-trigger" type="button">
                                    <i class="fas fa-sync-alt"></i> Refresh Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resource Usage Row -->
        <div class="row mb-4">
            <!-- CPU Usage -->
            <div class="col-lg-4 mb-3" id="cpu-card">
                {% set cpu_class = 'danger' if cpu.cpu_usage_percent > 80 else 'warning' if cpu.cpu_usage_percent > 50 else 'success' %}
                <div class="card health-card {{ cpu_class }} h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-microchip section-icon"></i> CPU Usage</h5>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">Overall Usage</span>
                            <span class="badge bg-{{ 'danger' if cpu.cpu_usage_percent > 80 else 'warning' if cpu.cpu_usage_percent > 50 else 'success' }}">
                                {{ "%.1f"|format(cpu.cpu_usage_percent or 0) }}%
                            </span>
                        </div>
                        <div class="progress progress-sm mb-3">
                            {% set progress_class = 'bg-danger' if cpu.cpu_usage_percent > 80 else 'bg-warning' if cpu.cpu_usage_percent > 50 else 'bg-success' %}
                            <div class="progress-bar {{ progress_class }}" style="width: {{ cpu.cpu_usage_percent or 0 }}%"></div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Physical Cores:</span>
                                        <span class="metric-value">{{ cpu.physical_cores or 'N/A' }}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Total Cores:</span>
                                        <span class="metric-value">{{ cpu.total_cores or 'N/A' }}</span>
                                    </div>
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Max Freq:</span>
                                        <span class="metric-value">{{ "%.0f"|format(cpu.max_frequency or 0) }} MHz</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Current:</span>
                                        <span class="metric-value">{{ "%.0f"|format(cpu.current_frequency or 0) }} MHz</span>
                                    </div>
                                </small>
                            </div>
                        </div>

                        {% if cpu.cpu_usage_per_core and cpu.cpu_usage_per_core|length <= 8 %}
                        <hr>
                        <h6 class="text-muted">Per-Core Usage</h6>
                        <div class="row">
                            {% for usage in cpu.cpu_usage_per_core %}
                            <div class="col-6 col-lg-12 col-xl-6">
                                <small>
                                    <div class="d-flex justify-content-between">
                                        <span>Core {{ loop.index0 }}:</span>
                                        <span class="metric-value">{{ "%.1f"|format(usage) }}%</span>
                                    </div>
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="col-lg-4 mb-3" id="memory-card">
                {% set mem_class = 'danger' if memory.percentage > 90 else 'warning' if memory.percentage > 75 else 'success' %}
                <div class="card health-card {{ mem_class }} h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-memory section-icon"></i> Memory Usage</h5>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">RAM Usage</span>
                            <span class="badge bg-{{ 'danger' if memory.percentage > 90 else 'warning' if memory.percentage > 75 else 'success' }}">
                                {{ "%.1f"|format(memory.percentage or 0) }}%
                            </span>
                        </div>
                        <div class="progress progress-sm mb-2">
                            {% set mem_progress_class = 'bg-danger' if memory.percentage > 90 else 'bg-warning' if memory.percentage > 75 else 'bg-success' %}
                            <div class="progress-bar {{ mem_progress_class }}" style="width: {{ memory.percentage or 0 }}%"></div>
                        </div>
                        <small class="text-muted">{{ format_bytes(memory.used or 0) }} / {{ format_bytes(memory.total or 0) }}</small>

                        {% if memory.swap_total and memory.swap_total > 0 %}
                        <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                            <span class="metric-label">Swap Usage</span>
                            <span class="badge bg-info">{{ "%.1f"|format(memory.swap_percentage or 0) }}%</span>
                        </div>
                        <div class="progress progress-sm mb-2">
                            <div class="progress-bar bg-info" style="width: {{ memory.swap_percentage or 0 }}%"></div>
                        </div>
                        <small class="text-muted">{{ format_bytes(memory.swap_used or 0) }} / {{ format_bytes(memory.swap_total or 0) }}</small>
                        {% endif %}

                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Available:</span>
                                        <span class="metric-value">{{ format_bytes(memory.available or 0) }}</span>
                                    </div>
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Free:</span>
                                        <span class="metric-value">{{ format_bytes(memory.free or 0) }}</span>
                                    </div>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stack Overview -->
            <div class="col-lg-4 mb-3" id="containers-card">
                {% set containers_data = containers or {} %}
                {% set summary = containers_data.summary or {} %}
                {% set total_containers = summary.get('total', 0) %}
                {% set running_containers = summary.get('running', 0) %}
                {% set unhealthy_containers = summary.get('unhealthy', 0) %}
                {% set stopped_containers = summary.get('stopped', total_containers - running_containers) %}
                <div class="card health-card h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-layer-group section-icon"></i> Stack Services</h5>


                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">Database</span>
                            {% set db_status = database.status or 'Unknown' %}
                            {% if db_status == 'connected' %}
                                {% set db_class = 'success' %}
                            {% elif 'error' in db_status|lower %}
                                {% set db_class = 'danger' %}
                            {% elif db_status|lower in ['unavailable', 'unknown'] %}
                                {% set db_class = 'secondary' %}
                            {% else %}
                                {% set db_class = 'warning' %}
                            {% endif %}
                            <span class="badge bg-{{ db_class }}">{{ db_status }}</span>
                        </div>
                        {% if database.info %}
                            {% if database.info.version %}
                            <small class="text-muted d-block">Version: {{ database.info.version[:60] }}{% if database.info.version|length > 60 %}…{% endif %}</small>
                            {% endif %}
                            {% if database.info.size %}
                            <small class="text-muted d-block">Size: {{ database.info.size }}</small>
                            {% endif %}
                            {% if database.info.active_connections is not none %}
                            <small class="text-muted d-block">Active Connections: {{ database.info.active_connections }}</small>
                            {% endif %}
                        {% endif %}


                        <hr>

                        <div class="stack-summary mb-3">
                            <div>
                                <span class="metric-label">Containers</span>
                                <span class="metric-value">{{ total_containers }}</span>
                            </div>
                            <div>
                                <span class="metric-label text-success">Running</span>
                                <span class="metric-value text-success">{{ running_containers }}</span>
                            </div>
                            <div>
                                <span class="metric-label text-warning">Stopped</span>
                                <span class="metric-value text-warning">{{ stopped_containers if stopped_containers >= 0 else 0 }}</span>
                            </div>
                            <div>
                                <span class="metric-label text-danger">Unhealthy</span>
                                <span class="metric-value text-danger">{{ unhealthy_containers }}</span>
                            </div>
                        </div>

                        {% if containers_data.available %}
                            {% set preview = containers_data.containers[:4] if containers_data.containers else [] %}
                            {% for container in preview %}
                                {% set health = (container.health or '')|lower %}
                                {% set state = (container.state or '')|lower %}
                                {% if health == 'healthy' %}
                                    {% set badge_class = 'success' %}
                                    {% set status_label = 'Healthy' %}
                                {% elif health == 'unhealthy' %}
                                    {% set badge_class = 'danger' %}
                                    {% set status_label = 'Unhealthy' %}
                                {% elif health == 'starting' %}
                                    {% set badge_class = 'warning' %}
                                    {% set status_label = 'Starting' %}
                                {% else %}
                                    {% if state == 'running' %}
                                        {% set badge_class = 'success' %}
                                    {% elif state in ['restarting', 'created', 'paused'] %}
                                        {% set badge_class = 'warning' %}
                                    {% elif state in ['exited', 'dead'] %}
                                        {% set badge_class = 'secondary' %}
                                    {% else %}
                                        {% set badge_class = 'secondary' %}
                                    {% endif %}
                                    {% set status_label = container.status or (state|upper if state else 'Unknown') %}
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div>
                                        <span class="metric-label">{{ container.display_name or container.name }}</span>
                                        {% if container.service %}
                                        <small class="text-muted d-block">{{ container.service }}</small>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-{{ badge_class }} status-badge">{{ status_label }}</span>
                                </div>
                            {% endfor %}
                            {% if containers_data.containers and containers_data.containers|length > 4 %}
                                <small class="text-muted">… and {{ containers_data.containers|length - 4 }} more containers</small>
                            {% elif not containers_data.containers %}
                                <p class="text-muted mb-0">No containers detected for the current engine.</p>
                            {% endif %}
                            {% set has_engine = containers_data.engine %}
                            {% set has_project = containers_data.compose_project %}
                            {% set has_collector = containers_data.collector %}
                            {% if has_engine or has_project or has_collector %}
                                <small class="text-muted d-block mt-2">
                                    {% if has_engine %}Engine: {{ containers_data.engine|upper }}{% endif %}
                                    {% if has_project %}{% if has_engine %} • {% endif %}Project: {{ containers_data.compose_project }}{% endif %}
                                    {% if has_collector %}{% if has_engine or has_project %} • {% endif %}Source: {{ containers_data.collector }}{% endif %}
                                </small>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning mb-0 py-2">
                                Container information unavailable{% if containers_data.error %}: {{ containers_data.error }}{% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Storage & Network Row -->
        <div class="row mb-4">
            <!-- Disk Storage -->
            <div class="col-lg-8 mb-3" id="storage-card">
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-hdd section-icon"></i> Storage Usage</h5>
                        
                        {% for disk_item in disk %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="metric-label">
                                    <strong>{{ disk_item.device or 'Unknown' }}</strong>
                                    <small class="text-muted">({{ disk_item.mountpoint or 'Unknown' }})</small>
                                </span>
                                <span class="badge bg-{{ 'danger' if disk_item.percentage > 90 else 'warning' if disk_item.percentage > 75 else 'success' }}">
                                    {{ "%.1f"|format(disk_item.percentage or 0) }}%
                                </span>
                            </div>
                            <div class="progress progress-sm mb-1">
                                {% set disk_class = 'bg-danger' if disk_item.percentage > 90 else 'bg-warning' if disk_item.percentage > 75 else 'bg-success' %}
                                <div class="progress-bar {{ disk_class }}" style="width: {{ disk_item.percentage or 0 }}%"></div>
                            </div>
                            <small class="text-muted">
                                {{ format_bytes(disk_item.used or 0) }} used / {{ format_bytes(disk_item.total or 0) }} total
                                ({{ format_bytes(disk_item.free or 0) }} free) • {{ disk_item.fstype or 'Unknown' }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Network Summary -->
            <div class="col-lg-4 mb-3" id="network-card">
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-network-wired section-icon"></i> Network</h5>
                        
                        <div class="metric-row mb-3">
                            <span class="metric-label">Hostname:</span>
                            <span class="metric-value">{{ network.hostname or 'Unknown' }}</span>
                        </div>

                        {% for interface in network.interfaces[:3] %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="metric-label">{{ interface.name or 'Unknown' }}</span>
                                {% set status_class = 'success' if interface.is_up else 'secondary' %}
                                <span class="badge bg-{{ status_class }} status-badge">{{ 'UP' if interface.is_up else 'DOWN' }}</span>
                            </div>
                            {% for addr in interface.addresses[:2] %}
                                {% if addr.type == 'IPv4' %}
                                <small class="text-muted d-block">{{ addr.address or 'Unknown' }}</small>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}

                        {% if network.interfaces|length > 3 %}
                        <small class="text-muted">... and {{ network.interfaces|length - 3 }} more interfaces</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Container Details -->
        <div class="row mb-4">
            <div class="col-12" id="containers-details">
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-boxes section-icon"></i> Container Details</h5>

                        {% set containers_data = containers or {} %}
                        {% set container_items = containers_data.containers or [] %}

                        {% if containers_data.available and container_items %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover container-table">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Container</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Health</th>
                                        <th scope="col">Uptime</th>
                                        <th scope="col">Image</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for container in container_items %}
                                    {% set status_label = container.status or (container.state|upper if container.state else 'Unknown') %}
                                    {% set state = (container.state or '')|lower %}
                                    {% set health = (container.health or '')|lower %}
                                    {% if health == 'healthy' %}
                                        {% set status_class = 'success' %}
                                    {% elif health == 'unhealthy' %}
                                        {% set status_class = 'danger' %}
                                    {% elif state == 'running' %}
                                        {% set status_class = 'success' %}
                                    {% elif state in ['restarting', 'created', 'paused'] %}
                                        {% set status_class = 'warning' %}
                                    {% elif state in ['exited', 'dead'] %}
                                        {% set status_class = 'secondary' %}
                                    {% else %}
                                        {% set status_class = 'secondary' %}
                                    {% endif %}
                                    <tr>
                                        <td>
                                            <strong>{{ container.display_name or container.name }}</strong>
                                            {% if container.service %}
                                            <div class="container-meta">Service: {{ container.service }}</div>
                                            {% endif %}
                                            {% if container.project %}
                                            <div class="container-meta">Project: {{ container.project }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ status_class }} status-badge">{{ status_label }}</span>
                                        </td>
                                        <td>
                                            {% if container.health %}
                                                {% if container.health == 'healthy' %}
                                                <span class="badge bg-success status-badge">Healthy</span>
                                                {% elif container.health == 'unhealthy' %}
                                                <span class="badge bg-danger status-badge">Unhealthy</span>
                                                {% elif container.health == 'starting' %}
                                                <span class="badge bg-warning status-badge">Starting</span>
                                                {% else %}
                                                <span class="badge bg-secondary status-badge">{{ container.health }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td><span class="metric-value">{{ container.running_for or '—' }}</span></td>
                                        <td>
                                            {% if container.image %}
                                            <div class="container-image">{{ container.image }}</div>
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                            {% if container.ports %}
                                            <div class="container-meta">Ports: {{ container.ports }}</div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">
                            {% if containers_data.available %}
                                No container information detected for the current engine.
                            {% elif containers_data.error %}
                                Container details unavailable: {{ containers_data.error }}
                            {% else %}
                                Container details unavailable.
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Information -->
        <div class="row">
            <div class="col-12" id="processes-card">
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-tasks section-icon"></i> Top Processes (CPU Usage)</h5>
                        
                        {% if processes.top_processes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>PID</th>
                                        <th>Process Name</th>
                                        <th>CPU %</th>
                                        <th>Memory %</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for proc in processes.top_processes[:10] %}
                                    <tr>
                                        <td><code>{{ proc.pid or 'N/A' }}</code></td>
                                        <td>
                                            <span title="{{ proc.name or 'Unknown' }}">
                                                {% if proc.name and proc.name|length > 20 %}
                                                    {{ proc.name[:20] }}...
                                                {% else %}
                                                    {{ proc.name or 'Unknown' }}
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="metric-value">{{ "%.1f"|format(proc.cpu_percent or 0) }}%</span>
                                        </td>
                                        <td>
                                            <span class="metric-value">{{ "%.1f"|format(proc.memory_percent or 0) }}%</span>
                                        </td>
                                        <td><small class="text-muted">{{ proc.username or 'N/A' }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-3">No process information available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Temperature Sensors (if available) -->
        <div class="row mt-4 {% if not temperature %}d-none{% endif %}" id="temperature-section">
            {% if temperature %}
            <div class="col-12">
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-thermometer-half section-icon"></i> Temperature Sensors</h5>
                        <div class="row">
                            {% for sensor_name, entries in temperature.items() %}
                            <div class="col-md-4 mb-3">
                                <h6 class="text-muted">{{ sensor_name }}</h6>
                                {% for entry in entries %}
                                <div class="metric-row">
                                    <span class="metric-label">{{ entry.label or 'Sensor' }}:</span>
                                    <span class="metric-value">
                                        {{ "%.1f"|format(entry.current) }}°C
                                        {% if entry.critical and entry.current > entry.critical * 0.8 %}
                                            <span class="badge bg-warning ms-1">Hot</span>
                                        {% endif %}
                                    </span>
                                </div>
                                {% if entry.high or entry.critical %}
                                <small class="text-muted">
                                    {% if entry.high %}High: {{ "%.1f"|format(entry.high) }}°C{% endif %}
                                    {% if entry.critical %}{% if entry.high %} • {% endif %}Critical: {{ "%.1f"|format(entry.critical) }}°C{% endif %}
                                </small>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Auto-refresh button -->
    <button class="btn btn-primary refresh-btn refresh-trigger" type="button" title="Refresh system data">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>
{% endblock %}

{% block scripts %}
    <script>
        const initialHealthData = {{ health_data_json | safe }} || {};
        const REFRESH_INTERVAL_MS = 30000;
        let lastUpdatedTime = null;

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function toNumber(value, fallback = 0) {
            const numberValue = Number(value);
            return Number.isFinite(numberValue) ? numberValue : fallback;
        }

        function formatBytes(bytes) {
            const numeric = toNumber(bytes, 0);
            if (numeric <= 0) {
                return '0 B';
            }
            const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const exponent = Math.min(Math.floor(Math.log(numeric) / Math.log(1024)), units.length - 1);
            const value = numeric / Math.pow(1024, exponent);
            const precision = value >= 10 || exponent === 0 ? 0 : 1;
            return `${value.toFixed(precision)} ${units[exponent]}`;
        }

        function formatUptime(seconds) {
            const numeric = toNumber(seconds, 0);
            if (numeric <= 0) {
                return '0s';
            }
            let remaining = Math.floor(numeric);
            const days = Math.floor(remaining / 86400);
            remaining -= days * 86400;
            const hours = Math.floor(remaining / 3600);
            remaining -= hours * 3600;
            const minutes = Math.floor(remaining / 60);
            remaining -= minutes * 60;
            const parts = [];
            if (days) {
                parts.push(`${days}d`);
            }
            if (hours) {
                parts.push(`${hours}h`);
            }
            if (minutes) {
                parts.push(`${minutes}m`);
            }
            parts.push(`${remaining}s`);
            return parts.join(' ');
        }

        function formatPercent(value) {
            const numeric = toNumber(value, 0);
            return numeric.toFixed(1);
        }

        function setElementText(id, text) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = text;
            }
        }

        function updateCurrentTimeDisplay() {
            const element = document.getElementById('current-time');
            if (!element || !lastUpdatedTime) {
                return;
            }

            const now = new Date();
            const secondsAgo = Math.max(0, Math.floor((now.getTime() - lastUpdatedTime.getTime()) / 1000));
            const formattedTime = lastUpdatedTime.toLocaleTimeString();
            element.textContent = `${formattedTime} (${secondsAgo}s ago)`;
        }

        function showError(message) {
            const alertElement = document.getElementById('refresh-error');
            if (!alertElement) {
                return;
            }
            alertElement.textContent = message;
            alertElement.classList.remove('d-none');
        }

        function hideError() {
            const alertElement = document.getElementById('refresh-error');
            if (!alertElement) {
                return;
            }
            alertElement.textContent = '';
            alertElement.classList.add('d-none');
        }

        function setRefreshing(isRefreshing) {
            const buttons = document.querySelectorAll('.refresh-trigger');
            buttons.forEach((button) => {
                if (isRefreshing) {
                    if (!button.dataset.originalContent) {
                        button.dataset.originalContent = button.innerHTML;
                    }
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    button.disabled = true;
                } else {
                    const original = button.dataset.originalContent;
                    button.innerHTML = original || '<i class="fas fa-sync-alt"></i>';
                    if (original) {
                        delete button.dataset.originalContent;
                    }
                    button.disabled = false;
                }
            });
        }

        function joinLoadAverages(loadAverages) {
            if (!Array.isArray(loadAverages) || !loadAverages.length) {
                return 'N/A';
            }
            return loadAverages.map((value) => formatPercent(value)).join(', ');
        }

        function updateOverview(data) {
            const system = data.system || {};
            const processes = data.processes || {};
            const loadAverages = Array.isArray(data.load_averages) ? data.load_averages : [];

            setElementText('hostname-value', system.hostname || 'Unknown');
            setElementText('os-value', `${system.system || 'Unknown'} ${system.release || ''}`.trim());
            setElementText('architecture-value', system.machine || 'Unknown');
            setElementText('uptime-value', formatUptime(system.uptime_seconds));
            setElementText('load-average-value', joinLoadAverages(loadAverages));

            const totalProcesses = toNumber(processes.total_processes, 0);
            const runningProcesses = toNumber(processes.running_processes, 0);
            setElementText('processes-summary', `${totalProcesses} total (${runningProcesses} running)`);
        }

        function renderCpuCard(cpu) {
            const usage = toNumber(cpu.cpu_usage_percent, 0);
            const cpuClass = usage > 80 ? 'danger' : usage > 50 ? 'warning' : 'success';
            const progressClass = usage > 80 ? 'bg-danger' : usage > 50 ? 'bg-warning' : 'bg-success';
            const perCoreUsage = Array.isArray(cpu.cpu_usage_per_core) ? cpu.cpu_usage_per_core : [];

            let perCoreHtml = '';
            if (perCoreUsage.length && perCoreUsage.length <= 8) {
                const perCoreRows = perCoreUsage
                    .map((value, index) => `
                            <div class="col-6 col-lg-12 col-xl-6">
                                <small>
                                    <div class="d-flex justify-content-between">
                                        <span>Core ${index}</span>
                                        <span class="metric-value">${formatPercent(value)}%</span>
                                    </div>
                                </small>
                            </div>
                        `)
                    .join('');
                perCoreHtml = `
                    <hr>
                    <h6 class="text-muted">Per-Core Usage</h6>
                    <div class="row">
                        ${perCoreRows}
                    </div>
                `;
            }

            return `
                <div class="card health-card ${cpuClass} h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-microchip section-icon"></i> CPU Usage</h5>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">Overall Usage</span>
                            <span class="badge bg-${usage > 80 ? 'danger' : usage > 50 ? 'warning' : 'success'}">
                                ${formatPercent(usage)}%
                            </span>
                        </div>
                        <div class="progress progress-sm mb-3">
                            <div class="progress-bar ${progressClass}" style="width: ${Math.min(100, Math.max(0, usage))}%"></div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Physical Cores:</span>
                                        <span class="metric-value">${cpu.physical_cores ?? 'N/A'}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Total Cores:</span>
                                        <span class="metric-value">${cpu.total_cores ?? 'N/A'}</span>
                                    </div>
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Max Freq:</span>
                                        <span class="metric-value">${toNumber(cpu.max_frequency, 0).toFixed(0)} MHz</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Current:</span>
                                        <span class="metric-value">${toNumber(cpu.current_frequency, 0).toFixed(0)} MHz</span>
                                    </div>
                                </small>
                            </div>
                        </div>
                        ${perCoreHtml}
                    </div>
                </div>
            `;
        }

        function renderMemoryCard(memory) {
            const usage = toNumber(memory.percentage, 0);
            const memoryClass = usage > 90 ? 'danger' : usage > 75 ? 'warning' : 'success';
            const progressClass = usage > 90 ? 'bg-danger' : usage > 75 ? 'bg-warning' : 'bg-success';
            const swapUsage = toNumber(memory.swap_percentage, 0);

            const swapSection = memory.swap_total && toNumber(memory.swap_total, 0) > 0
                ? `
                        <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                            <span class="metric-label">Swap Usage</span>
                            <span class="badge bg-info">${formatPercent(swapUsage)}%</span>
                        </div>
                        <div class="progress progress-sm mb-2">
                            <div class="progress-bar bg-info" style="width: ${Math.min(100, Math.max(0, swapUsage))}%"></div>
                        </div>
                        <small class="text-muted">${formatBytes(memory.swap_used)} / ${formatBytes(memory.swap_total)}</small>
                    `
                : '';

            return `
                <div class="card health-card ${memoryClass} h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-memory section-icon"></i> Memory Usage</h5>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">RAM Usage</span>
                            <span class="badge bg-${usage > 90 ? 'danger' : usage > 75 ? 'warning' : 'success'}">${formatPercent(usage)}%</span>
                        </div>
                        <div class="progress progress-sm mb-2">
                            <div class="progress-bar ${progressClass}" style="width: ${Math.min(100, Math.max(0, usage))}%"></div>
                        </div>
                        <small class="text-muted">${formatBytes(memory.used)} / ${formatBytes(memory.total)}</small>
                        ${swapSection}
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Available:</span>
                                        <span class="metric-value">${formatBytes(memory.available)}</span>
                                    </div>
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <div class="metric-row">
                                        <span class="metric-label">Free:</span>
                                        <span class="metric-value">${formatBytes(memory.free)}</span>
                                    </div>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function determineContainerBadge(container) {
            if (!container || typeof container !== 'object') {
                return { badge: 'secondary', label: 'Unknown' };
            }

            const state = String(container.state || '').toLowerCase();
            const rawStatus = container.status || (state ? state.toUpperCase() : 'Unknown');
            const health = String(container.health || '').toLowerCase();

            if (health === 'healthy') {
                return { badge: 'success', label: 'Healthy' };
            }
            if (health === 'unhealthy') {
                return { badge: 'danger', label: 'Unhealthy' };
            }
            if (health === 'starting') {
                return { badge: 'warning', label: 'Starting' };
            }
            if (state === 'running') {
                return { badge: 'success', label: rawStatus };
            }
            if (['restarting', 'created', 'paused'].includes(state)) {
                return { badge: 'warning', label: rawStatus };
            }
            if (['exited', 'dead'].includes(state)) {
                return { badge: 'secondary', label: rawStatus };
            }
            return { badge: 'secondary', label: rawStatus };
        }

        function renderStackCard(database, containers) {
            const containerData = containers && typeof containers === 'object' ? containers : {};
            const summary = containerData.summary || {};
            const total = toNumber(summary.total, 0);
            const running = toNumber(summary.running, 0);
            const stopped = Math.max(toNumber(summary.stopped, total - running), 0);
            const unhealthy = toNumber(summary.unhealthy, 0);

            const dbStatusRaw = database && database.status ? String(database.status) : 'Unknown';
            const statusLower = dbStatusRaw.toLowerCase();
            let dbClass = 'warning';
            if (statusLower === 'connected') {
                dbClass = 'success';
            } else if (statusLower.includes('error')) {
                dbClass = 'danger';
            } else if (statusLower === 'unknown' || statusLower === 'unavailable') {
                dbClass = 'secondary';
            }

            const dbInfo = (database && database.info) || {};
            const databaseDetails = [];
            if (dbInfo.version) {
                databaseDetails.push(`<small class="text-muted d-block">Version: ${escapeHtml(dbInfo.version)}</small>`);
            }
            if (dbInfo.size) {
                databaseDetails.push(`<small class="text-muted d-block">Size: ${escapeHtml(dbInfo.size)}</small>`);
            }
            if (dbInfo.active_connections !== undefined) {
                databaseDetails.push(`<small class="text-muted d-block">Active Connections: ${escapeHtml(dbInfo.active_connections)}</small>`);
            }

            const isAvailable = Boolean(containerData.available);
            const containersList = Array.isArray(containerData.containers) ? containerData.containers : [];
            const previewItems = isAvailable ? containersList.slice(0, 4) : [];

            const previewHtml = previewItems
                .map((container) => {
                    const { badge, label } = determineContainerBadge(container);
                    const displayName = container.display_name || container.name || 'Unknown';
                    const service = container.service ? `<small class="text-muted d-block">${escapeHtml(container.service)}</small>` : '';
                    return `
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div>
                                        <span class="metric-label">${escapeHtml(displayName)}</span>
                                        ${service}
                                    </div>
                                    <span class="badge bg-${badge} status-badge">${escapeHtml(label)}</span>
                                </div>
                            `;
                })
                .join('');

            let previewFooter = '';
            if (isAvailable) {
                if (containersList.length > previewItems.length) {
                    previewFooter = `<small class="text-muted">… and ${containersList.length - previewItems.length} more containers</small>`;
                } else if (!containersList.length) {
                    previewFooter = '<p class="text-muted mb-0">No containers detected for the current engine.</p>';
                }
            }

            const engineBits = [];
            if (containerData.engine) {
                engineBits.push(`Engine: ${escapeHtml(String(containerData.engine).toUpperCase())}`);
            }
            if (containerData.compose_project) {
                engineBits.push(`Project: ${escapeHtml(containerData.compose_project)}`);
            }
            if (containerData.collector) {
                engineBits.push(`Source: ${escapeHtml(containerData.collector)}`);
            }

            const engineInfo = engineBits.length
                ? `<small class="text-muted d-block mt-2">${engineBits.join(' • ')}</small>`
                : '';

            const availabilityAlert = !isAvailable
                ? `<div class="alert alert-warning mb-0 py-2">Container information unavailable${containerData.error ? `: ${escapeHtml(containerData.error)}` : ''}</div>`
                : '';

            return `
                <div class="card health-card h-100">
                    <div class="card-body">
                        <h5><i class="fas fa-layer-group section-icon"></i> Stack Services</h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="metric-label">Database</span>
                            <span class="badge bg-${dbClass}">${escapeHtml(dbStatusRaw)}</span>
                        </div>
                        ${databaseDetails.join('')}

                        <hr>

                        <div class="stack-summary mb-3">
                            <div>
                                <span class="metric-label">Containers</span>
                                <span class="metric-value">${total}</span>
                            </div>
                            <div>
                                <span class="metric-label text-success">Running</span>
                                <span class="metric-value text-success">${running}</span>
                            </div>
                            <div>
                                <span class="metric-label text-warning">Stopped</span>
                                <span class="metric-value text-warning">${stopped}</span>
                            </div>
                            <div>
                                <span class="metric-label text-danger">Unhealthy</span>
                                <span class="metric-value text-danger">${unhealthy}</span>
                            </div>
                        </div>

                        ${isAvailable ? previewHtml : ''}
                        ${isAvailable ? previewFooter : availabilityAlert}
                        ${isAvailable ? engineInfo : ''}
                    </div>
                </div>
            `;
        }

        function renderContainerDetails(containers) {
            const containerData = containers && typeof containers === 'object' ? containers : {};
            const available = Boolean(containerData.available);
            const items = Array.isArray(containerData.containers) ? containerData.containers : [];

            if (!available || !items.length) {
                const message = available
                    ? 'No container information detected for the current engine.'
                    : containerData.error
                        ? `Container details unavailable: ${escapeHtml(containerData.error)}`
                        : 'Container details unavailable.';
                return `
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-boxes section-icon"></i> Container Details</h5>
                        <p class="text-muted mb-0">${message}</p>
                    </div>
                </div>`;
            }

            const rows = items
                .map((container) => {
                    const { badge, label } = determineContainerBadge(container);
                    const displayName = container.display_name || container.name || 'Unknown';
                    const service = container.service ? `<div class="container-meta">Service: ${escapeHtml(container.service)}</div>` : '';
                    const project = container.project ? `<div class="container-meta">Project: ${escapeHtml(container.project)}</div>` : '';

                    const healthValue = container.health
                        ? String(container.health).toLowerCase()
                        : '';
                    let healthBadge = '<span class="text-muted">—</span>';
                    if (healthValue) {
                        if (healthValue === 'healthy') {
                            healthBadge = '<span class="badge bg-success status-badge">Healthy</span>';
                        } else if (healthValue === 'unhealthy') {
                            healthBadge = '<span class="badge bg-danger status-badge">Unhealthy</span>';
                        } else if (healthValue === 'starting') {
                            healthBadge = '<span class="badge bg-warning status-badge">Starting</span>';
                        } else {
                            healthBadge = `<span class="badge bg-secondary status-badge">${escapeHtml(container.health)}</span>`;
                        }
                    }

                    const image = container.image
                        ? `<div class="container-image">${escapeHtml(container.image)}</div>`
                        : '<span class="text-muted">—</span>';
                    const ports = container.ports
                        ? `<div class="container-meta">Ports: ${escapeHtml(container.ports)}</div>`
                        : '';

                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(displayName)}</strong>
                                ${service}
                                ${project}
                            </td>
                            <td><span class="badge bg-${badge} status-badge">${escapeHtml(label)}</span></td>
                            <td>${healthBadge}</td>
                            <td><span class="metric-value">${escapeHtml(container.running_for || '—')}</span></td>
                            <td>
                                ${image}
                                ${ports}
                            </td>
                        </tr>
                    `;
                })
                .join('');

            return `
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-boxes section-icon"></i> Container Details</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover container-table">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Container</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Health</th>
                                        <th scope="col">Uptime</th>
                                        <th scope="col">Image</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStorageCard(disks) {
            const diskItems = Array.isArray(disks) ? disks : [];
            const diskHtml = diskItems
                .map((disk) => {
                    const percentage = toNumber(disk.percentage, 0);
                    const badgeClass = percentage > 90 ? 'danger' : percentage > 75 ? 'warning' : 'success';
                    const progressClass = percentage > 90 ? 'bg-danger' : percentage > 75 ? 'bg-warning' : 'bg-success';
                    return `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="metric-label">
                                    <strong>${escapeHtml(disk.device || 'Unknown')}</strong>
                                    <small class="text-muted">(${escapeHtml(disk.mountpoint || 'Unknown')})</small>
                                </span>
                                <span class="badge bg-${badgeClass}">${formatPercent(percentage)}%</span>
                            </div>
                            <div class="progress progress-sm mb-1">
                                <div class="progress-bar ${progressClass}" style="width: ${Math.min(100, Math.max(0, percentage))}%"></div>
                            </div>
                            <small class="text-muted">
                                ${formatBytes(disk.used)} used / ${formatBytes(disk.total)} total
                                (${formatBytes(disk.free)} free) • ${escapeHtml(disk.fstype || 'Unknown')}
                            </small>
                        </div>
                    `;
                })
                .join('');

            return `
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-hdd section-icon"></i> Storage Usage</h5>
                        ${diskHtml || '<p class="text-muted">No disk information available</p>'}
                    </div>
                </div>
            `;
        }

        function renderNetworkCard(network) {
            const hostname = network && network.hostname ? network.hostname : 'Unknown';
            const interfaces = Array.isArray(network && network.interfaces) ? network.interfaces.slice(0, 3) : [];
            const moreCount = Array.isArray(network && network.interfaces) && network.interfaces.length > 3
                ? network.interfaces.length - 3
                : 0;

            const interfaceHtml = interfaces
                .map((interfaceInfo) => {
                    const statusClass = interfaceInfo.is_up ? 'success' : 'secondary';
                    const addresses = Array.isArray(interfaceInfo.addresses)
                        ? interfaceInfo.addresses.filter((addr) => addr.type === 'IPv4').slice(0, 2)
                        : [];
                    const addressHtml = addresses
                        .map((addr) => `<small class="text-muted d-block">${escapeHtml(addr.address || 'Unknown')}</small>`)
                        .join('');
                    return `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="metric-label">${escapeHtml(interfaceInfo.name || 'Unknown')}</span>
                                <span class="badge bg-${statusClass} status-badge">${interfaceInfo.is_up ? 'UP' : 'DOWN'}</span>
                            </div>
                            ${addressHtml}
                        </div>
                    `;
                })
                .join('');

            const moreText = moreCount > 0
                ? `<small class="text-muted">... and ${moreCount} more interfaces</small>`
                : '';

            return `
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-network-wired section-icon"></i> Network</h5>
                        <div class="metric-row mb-3">
                            <span class="metric-label">Hostname:</span>
                            <span class="metric-value">${escapeHtml(hostname)}</span>
                        </div>
                        ${interfaceHtml}
                        ${moreText}
                    </div>
                </div>
            `;
        }

        function renderProcessesCard(processes) {
            const processList = Array.isArray(processes && processes.top_processes)
                ? processes.top_processes.slice(0, 10)
                : [];

            const tableBody = processList
                .map((proc) => {
                    const name = proc.name || 'Unknown';
                    const shortName = name.length > 20 ? `${escapeHtml(name.substring(0, 20))}...` : escapeHtml(name);
                    const titleAttr = escapeHtml(name);
                    return `
                        <tr>
                            <td><code>${escapeHtml(proc.pid ?? 'N/A')}</code></td>
                            <td><span title="${titleAttr}">${shortName}</span></td>
                            <td><span class="metric-value">${formatPercent(proc.cpu_percent)}%</span></td>
                            <td><span class="metric-value">${formatPercent(proc.memory_percent)}%</span></td>
                            <td><small class="text-muted">${escapeHtml(proc.username || 'N/A')}</small></td>
                        </tr>
                    `;
                })
                .join('');

            const content = tableBody
                ? `
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>PID</th>
                                        <th>Process Name</th>
                                        <th>CPU %</th>
                                        <th>Memory %</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableBody}
                                </tbody>
                            </table>
                        </div>
                    `
                : '<p class="text-muted text-center py-3">No process information available</p>';

            return `
                <div class="card health-card">
                    <div class="card-body">
                        <h5><i class="fas fa-tasks section-icon"></i> Top Processes (CPU Usage)</h5>
                        ${content}
                    </div>
                </div>
            `;
        }

        function renderTemperatureSection(temperature) {
            if (!temperature || typeof temperature !== 'object') {
                return '';
            }
            const sensorEntries = Object.entries(temperature);
            if (!sensorEntries.length) {
                return '';
            }

            const sensorsHtml = sensorEntries
                .map(([name, entries]) => {
                    const readings = Array.isArray(entries) ? entries : [];
                    const readingHtml = readings
                        .map((entry) => {
                            const current = formatPercent(entry.current);
                            const badge = entry.critical && entry.current > entry.critical * 0.8
                                ? '<span class="badge bg-warning ms-1">Hot</span>'
                                : '';
                            const high = entry.high !== undefined && entry.high !== null
                                ? `High: ${formatPercent(entry.high)}°C`
                                : '';
                            const critical = entry.critical !== undefined && entry.critical !== null
                                ? `Critical: ${formatPercent(entry.critical)}°C`
                                : '';
                            const thresholds = [high, critical].filter(Boolean).join(' • ');
                            const thresholdsHtml = thresholds ? `<small class="text-muted">${thresholds}</small>` : '';
                            return `
                                <div class="metric-row">
                                    <span class="metric-label">${escapeHtml(entry.label || 'Sensor')}:</span>
                                    <span class="metric-value">${current}°C ${badge}</span>
                                </div>
                                ${thresholdsHtml}
                            `;
                        })
                        .join('');
                    return `
                        <div class="col-md-4 mb-3">
                            <h6 class="text-muted">${escapeHtml(name)}</h6>
                            ${readingHtml}
                        </div>
                    `;
                })
                .join('');

            return `
                <div class="col-12">
                    <div class="card health-card">
                        <div class="card-body">
                            <h5><i class="fas fa-thermometer-half section-icon"></i> Temperature Sensors</h5>
                            <div class="row">
                                ${sensorsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function applyHealthData(data) {
            if (!data || typeof data !== 'object') {
                return;
            }

            updateOverview(data);

            const cpuContainer = document.getElementById('cpu-card');
            if (cpuContainer) {
                cpuContainer.innerHTML = renderCpuCard(data.cpu || {});
            }

            const memoryContainer = document.getElementById('memory-card');
            if (memoryContainer) {
                memoryContainer.innerHTML = renderMemoryCard(data.memory || {});
            }

            const stackContainer = document.getElementById('containers-card');
            if (stackContainer) {
                stackContainer.innerHTML = renderStackCard(data.database || {}, data.containers || {});
            }

            const containersDetailContainer = document.getElementById('containers-details');
            if (containersDetailContainer) {
                containersDetailContainer.innerHTML = renderContainerDetails(data.containers || {});
            }

            const storageContainer = document.getElementById('storage-card');
            if (storageContainer) {
                storageContainer.innerHTML = renderStorageCard(data.disk || []);
            }

            const networkContainer = document.getElementById('network-card');
            if (networkContainer) {
                networkContainer.innerHTML = renderNetworkCard(data.network || {});
            }

            const processesContainer = document.getElementById('processes-card');
            if (processesContainer) {
                processesContainer.innerHTML = renderProcessesCard(data.processes || {});
            }

            const temperatureSection = document.getElementById('temperature-section');
            if (temperatureSection) {
                const temperatureHtml = renderTemperatureSection(data.temperature);
                if (temperatureHtml) {
                    temperatureSection.classList.remove('d-none');
                    temperatureSection.innerHTML = temperatureHtml;
                } else {
                    temperatureSection.classList.add('d-none');
                    temperatureSection.innerHTML = '';
                }
            }

            const timestamp = data.local_timestamp || data.timestamp;
            const parsedDate = timestamp ? new Date(timestamp) : new Date();
            lastUpdatedTime = Number.isNaN(parsedDate.getTime()) ? new Date() : parsedDate;
            updateCurrentTimeDisplay();
        }

        async function refreshHealthData(showSpinner = false) {
            try {
                if (showSpinner) {
                    setRefreshing(true);
                }
                hideError();

                const response = await fetch('/api/system_health', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                applyHealthData(data);
            } catch (error) {
                console.error('Error refreshing system health data:', error);
                showError('Unable to refresh system health data. Please try again.');
            } finally {
                if (showSpinner) {
                    setRefreshing(false);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyHealthData(initialHealthData);
            updateCurrentTimeDisplay();
            setInterval(updateCurrentTimeDisplay, 1000);

            document.querySelectorAll('.refresh-trigger').forEach((button) => {
                button.addEventListener('click', () => {
                    refreshHealthData(true);
                });
            });

            setInterval(() => {
                refreshHealthData(false);
            }, REFRESH_INTERVAL_MS);
        });
    </script>
{% endblock %}
