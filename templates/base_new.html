<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}EAS Station - Emergency Alert System{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/eas-system-wordmark.svg') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/eas-system-wordmark.svg') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/eas-system-wordmark.svg') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='img/eas-system-wordmark.svg') }}" color="#204885">
    <meta name="theme-color" content="#204885">

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EAS Station Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

    <script>
        window.CSRF_TOKEN = {{ csrf_token | tojson }};
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                init = init || {};
                const method = (init.method || 'GET').toUpperCase();
                if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                    const headers = new Headers(init.headers || {});
                    if (window.CSRF_TOKEN && !headers.has('X-CSRF-Token')) {
                        headers.set('X-CSRF-Token', window.CSRF_TOKEN);
                    }
                    init.headers = headers;
                }
                return originalFetch.call(this, input, init);
            };
        })();
    </script>

    {% if location_settings %}
    <script>
        window.APP_LOCATION = {{ location_settings | tojson }};
    </script>
    {% endif %}

    {% if boundary_type_config %}
    <script>
        window.BOUNDARY_TYPE_CONFIG = {{ boundary_type_config | tojson }};
        window.BOUNDARY_GROUP_LABELS = {{ boundary_group_labels | tojson }};
    </script>
    {% endif %}

    {% block extra_css %}{% endblock %}
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <!-- Brand -->
            <a class="navbar-brand" href="/" aria-label="EAS Station Home">
                <img src="{{ url_for('static', filename='img/eas-system-wordmark.svg') }}"
                     alt=""
                     class="navbar-brand-logo"
                     width="36"
                     height="36">
                <span class="navbar-brand-text">
                    <span class="navbar-brand-title">EAS Station</span>
                    <span class="navbar-brand-subtitle">Emergency Alert Platform</span>
                </span>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggle" 
                    type="button" 
                    id="navbar-toggle"
                    aria-label="Toggle navigation menu"
                    aria-expanded="false"
                    aria-controls="navbar-menu">
                <span class="navbar-toggle-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>

            <!-- Main Navigation -->
            <ul class="navbar-menu" id="navbar-menu" role="menubar">
                <!-- Dashboard -->
                <li class="nav-item" role="none">
                    <a class="nav-link {% if request.path == '/' %}active{% endif %}" 
                       href="/" 
                       role="menuitem">
                        <i class="fas fa-gauge-high" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

                <!-- Alerts -->
                <li class="nav-item nav-dropdown" role="none">
                    <a class="nav-link nav-dropdown-toggle" 
                       href="#" 
                       role="menuitem"
                       aria-haspopup="true"
                       aria-expanded="false"
                       id="alerts-menu">
                        <i class="fas fa-bell" aria-hidden="true"></i>
                        <span>Alerts</span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="alerts-menu">
                        <li role="none">
                            <a class="dropdown-item" href="/alerts" role="menuitem">
                                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                                Active Alerts
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/alerts" role="menuitem">
                                <i class="fas fa-history" aria-hidden="true"></i>
                                Alert History
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('audio_history') }}" role="menuitem">
                                <i class="fas fa-headphones" aria-hidden="true"></i>
                                Audio Archive
                            </a>
                        </li>
                        <li role="separator"><hr class="dropdown-divider"></li>
                        <li role="none">
                            <a class="dropdown-item" 
                               href="{{ url_for('alert_verification') }}" 
                               role="menuitem"
                               {% if current_user is not defined or not current_user.is_authenticated %}
                               title="Sign in required"
                               {% endif %}>
                                <i class="fas fa-shield-check" aria-hidden="true"></i>
                                Alert Validation
                                {% if current_user is not defined or not current_user.is_authenticated %}
                                <i class="fas fa-lock lock-icon" aria-hidden="true"></i>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- Operations -->
                <li class="nav-item nav-dropdown" role="none">
                    <a class="nav-link nav-dropdown-toggle" 
                       href="#" 
                       role="menuitem"
                       aria-haspopup="true"
                       aria-expanded="false"
                       id="operations-menu">
                        <i class="fas fa-tower-broadcast" aria-hidden="true"></i>
                        <span>Operations</span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="operations-menu">
                        <li role="none">
                            <a class="dropdown-item" 
                               href="{{ url_for('eas.workflow_home') }}" 
                               role="menuitem"
                               {% if current_user is not defined or not current_user.is_authenticated %}
                               title="Sign in required"
                               {% endif %}>
                                <i class="fas fa-broadcast-tower" aria-hidden="true"></i>
                                EAS Workflow
                                {% if current_user is not defined or not current_user.is_authenticated %}
                                <i class="fas fa-lock lock-icon" aria-hidden="true"></i>
                                {% endif %}
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('led_control') }}" role="menuitem">
                                <i class="fas fa-tv" aria-hidden="true"></i>
                                LED Control
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('vfd_control') }}" role="menuitem">
                                <i class="fas fa-desktop" aria-hidden="true"></i>
                                VFD Display
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('radio_settings') }}" role="menuitem">
                                <i class="fas fa-signal" aria-hidden="true"></i>
                                Radio Settings
                            </a>
                        </li>
                        <li role="separator"><hr class="dropdown-divider"></li>
                        <li role="none">
                            <a class="dropdown-item" 
                               href="{{ url_for('compliance_dashboard') }}" 
                               role="menuitem"
                               {% if current_user is not defined or not current_user.is_authenticated %}
                               title="Sign in required"
                               {% endif %}>
                                <i class="fas fa-clipboard-check" aria-hidden="true"></i>
                                Compliance
                                {% if current_user is not defined or not current_user.is_authenticated %}
                                <i class="fas fa-lock lock-icon" aria-hidden="true"></i>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- System -->
                <li class="nav-item nav-dropdown" role="none">
                    <a class="nav-link nav-dropdown-toggle" 
                       href="#" 
                       role="menuitem"
                       aria-haspopup="true"
                       aria-expanded="false"
                       id="system-menu">
                        <i class="fas fa-server" aria-hidden="true"></i>
                        <span>System</span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="system-menu">
                        <li role="none">
                            <a class="dropdown-item" href="/health" role="menuitem">
                                <i class="fas fa-heartbeat" aria-hidden="true"></i>
                                System Health
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/stats" role="menuitem">
                                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                                Statistics
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/admin" role="menuitem">
                                <i class="fas fa-sliders" aria-hidden="true"></i>
                                Configuration
                            </a>
                        </li>
                        <li role="separator"><hr class="dropdown-divider"></li>
                        <li role="none"><span class="dropdown-header">Export Data</span></li>
                        <li role="none">
                            <a class="dropdown-item" href="/export/alerts" role="menuitem">
                                <i class="fas fa-download" aria-hidden="true"></i>
                                Export Alerts
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/export/boundaries" role="menuitem">
                                <i class="fas fa-download" aria-hidden="true"></i>
                                Export Boundaries
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/export/statistics" role="menuitem">
                                <i class="fas fa-download" aria-hidden="true"></i>
                                Export Statistics
                            </a>
                        </li>
                        <li role="separator"><hr class="dropdown-divider"></li>
                        <li role="none"><span class="dropdown-header">Advanced</span></li>
                        <li role="none">
                            <a class="dropdown-item" href="/debug/ipaws" role="menuitem">
                                <i class="fas fa-satellite" aria-hidden="true"></i>
                                IPAWS Debug
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="/version" role="menuitem">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Version Info
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- Help -->
                <li class="nav-item nav-dropdown" role="none">
                    <a class="nav-link nav-dropdown-toggle" 
                       href="#" 
                       role="menuitem"
                       aria-haspopup="true"
                       aria-expanded="false"
                       id="help-menu">
                        <i class="fas fa-circle-question" aria-hidden="true"></i>
                        <span>Help</span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="help-menu">
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('help_page') }}" role="menuitem">
                                <i class="fas fa-book" aria-hidden="true"></i>
                                Documentation
                            </a>
                        </li>
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('about_page') }}" role="menuitem">
                                <i class="fas fa-circle-info" aria-hidden="true"></i>
                                About
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>

            <!-- Utility Navigation -->
            <div class="navbar-utility">
                <!-- System Status -->
                <div class="navbar-status" role="status" aria-live="polite">
                    <span class="navbar-status-dot" id="system-status-dot"></span>
                    <span class="navbar-status-text" id="system-status-text">System OK</span>
                </div>

                <!-- User Menu -->
                {% if current_user is defined and current_user.is_authenticated %}
                <div class="nav-item nav-dropdown">
                    <a class="nav-link nav-dropdown-toggle" 
                       href="#" 
                       role="menuitem"
                       aria-haspopup="true"
                       aria-expanded="false"
                       id="user-menu">
                        <i class="fas fa-user-shield" aria-hidden="true"></i>
                        <span>{{ current_user.username }}</span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="user-menu" style="right: 0; left: auto;">
                        <li role="none">
                            <a class="dropdown-item" href="{{ url_for('logout') }}" role="menuitem">
                                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
                {% else %}
                <a class="nav-link" href="{{ url_for('login') }}">
                    <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                    <span>Login</span>
                </a>
                {% endif %}

                <!-- Theme Toggle -->
                <button class="theme-toggle" 
                        type="button" 
                        onclick="toggleTheme()" 
                        aria-label="Toggle dark mode"
                        title="Toggle dark/light mode">
                    <i id="theme-icon" class="fas fa-moon" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
        <div class="container-fluid">
            <div class="footer-content">
                <p class="footer-text">
                    &copy; {{ current_year or 2024 }} EAS Station - Emergency Alert System
                </p>
                <div class="footer-links">
                    <a href="{{ url_for('privacy_policy') }}">Privacy Policy</a>
                    <a href="{{ url_for('about_page') }}">About</a>
                    <a href="{{ url_for('help_page') }}">Help</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <!-- Navigation Script -->
    <script>
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Load saved theme
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        })();

        // Mobile Navigation Toggle
        document.getElementById('navbar-toggle')?.addEventListener('click', function() {
            this.classList.toggle('active');
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('active');
            const expanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !expanded);
        });

        // Dropdown Toggle
        document.querySelectorAll('.nav-dropdown-toggle').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                const dropdown = this.closest('.nav-dropdown');
                const isActive = dropdown.classList.contains('active');
                
                // Close all dropdowns
                document.querySelectorAll('.nav-dropdown').forEach(d => {
                    d.classList.remove('active');
                    d.querySelector('.nav-dropdown-toggle')?.setAttribute('aria-expanded', 'false');
                });
                
                // Toggle current dropdown
                if (!isActive) {
                    dropdown.classList.add('active');
                    this.setAttribute('aria-expanded', 'true');
                }
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(d => {
                    d.classList.remove('active');
                    d.querySelector('.nav-dropdown-toggle')?.setAttribute('aria-expanded', 'false');
                });
            }
        });

        // Keyboard Navigation
        document.querySelectorAll('.nav-link, .dropdown-item').forEach(item => {
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

        // System Status Check
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/system_health');
                if (response.ok) {
                    const data = await response.json();
                    updateSystemStatus(data);
                }
            } catch (error) {
                console.error('Error checking system status:', error);
            }
        }

        function updateSystemStatus(data) {
            const dot = document.getElementById('system-status-dot');
            const text = document.getElementById('system-status-text');
            
            if (!dot || !text) return;
            
            // Simple health check based on CPU and memory
            const cpuUsage = data.cpu?.cpu_usage_percent || 0;
            const memUsage = data.memory?.percentage || 0;
            
            if (cpuUsage > 90 || memUsage > 95) {
                dot.className = 'navbar-status-dot danger';
                text.textContent = 'System Critical';
            } else if (cpuUsage > 75 || memUsage > 85) {
                dot.className = 'navbar-status-dot warning';
                text.textContent = 'System Warning';
            } else {
                dot.className = 'navbar-status-dot';
                text.textContent = 'System OK';
            }
        }

        // Check system status every 30 seconds
        checkSystemStatus();
        setInterval(checkSystemStatus, 30000);
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>