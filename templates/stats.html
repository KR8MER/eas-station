{% extends "base.html" %}

{% block title %}Statistics Dashboard - KR8MER CAP Emergency Alert System{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), var(--info-color));
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-card.green { background: linear-gradient(135deg, #28a745, #20c997); }
    .stat-card.red { background: linear-gradient(135deg, #dc3545, #fd7e14); }
    .stat-card.orange { background: linear-gradient(135deg, #fd7e14, #ffc107); }
    .stat-card.blue { background: linear-gradient(135deg, #007bff, #6f42c1); }
    .stat-card.purple { background: linear-gradient(135deg, #6f42c1, #e83e8c); }
    .stat-card.teal { background: linear-gradient(135deg, #17a2b8, #20c997); }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 3px;
    }

    .stat-subtitle {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .section-header {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 25px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-container {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px var(--shadow-color);
        min-height: 350px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 15px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-grid-large {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-grid-small {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .loading-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        color: var(--secondary-color);
        flex-direction: column;
    }

    .spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .simple-chart {
        background: var(--light-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        color: var(--text-color);
    }

    .fun-stats {
        background: linear-gradient(135deg, var(--light-color), #e9ecef);
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 2px 10px var(--shadow-color);
    }

    .fun-stat {
        text-align: center;
        margin-bottom: 15px;
    }

    .fun-stat h4 {
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 1.3rem;
    }

    .fun-stat p {
        color: var(--secondary-color);
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .data-table {
        width: 100%;
        margin-top: 15px;
    }

    .data-table th {
        background: var(--primary-color);
        color: white;
        font-weight: 600;
        padding: 12px;
        text-align: left;
    }

    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table tr:nth-child(even) {
        background: var(--light-color);
    }

    .impact-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .impact-high { background: #dc3545; color: white; }
    .impact-medium { background: #ffc107; color: #212529; }
    .impact-low { background: #28a745; color: white; }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .quick-stat {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

    .quick-stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
    }

    .quick-stat-label {
        font-size: 0.9rem;
        color: var(--secondary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-bar"></i> Emergency Alert Statistics Dashboard
                <small class="text-muted">Comprehensive system analytics and insights</small>
            </h1>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row">
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card green">
                <div class="stat-number">{{ active_alerts or 0 }}</div>
                <div class="stat-label">Active Alerts</div>
                <div class="stat-subtitle">Currently active</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card orange">
                <div class="stat-number">{{ expired_alerts or 0 }}</div>
                <div class="stat-label">Expired Alerts</div>
                <div class="stat-subtitle">No longer active</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card blue">
                <div class="stat-number">{{ total_alerts or 0 }}</div>
                <div class="stat-label">Total Alerts</div>
                <div class="stat-subtitle">All time</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card purple">
                <div class="stat-number">{{ total_boundaries or 0 }}</div>
                <div class="stat-label">Boundaries</div>
                <div class="stat-subtitle">Geographic regions</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card red">
                <div class="stat-number" id="uptime-days">Loading...</div>
                <div class="stat-label">System Uptime</div>
                <div class="stat-subtitle">Days online</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="stat-card teal">
                <div class="stat-number">{{ (polling.success_rate * 100) | round(1) if polling and polling.success_rate else 95 }}%</div>
                <div class="stat-label">Reliability</div>
                <div class="stat-subtitle">System uptime</div>
            </div>
        </div>
    </div>

    <!-- Alert Analysis -->
    <h2 class="section-header">
        <i class="fas fa-tags"></i> Alert Analysis
    </h2>

    <div class="chart-grid">
        <!-- Alert Types Distribution -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-pie"></i> Alert Types Distribution
            </div>
            <div id="alertTypesChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading alert types chart...</div>
                </div>
            </div>
        </div>

        <!-- Alert Severity -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-exclamation-triangle"></i> Alert Severity Levels
            </div>
            <div id="severityChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading severity chart...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time-Based Analysis -->
    <h2 class="section-header">
        <i class="fas fa-clock"></i> Time-Based Analysis
    </h2>

    <!-- Hourly Heatmap -->
    <div class="chart-grid-large">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-calendar-day"></i> Alert Activity by Hour of Day
            </div>
            <div id="hourlyHeatmapChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading hourly activity chart...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="chart-grid-small">
        <!-- Day of Week -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-calendar-week"></i> Alerts by Day of Week
            </div>
            <div id="dayOfWeekChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading day of week chart...</div>
                </div>
            </div>
        </div>

        <!-- Monthly Distribution -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-calendar-alt"></i> Monthly Alert Distribution
            </div>
            <div id="monthlyChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading monthly chart...</div>
                </div>
            </div>
        </div>

        <!-- Alert Status -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-list-ul"></i> Alert Status Breakdown
            </div>
            <div id="statusChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading status chart...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Trend -->
    {% if alert_by_year and alert_by_year|length > 1 %}
    <div class="chart-grid-large">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i> Historical Alert Trend
            </div>
            <div id="yearlyTrendChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading yearly trend...</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Geographic Impact -->
    {% if most_affected_boundaries and most_affected_boundaries|length > 0 %}
    <h2 class="section-header">
        <i class="fas fa-map-marked-alt"></i> Geographic Impact Analysis
    </h2>

    <div class="chart-grid">
        <!-- Most Affected Areas -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-map-pin"></i> Most Affected Boundaries
            </div>
            <div id="affectedAreasChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading affected areas...</div>
                </div>
            </div>
        </div>

        <!-- Boundary Types -->
        {% if boundary_stats and boundary_stats|length > 0 %}
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-layer-group"></i> Boundary Types Distribution
            </div>
            <div id="boundaryTypesChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading boundary types...</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Impact Details Table -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i> Detailed Impact Report
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Boundary Name</th>
                    <th>Type</th>
                    <th>Alert Count</th>
                    <th>Impact Level</th>
                </tr>
            </thead>
            <tbody>
                {% for boundary in most_affected_boundaries[:10] %}
                <tr>
                    <td><strong>{{ boundary.name }}</strong></td>
                    <td>
                        <span class="badge bg-secondary">{{ boundary.type.title() }}</span>
                    </td>
                    <td>{{ boundary.count }}</td>
                    <td>
                        {% if boundary.count >= 10 %}
                        <span class="impact-badge impact-high">High Impact</span>
                        {% elif boundary.count >= 5 %}
                        <span class="impact-badge impact-medium">Medium Impact</span>
                        {% else %}
                        <span class="impact-badge impact-low">Low Impact</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- System Performance -->
    {% if polling or avg_durations %}
    <h2 class="section-header">
        <i class="fas fa-tachometer-alt"></i> System Performance Metrics
    </h2>

    <div class="chart-grid">
        <!-- Reliability Gauge -->
        {% if polling and polling.success_rate %}
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-shield-alt"></i> System Reliability
            </div>
            <div id="reliabilityGauge">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading reliability gauge...</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Average Alert Duration -->
        {% if avg_durations and avg_durations|length > 0 %}
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-hourglass-half"></i> Average Alert Duration
            </div>
            <div id="durationChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading duration chart...</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Performance Quick Stats -->
    {% if polling %}
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-number">{{ polling.total_polls or 0 }}</div>
            <div class="quick-stat-label">Total Polls</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number">{{ polling.successful_polls or 0 }}</div>
            <div class="quick-stat-label">Successful</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number">{{ polling.failed_polls or 0 }}</div>
            <div class="quick-stat-label">Failed</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-number">{{ polling.avg_time_ms | round(0) if polling.avg_time_ms else 0 }}ms</div>
            <div class="quick-stat-label">Avg Response</div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Recent Activity -->
    {% if recent_by_day and recent_by_day|length > 0 %}
    <h2 class="section-header">
        <i class="fas fa-history"></i> Recent Activity Trends
    </h2>

    <div class="chart-grid-large">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-area"></i> Recent Alert Activity (Last 30 Days)
            </div>
            <div id="recentActivityChart">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading recent activity...</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Fun Statistics -->
    {% if fun_stats %}
    <h2 class="section-header">
        <i class="fas fa-star"></i> Interesting System Facts
    </h2>

    <div class="fun-stats">
        <div class="row">
            <div class="col-md-3">
                <div class="fun-stat">
                    <h4>{{ fun_stats.busiest_hour or 'N/A' }}</h4>
                    <p>Peak alert hour</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="fun-stat">
                    <h4>{{ fun_stats.busiest_day or 'N/A' }}</h4>
                    <p>Most active day</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="fun-stat">
                    <h4>{{ fun_stats.avg_duration or 'N/A' }}</h4>
                    <p>Average alert duration</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="fun-stat">
                    <h4>"{{ fun_stats.most_common_event or 'None' }}"</h4>
                    <p>Most common alert type</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Footer Info -->
    <div class="mt-5 text-center text-muted">
        <small>
            <i class="fas fa-info-circle"></i> Statistics generated from {{ total_alerts or 0 }} total alerts across {{ total_boundaries or 0 }} geographic boundaries
            <br>
            Dashboard last updated: <span id="stats-timestamp"></span> |
            Data refresh interval: 5 minutes |
            <a href="/export/statistics" class="text-decoration-none">
                <i class="fas fa-download"></i> Export Data
            </a>
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Highcharts and modules -->
<script src="https://code.highcharts.com/11.4.1/highcharts.js"></script>
<script src="https://code.highcharts.com/11.4.1/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/11.4.1/highcharts-more.js"></script>
<script src="https://code.highcharts.com/11.4.1/modules/solid-gauge.js"></script>
<script src="https://code.highcharts.com/11.4.1/modules/accessibility.js"></script>

<script>
console.log('🚀 Statistics dashboard initializing...');

// Store all data from backend
const statsData = {
    alertByEvent: {{ alert_by_event | tojson | safe }} || [],
    alertBySeverity: {{ alert_by_severity | tojson | safe }} || [],
    alertByStatus: {{ alert_by_status | tojson | safe }} || [],
    alertByHour: {{ alert_by_hour | tojson | safe }} || Array(24).fill(0),
    alertByDow: {{ alert_by_dow | tojson | safe }} || Array(7).fill(0),
    alertByMonth: {{ alert_by_month | tojson | safe }} || Array(12).fill(0),
    alertByYear: {{ alert_by_year | tojson | safe }} || [],
    mostAffectedBoundaries: {{ most_affected_boundaries | tojson | safe }} || [],
    avgDurations: {{ avg_durations | tojson | safe }} || [],
    recentByDay: {{ recent_by_day | tojson | safe }} || [],
    boundaryStats: {{ boundary_stats | tojson | safe }} || [],
    polling: {{ polling | tojson | safe }} || {}
};

console.log('✅ Data loaded:', statsData);

// Global chart settings
Highcharts.setOptions({
    colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#6c757d'],
    chart: {
        backgroundColor: 'transparent',
        style: { fontFamily: 'Segoe UI, sans-serif' }
    },
    credits: { enabled: false },
    title: { style: { color: '#212529', fontSize: '16px' } }
});

// Utility functions
function hasValidData(data) {
    return data && Array.isArray(data) && data.length > 0 && data.some(item => (item.count || item.y || item.count) > 0);
}

function showError(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="simple-chart text-danger"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
    } else {
        console.warn(`⚠️ Container ${containerId} not found for error message: ${message}`);
    }
}

function showNoData(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="simple-chart text-muted"><i class="fas fa-info-circle"></i> ${message}</div>`;
    } else {
        console.warn(`⚠️ Container ${containerId} not found for no-data message: ${message}`);
    }
}

// Chart creation functions
function createAlertTypesChart() {
    const container = document.getElementById('alertTypesChart');
    if (!container) return;

    if (!hasValidData(statsData.alertByEvent)) {
        showNoData('alertTypesChart', 'No alert type data available');
        return;
    }

    try {
        const data = statsData.alertByEvent.map(item => ({
            name: item.event || 'Unknown',
            y: item.count || 0
        }));

        Highcharts.chart('alertTypesChart', {
            chart: { type: 'pie', height: 350 },
            title: { text: null },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b><br>{point.percentage:.1f}%'
                    },
                    showInLegend: true
                }
            },
            series: [{
                name: 'Alerts',
                data: data
            }]
        });
        console.log('✅ Alert types chart created');
    } catch (error) {
        console.error('❌ Alert types chart error:', error);
        showError('alertTypesChart', 'Error creating chart: ' + error.message);
    }
}

function createSeverityChart() {
    const container = document.getElementById('severityChart');
    if (!container) return;

    if (!hasValidData(statsData.alertBySeverity)) {
        showNoData('severityChart', 'No severity data available');
        return;
    }

    try {
        const severityColors = {
            'Extreme': '#dc3545',
            'Severe': '#fd7e14',
            'Moderate': '#ffc107',
            'Minor': '#17a2b8',
            'Unknown': '#6c757d'
        };

        const data = statsData.alertBySeverity.map(item => ({
            name: item.severity || 'Unknown',
            y: item.count || 0,
            color: severityColors[item.severity] || '#6c757d'
        }));

        Highcharts.chart('severityChart', {
            chart: { type: 'column', height: 350 },
            title: { text: null },
            xAxis: {
                categories: data.map(item => item.name),
                title: { text: 'Severity Level' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            plotOptions: {
                column: { colorByPoint: true }
            },
            series: [{
                name: 'Alerts',
                data: data
            }]
        });
        console.log('✅ Severity chart created');
    } catch (error) {
        console.error('❌ Severity chart error:', error);
        showError('severityChart', 'Error creating chart: ' + error.message);
    }
}

function createStatusChart() {
    if (!hasValidData(statsData.alertByStatus)) {
        showNoData('statusChart', 'No status data available');
        return;
    }

    try {
        const data = statsData.alertByStatus.map(item => ({
            name: item.status || 'Unknown',
            y: item.count || 0
        }));

        Highcharts.chart('statusChart', {
            chart: { type: 'pie', height: 350 },
            title: { text: null },
            plotOptions: {
                pie: {
                    innerSize: '60%',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b><br>{point.y}'
                    }
                }
            },
            series: [{
                name: 'Status',
                data: data
            }]
        });
        console.log('✅ Status chart created');
    } catch (error) {
        console.error('❌ Status chart error:', error);
        showError('statusChart', 'Error creating chart: ' + error.message);
    }
}

function createHourlyHeatmapChart() {
    try {
        const hourlyData = statsData.alertByHour || Array(24).fill(0);
        const data = hourlyData.map((count, hour) => [hour, 0, count]);

        Highcharts.chart('hourlyHeatmapChart', {
            chart: { type: 'heatmap', height: 200 },
            title: { text: null },
            xAxis: {
                categories: Array.from({length: 24}, (_, i) => `${i}:00`),
                title: { text: 'Hour of Day' }
            },
            yAxis: {
                categories: ['Alert Frequency'],
                title: { text: null }
            },
            colorAxis: {
                min: 0,
                minColor: '#FFFFFF',
                maxColor: '#007bff'
            },
            series: [{
                name: 'Alerts per Hour',
                borderWidth: 1,
                data: data,
                dataLabels: {
                    enabled: true,
                    color: '#000000'
                }
            }]
        });
        console.log('✅ Hourly heatmap created');
    } catch (error) {
        console.error('❌ Hourly heatmap error:', error);
        showError('hourlyHeatmapChart', 'Error creating chart: ' + error.message);
    }
}

function createDayOfWeekChart() {
    try {
        const dowData = statsData.alertByDow || Array(7).fill(0);
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        Highcharts.chart('dayOfWeekChart', {
            chart: { type: 'column', height: 350 },
            title: { text: null },
            xAxis: {
                categories: dayNames,
                title: { text: 'Day of Week' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            series: [{
                name: 'Alerts',
                data: dowData,
                color: '#28a745'
            }]
        });
        console.log('✅ Day of week chart created');
    } catch (error) {
        console.error('❌ Day of week chart error:', error);
        showError('dayOfWeekChart', 'Error creating chart: ' + error.message);
    }
}

function createMonthlyChart() {
    try {
        const monthData = statsData.alertByMonth || Array(12).fill(0);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        Highcharts.chart('monthlyChart', {
            chart: { type: 'area', height: 350 },
            title: { text: null },
            xAxis: {
                categories: monthNames,
                title: { text: 'Month' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            plotOptions: {
                area: {
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                        stops: [
                            [0, 'rgba(0, 123, 255, 0.3)'],
                            [1, 'rgba(0, 123, 255, 0.1)']
                        ]
                    }
                }
            },
            series: [{
                name: 'Monthly Alerts',
                data: monthData,
                color: '#007bff'
            }]
        });
        console.log('✅ Monthly chart created');
    } catch (error) {
        console.error('❌ Monthly chart error:', error);
        showError('monthlyChart', 'Error creating chart: ' + error.message);
    }
}

function createYearlyTrendChart() {
    if (!hasValidData(statsData.alertByYear)) return;

    const container = document.getElementById('yearlyTrendChart');
    if (!container) {
        console.log('⚠️ Yearly trend chart container not found - skipping');
        return;
    }

    try {
        Highcharts.chart('yearlyTrendChart', {
            chart: { type: 'line', height: 300 },
            title: { text: null },
            xAxis: {
                categories: statsData.alertByYear.map(item => item.year),
                title: { text: 'Year' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            plotOptions: {
                line: {
                    dataLabels: { enabled: true },
                    marker: { enabled: true, radius: 6 }
                }
            },
            series: [{
                name: 'Annual Alerts',
                data: statsData.alertByYear.map(item => item.count),
                color: '#6f42c1'
            }]
        });
        console.log('✅ Yearly trend chart created');
    } catch (error) {
        console.error('❌ Yearly trend chart error:', error);
        showError('yearlyTrendChart', 'Error creating chart: ' + error.message);
    }
}

function createAffectedAreasChart() {
    if (!hasValidData(statsData.mostAffectedBoundaries)) {
        showNoData('affectedAreasChart', 'No boundary impact data available');
        return;
    }

    try {
        Highcharts.chart('affectedAreasChart', {
            chart: { type: 'bar', height: 400 },
            title: { text: null },
            xAxis: {
                categories: statsData.mostAffectedBoundaries.map(item => item.name),
                title: { text: 'Boundary' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            plotOptions: {
                bar: { dataLabels: { enabled: true } }
            },
            series: [{
                name: 'Alert Count',
                data: statsData.mostAffectedBoundaries.map(item => item.count),
                color: '#17a2b8'
            }]
        });
        console.log('✅ Affected areas chart created');
    } catch (error) {
        console.error('❌ Affected areas chart error:', error);
        showError('affectedAreasChart', 'Error creating chart: ' + error.message);
    }
}

function createBoundaryTypesChart() {
    if (!hasValidData(statsData.boundaryStats)) return;

    try {
        const data = statsData.boundaryStats.map(item => ({
            name: item.type.charAt(0).toUpperCase() + item.type.slice(1),
            y: item.count
        }));

        Highcharts.chart('boundaryTypesChart', {
            chart: { type: 'pie', height: 350 },
            title: { text: null },
            plotOptions: {
                pie: {
                    dataLabels: { enabled: true }
                }
            },
            series: [{
                name: 'Boundary Types',
                data: data
            }]
        });
        console.log('✅ Boundary types chart created');
    } catch (error) {
        console.error('❌ Boundary types chart error:', error);
        showError('boundaryTypesChart', 'Error creating chart: ' + error.message);
    }
}

function createReliabilityGauge() {
    if (!statsData.polling || typeof statsData.polling.success_rate === 'undefined') return;

    try {
        const successRate = statsData.polling.success_rate || 0;

        Highcharts.chart('reliabilityGauge', {
            chart: { type: 'solidgauge', height: 350 },
            title: { text: null },
            pane: {
                center: ['50%', '85%'],
                size: '140%',
                startAngle: -90,
                endAngle: 90,
                background: {
                    backgroundColor: '#EEE',
                    innerRadius: '60%',
                    outerRadius: '100%',
                    shape: 'arc'
                }
            },
            yAxis: {
                min: 0,
                max: 1,
                stops: [
                    [0.1, '#dc3545'],
                    [0.5, '#ffc107'],
                    [0.9, '#28a745']
                ],
                lineWidth: 0,
                tickWidth: 0,
                minorTickInterval: null,
                tickAmount: 2,
                title: { y: -70, text: 'System Reliability' },
                labels: {
                    y: 16,
                    formatter: function() {
                        return Math.round(this.value * 100) + '%';
                    }
                }
            },
            series: [{
                name: 'Reliability',
                data: [successRate],
                dataLabels: {
                    format: '<div style="text-align:center"><span style="font-size:25px;color:black">{y:.1%}</span><br/><span style="font-size:12px;color:silver">Uptime</span></div>',
                    y: 5,
                    borderWidth: 0,
                    useHTML: true
                }
            }]
        });
        console.log('✅ Reliability gauge created');
    } catch (error) {
        console.error('❌ Reliability gauge error:', error);
        showError('reliabilityGauge', 'Error creating chart: ' + error.message);
    }
}

function createDurationChart() {
    if (!hasValidData(statsData.avgDurations)) return;

    try {
        Highcharts.chart('durationChart', {
            chart: { type: 'column', height: 350 },
            title: { text: null },
            xAxis: {
                categories: statsData.avgDurations.map(item => item.event),
                title: { text: 'Alert Type' }
            },
            yAxis: { title: { text: 'Average Duration (hours)' } },
            series: [{
                name: 'Duration',
                data: statsData.avgDurations.map(item => Math.round(item.avg_duration_hours * 10) / 10),
                color: '#fd7e14'
            }]
        });
        console.log('✅ Duration chart created');
    } catch (error) {
        console.error('❌ Duration chart error:', error);
        showError('durationChart', 'Error creating chart: ' + error.message);
    }
}

function createRecentActivityChart() {
    if (!hasValidData(statsData.recentByDay)) return;

    try {
        Highcharts.chart('recentActivityChart', {
            chart: { type: 'spline', height: 300 },
            title: { text: null },
            xAxis: {
                categories: statsData.recentByDay.map(item => new Date(item.date).toLocaleDateString()),
                title: { text: 'Date' }
            },
            yAxis: { title: { text: 'Number of Alerts' } },
            plotOptions: {
                spline: {
                    marker: { enabled: true, radius: 4 },
                    lineWidth: 3
                }
            },
            series: [{
                name: 'Daily Alerts',
                data: statsData.recentByDay.map(item => item.count),
                color: '#20c997'
            }]
        });
        console.log('✅ Recent activity chart created');
    } catch (error) {
        console.error('❌ Recent activity chart error:', error);
        showError('recentActivityChart', 'Error creating chart: ' + error.message);
    }
}

// Initialize all charts
function initializeCharts() {
    console.log('📊 Creating all charts...');

    const chartFunctions = [
        createAlertTypesChart,
        createSeverityChart,
        createStatusChart,
        createHourlyHeatmapChart,
        createDayOfWeekChart,
        createMonthlyChart,
        createYearlyTrendChart,
        createAffectedAreasChart,
        createBoundaryTypesChart,
        createReliabilityGauge,
        createDurationChart,
        createRecentActivityChart
    ];

    // Create charts with small delays to prevent browser blocking
    chartFunctions.forEach((func, index) => {
        setTimeout(func, index * 150);
    });
}

// Update timestamps and uptime
function updateSystemInfo() {
    // Update timestamp
    const timestamp = document.getElementById('stats-timestamp');
    if (timestamp) {
        timestamp.textContent = new Date().toLocaleString();
    }

    // Calculate uptime (approximate - would be more accurate from server)
    const uptimeDays = document.getElementById('uptime-days');
    if (uptimeDays) {
        const startDate = new Date('2025-01-01'); // Adjust based on your system start
        const now = new Date();
        const days = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        uptimeDays.textContent = days;
    }
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Statistics dashboard loaded');

    updateSystemInfo();

    setTimeout(() => {
        if (typeof Highcharts !== 'undefined') {
            console.log('✅ Highcharts ready, initializing charts...');
            initializeCharts();
        } else {
            console.error('❌ Highcharts not available');
        }
    }, 1000);

    console.log('✅ Dashboard initialization complete');
});

console.log('📜 Statistics dashboard script loaded');
</script>
{% endblock %}