{% extends "base.html" %}

{% block title %}GPIO Pin Map - EAS Station{% endblock %}

{% block extra_css %}
<style>
    .pin-card {
        border-left: 4px solid #0d6efd;
        height: 100%;
        transition: all 0.3s ease;
    }
    .pin-card.power { border-left-color: #ffc107; }
    .pin-card.ground { border-left-color: #6c757d; }
    .pin-card.gpio.configured { border-left-color: #28a745; }
    .pin-card.gpio:not(.configured) { border-left-color: #0d6efd; }
    .pin-card.gpio.has-behavior { 
        border-left-color: #198754;
        box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.15);
    }
    .behavior-grid {
        display: grid;
        gap: 0.75rem;
    }
    @media (min-width: 768px) {
        .behavior-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }
    .behavior-label {
        display: flex;
        flex-direction: column;
    }
    .behavior-label small {
        color: var(--bs-secondary-color);
    }
    .form-check-input:checked + .form-check-label {
        font-weight: 600;
        color: #198754;
    }
    .unsaved-changes {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        display: none;
    }
    .unsaved-changes.show {
        display: block;
        animation: slideInRight 0.3s ease;
    }
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12 col-lg-10">
            <h2><i class="fas fa-map"></i> Raspberry Pi GPIO Pin Map</h2>
            <p class="text-muted mb-0">
                Assign alert behaviors to GPIO pins. Pin numbers (1-40) refer to physical header positions. 
                BCM numbers refer to Broadcom GPIO identifiers (e.g., BCM GPIO 17 = Physical Pin 11).
                Behaviors determine when a pin is driven active (respecting its configured active-high or active-low state).
            </p>
        </div>
        <div class="col-12 col-lg-2 text-lg-end mt-3 mt-lg-0">
            <button class="btn btn-outline-secondary" id="reloadPinMap">
                <i class="fas fa-rotate"></i> Reload
            </button>
        </div>
    </div>

    <div id="pinMapAlert" class="alert d-none" role="alert"></div>
    
    <!-- Success toast notification -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="saveSuccessToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="toastMessage">Changes saved successfully!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        <div id="saveErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorToastMessage">Failed to save changes</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="alert alert-info" role="alert">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle me-2 mt-1"></i>
            <div>
                <strong>How to configure GPIO behaviors:</strong>
                <ol class="mb-0 mt-2">
                    <li>Select a behavior for each GPIO pin you want to use (or leave as "None" to disable)</li>
                    <li>Click <strong>"Save Behaviors"</strong> to write changes to your environment configuration</li>
                    <li>Restart the service for changes to take effect: <code>docker compose restart</code></li>
                </ol>
                <p class="mb-0 mt-2">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i> Tip: Configure pins in <strong>Settings → Environment → GPIO</strong> 
                        before assigning behaviors here.
                    </small>
                </p>
            </div>
        </div>
    </div>

    {% for row in pin_rows %}
    <div class="row g-3 align-items-stretch mb-3">
        {% for side in ['left', 'right'] %}
        {% set pin = row[side] %}
        <div class="col-md-6">
            <div class="card pin-card {{ pin.type }} {% if pin.is_gpio %}gpio{% endif %} {% if pin.configured %}configured{% endif %}" data-physical="{{ pin.physical }}" {% if pin.is_gpio and pin.bcm is not none %}data-bcm="{{ pin.bcm }}"{% endif %}>
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-primary me-2">Pin {{ pin.physical }}</span>
                            <strong>{{ pin.name }}</strong>
                        </div>
                        {% if pin.is_gpio and pin.bcm is not none %}
                        <span class="badge bg-dark">BCM {{ pin.bcm }}</span>
                        {% endif %}
                    </div>

                    {% if pin.description %}
                    <p class="text-muted small mb-2">{{ pin.description }}</p>
                    {% endif %}

                    {% if not pin.is_gpio %}
                        <div class="alert alert-light border-secondary small mb-0" role="status">
                            {% if pin.type == 'power' %}
                                <i class="fas fa-bolt"></i> Power rail
                            {% elif pin.type == 'ground' %}
                                <i class="fas fa-plug"></i> Ground reference
                            {% else %}
                                Non-GPIO function
                            {% endif %}
                        </div>
                    {% elif pin.bcm is none %}
                        <div class="alert alert-warning small mb-0" role="status">
                            <i class="fas fa-exclamation-triangle"></i> GPIO mapping unavailable for this pin.
                        </div>
                    {% else %}
                        <div class="mb-3">
                            {% if pin.configured %}
                                <span class="badge bg-success me-2">Configured</span>
                                <span class="text-muted small">Active {{ 'HIGH' if pin.active_high else 'LOW' }}</span>
                            {% else %}
                                <span class="badge bg-secondary me-2">Not configured</span>
                                <span class="text-muted small">Assign in Settings → Environment to control this pin.</span>
                            {% endif %}
                        </div>

                        <div class="behavior-grid" aria-label="Behaviors for GPIO {{ pin.bcm }}">
                            <div class="form-check">
                                <input class="form-check-input behavior-radio" type="radio"
                                       name="pin{{ pin.bcm }}-behavior"
                                       id="pin{{ pin.bcm }}-none"
                                       data-bcm="{{ pin.bcm }}"
                                       data-behavior=""
                                       value=""
                                       {% if not pin.behaviors %}checked{% endif %}>
                                <label class="form-check-label behavior-label" for="pin{{ pin.bcm }}-none">
                                    <span>None</span>
                                    <small>No automatic behavior</small>
                                </label>
                            </div>
                            {% for behavior in behavior_options %}
                            <div class="form-check">
                                <input class="form-check-input behavior-radio" type="radio"
                                       name="pin{{ pin.bcm }}-behavior"
                                       id="pin{{ pin.bcm }}-{{ behavior.value }}"
                                       data-bcm="{{ pin.bcm }}"
                                       data-behavior="{{ behavior.value }}"
                                       value="{{ behavior.value }}"
                                       {% if behavior.value in pin.behaviors %}checked{% endif %}>
                                <label class="form-check-label behavior-label" for="pin{{ pin.bcm }}-{{ behavior.value }}">
                                    <span>{{ behavior.label }}</span>
                                    {% if behavior.description %}
                                    <small>{{ behavior.description }}</small>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button class="btn btn-outline-secondary" id="clearPinMap">
            <i class="fas fa-eraser"></i> Clear All
        </button>
        <button class="btn btn-primary" id="savePinMap">
            <i class="fas fa-save"></i> Save Behaviors
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const alertBox = document.getElementById('pinMapAlert');
    const saveButton = document.getElementById('savePinMap');
    const clearButton = document.getElementById('clearPinMap');
    const reloadButton = document.getElementById('reloadPinMap');
    let hasUnsavedChanges = false;

    function showMessage(message, variant) {
        console.log(`showMessage called: ${variant} - ${message}`);
        if (!alertBox) { 
            console.error('Alert box element not found');
            return; 
        }
        alertBox.className = `alert alert-${variant}`;
        alertBox.textContent = message;
        alertBox.classList.remove('d-none');
        console.log('Alert box updated successfully');
        
        // Also show toast notification
        try {
            if (variant === 'success') {
                const toast = document.getElementById('saveSuccessToast');
                const toastMessage = document.getElementById('toastMessage');
                if (toast && toastMessage) {
                    toastMessage.textContent = message;
                    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
                        bsToast.show();
                        console.log('Success toast shown');
                    } else {
                        console.warn('Bootstrap Toast not available');
                    }
                }
            } else if (variant === 'danger') {
                const toast = document.getElementById('saveErrorToast');
                const errorMessage = document.getElementById('errorToastMessage');
                if (toast && errorMessage) {
                    errorMessage.textContent = message;
                    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                        const bsToast = new bootstrap.Toast(toast, { delay: 8000 });
                        bsToast.show();
                        console.log('Error toast shown');
                    } else {
                        console.warn('Bootstrap Toast not available');
                    }
                }
            }
        } catch (toastError) {
            console.error('Failed to show toast notification:', toastError);
            // Don't let toast errors break the main flow
        }
    }

    function hideMessage() {
        if (!alertBox) { return; }
        alertBox.classList.add('d-none');
    }
    
    function markUnsavedChanges() {
        hasUnsavedChanges = true;
        if (saveButton) {
            saveButton.classList.add('btn-warning');
            saveButton.classList.remove('btn-primary');
        }
    }
    
    function clearUnsavedChanges() {
        hasUnsavedChanges = false;
        if (saveButton) {
            saveButton.classList.remove('btn-warning');
            saveButton.classList.add('btn-primary');
        }
    }
    
    function updateCardHighlights() {
        // Highlight cards that have a behavior selected
        document.querySelectorAll('.pin-card.gpio').forEach(card => {
            const bcm = card.dataset.bcm;
            if (!bcm) return;
            
            const selected = card.querySelector(`input[name="pin${bcm}-behavior"]:checked`);
            if (selected && selected.dataset.behavior) {
                card.classList.add('has-behavior');
            } else {
                card.classList.remove('has-behavior');
            }
        });
    }

    function buildBehaviorMatrix() {
        const matrix = {};
        // Get all unique BCM pins from radio buttons
        const pins = new Set();
        document.querySelectorAll('.behavior-radio').forEach((radio) => {
            if (radio.dataset.bcm) {
                pins.add(radio.dataset.bcm);
            }
        });
        
        // For each pin, find the selected behavior
        pins.forEach((bcm) => {
            const selected = document.querySelector(`input[name="pin${bcm}-behavior"]:checked`);
            if (selected && selected.dataset.behavior) {
                // Store as array with single value for backward compatibility
                matrix[bcm] = [selected.dataset.behavior];
            }
        });
        return matrix;
    }

    async function saveMatrix() {
        console.log('saveMatrix function called');
        hideMessage();
        if (!saveButton) {
            console.error('Save button not found!');
            alert('Error: Save button element not found');
            return;
        }
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving';

        const matrix = buildBehaviorMatrix();
        console.log('Behavior matrix to save:', matrix);
        
        const payload = {
            variables: {
                GPIO_PIN_BEHAVIOR_MATRIX: Object.keys(matrix).length ? JSON.stringify(matrix) : ''
            }
        };
        
        console.log('Payload:', payload);
        console.log('Payload JSON:', JSON.stringify(payload, null, 2));

        try {
            console.log('Starting fetch request to /api/environment/variables...');
            const response = await fetch('/api/environment/variables', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            console.log('Fetch completed');
            
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            // Clone response before reading to allow re-reading if needed
            const responseClone = response.clone();
            let data;
            try {
                data = await response.json();
                console.log('Response data:', data);
            } catch (jsonError) {
                console.error('Failed to parse response as JSON:', jsonError);
                try {
                    const text = await responseClone.text();
                    console.error('Response text:', text);
                    throw new Error(`Server returned non-JSON response (status ${response.status}): ${text.substring(0, 200)}`);
                } catch (textError) {
                    console.error('Failed to read response text:', textError);
                    throw new Error(`Server returned non-JSON response (status ${response.status}) and failed to read response text`);
                }
            }
            
            if (!response.ok) {
                // Handle specific error cases
                if (response.status === 401) {
                    throw new Error('Authentication required. Please log in to save GPIO behaviors.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You need "system.configure" permission to modify environment variables.');
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    throw new Error(data.message || `Server error (status ${response.status})`);
                }
            }
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show detailed success message
            let message = '✓ GPIO behavior matrix saved successfully to .env file!';
            if (data.saved_variables && data.saved_variables.length > 0) {
                message += ` Variable saved: ${data.saved_variables.join(', ')}.`;
            }
            if (data.restart_required) {
                message += ' Restart the service to apply changes: docker compose restart';
            }
            console.log('About to show success message:', message);
            showMessage(message, 'success');
            
            // Update the alert to include a link to verify
            // Wait a moment to ensure the message is shown first
            setTimeout(() => {
                if (alertBox) {
                    alertBox.innerHTML = `
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            ${message}
                        </div>
                        <div class="mt-2">
                            <a href="/settings/environment" class="btn btn-sm btn-success">
                                <i class="fas fa-eye"></i> View in Environment Settings
                            </a>
                        </div>
                    `;
                    console.log('Alert box updated with link');
                }
            }, 100);
            
            clearUnsavedChanges();
        } catch (error) {
            console.error('Failed to save pin map', error);
            console.error('Error stack:', error.stack);
            const errorMsg = `✗ Failed to save behavior map: ${error.message}`;
            console.log('About to show error message:', errorMsg);
            showMessage(errorMsg, 'danger');
        } finally {
            console.log('saveMatrix finally block');
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Behaviors';
            }
        }
    }

    function clearMatrix() {
        // Set all pins back to "None"
        document.querySelectorAll('.behavior-radio').forEach((radio) => {
            if (radio.dataset.behavior === '') {
                radio.checked = true;
            }
        });
        updateCardHighlights();
        markUnsavedChanges();
        showMessage('Cleared selections. Remember to save to persist the changes.', 'warning');
    }
    
    // Listen for behavior changes
    document.querySelectorAll('.behavior-radio').forEach((radio) => {
        radio.addEventListener('change', () => {
            updateCardHighlights();
            markUnsavedChanges();
        });
    });

    if (saveButton) {
        saveButton.addEventListener('click', () => {
            console.log('Save button clicked!');
            saveMatrix();
        });
    } else {
        console.error('Save button element not found during initialization');
    }
    if (clearButton) {
        clearButton.addEventListener('click', clearMatrix);
    }
    if (reloadButton) {
        reloadButton.addEventListener('click', () => window.location.reload());
    }
    
    // Initialize card highlights on load
    updateCardHighlights();
    
    // Warn about unsaved changes
    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
})();
</script>
{% endblock %}
