<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Profiles - EAS Station</title>
    {% include 'partials/common_head.html' %}
    <style>
        .profile-card {
            transition: box-shadow 0.2s;
        }
        .profile-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .profile-enabled {
            border-left: 4px solid #28a745;
        }
        .profile-disabled {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }
        .bandwidth-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    {% include 'partials/navbar.html' %}
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1><i class="fas fa-broadcast-tower"></i> Stream Profiles</h1>
                        <p class="text-muted">Configure Icecast streaming profiles with different bitrates and formats</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#createProfileModal">
                            <i class="fas fa-plus"></i> Create Profile
                        </button>
                    </div>
                </div>

                <!-- Bandwidth Summary -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h5>Active Profiles</h5>
                                <h2 id="activeProfileCount">-</h2>
                            </div>
                            <div class="col-md-3">
                                <h5>Total Profiles</h5>
                                <h2 id="totalProfileCount">-</h2>
                            </div>
                            <div class="col-md-6">
                                <h5>Estimated Bandwidth Usage</h5>
                                <h2 id="bandwidthEstimate">-</h2>
                                <p class="bandwidth-info">Per hour for all active streams</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profiles List -->
                <div id="profilesContainer" class="row">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="card text-center py-5" style="display: none;">
                    <div class="card-body">
                        <i class="fas fa-broadcast-tower fa-5x text-muted mb-4"></i>
                        <h3>No Stream Profiles</h3>
                        <p class="text-muted">Create your first stream profile to get started</p>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#createProfileModal">
                            <i class="fas fa-plus"></i> Create Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Profile Modal -->
    <div class="modal fade" id="createProfileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span id="modalTitleCreate">Create Stream Profile</span>
                        <span id="modalTitleEdit" style="display: none;">Edit Stream Profile</span>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <input type="hidden" id="editMode" value="false">
                        <input type="hidden" id="originalName" value="">
                        
                        <!-- Quick Presets -->
                        <div class="form-group">
                            <label>Quick Preset (Optional)</label>
                            <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                <label class="btn btn-outline-secondary">
                                    <input type="radio" name="preset" value=""> Custom
                                </label>
                                <label class="btn btn-outline-secondary">
                                    <input type="radio" name="preset" value="low"> Low (64kbps)
                                </label>
                                <label class="btn btn-outline-secondary">
                                    <input type="radio" name="preset" value="medium"> Medium (128kbps)
                                </label>
                                <label class="btn btn-outline-secondary">
                                    <input type="radio" name="preset" value="high"> High (192kbps)
                                </label>
                                <label class="btn btn-outline-secondary">
                                    <input type="radio" name="preset" value="premium"> Premium (320kbps)
                                </label>
                            </div>
                            <small class="form-text text-muted">Select a preset to auto-fill settings, or choose Custom to configure manually</small>
                        </div>

                        <hr>

                        <!-- Basic Settings -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="profileName">Profile Name *</label>
                                    <input type="text" class="form-control" id="profileName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="profileMount">Mount Point *</label>
                                    <input type="text" class="form-control" id="profileMount" placeholder="/stream.mp3" required>
                                    <small class="form-text text-muted">e.g., /stream.mp3 or /high.mp3</small>
                                </div>
                            </div>
                        </div>

                        <!-- Audio Settings -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="profileFormat">Format *</label>
                                    <select class="form-control" id="profileFormat" required>
                                        <option value="mp3">MP3</option>
                                        <option value="ogg">OGG Vorbis</option>
                                        <option value="opus">Opus</option>
                                        <option value="aac">AAC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="profileBitrate">Bitrate (kbps) *</label>
                                    <input type="number" class="form-control" id="profileBitrate" min="32" max="320" value="128" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="profileChannels">Channels *</label>
                                    <select class="form-control" id="profileChannels" required>
                                        <option value="1">Mono</option>
                                        <option value="2" selected>Stereo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata -->
                        <div class="form-group">
                            <label for="profileDescription">Description</label>
                            <input type="text" class="form-control" id="profileDescription" placeholder="High quality monitoring stream">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="profileSampleRate">Sample Rate (Hz)</label>
                                    <select class="form-control" id="profileSampleRate">
                                        <option value="44100" selected>44100 (CD Quality)</option>
                                        <option value="48000">48000 (Professional)</option>
                                        <option value="32000">32000</option>
                                        <option value="22050">22050</option>
                                        <option value="16000">16000</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="profileGenre">Genre</label>
                                    <input type="text" class="form-control" id="profileGenre" value="Emergency Alert">
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="custom-control custom-checkbox mb-3">
                            <input type="checkbox" class="custom-control-input" id="profileEnabled" checked>
                            <label class="custom-control-label" for="profileEnabled">Enable this profile</label>
                        </div>

                        <div class="alert alert-info">
                            <strong>Note:</strong> Changes to stream profiles require restarting the Icecast service to take effect.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">
                        <span id="saveButtonCreate">Create Profile</span>
                        <span id="saveButtonEdit" style="display: none;">Save Changes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% include 'partials/footer.html' %}

    <script>
        let profiles = {};

        // Load profiles on page load
        document.addEventListener('DOMContentLoaded', loadProfiles);

        // Preset selection handler
        document.querySelectorAll('input[name="preset"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value) {
                    applyPreset(this.value);
                }
            });
        });

        async function loadProfiles() {
            try {
                const response = await fetch('/api/stream-profiles');
                const data = await response.json();
                
                if (data.success) {
                    profiles = data.profiles;
                    displayProfiles();
                    updateSummary(data);
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                showAlert('Error loading stream profiles', 'danger');
            }
        }

        function displayProfiles() {
            const container = document.getElementById('profilesContainer');
            container.innerHTML = '';
            
            if (Object.keys(profiles).length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            Object.entries(profiles).forEach(([name, profile]) => {
                const card = createProfileCard(name, profile);
                container.appendChild(card);
            });
        }

        function createProfileCard(name, profile) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const enabledClass = profile.enabled ? 'profile-enabled' : 'profile-disabled';
            const statusBadge = profile.enabled 
                ? '<span class="badge badge-success">Enabled</span>'
                : '<span class="badge badge-secondary">Disabled</span>';
            
            col.innerHTML = `
                <div class="card profile-card ${enabledClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">${escapeHtml(profile.name)}</h5>
                            ${statusBadge}
                        </div>
                        <p class="text-muted small">${escapeHtml(profile.description || 'No description')}</p>
                        
                        <hr>
                        
                        <div class="row small">
                            <div class="col-6">
                                <strong>Mount:</strong> ${escapeHtml(profile.mount)}<br>
                                <strong>Format:</strong> ${profile.format.toUpperCase()}<br>
                                <strong>Bitrate:</strong> ${profile.bitrate} kbps
                            </div>
                            <div class="col-6">
                                <strong>Sample Rate:</strong> ${profile.sample_rate} Hz<br>
                                <strong>Channels:</strong> ${profile.channels === 1 ? 'Mono' : 'Stereo'}<br>
                                <strong>Est. Usage:</strong> ~${estimateBandwidth(profile.bitrate)} MB/hr
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="btn-group btn-block" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editProfile('${escapeHtml(name)}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-${profile.enabled ? 'warning' : 'success'}" 
                                    onclick="toggleProfile('${escapeHtml(name)}', ${!profile.enabled})">
                                <i class="fas fa-power-off"></i> ${profile.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProfile('${escapeHtml(name)}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function updateSummary(data) {
            document.getElementById('activeProfileCount').textContent = data.active_count;
            document.getElementById('totalProfileCount').textContent = data.total_count;
            
            // Get bandwidth estimate
            fetch('/api/stream-profiles/bandwidth-estimate')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('bandwidthEstimate').textContent = 
                            `${data.total_mb} MB`;
                    }
                });
        }

        function estimateBandwidth(bitrate) {
            // Estimate MB per hour: bitrate (kbps) * 3600s / 8 / 1024
            return Math.round(bitrate * 3600 / 8 / 1024);
        }

        function applyPreset(preset) {
            const presets = {
                'low': { bitrate: 64, channels: 1 },
                'medium': { bitrate: 128, channels: 2 },
                'high': { bitrate: 192, channels: 2 },
                'premium': { bitrate: 320, channels: 2 }
            };
            
            if (presets[preset]) {
                document.getElementById('profileBitrate').value = presets[preset].bitrate;
                document.getElementById('profileChannels').value = presets[preset].channels;
                
                // Suggest mount point
                if (!document.getElementById('editMode').value === 'true') {
                    document.getElementById('profileMount').value = `/${preset}.mp3`;
                }
            }
        }

        function editProfile(name) {
            const profile = profiles[name];
            if (!profile) return;
            
            // Set edit mode
            document.getElementById('editMode').value = 'true';
            document.getElementById('originalName').value = name;
            document.getElementById('modalTitleCreate').style.display = 'none';
            document.getElementById('modalTitleEdit').style.display = 'block';
            document.getElementById('saveButtonCreate').style.display = 'none';
            document.getElementById('saveButtonEdit').style.display = 'inline';
            
            // Fill form
            document.getElementById('profileName').value = profile.name;
            document.getElementById('profileMount').value = profile.mount;
            document.getElementById('profileFormat').value = profile.format;
            document.getElementById('profileBitrate').value = profile.bitrate;
            document.getElementById('profileChannels').value = profile.channels;
            document.getElementById('profileDescription').value = profile.description || '';
            document.getElementById('profileSampleRate').value = profile.sample_rate;
            document.getElementById('profileGenre').value = profile.genre;
            document.getElementById('profileEnabled').checked = profile.enabled;
            
            // Show modal
            $('#createProfileModal').modal('show');
        }

        async function saveProfile() {
            const editMode = document.getElementById('editMode').value === 'true';
            const originalName = document.getElementById('originalName').value;
            
            const profile = {
                name: document.getElementById('profileName').value,
                mount: document.getElementById('profileMount').value,
                format: document.getElementById('profileFormat').value,
                bitrate: parseInt(document.getElementById('profileBitrate').value),
                channels: parseInt(document.getElementById('profileChannels').value),
                sample_rate: parseInt(document.getElementById('profileSampleRate').value),
                description: document.getElementById('profileDescription').value,
                genre: document.getElementById('profileGenre').value,
                enabled: document.getElementById('profileEnabled').checked,
                public: false,
                fallback_mount: null,
                max_listeners: 100,
                burst_size: 65535
            };
            
            try {
                let response;
                if (editMode) {
                    response = await fetch(`/api/stream-profiles/${originalName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profile)
                    });
                } else {
                    response = await fetch('/api/stream-profiles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profile)
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    $('#createProfileModal').modal('hide');
                    resetForm();
                    loadProfiles();
                } else {
                    showAlert(data.error, 'danger');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showAlert('Error saving profile', 'danger');
            }
        }

        async function toggleProfile(name, enable) {
            const action = enable ? 'enable' : 'disable';
            try {
                const response = await fetch(`/api/stream-profiles/${name}/${action}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadProfiles();
                } else {
                    showAlert(data.error, 'danger');
                }
            } catch (error) {
                console.error(`Error ${action}ing profile:`, error);
                showAlert(`Error ${action}ing profile`, 'danger');
            }
        }

        async function deleteProfile(name) {
            if (!confirm(`Are you sure you want to delete the profile "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/stream-profiles/${name}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadProfiles();
                } else {
                    showAlert(data.error, 'danger');
                }
            } catch (error) {
                console.error('Error deleting profile:', error);
                showAlert('Error deleting profile', 'danger');
            }
        }

        function resetForm() {
            document.getElementById('profileForm').reset();
            document.getElementById('editMode').value = 'false';
            document.getElementById('originalName').value = '';
            document.getElementById('modalTitleCreate').style.display = 'block';
            document.getElementById('modalTitleEdit').style.display = 'none';
            document.getElementById('saveButtonCreate').style.display = 'inline';
            document.getElementById('saveButtonEdit').style.display = 'none';
            
            // Uncheck preset radio buttons
            document.querySelectorAll('input[name="preset"]').forEach(radio => {
                radio.checked = false;
            });
        }

        // Reset form when modal is closed
        $('#createProfileModal').on('hidden.bs.modal', resetForm);

        function showAlert(message, type) {
            // Simple alert for now - could be enhanced with toast notifications
            alert(message);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
