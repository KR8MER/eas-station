{% extends "base.html" %}

{% block title %}Audio Monitoring - EAS Station{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2><i class="fas fa-headphones"></i> Audio Monitoring</h2>
        <p class="text-muted">Listen to live audio from configured sources</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Note:</strong> Audio sources must be running to stream audio. Use the start button if a source is stopped.
            Streams automatically stop after ~2 minutes to prevent resource exhaustion. Click play again to resume.
        </div>
    </div>
</div>

<div id="audio-sources-container" class="row">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Loading audio sources...</p>
    </div>
</div>

<style>
.audio-source-card {
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

.audio-source-card.status-running {
    border-left-color: #28a745;
}

.audio-source-card.status-stopped {
    border-left-color: #6c757d;
}

.audio-source-card.status-error {
    border-left-color: #dc3545;
}

.audio-source-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.audio-player-container {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.audio-player-container audio {
    width: 100%;
    height: 54px;
}

.waveform-container {
    background: #000;
    border-radius: 4px;
    padding: 0.5rem;
    margin-bottom: 1rem;
    height: 120px;
}

.waveform-canvas {
    width: 100%;
    height: 100%;
}

.status-badge {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
    margin-top: 1rem;
}

.metric-item {
    background: #e9ecef;
    padding: 0.75rem;
    border-radius: 6px;
    text-align: center;
}

.metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #212529;
}

.level-meter {
    height: 20px;
    background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
    border-radius: 10px;
    position: relative;
    overflow: hidden;
}

.level-indicator {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #000;
    transform: translateX(-50%);
}
</style>

<script>
let audioSources = [];
let waveformIntervals = {};

// Fetch audio sources from API
async function loadAudioSources() {
    try {
        const response = await fetch('/api/audio/sources');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        audioSources = data.sources || [];
        renderAudioSources();

        // Start waveform updates for running sources
        audioSources.forEach(source => {
            if (source.status === 'running') {
                startWaveformUpdate(source.name);
            }
        });
    } catch (error) {
        console.error('Failed to load audio sources:', error);
        document.getElementById('audio-sources-container').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <strong>Error loading audio sources:</strong> ${error.message}
                </div>
            </div>
        `;
    }
}

function renderAudioSources() {
    const container = document.getElementById('audio-sources-container');

    if (audioSources.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No audio sources configured. Please configure audio sources in the Audio Settings page.
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = audioSources.map(source => `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card audio-source-card status-${source.status}">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-${getSourceIcon(source.type)}"></i>
                            ${escapeHtml(source.name)}
                        </h5>
                        <span class="badge status-badge bg-${getStatusColor(source.status)}">
                            ${source.status.toUpperCase()}
                        </span>
                    </div>
                    <small class="text-muted">${escapeHtml(source.type.toUpperCase())} Source</small>
                </div>
                <div class="card-body">
                    ${source.description ? `<p class="text-muted">${escapeHtml(source.description)}</p>` : ''}

                    <!-- Waveform visualization -->
                    <div class="waveform-container" id="waveform-${source.name}" style="display: ${source.status === 'running' ? 'block' : 'none'};">
                        <canvas class="waveform-canvas" id="canvas-${source.name}" width="800" height="100"></canvas>
                    </div>

                    <!-- Audio Player -->
                    <div class="audio-player-container" id="player-container-${source.name}">
                        ${source.status === 'running' ? `
                            <audio controls id="audio-${source.name}">
                                <source src="/api/audio/stream/${encodeURIComponent(source.name)}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                        ` : `
                            <div class="alert alert-secondary mb-0">
                                <i class="fas fa-pause-circle"></i>
                                Audio source is ${source.status}. ${source.error_message ? `Error: ${escapeHtml(source.error_message)}` : 'Start the source to listen.'}
                            </div>
                        `}
                    </div>

                    <!-- Metrics -->
                    ${source.status === 'running' && source.metrics ? `
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Peak</div>
                                <div class="metric-value">${source.metrics.peak_level_db.toFixed(1)} dB</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">RMS</div>
                                <div class="metric-value">${source.metrics.rms_level_db.toFixed(1)} dB</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Sample Rate</div>
                                <div class="metric-value">${(source.metrics.sample_rate / 1000).toFixed(1)} kHz</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Channels</div>
                                <div class="metric-value">${source.metrics.channels}</div>
                            </div>
                        </div>

                        <!-- Stream Metadata (if available) -->
                        ${source.metrics.metadata ? `
                            <div class="mt-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-info-circle"></i> Stream Information</h6>
                                <div class="small">
                                    ${source.metrics.metadata.codec ? `
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">Codec:</span>
                                            <span class="fw-bold text-uppercase">
                                                ${escapeHtml(source.metrics.metadata.codec)}
                                                ${source.metrics.metadata.codec_version ? `
                                                    <span class="badge bg-secondary text-white small ms-1">${escapeHtml(source.metrics.metadata.codec_version)}</span>
                                                ` : ''}
                                            </span>
                                        </div>
                                    ` : ''}
                                    ${source.metrics.metadata.bitrate_kbps ? `
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">Bitrate:</span>
                                            <span class="fw-bold">
                                                ${source.metrics.metadata.bitrate_kbps} kbps
                                                ${source.metrics.metadata.is_vbr ? `
                                                    <span class="badge bg-info text-white small ms-1">VBR</span>
                                                ` : ''}
                                            </span>
                                        </div>
                                    ` : ''}
                                    ${source.metrics.metadata.icy_name ? `
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">Station:</span>
                                            <span class="fw-bold">${escapeHtml(source.metrics.metadata.icy_name)}</span>
                                        </div>
                                    ` : ''}
                                    ${source.metrics.metadata.icy_genre ? `
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">Genre:</span>
                                            <span>${escapeHtml(source.metrics.metadata.icy_genre)}</span>
                                        </div>
                                    ` : ''}
                                    ${source.metrics.metadata.stream_url ? `
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">URL:</span>
                                            <span class="font-monospace small text-break">${escapeHtml(source.metrics.metadata.stream_url)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}

                    <!-- Control Buttons -->
                    <div class="mt-3 d-flex gap-2">
                        ${source.status !== 'running' ? `
                            <button class="btn btn-success btn-sm" onclick="startSource('${source.name}')">
                                <i class="fas fa-play"></i> Start
                            </button>
                        ` : `
                            <button class="btn btn-danger btn-sm" onclick="stopSource('${source.name}')">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        `}
                        <button class="btn btn-outline-primary btn-sm" onclick="loadAudioSources()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getSourceIcon(type) {
    const icons = {
        'sdr': 'satellite-dish',
        'alsa': 'volume-up',
        'pulse': 'volume-up',
        'file': 'file-audio',
        'stream': 'broadcast-tower'
    };
    return icons[type] || 'question';
}

function getStatusColor(status) {
    const colors = {
        'running': 'success',
        'stopped': 'secondary',
        'starting': 'warning',
        'error': 'danger',
        'disconnected': 'warning'
    };
    return colors[status] || 'secondary';
}

function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

async function startSource(sourceName) {
    try {
        const response = await fetch(`/api/audio/sources/${encodeURIComponent(sourceName)}/start`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            alert(`Failed to start source: ${error.error || 'Unknown error'}`);
            return;
        }

        // Reload sources after a brief delay
        setTimeout(loadAudioSources, 1000);
    } catch (error) {
        console.error('Error starting source:', error);
        alert(`Error starting source: ${error.message}`);
    }
}

async function stopSource(sourceName) {
    try {
        const response = await fetch(`/api/audio/sources/${encodeURIComponent(sourceName)}/stop`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            alert(`Failed to stop source: ${error.error || 'Unknown error'}`);
            return;
        }

        // Stop waveform updates
        stopWaveformUpdate(sourceName);

        // Reload sources
        loadAudioSources();
    } catch (error) {
        console.error('Error stopping source:', error);
        alert(`Error stopping source: ${error.message}`);
    }
}

function startWaveformUpdate(sourceName) {
    // Clear any existing interval
    stopWaveformUpdate(sourceName);

    // Update waveform every 100ms
    waveformIntervals[sourceName] = setInterval(() => updateWaveform(sourceName), 100);
}

function stopWaveformUpdate(sourceName) {
    if (waveformIntervals[sourceName]) {
        clearInterval(waveformIntervals[sourceName]);
        delete waveformIntervals[sourceName];
    }
}

async function updateWaveform(sourceName) {
    try {
        const response = await fetch(`/api/audio/waveform/${encodeURIComponent(sourceName)}`);
        if (!response.ok) return;

        const data = await response.json();
        const canvas = document.getElementById(`canvas-${sourceName}`);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Clear canvas
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        // Draw waveform
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 1;
        ctx.beginPath();

        const waveform = data.waveform || [];
        const step = width / waveform.length;

        for (let i = 0; i < waveform.length; i++) {
            const x = i * step;
            const y = (waveform[i] + 1) * height / 2; // Convert from [-1, 1] to canvas coords

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }

        ctx.stroke();

        // Draw center line
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
        ctx.lineTo(width, height / 2);
        ctx.stroke();

    } catch (error) {
        console.error(`Error updating waveform for ${sourceName}:`, error);
    }
}

// Load sources on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAudioSources();

    // Auto-refresh every 5 seconds
    setInterval(loadAudioSources, 5000);
});

// Clean up intervals when page unloads
window.addEventListener('beforeunload', function() {
    Object.keys(waveformIntervals).forEach(sourceName => {
        stopWaveformUpdate(sourceName);
    });
});
</script>
{% endblock %}
