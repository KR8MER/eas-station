<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}EAS Station - Emergency Alert System{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/eas-station-logo.svg') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/eas-station-logo.svg') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/eas-station-logo.svg') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='img/eas-station-logo.svg') }}" color="#204885">
    <meta name="theme-color" content="#204885">

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EAS Station Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive-enhancements.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading-states.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/error-handling.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}">

    <script>
        window.CSRF_TOKEN = {{ csrf_token | tojson }};
        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                init = init || {};
                const method = (init.method || 'GET').toUpperCase();
                if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                    const headers = new Headers(init.headers || {});
                    if (window.CSRF_TOKEN && !headers.has('X-CSRF-Token')) {
                        headers.set('X-CSRF-Token', window.CSRF_TOKEN);
                    }
                    init.headers = headers;
                }
                return originalFetch.call(this, input, init);
            };
        })();
    </script>

    {% if location_settings %}
    <script>
        window.APP_LOCATION = {{ location_settings | tojson }};
    </script>
    {% endif %}

    {% if boundary_type_config %}
    <script>
        window.BOUNDARY_TYPE_CONFIG = {{ boundary_type_config | tojson }};
        window.BOUNDARY_GROUP_LABELS = {{ boundary_group_labels | tojson }};
    </script>
    {% endif %}


    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
        <div class="container-fluid">
            <div class="navbar-brand-group">
                <a class="navbar-brand" href="/">
                    <img src="{{ url_for('static', filename='img/eas-station-logo.svg') }}" alt="EAS Station" class="brand-logo" width="42" height="42" loading="lazy">
                    <span class="brand-text">
                        <span class="brand-title">EAS Station</span>
                        <span class="brand-subtitle">Emergency Alert Platform</span>
                    </span>
                </a>

                <div class="health-indicator status-healthy" id="system-health-indicator" role="status" aria-live="polite" title="System OK">
                    <span class="health-label">Status</span>
                    <span class="health-dot health-good" id="system-health-dot"></span>
                    <span class="health-text" id="system-health-text">System OK</span>
                </div>
            </div>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-sections">
                    <!-- Primary Navigation -->
                    <ul class="navbar-nav primary-nav">
                        <!-- Dashboard -->
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-gauge-high"></i>
                                <span class="d-none d-md-inline">Dashboard</span>
                                <span class="d-md-none">Home</span>
                            </a>
                        </li>

                        <!-- Monitoring -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="monitoringDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-radar"></i>
                                <span class="d-none d-md-inline">Monitoring</span>
                                <span class="d-md-none">Monitor</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="monitoringDropdown">
                                <li>
                                    <a class="dropdown-item" href="/alerts">
                                        <i class="fas fa-bell"></i> Active Alerts
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/alerts">
                                        <i class="fas fa-history"></i> Alert History
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('audio_history') }}">
                                        <i class="fas fa-headphones"></i> Audio Archive
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <!-- Operations -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="operationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-tower-broadcast"></i>
                                <span class="d-none d-md-inline">Operations</span>
                                <span class="d-md-none">Ops</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="operationsDropdown">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('eas.workflow_home') }}" {% if current_user is not defined or not current_user.is_authenticated %}title="Sign in required to access the manual EAS workflow."{% endif %}>
                                        <i class="fas fa-broadcast-tower"></i> EAS Workflow
                                        {% if current_user is not defined or not current_user.is_authenticated %}
                                        <i class="fas fa-lock small ms-1 text-warning"></i>
                                        {% endif %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('led_control') }}">
                                        <i class="fas fa-tv"></i> LED Control
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('vfd_control') }}">
                                        <i class="fas fa-desktop"></i> VFD Display
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('radio_settings') }}">
                                        <i class="fas fa-signal"></i> Radio Settings
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('audio_sources_page') }}">
                                        <i class="fas fa-microphone"></i> Audio Sources
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('alert_verification') }}" {% if current_user is not defined or not current_user.is_authenticated %}title="Sign in required to access alert validation tools."{% endif %}>
                                        <i class="fas fa-shield-check"></i> Alert Validation
                                        {% if current_user is not defined or not current_user.is_authenticated %}
                                        <i class="fas fa-lock small ms-1 text-warning"></i>
                                        {% endif %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('compliance_dashboard') }}" {% if current_user is not defined or not current_user.is_authenticated %}title="Sign in required to review compliance dashboards."{% endif %}>
                                        <i class="fas fa-clipboard-check"></i> Compliance
                                        {% if current_user is not defined or not current_user.is_authenticated %}
                                        <i class="fas fa-lock small ms-1 text-warning"></i>
                                        {% endif %}
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <!-- Analytics -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="analyticsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-chart-line"></i>
                                <span class="d-none d-md-inline">Analytics</span>
                                <span class="d-md-none">Stats</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="analyticsDropdown">
                                <li>
                                    <a class="dropdown-item" href="/stats">
                                        <i class="fas fa-chart-bar"></i> Statistics
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/health">
                                        <i class="fas fa-heartbeat"></i> System Health
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="/export/alerts">
                                        <i class="fas fa-download"></i> Export Alerts
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/export/boundaries">
                                        <i class="fas fa-download"></i> Export Boundaries
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/export/statistics">
                                        <i class="fas fa-download"></i> Export Statistics
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <!-- Settings -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i>
                                <span class="d-none d-md-inline">Settings</span>
                                <span class="d-md-none">Config</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="settingsDropdown">
                                <li>
                                    <a class="dropdown-item" href="/admin">
                                        <i class="fas fa-sliders"></i> Configuration
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/settings/environment">
                                        <i class="fas fa-cog"></i> Environment Settings
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="/debug/ipaws">
                                        <i class="fas fa-satellite"></i> IPAWS Debug
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/version">
                                        <i class="fas fa-info-circle"></i> Version Info
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('docs_index') }}">
                                        <i class="fas fa-book"></i> Documentation
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('about_page') }}">
                                        <i class="fas fa-circle-info"></i> About
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('help_page') }}">
                                        <i class="fas fa-circle-question"></i> Help
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>

                    <!-- Utility Navigation -->
                    <ul class="navbar-nav utility-nav">
                        {% if current_user is defined and current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-shield"></i>
                                <span>{{ current_user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('logout') }}">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Login</span>
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item theme-toggle-nav-item">
                            <button class="theme-toggle-button" type="button" onclick="toggleTheme()" aria-label="Toggle dark or light mode">
                                <i id="theme-icon" class="fas fa-moon" aria-hidden="true"></i>
                                <span class="visually-hidden">Toggle theme</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="system-status-banner" class="system-status-banner alert alert-warning d-none" role="alert" aria-live="polite">
        <div class="banner-content">
            <i class="fas fa-triangle-exclamation banner-icon"></i>
            <div class="banner-message">
                <span class="banner-title" id="system-status-banner-title">System Warning</span>
                <span class="banner-text" id="system-status-banner-text">System status updates will appear here.</span>
            </div>
        </div>
        <button type="button" class="btn-close" id="system-status-banner-close" aria-label="Dismiss system status alert"></button>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="container-fluid mt-3">
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="footer-content d-flex flex-column flex-lg-row align-items-center justify-content-between text-center text-lg-start">
                <div class="footer-meta">
                    <div class="footer-brand">
                        <i class="fas fa-broadcast-tower me-2"></i>© 2025 Timothy Kramer (KR8MER)
                    </div>
                    <div class="footer-subtext">
                        <i class="fas fa-shield-alt me-2"></i>EAS Station · Emergency Alert System Research Platform
                    </div>
                </div>
                <div class="footer-clock d-flex align-items-center justify-content-center">
                    <i class="fas fa-clock me-2"></i>
                    <span id="current-time">Loading...</span>
                </div>
                <div class="footer-version text-uppercase fw-semibold">
                    Version {{ system_version }}
                </div>
            </div>
            <div class="footer-links">
                <a href="{{ url_for('terms_page') }}"><i class="fas fa-file-contract me-1"></i>Terms of Use</a>
                <span class="text-muted">•</span>
                <a href="{{ url_for('privacy_page') }}"><i class="fas fa-user-lock me-1"></i>Privacy Policy</a>
                <span class="text-muted">•</span>
                <a href="{{ url_for('help_page') }}"><i class="fas fa-life-ring me-1"></i>Help Center</a>
            </div>
            <p class="footer-disclaimer mb-0">
                Experimental development project cross-checked with tools like multimon-ng. Not FCC-certified equipment, not for
                production deployments, and never for life-or-death decision making.
            </p>
        </div>
    </footer>

    <!-- SCRIPTS - Load order is important! -->
    <!-- 1. Bootstrap first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <!-- 2. EAS Station Core JavaScript Modules -->
    <script src="{{ url_for('static', filename='js/core/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/health.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loading-error-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/accessibility-utils.js') }}"></script>

    <!-- 3. Page-specific scripts -->
    {% block scripts %}{% endblock %}
</body>
</html>
