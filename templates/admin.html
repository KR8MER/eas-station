{% extends "base.html" %}

{% block title %}Administration Panel - KR8MER CAP{% endblock %}

{% block extra_css %}
<style>
    .admin-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #6f42c1 100%);
        color: white;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px var(--shadow-color);
    }

    .admin-card {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 20px var(--shadow-color);
        margin-bottom: 30px;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .admin-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px var(--shadow-color);
    }

    .admin-card-header {
        background: linear-gradient(135deg, var(--light-color) 0%, var(--border-color) 100%);
        color: var(--text-color);
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
    }

    .admin-card-body {
        padding: 25px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
    }

    .form-select, .form-control {
        background-color: var(--bg-color);
        border: 2px solid var(--border-color);
        color: var(--text-color);
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .btn {
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, #4dabf7 100%);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color) 0%, #51cf66 100%);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b6b 100%);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }

    .btn-outline-secondary {
        border: 2px solid var(--border-color);
        color: var(--text-color);
        background: transparent;
    }

    .btn-outline-secondary:hover {
        background: var(--border-color);
        color: var(--text-color);
        transform: translateY(-2px);
    }

    .nav-pills {
        background: var(--light-color);
        border-radius: 12px;
        padding: 8px;
        margin-bottom: 25px;
    }

    .nav-pills .nav-link {
        border-radius: 8px;
        color: var(--text-color);
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 0 4px;
    }

    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, var(--primary-color) 0%, #4dabf7 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .nav-pills .nav-link:hover:not(.active) {
        background: var(--border-color);
        transform: translateY(-1px);
    }

    .status-message {
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        font-weight: 500;
        display: none;
        animation: slideIn 0.3s ease;
    }

    .status-message.success {
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid var(--success-color);
        color: var(--success-color);
    }

    .status-message.error {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid var(--danger-color);
        color: var(--danger-color);
    }

    .status-message.info {
        background: rgba(23, 162, 184, 0.1);
        border: 1px solid var(--info-color);
        color: var(--info-color);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, #6f42c1 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 20px var(--shadow-color);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px var(--shadow-color);
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .stat-label {
        font-size: 1.1em;
        opacity: 0.9;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .operations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .operation-card {
        background: var(--bg-color);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .operation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--info-color));
    }

    .operation-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px var(--shadow-color);
        border-color: var(--primary-color);
    }

    .operation-icon {
        font-size: 3em;
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    .operation-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-color);
    }

    .operation-description {
        color: var(--secondary-color);
        margin-bottom: 20px;
        font-size: 0.9em;
    }

    .boundary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .boundary-item {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .boundary-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 20px var(--shadow-color);
    }

    .boundary-item h4 {
        color: var(--primary-color);
        margin-bottom: 15px;
        font-weight: 600;
    }

    .boundary-entry {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: var(--light-color);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .boundary-entry:hover {
        background: var(--border-color);
    }

    .boundary-name {
        flex-grow: 1;
        font-weight: 500;
        color: var(--text-color);
    }

    .delete-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 0.8em;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background: #c82333;
        transform: scale(1.05);
    }

    .loading-indicator {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: var(--text-color);
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .breadcrumb {
        background: var(--light-color);
        border-radius: 8px;
        padding: 12px 20px;
    }

    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .breadcrumb-item.active {
        color: var(--text-color);
    }

    /* Dark mode specific adjustments */
    [data-theme="dark"] .form-select option {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .operations-grid {
            grid-template-columns: 1fr;
        }

        .boundary-list {
            grid-template-columns: 1fr;
        }

        .admin-card-body {
            padding: 20px;
        }
    }

    /* Preview results styling */
    .preview-result {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: var(--light-color);
    }

    .preview-result h6 {
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .field-mapping {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px;
        margin: 10px 0;
    }

    .alert-enhancement {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        color: #2d3436;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="admin-header">
        <div class="p-4">
            <h1 class="h2 mb-3">
                <i class="fas fa-cog"></i> Administration Panel
            </h1>
            <p class="mb-0 opacity-75">Manage boundaries, configure system settings, and monitor operations</p>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Administration</li>
        </ol>
    </nav>

    <!-- Quick Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link active" href="#upload" onclick="showSection('upload')">
                        <i class="fas fa-upload"></i> Upload Boundaries
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#preview" onclick="showSection('preview')">
                        <i class="fas fa-eye"></i> Preview Data
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#manage" onclick="showSection('manage')">
                        <i class="fas fa-list"></i> Manage Boundaries
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#operations" onclick="showSection('operations')">
                        <i class="fas fa-tools"></i> Operations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#stats" onclick="showSection('stats')">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#health" onclick="showSection('health')">
                        <i class="fas fa-heartbeat"></i> Health
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-section" class="admin-section">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-upload"></i> Upload Boundary Files</h3>
            </div>
            <div class="admin-card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="boundaryType" class="form-label">Boundary Type</label>
                                <select id="boundaryType" name="boundary_type" class="form-select" required>
                                    <option value="">Select boundary type...</option>
                                    <option value="electric">⚡ Electric Providers</option>
                                    <option value="villages">🏘️ Villages</option>
                                    <option value="school">🏫 School Districts</option>
                                    <option value="fire">🔥 Fire Districts</option>
                                    <option value="ems">🚑 EMS Districts</option>
                                    <option value="township">🏘️ Townships</option>
                                    <option value="telephone">📞 Telephone Providers</option>
                                    <option value="county">🗺️ County Outlines</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="geoJsonFile" class="form-label">GeoJSON File</label>
                                <input type="file" id="geoJsonFile" name="file" class="form-control" accept=".geojson,.json" required>
                                <small class="form-text text-muted">Upload a GeoJSON file containing boundary polygons</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Boundaries
                        </button>
                    </div>
                </form>
                <div id="uploadStatus" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="preview-section" class="admin-section" style="display: none;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-eye"></i> Preview Data Extraction</h3>
            </div>
            <div class="admin-card-body">
                <div class="alert-enhancement">
                    <i class="fas fa-lightbulb"></i> <strong>Smart Preview:</strong>
                    This feature analyzes your GeoJSON file and shows exactly what will be extracted before uploading.
                </div>
                <form id="previewForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="previewBoundaryType" class="form-label">Boundary Type</label>
                                <select id="previewBoundaryType" name="boundary_type" class="form-select" required>
                                    <option value="">Select boundary type...</option>
                                    <option value="electric">⚡ Electric Providers</option>
                                    <option value="villages">🏘️ Villages</option>
                                    <option value="school">🏫 School Districts</option>
                                    <option value="fire">🔥 Fire Districts</option>
                                    <option value="ems">🚑 EMS Districts</option>
                                    <option value="township">🏘️ Townships</option>
                                    <option value="telephone">📞 Telephone Providers</option>
                                    <option value="county">🗺️ County Outlines</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="previewFile" class="form-label">GeoJSON File</label>
                                <input type="file" id="previewFile" name="file" class="form-control" accept=".geojson,.json" required>
                                <small class="form-text text-muted">Preview what will be extracted before uploading</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="button" onclick="previewExtraction()" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Preview Extraction
                        </button>
                    </div>
                </form>
                <div id="previewResults" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Manage Section -->
    <div id="manage-section" class="admin-section" style="display: none;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-list"></i> Manage Boundaries</h3>
            </div>
            <div class="admin-card-body">
                <!-- Delete Controls -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <label for="deleteType" class="form-label">Delete by Type</label>
                        <select id="deleteType" class="form-select">
                            <option value="">Select boundary type to delete...</option>
                            <option value="electric">⚡ Electric Providers</option>
                            <option value="villages">🏘️ Villages</option>
                            <option value="school">🏫 School Districts</option>
                            <option value="fire">🔥 Fire Districts</option>
                            <option value="ems">🚑 EMS Districts</option>
                            <option value="township">🏘️ Townships</option>
                            <option value="telephone">📞 Telephone Providers</option>
                            <option value="county">🗺️ County Outlines</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button onclick="deleteBoundariesByType()" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Delete Type
                            </button>
                            <button onclick="clearAllBoundaries()" class="btn btn-danger">
                                <i class="fas fa-exclamation-triangle"></i> Clear ALL
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Boundaries List -->
                <div id="boundariesList">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        Loading boundaries...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Section -->
    <div id="operations-section" class="admin-section" style="display: none;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-tools"></i> Manual Operations</h3>
            </div>
            <div class="admin-card-body">
                <div class="operations-grid">
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-satellite-dish"></i>
                        </div>
                        <div class="operation-title">Trigger CAP Poll</div>
                        <div class="operation-description">Manually fetch latest CAP alerts from NOAA</div>
                        <button onclick="triggerCAPPoll()" class="btn btn-success">
                            <i class="fas fa-download"></i> Poll Now
                        </button>
                    </div>

                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        <div class="operation-title">Clear Expired Alerts</div>
                        <div class="operation-description">Remove all expired alerts from database</div>
                        <button onclick="clearExpiredAlerts()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Clear Expired
                        </button>
                    </div>

                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="operation-title">Optimize Database</div>
                        <div class="operation-description">Run database maintenance tasks (VACUUM ANALYZE)</div>
                        <button onclick="optimizeDatabase()" class="btn btn-primary">
                            <i class="fas fa-wrench"></i> Optimize
                        </button>
                    </div>

                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="operation-title">Recalculate Intersections</div>
                        <div class="operation-description">Fix alert-boundary intersections</div>
                        <button onclick="recalculateIntersections()" class="btn btn-warning">
                            <i class="fas fa-calculator"></i> Recalculate
                        </button>
                    </div>

                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="operation-title">Fix County Intersections</div>
                        <div class="operation-description">Fix county-wide alert intersections</div>
                        <button onclick="fixCountyIntersections()" class="btn btn-info">
                            <i class="fas fa-map"></i> Fix County
                        </button>
                    </div>

                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="operation-title">Database Health Check</div>
                        <div class="operation-description">Check database tables and vacuum status</div>
                        <button onclick="checkDatabaseHealth()" class="btn btn-secondary">
                            <i class="fas fa-heartbeat"></i> Check Health
                        </button>
                    </div>
                </div>
                <div id="operationStatus" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div id="stats-section" class="admin-section" style="display: none;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-chart-bar"></i> System Statistics</h3>
            </div>
            <div class="admin-card-body">
                <div id="systemStats">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        Loading statistics...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Section -->
    <div id="health-section" class="admin-section" style="display: none;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h3><i class="fas fa-heartbeat"></i> System Health Monitor</h3>
            </div>
            <div class="admin-card-body">
                <div class="text-center mb-3">
                    <a href="/system_health" class="btn btn-primary" target="_blank">
                        <i class="fas fa-external-link-alt"></i> Open Full Health Monitor
                    </a>
                </div>
                <div id="healthSummary">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        Loading health data...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Section navigation
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(section => {
        section.style.display = 'none';
    });

    // Remove active class from all nav links
    document.querySelectorAll('.nav-pills .nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // Show selected section
    document.getElementById(sectionName + '-section').style.display = 'block';

    // Add active class to clicked nav link
    event.target.closest('.nav-link').classList.add('active');

    // Load data if needed
    if (sectionName === 'manage') {
        loadBoundaries();
    } else if (sectionName === 'stats') {
        loadSystemStats();
    } else if (sectionName === 'health') {
        loadHealthSummary();
    }
}

// Load system statistics
async function loadSystemStats() {
    try {
        const response = await fetch('/api/system_status');
        const data = await response.json();

        const statsHtml = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">${data.active_alerts_count || 0}</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.boundaries_count || 0}</div>
                    <div class="stat-label">Total Boundaries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.system_resources?.cpu_usage_percent?.toFixed(1) || 0}%</div>
                    <div class="stat-label">CPU Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.system_resources?.memory_usage_percent?.toFixed(1) || 0}%</div>
                    <div class="stat-label">Memory Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.system_resources?.disk_free_gb || 0} GB</div>
                    <div class="stat-label">Free Disk</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.database_status === 'connected' ? '✅' : '❌'}</div>
                    <div class="stat-label">Database Status</div>
                </div>
            </div>
        `;
        document.getElementById('systemStats').innerHTML = statsHtml;
    } catch (error) {
        document.getElementById('systemStats').innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Error loading statistics</h5>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Load health summary
async function loadHealthSummary() {
    try {
        const response = await fetch('/api/system_health');
        const data = await response.json();

        const cpu = data.cpu?.cpu_usage_percent || 0;
        const memory = data.memory?.percentage || 0;
        const disk = data.disk?.[0]?.percentage || 0;

        let healthStatus = 'good';
        if (cpu > 80 || memory > 90 || disk > 90) {
            healthStatus = 'critical';
        } else if (cpu > 60 || memory > 75 || disk > 75) {
            healthStatus = 'warning';
        }

        const statusColors = {
            good: '#28a745',
            warning: '#ffc107',
            critical: '#dc3545'
        };

        const healthHtml = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 style="color: ${statusColors[healthStatus]}">
                                <i class="fas fa-heartbeat"></i> System Status: ${healthStatus.toUpperCase()}
                            </h5>
                            <div class="row mt-3">
                                <div class="col-4">
                                    <strong>CPU</strong><br>
                                    <span style="color: ${cpu > 80 ? '#dc3545' : cpu > 60 ? '#ffc107' : '#28a745'}">${cpu.toFixed(1)}%</span>
                                </div>
                                <div class="col-4">
                                    <strong>Memory</strong><br>
                                    <span style="color: ${memory > 90 ? '#dc3545' : memory > 75 ? '#ffc107' : '#28a745'}">${memory.toFixed(1)}%</span>
                                </div>
                                <div class="col-4">
                                    <strong>Disk</strong><br>
                                    <span style="color: ${disk > 90 ? '#dc3545' : disk > 75 ? '#ffc107' : '#28a745'}">${disk.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-info-circle"></i> System Info</h6>
                            <p><strong>Hostname:</strong> ${data.system?.hostname || 'Unknown'}</p>
                            <p><strong>OS:</strong> ${data.system?.system || 'Unknown'} ${data.system?.release || ''}</p>
                            <p><strong>Database:</strong> ${data.database?.status || 'Unknown'}</p>
                            <p><strong>Uptime:</strong> ${formatUptime(data.system?.uptime_seconds || 0)}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('healthSummary').innerHTML = healthHtml;
    } catch (error) {
        document.getElementById('healthSummary').innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Error loading health data: ${error.message}</p>
            </div>
        `;
    }
}

// Load boundaries list
async function loadBoundaries() {
    try {
        const response = await fetch('/api/boundaries');
        const data = await response.json();

        if (data.features && data.features.length > 0) {
            const boundariesByType = {};
            data.features.forEach(feature => {
                const type = feature.properties.type;
                if (!boundariesByType[type]) {
                    boundariesByType[type] = [];
                }
                boundariesByType[type].push(feature.properties);
            });

            let html = '<div class="boundary-list">';
            for (const [type, boundaries] of Object.entries(boundariesByType)) {
                const typeIcons = {
                    electric: '⚡',
                    villages: '🏘️',
                    school: '🏫',
                    fire: '🔥',
                    ems: '🚑',
                    township: '🏘️',
                    telephone: '📞',
                    county: '🗺️'
                };

                html += `
                    <div class="boundary-item">
                        <h4>${typeIcons[type] || '📍'} ${type.charAt(0).toUpperCase() + type.slice(1)} (${boundaries.length})</h4>
                `;

                boundaries.forEach(boundary => {
                    html += `
                        <div class="boundary-entry">
                            <span class="boundary-name">${boundary.name}</span>
                            <button onclick="deleteBoundary(${boundary.id}, '${boundary.name.replace(/'/g, "\\'")}')"
                                    class="delete-btn" title="Delete boundary">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('boundariesList').innerHTML = html;
        } else {
            document.getElementById('boundariesList').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-map fa-3x mb-3"></i>
                    <h5>No boundaries found</h5>
                    <p>Use the upload form to add boundary files.</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('boundariesList').innerHTML = `
            <div class="text-center text-danger py-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Error loading boundaries</h5>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Preview extraction functionality
async function previewExtraction() {
    const form = document.getElementById('previewForm');
    const formData = new FormData(form);
    const resultsDiv = document.getElementById('previewResults');

    showStatus(resultsDiv, 'Analyzing file...', 'info');

    try {
        const response = await fetch('/admin/preview_geojson', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            let html = `
                <div class="preview-result">
                    <h6><i class="fas fa-info-circle"></i> Preview Results</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Features:</strong> ${result.total_features}</p>
                            <p><strong>Boundary Type:</strong> ${result.boundary_type}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Available Fields:</strong> ${result.all_fields.join(', ')}</p>
                            <p><strong>Sample Count:</strong> ${result.preview_count}</p>
                        </div>
                    </div>
                    <h6 class="mt-3">Sample Extractions:</h6>
            `;

            result.previews.forEach((preview, index) => {
                html += `
                    <div class="field-mapping">
                        <strong>Feature ${index + 1}:</strong><br>
                        <strong>Name:</strong> ${preview.name}<br>
                        <strong>Description:</strong> ${preview.description || 'No description'}
                    </div>
                `;
            });

            if (result.field_mappings && Object.keys(result.field_mappings).length > 0) {
                html += `
                    <h6 class="mt-3">Field Mappings for ${result.boundary_type}:</h6>
                    <p><strong>Name Fields:</strong> ${result.field_mappings.name_fields ? result.field_mappings.name_fields.join(', ') : 'None configured'}</p>
                    <p><strong>Description Fields:</strong> ${result.field_mappings.description_fields ? result.field_mappings.description_fields.join(', ') : 'None configured'}</p>
                `;
            }

            html += '</div>';
            showStatus(resultsDiv, html, 'success');
        } else {
            showStatus(resultsDiv, result.error || 'Preview failed', 'error');
        }
    } catch (error) {
        showStatus(resultsDiv, 'Error: ' + error.message, 'error');
    }
}

// Delete individual boundary
async function deleteBoundary(boundaryId, boundaryName) {
    if (!confirm(`Are you sure you want to delete boundary "${boundaryName}"?`)) return;

    try {
        const response = await fetch(`/admin/delete_boundary/${boundaryId}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok) {
            showToast(result.success || 'Boundary deleted successfully', 'success');
            loadBoundaries();
            loadSystemStats();
        } else {
            showToast(result.error || 'Failed to delete boundary', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Delete boundaries by type
async function deleteBoundariesByType() {
    const boundaryType = document.getElementById('deleteType').value;
    if (!boundaryType) {
        showToast('Please select a boundary type to delete', 'error');
        return;
    }

    if (!confirm(`Are you sure you want to delete ALL ${boundaryType} boundaries? This cannot be undone!`)) return;

    try {
        const response = await fetch('/admin/delete_boundaries_by_type', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ boundary_type: boundaryType })
        });
        const result = await response.json();

        if (response.ok) {
            showToast(result.success || result.message, 'success');
            loadBoundaries();
            loadSystemStats();
            document.getElementById('deleteType').value = '';
        } else {
            showToast(result.error || 'Failed to delete boundaries', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Clear all boundaries
async function clearAllBoundaries() {
    if (!confirm('⚠️ WARNING: This will delete ALL boundaries from the system! This cannot be undone! Are you absolutely sure?')) return;
    if (!confirm('⚠️ FINAL WARNING: This will permanently remove ALL boundary data. Continue?')) return;

    try {
        const response = await fetch('/admin/clear_all_boundaries', { method: 'DELETE' });
        const result = await response.json();

        if (response.ok) {
            showToast(result.success || result.message, 'success');
            loadBoundaries();
            loadSystemStats();
        } else {
            showToast(result.error || 'Failed to clear boundaries', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Handle file upload
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const statusDiv = document.getElementById('uploadStatus');

    showStatus(statusDiv, '⏳ Uploading and processing...', 'info');

    try {
        const response = await fetch('/admin/upload_boundary', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            showStatus(statusDiv, '✅ ' + (result.success || 'Upload successful!'), 'success');
            this.reset();
            loadBoundaries();
            loadSystemStats();
        } else {
            showStatus(statusDiv, '❌ ' + (result.error || 'Upload failed'), 'error');
        }
    } catch (error) {
        showStatus(statusDiv, '❌ Error: ' + error.message, 'error');
    }
});

// Manual operations
async function triggerCAPPoll() {
    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '📡 Triggering CAP poll...', 'info');

    try {
        const response = await fetch('/admin/trigger_poll', { method: 'POST' });
        const result = await response.json();

        const message = (response.ok ? '✅ ' : '❌ ') + (result.message || result.error);
        showStatus(operationStatus, message, response.ok ? 'success' : 'error');

        if (response.ok) {
            loadSystemStats();
        }
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

async function clearExpiredAlerts() {
    if (!confirm('Are you sure you want to clear all expired alerts?')) return;

    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '🗑️ Clearing expired alerts...', 'info');

    try {
        const response = await fetch('/admin/clear_expired', { method: 'POST' });
        const result = await response.json();

        const message = (response.ok ? '✅ ' : '❌ ') + (result.message || result.error);
        showStatus(operationStatus, message, response.ok ? 'success' : 'error');

        if (response.ok) {
            loadSystemStats();
        }
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

async function optimizeDatabase() {
    if (!confirm('Run database optimization? This will run VACUUM ANALYZE to improve performance.')) return;

    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '🔧 Optimizing database (VACUUM ANALYZE)...', 'info');

    try {
        const response = await fetch('/admin/optimize_db', { method: 'POST' });
        const result = await response.json();

        const message = (response.ok ? '✅ ' : '❌ ') + (result.message || result.error);
        showStatus(operationStatus, message, response.ok ? 'success' : 'error');
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

async function recalculateIntersections() {
    if (!confirm('Recalculate all alert-boundary intersections? This may take a few minutes.')) return;

    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '🧮 Recalculating intersections...', 'info');

    try {
        const response = await fetch('/admin/recalculate_intersections', { method: 'POST' });
        const result = await response.json();

        const message = (response.ok ? '✅ ' : '❌ ') + (result.message || result.error);
        showStatus(operationStatus, message, response.ok ? 'success' : 'error');
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

async function fixCountyIntersections() {
    if (!confirm('Fix county-wide alert intersections? This will ensure county-wide alerts show all affected boundaries.')) return;

    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '🗺️ Fixing county intersections...', 'info');

    try {
        const response = await fetch('/admin/fix_county_intersections', { method: 'POST' });
        const result = await response.json();

        const message = (response.ok ? '✅ ' : '❌ ') + (result.message || result.error);
        showStatus(operationStatus, message, response.ok ? 'success' : 'error');
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

async function checkDatabaseHealth() {
    const operationStatus = document.getElementById('operationStatus');
    showStatus(operationStatus, '💓 Checking database health...', 'info');

    try {
        const response = await fetch('/admin/db_health', { method: 'GET' });
        const result = await response.json();

        if (response.ok) {
            let healthHtml = `
                <h6>Database Health Report</h6>
                <p><strong>Database Size:</strong> ${result.database_size}</p>
                <p><strong>Tables:</strong> ${result.tables.length}</p>
                <h6>Recommendations:</h6>
                <ul>
            `;

            result.recommendations.forEach(rec => {
                healthHtml += `<li>${rec}</li>`;
            });

            healthHtml += '</ul>';
            showStatus(operationStatus, healthHtml, 'success');
        } else {
            showStatus(operationStatus, '❌ ' + (result.error || 'Health check failed'), 'error');
        }
    } catch (error) {
        showStatus(operationStatus, '❌ Error: ' + error.message, 'error');
    }
}

// Utility functions
function showStatus(element, message, type) {
    element.className = `status-message ${type}`;
    element.innerHTML = message;
    element.style.display = 'block';

    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
}

function formatUptime(seconds) {
    if (!seconds) return '0s';

    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStats();

    // Refresh stats every 30 seconds
    setInterval(loadSystemStats, 30000);

    // Set up keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.altKey) {
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    showSection('upload');
                    break;
                case '2':
                    e.preventDefault();
                    showSection('preview');
                    break;
                case '3':
                    e.preventDefault();
                    showSection('manage');
                    break;
                case '4':
                    e.preventDefault();
                    showSection('operations');
                    break;
                case '5':
                    e.preventDefault();
                    showSection('stats');
                    break;
                case '6':
                    e.preventDefault();
                    showSection('health');
                    break;
            }
        }
    });
});
</script>
{% endblock %}