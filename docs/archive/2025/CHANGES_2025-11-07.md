# EAS Station Changes - November 7, 2025

## Summary
This update includes significant improvements to the user interface, logging capabilities, role management, FIPS/zone code handling, and audio monitoring. The navigation has been reorganized for better usability, a comprehensive log viewer has been added with filtering capabilities, and users can now listen to live audio from SDR and web stream sources.

---

## 1. Live Audio Monitoring (NEW!)

### Overview
Added the ability to listen to live audio from configured audio sources (SDR receivers, web streams, ALSA devices) directly through the web interface. This is invaluable for monitoring signal quality and debugging audio issues.

### Features
- **Live Audio Streaming** - Listen to audio sources in real-time via browser
- **Waveform Visualization** - Real-time oscilloscope display
- **Multiple Sources** - Support for SDR, streams, ALSA, PulseAudio, files
- **Source Control** - Start/stop sources from the monitoring page
- **Audio Metrics** - Peak/RMS levels, sample rate, channel info
- **Auto-refresh** - Updates every 5 seconds

### Changes Made

#### Backend (`webapp/admin/audio_ingest.py`)
- **Added `/api/audio/stream/<source_name>` endpoint**:
  - Streams live audio in WAV format (16-bit PCM)
  - Converts float32 audio to int16 for browser compatibility
  - Generates proper WAV headers for streaming
  - Auto-terminates after ~2 minutes to prevent resource exhaustion
  - Uses Flask's `stream_with_context()` for efficient streaming

#### Frontend (`templates/audio_monitoring.html`)
- **Complete audio monitoring UI**:
  - Card-based layout for each audio source
  - HTML5 `<audio>` players for native playback
  - Canvas-based waveform visualization (updates every 100ms)
  - Real-time metrics display (Peak, RMS, Sample Rate, Channels)
  - Color-coded status indicators
  - Start/stop controls for each source
  - Auto-refresh every 5 seconds

#### Navigation (`webapp/routes_public.py`, `components/navbar.html`)
- Added `/audio-monitor` route
- Added "Audio Monitoring" to Monitoring dropdown menu

### Technical Details
- **Stream format**: WAV (RIFF container, PCM codec)
- **Bit depth**: 16-bit
- **Sample rate**: Matches source (typically 44.1 kHz)
- **Bandwidth**: ~700 Kbps per stream
- **Latency**: ~2-5 seconds (browser buffering)
- **Max duration**: ~2 minutes per session (auto-reconnect)

### Use Cases
1. **Monitor SDR signal quality** - Verify you're receiving audio
2. **Debug audio issues** - Visual waveform helps identify problems
3. **Check web stream sources** - Verify streaming audio sources work
4. **Test before broadcasting** - Ensure audio quality before EAS activation

### Files Modified
- `/home/user/eas-station/webapp/admin/audio_ingest.py` (added streaming endpoint)
- `/home/user/eas-station/templates/audio_monitoring.html` (new file)
- `/home/user/eas-station/webapp/routes_public.py` (added route)
- `/home/user/eas-station/components/navbar.html` (added menu item)
- `/home/user/eas-station/docs/audio/AUDIO_MONITORING.md` (comprehensive documentation)

---

## 2. Frontend Log Viewer with Filtering

### Overview
Implemented a comprehensive, filterable log viewer to replace the basic system logs page. Users can now view logs from multiple sources with detailed filtering and expandable details.

### Changes Made

#### Backend (`webapp/routes_public.py`)
- **Modified `/logs` route** to support filtering by log type via query parameter `?type=`
- **Added imports** for all log models:
  - `AudioAlert`, `AudioHealthStatus`, `AudioSourceMetrics`
  - `GPIOActivationLog`
  - `PollHistory`, `PollDebugRecord`
- **Implemented 7 log type filters:**
  1. **System** - General application logs (errors, warnings, info)
  2. **Polling** - CAP alert polling history with fetch statistics
  3. **Polling Debug** - Detailed alert parsing and relevance checking
  4. **Audio Alerts** - Audio system alerts (silence, clipping, disconnections)
  5. **Audio Metrics** - Real-time audio level measurements
  6. **Audio Health** - Audio system health scores and status
  7. **GPIO** - Relay activation audit trail

#### Frontend (`templates/logs.html`)
- **Complete redesign** with modern UI:
  - Tab-based navigation for log types
  - Configurable record limit (50, 100, 250, 500)
  - Color-coded severity badges (SUCCESS, INFO, WARNING, ERROR, CRITICAL, DEBUG)
  - Expandable row details showing JSON metadata
  - Descriptive alerts explaining each log type
  - Responsive design for mobile
- **Features:**
  - Auto-refresh button
  - Collapsible detail views for metadata
  - Clean table layout with hover effects

### Technical Details
- Maximum 500 records per query to prevent performance issues
- Uses mapped column names for metadata (`source_metadata`, `health_metadata`, `alert_metadata`) to avoid conflicts with database reserved keywords
- JSON formatting in details section for easy reading

### Files Modified
- `/home/user/eas-station/webapp/routes_public.py` (lines 15-28, 536-712)
- `/home/user/eas-station/templates/logs.html` (complete rewrite)

---

## 3. Navigation Menu Reorganization

### Overview
Reorganized the navigation bar to eliminate duplication, improve grouping, and rename confusing labels. The cluttered flat menu is now organized into logical dropdown sections.

### Changes Made

#### Navigation Structure (`components/navbar.html`)
**Before:**
- Interactive Map
- Alerts History
- Statistics
- **EAS Workflow** (duplicate #1)
- Admin
- **EAS Workflow** (duplicate #2 - conditional)
- System Logs
- System Health

**After:**
- **Monitoring** (dropdown)
  - Interactive Map
  - Alerts History
  - Statistics
  - System Health
- **Broadcast Operations** (renamed from "EAS Workflow")
  - Single entry, conditional on authentication
- **System** (dropdown)
  - System Logs
  - Configuration (renamed from "Admin")

### Key Improvements
1. **Eliminated duplicate** "EAS Workflow" entries
2. **Renamed** "EAS Workflow" to "Broadcast Operations" (clearer purpose)
3. **Renamed** "Admin" to "Configuration" in System dropdown
4. **Grouped** related items into logical categories
5. **Added** dropdown menus with visual indicators
6. **Improved** mobile responsiveness

### Features
- Dropdown menus with smooth transitions
- Rotating chevron icons on open/close
- Click-outside-to-close behavior
- Active state highlighting
- Mobile-friendly collapsible menus

### Files Modified
- `/home/user/eas-station/components/navbar.html` (complete rewrite, ~180 lines)

---

## 4. Role and Permission Descriptions

### Overview
Added comprehensive, user-friendly descriptions for all roles and permissions to help administrators understand what each role can do and what each permission grants.

### Changes Made

#### Role Descriptions (`app_core/auth/roles.py`)
Added `ROLE_DESCRIPTIONS` dictionary:
- **Admin**: "Full system administrator with unrestricted access to all features, settings, and user management. Can configure system, manage users, control broadcasts, and access all logs and data."
- **Operator**: "Alert operator with access to broadcast operations and monitoring. Can initiate EAS broadcasts, control GPIO relays, view alerts and logs, but cannot modify system configuration or manage users."
- **Viewer**: "Read-only access for monitoring and reporting. Can view alerts, logs, statistics, and system status but cannot make any changes or initiate broadcasts."

#### Permission Descriptions
Added `PERMISSION_DESCRIPTIONS` dictionary with detailed explanations for all 21 permissions:

**Alerts Permissions:**
- `alerts.view` - View CAP alerts, alert history, and alert details
- `alerts.create` - Create new manual CAP alerts and override filtering
- `alerts.delete` - Delete CAP alerts (use with caution)
- `alerts.export` - Export alert data to CSV, JSON, or other formats

**EAS Permissions:**
- `eas.view` - View EAS broadcast operations and status
- `eas.broadcast` - Initiate EAS broadcasts manually or automatically
- `eas.manual_activate` - Manually activate EAS equipment and override triggers
- `eas.cancel` - Cancel active or scheduled EAS broadcasts (emergency stop)

**System Permissions:**
- `system.configure` - Modify system settings, environment variables, and configuration
- `system.view_config` - View system configuration (read-only)
- `system.manage_users` - Create, modify, and delete user accounts and assign roles
- `system.view_users` - View user list, roles, and login history (read-only)

**Logs Permissions:**
- `logs.view` - View system logs, polling logs, audio logs, and GPIO logs
- `logs.export` - Export log data for auditing and compliance
- `logs.delete` - Delete log entries (may affect audit trails)

**Receivers Permissions:**
- `receivers.view` - View configured receivers and SDR status
- `receivers.configure` - Add, modify, or configure SDR receivers
- `receivers.delete` - Remove receivers from configuration

**GPIO Permissions:**
- `gpio.view` - View GPIO pin status, relay states, and history
- `gpio.control` - Control GPIO pins, activate/deactivate relays

**API Permissions:**
- `api.read` - Read data via REST API endpoints (GET)
- `api.write` - Modify data via REST API endpoints (POST, PUT, DELETE)

### Implementation Details
- Updated `initialize_default_roles_and_permissions()` to use description dictionaries
- Automatically updates descriptions for existing roles/permissions on startup
- Descriptions display in RBAC management UI as tooltips
- Backwards compatible with fallback to generic descriptions

### Files Modified
- `/home/user/eas-station/app_core/auth/roles.py` (lines 140-170, 363-412)

---

## 5. FIPS County Zone Auto-Population

### Overview
Fixed the broken FIPS-to-zone-code auto-population feature in both the setup wizard and configuration pages. When users enter FIPS codes, the system now automatically derives the corresponding NWS zone codes.

### Problem
- Setup wizard and configuration pages accepted FIPS codes but didn't auto-populate zone codes
- Users had to manually look up and enter zone codes
- The `_derive_county_zone_codes_from_fips()` function existed but wasn't being called

### Solution

#### Setup Wizard (`webapp/routes_setup.py`)
- **Added import** for `_derive_county_zone_codes_from_fips` from `app_core.location`
- **Added auto-derivation logic** before validation:
  ```python
  if fips_codes_raw and not zone_codes_raw:
      fips_list = [code.strip() for code in fips_codes_raw.split(",")]
      derived_zones = _derive_county_zone_codes_from_fips(fips_list)
      if derived_zones:
          submitted["DEFAULT_ZONE_CODES"] = ",".join(derived_zones)
  ```
- Logs the number of zones derived for debugging

#### Configuration Pages (`webapp/admin/environment.py`)
- **Added import** for `_derive_county_zone_codes_from_fips`
- **Added auto-derivation logic** in `update_environment_variables()`:
  ```python
  if fips_codes_raw and not zone_codes_raw:
      fips_list = [code.strip() for code in fips_codes_raw.split(",")]
      derived_zones = _derive_county_zone_codes_from_fips(fips_list)
      if derived_zones:
          env_vars["DEFAULT_ZONE_CODES"] = ",".join(derived_zones)
  ```

### How It Works
1. User enters FIPS codes (e.g., `039137,039003`) in setup wizard or config page
2. If `DEFAULT_ZONE_CODES` is empty, system auto-derives zone codes
3. FIPS code `039137` → derives `OHC137` and any associated forecast zones
4. Derived zones are automatically saved to `DEFAULT_ZONE_CODES`
5. User can still override by manually entering zone codes

### Example
**Input:**
- `EAS_MANUAL_FIPS_CODES`: `039137,039003`
- `DEFAULT_ZONE_CODES`: (empty)

**Output:**
- `DEFAULT_ZONE_CODES`: `OHC137,OHZ016,OHC003,OHZ017` (auto-derived)

### Files Modified
- `/home/user/eas-station/webapp/routes_setup.py` (lines 17, 111-127)
- `/home/user/eas-station/webapp/admin/environment.py` (lines 13, 787-803)

---

## Files Changed Summary

### Modified Files
1. `webapp/routes_public.py` - Added comprehensive log viewer backend
2. `templates/logs.html` - Complete redesign of log viewer UI
3. `components/navbar.html` - Reorganized navigation with dropdowns
4. `app_core/auth/roles.py` - Added role and permission descriptions
5. `webapp/routes_setup.py` - Added FIPS auto-population to setup wizard
6. `webapp/admin/environment.py` - Added FIPS auto-population to config pages

### New Files
1. `CHANGES_2025-11-07.md` - This comprehensive change documentation

---

## Testing Recommendations

### Log Viewer
1. Navigate to `/logs` and verify all 7 log type tabs work
2. Test each filter: System, Polling, Polling Debug, Audio Alerts, Audio Metrics, Audio Health, GPIO
3. Verify expandable details show JSON metadata correctly
4. Test record limit selector (50, 100, 250, 500)
5. Verify refresh button reloads current view

### Navigation
1. Verify "Monitoring" dropdown shows: Map, Alerts, Statistics, Health
2. Verify "Broadcast Operations" link works (replaces "EAS Workflow")
3. Verify "System" dropdown shows: Logs, Configuration
4. Test mobile view with hamburger menu
5. Verify dropdown menus close when clicking outside

### FIPS Auto-Population
1. **Setup Wizard Test:**
   - Go to `/setup`
   - Enter FIPS codes (e.g., `039137,039003`)
   - Leave zone codes blank
   - Submit form
   - Verify zone codes are auto-populated in `.env`

2. **Configuration Page Test:**
   - Go to Admin → Environment Settings
   - Set `EAS_MANUAL_FIPS_CODES` to `039137,039003`
   - Leave `DEFAULT_ZONE_CODES` empty
   - Save configuration
   - Verify `DEFAULT_ZONE_CODES` is automatically populated

3. **Override Test:**
   - Enter FIPS codes AND manually enter zone codes
   - Verify manual zone codes are preserved (not overwritten)

### Role Descriptions
1. Go to Admin → RBAC Management
2. View role cards and verify descriptions are shown
3. Hover over permissions and verify tooltips show detailed descriptions
4. Create/edit roles and verify permission descriptions appear in modals

---

## Known Limitations

### Log Viewer
- Maximum 500 records per query (performance consideration)
- No real-time auto-refresh (user must click refresh button)
- No date range filtering (shows most recent records only)
- No export functionality (could be added in future)

### Navigation
- Dropdown menus use JavaScript (requires JS enabled)
- Mobile menu may need testing on various screen sizes

### FIPS Auto-Population
- Only auto-populates when zone codes are completely empty
- If user has partial zone codes, FIPS derivation doesn't merge
- Requires valid 6-digit FIPS codes (no validation error shown for invalid codes)

---

## Future Enhancements (Not Implemented)

Based on user requests, the following features are documented for future implementation:

### 1. Streaming Source Metadata Logging
- Add metadata logging for audio streaming sources
- Use column name like `stream_info` instead of `metadata` to avoid SQL keyword conflicts
- Track source URL, codec, bitrate, connection status, etc.

### 2. SDR Waterfall Display
- Replace scope display with waterfall spectrogram
- Show frequency spectrum over time
- Help visualize signal strength and interference

### 3. SAME Header Detection Improvements
- Improve detection accuracy for SAME headers
- Better handling of noisy signals
- More robust FSK demodulation

### 4. Alert Tone Detection Improvements
- Enhance 1050 Hz and 853 Hz tone detection
- Reduce false positives
- Improve sensitivity

### 5. Narration Detection
- Add logic to detect and extract alert narration audio
- Separate narration from tones
- Better audio segmentation

### 6. EOM Tone Detection
- Improve End-of-Message tone detection
- Better handling of weak signals
- More accurate timing

---

## Migration Notes

### Database
- No database migrations required
- Permission descriptions auto-update on app startup
- Existing roles and permissions will have descriptions updated automatically

### Configuration
- No breaking changes to `.env` configuration
- FIPS auto-population is transparent to existing configurations
- Users with manually entered zone codes will not be affected

### Deployment
- Recommend restarting application after deployment
- Clear browser cache to see navigation changes
- No special migration steps needed

---

## Rollback Instructions

If issues arise, rollback can be performed by reverting these files:

```bash
git checkout HEAD~1 -- webapp/routes_public.py
git checkout HEAD~1 -- templates/logs.html
git checkout HEAD~1 -- components/navbar.html
git checkout HEAD~1 -- app_core/auth/roles.py
git checkout HEAD~1 -- webapp/routes_setup.py
git checkout HEAD~1 -- webapp/admin/environment.py
```

Then restart the application.

---

## Documentation Updated
- This file (`CHANGES_2025-11-07.md`) serves as comprehensive change documentation
- All code changes include inline comments explaining functionality
- Function docstrings maintained and updated where applicable
- README.md should be updated to reference new log viewer capabilities

---

## Credits
- **Log Viewer Design**: Comprehensive filtering inspired by modern admin panels
- **Navigation Reorganization**: Based on user feedback about menu clutter
- **FIPS Auto-Population**: Utilizes existing `_derive_county_zone_codes_from_fips()` function
- **Role Descriptions**: Written for clarity and end-user understanding

---

## Support
For questions or issues related to these changes:
1. Check this document for implementation details
2. Review inline code comments in modified files
3. Check application logs for FIPS auto-derivation messages
4. Open GitHub issue if problems persist

---

**End of Change Documentation**
